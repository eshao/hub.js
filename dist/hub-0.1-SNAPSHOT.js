/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(c){function a(){}a.prototype=c;return new a};if(!Array.prototype.forEach)Array.prototype.forEach=function(c,a){if(!c||!c.call)throw new TypeError;for(var b=0,h=this.length;b<h;b++)c.call(a,this[b],b,this)};hub.apply=function(c,a){return this[c].apply(this,a)};
hub.resolve=function(c,a,b){for(var h=a.indexOf(".");h!==-1;){var g=a.substring(0,h);if(!c.hasOwnProperty(g))return b;c=c[g];a=a.substring(h+1);h=a.indexOf(".")}return c.hasOwnProperty(a)?c[a]:b};hub.substitute=function(c,a,b){if(b===undefined)b="";return c.replace(/\{([a-zA-Z0-9\.]+)\}/g,a?function(h,g){return hub.resolve(a,g,b)}:function(){return b})};hub.Error=function(c,a,b){this.type=c;this.context=b;this.toString=function(){return hub.substitute(a,b)}};
hub.merge=function(c,a){if(c===undefined||c===null||c===a)return a;if(a===undefined||a===null)return c;var b=Object.prototype.toString,h=b.call(a);b=b.call(c);var g;if(b===h){if(h==="[object Object]"){for(g in a)if(a.hasOwnProperty(g))c[g]=hub.merge(c[g],a[g]);return c}if(h==="[object Array]")return c.concat(a)}throw new hub.Error("validation",b===h?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:c,source:a,targetType:b,sourceType:h});};
(function(){function c(g){return function(){var d=this._,j=typeof d[g];if(j!=="function")throw new TypeError(g+" is "+j);var k=b.call(arguments);return function(){var o=b.call(arguments);return d[g].apply(d,k.concat(o))}}}function a(){function g(j){this._=j}var d={};b.call(arguments).forEach(function(j){d[j]=c(j)});g.prototype=d;return g}var b=Array.prototype.slice,h=a("emit","on","un","create","factory","peer","mix");hub.does=new h(hub);hub.does.define=a})();
hub.iterator=function(c){function a(){if(b>=h)throw Error("Iterator out of bounds.");var g=c[b++];a.hasNext=b<h;return g}var b=0,h=c.length;a.hasNext=b<h;a.remove=function(g){var d=typeof g;if(d==="undefined")g=b;else if(d==="number")g<b&&b--;else{for(d=c.length-1;d>=0;d--)if(c[d]===g){g=d;break}if(d<0)return false}if(g>=h)return false;c.splice(g,1);a.hasNext=b<--h;return true};a.insert=function(g,d){if(typeof d==="undefined"){d=g;g=b}else g<b&&b++;c.splice(g,0,d);a.hasNext=b<++h};a.reset=function(){b=
0;a.hasNext=b<h};return a};(function(){hub.chain=function(){function c(){var b=this.propagate?this:hub.scope(arguments);b.push(a);return b.propagate()}var a=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);c.on=function(b){var h=typeof b;if(h!=="function")throw new TypeError("Callback is "+h);a.insert(0,b)};c.un=a.remove;return c}})();
(function(){function c(a){if(typeof a!=="function")throw new TypeError;}hub.mix=function(a,b){for(var h in b)if(b.hasOwnProperty(h)&&typeof b[h]==="function"){var g=a,d=h,j=b[h],k=g[d];if(k)if(k.add)k.add(j);else g[d]=hub.chain(j,g[d]);else g[d]=hub.chain(j)}return a};hub.create=function(a,b,h){if(typeof a!=="string"){h=b;b=a;a=null}c(b);var g={};a=a?hub.topicScope(a):hub.scope();a.mix=function(){hub.apply("emit",arguments).then(hub.does.mix(g))};b=h?b.apply(a,h):b.call(a);return hub.mix(g,b)};hub.factory=
function(a,b){typeof a!=="string"?c(a):c(b);return function(){return hub.create(a,b)}}})();
(function(){function c(e){var m=typeof e;if(m!=="string")throw Error("Topic is "+m);if(!e)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(e))throw Error("Illegal topic: "+e);}function a(e,m){var n=e.indexOf("*"),q=m.indexOf("*");if(n===-1)return q===-1?0:1;if(q===-1)return-1;var t=e.indexOf("."),r=m.indexOf(".");if(n<t){if(q>r)return-1}else if(q<r)return 1;return 0}function b(e){e=e.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+e+"$")}function h(e){return function(){return e}}function g(e,m,n){for(var q in n)if(n.hasOwnProperty(q))e.on(m+q,n[q])}function d(e,m){var n;if(e)if(typeof e==="string")c(e);else{n=e;e=o}else e=o;var q=b(e),t,r=m?[m]:[],p=Object.create(k);p.emit=function(f){if(arguments.length)hub.validateTopic(f);else f=e;var i=Array.prototype.slice.call(arguments,1);if(f.indexOf("{")!==-1)f=hub.substitute(f,i);if(f!==o&&!q.test(f)){if(f.indexOf("*")===-1||!b(f).test(e))return;f=o}i=this.propagate?
this:hub.scope(i);i=hub.topicScope(f,i);t&&t.call(i);if(i.aborted)return i.result();var l=i.topicChainQueue;if(l)Array.prototype.push.apply(l,r);else l=i.topicChainQueue=r.slice();for(;l.length;){l.shift().emit.call(i,f);if(i.aborted)break}return i.result()};p.matches=function(f){return q.test(f)};p.topic=e;p.on=function(f,i,l){if(typeof f==="function")p.on(e,f);else if(Object.prototype.toString.call(f)==="[object Object]")g(p,"",f);else{if(Object.prototype.toString.call(i)==="[object Object]"){g(p,
f+".",i);i=h(i)}if(e===f){t||(t=hub.chain());t.on(i)}else{var s,u,v;u=0;for(v=r.length;u<v;u++){s=r[u];if(s.matches(f)){s.on(f,i,l);return}l||(l=b(f));if(l.test(s.topic)){s=d(f,s);s.on(f,i,l);r[u]=s;return}}s=d(f);s.on(f,i);if(f.indexOf("*")===-1)r.unshift(s);else{u=0;for(v=r.length;u<v;u++)if(a(r[u].topic,f)!==-1){r.splice(u,0,s);return}r.push(s)}}}};p.un=function(f,i){if(typeof f==="function")return p.un("**",f);if(e===f)return t?t.un(i):-1;var l,s,u;l=0;for(s=r.length;l<s;l++){u=r[l];if(u.matches(f))if(u.un(f,
i))return true}c(f);l=typeof i;if(l!=="function")throw new TypeError("Callback is "+l);return false};p.mix=function(f){if(typeof f==="string")hub.apply("emit",arguments).then(p.does.on());else p.on(f);return p};p.does=new j(p);n&&g(p,"",n);return p}var j=hub.does.define("emit","on","un","create","factory","peer","mix"),k={create:hub.create,factory:hub.factory,peer:function(e,m,n){if(typeof e==="function"){if(m=hub.create(e,m))this.on(m)}else if(typeof m==="function"){if(m=hub.create(e,m,n))this.on(e,
m)}else this.on(e,m)}},o="**";hub.node=d;hub.topicComparator=a;hub.validateTopic=c})();(function(){var c=hub.node();hub.root=c;hub.on=function(a,b){c.on(a,b)};hub.un=function(a,b){return c.un(a,b)};hub.emit=function(){return c.emit.apply(c,arguments)};hub.peer=function(){return c.peer.apply(c,arguments)};hub.reset=function(){hub.root=c=hub.node()}})();
(function(){function c(d){return function(){d.reject.apply(d,arguments)}}function a(d,j){return function(){var k=h.call(arguments);j.then(function(){var o=h.call(arguments);d.resolve.apply(d,k.concat(o))})}}var b=hub.does.define("emit","on","un","create","factory","peer","mix","resolve","reject"),h=Array.prototype.slice,g={};["on","un","emit","create","factory","peer","mix"].forEach(function(d){g[d]=function(){var j=h.call(arguments);return this.then(function(){hub[d].apply(hub,j.concat(Array.prototype.slice.call(arguments)))})}});
hub.promise=function(d,j){function k(){p&&clearTimeout(p);for(var i=r?n:m,l=0,s=i.length;l<s;l++)i[l].apply(j,q);m.length=0;n.length=0}function o(){t--;!t&&q&&k()}function e(){if(q)throw Error("Promise already "+(r?"rejected":"resolved"));}var m=[],n=[],q,t=0,r=false,p,f;f=Object.create(g);f.then=function(i,l){if(!i&&!l)throw new TypeError("Require callback or errback");if(i&&typeof i!=="function")throw new TypeError("Callback is "+i);if(l&&typeof l!=="function")throw new TypeError("Errback is "+
l);i&&m.push(i);l&&n.push(l);!t&&q&&k();return this};f.resolve=function(){e();q=h.call(arguments);t||k();return this};f.reject=function(){e();r=true;q=h.call(arguments);t||k();return this};f.wait=function(){var i=0,l=arguments.length;for(t+=l;i<l;i++)arguments[i].then(o,o);return this};f.join=function(i){if(!i||typeof i.then!=="function")throw new TypeError("Promise is "+i);var l=hub.promise(0,j);this.then(a(l,i),c(l));i.then(null,c(l));return l};f.does=new b(f);if(d)p=setTimeout(function(){f.reject(new hub.Error("timeout",
"Promise timed out after {timeout} milliseconds",{timeout:d}))},d);return f}})();
(function(){function c(d,j){if(d)d+=".";return function(){var k=h.call(arguments);if(!k[0])throw new TypeError("Topic is "+k[0]);k[0]=d+k[0];return j.apply(hub,k)}}var a={},b={},h=Array.prototype.slice;["then","join","wait","resolve","reject"].forEach(function(d){a[d]=function(){var j=this.promise();j[d].apply(j,arguments)}});hub.scope=function(d){function j(){return m.propagate()}var k=[],o,e,m=Object.create(a);m.aborted=false;m.stopPropagation=function(){m.aborted=true;k.length=0;if(arguments.length)e=
arguments[0]};m.propagate=function(){if(arguments.length)d=h.call(arguments);var n=k.length;if(!n)return this.result();n=k[n-1];if(n.hasNext){n=n().apply(this,d);if(o){e=o;o=undefined;e.then(j);return e}else if(n&&n.then){e=n;e.then(j);return}e=hub.merge(e,n)}else{n.reset();k.pop()}return this.propagate()};m.result=function(){if(e&&e.then)return e;return hub.promise(0,this).resolve(e)};m.push=function(n){k.push(n)};m.promise=function(n,q){o||(o=hub.promise(n||0,q||this));return o};return m};hub.topicScope=
function(d,j){j||(j=hub.scope());var k=d.lastIndexOf(".");k=k===-1?"":d.substring(0,k);var o=b[k];if(!o){o={on:c(k,hub.on),un:c(k,hub.un),peer:c(k,hub.peer),emit:c(k,hub.emit),create:c(k,hub.create),factory:c(k,hub.factory)};b[k]=o}j.topic=d;j.on=o.on;j.un=o.un;j.peer=o.peer;j.emit=o.emit;j.create=o.create;j.factory=o.factory;return j};var g=hub.reset;hub.reset=function(){b={};g()}})();
