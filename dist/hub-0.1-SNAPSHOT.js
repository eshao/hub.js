/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(d){function c(){}c.prototype=d;return new c};hub.resolve=function(d,c,a){for(var f=c.indexOf(".");f!==-1;){var h=c.substring(0,f);if(!d.hasOwnProperty(h))return a;d=d[h];c=c.substring(f+1);f=c.indexOf(".")}return d.hasOwnProperty(c)?d[c]:a};hub.substitute=function(d,c,a){if(a===undefined)a="";return d.replace(/\{([a-zA-Z0-9\.]+)\}/g,c?function(f,h){return hub.resolve(c,h,a)}:function(){return a})};
hub.Error=function(d,c,a){this.type=d;this.context=a;this.toString=function(){return hub.substitute(c,a)}};
hub.merge=function(d,c){if(d===undefined||d===null||d===c)return c;if(c===undefined||c===null)return d;var a=Object.prototype.toString,f=a.call(c);a=a.call(d);var h;if(a===f){if(f==="[object Object]"){for(h in c)if(c.hasOwnProperty(h))d[h]=hub.merge(d[h],c[h]);return d}if(f==="[object Array]")return d.concat(c)}throw new hub.Error("validation",a===f?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:d,source:c,targetType:a,sourceType:f});};
hub.iterator=function(d){function c(){if(a>=f)throw Error("Iterator out of bounds.");var h=d[a++];c.hasNext=a<f;return h}var a=0,f=d.length;c.hasNext=a<f;c.remove=function(h){var b=typeof h;if(b==="undefined")h=a;else if(b==="number")h<a&&a--;else{for(b=d.length-1;b>=0;b--)if(d[b]===h){h=b;break}if(b<0)return false}if(h>=f)return false;d.splice(h,1);c.hasNext=a<--f;return true};c.insert=function(h,b){if(typeof b==="undefined"){b=h;h=a}else h<a&&a++;d.splice(h,0,b);c.hasNext=a<++f};c.reset=function(){a=
0;c.hasNext=a<f};return c};
(function(){function d(i){function o(){return k.propagate()}var n=[],p=false,l,g,k=Object.create(e);k.stopPropagation=function(){p=true;n.length=0;if(arguments.length)g=arguments[0]};k.propagate=function(){if(arguments.length)g=arguments[0];var m=n.length;if(!m)return this.result();m=n[m-1];if(m.hasNext){m=m().apply(this,i);if(l){g=l;l=undefined;g.then(o);return g}else if(m&&m.then){g=m;g.then(o);return}g=hub.merge(g,m)}else{m.reset();n.pop()}return this.propagate()};k.aborted=function(){return p};
k.result=function(){if(g&&g.then)return g;return hub.promise(0,this).resolve(g)};k.push=function(m){n.push(m)};k.promise=function(){l||(l=hub.promise());return l};return k}function c(){function i(){var n=this.propagate?this:d(arguments);n.push(o);return n.propagate()}var o=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);i.add=function(n){var p=typeof n;if(p!=="function")throw new TypeError("Callback is "+p);o.insert(0,n)};i.insert=o.insert;i.remove=o.remove;return i}function a(i){i=
i.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+i+"$")}function f(i){var o=typeof i;if(o!=="string")throw Error("Topic is "+o);if(!i)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(i))throw Error("Illegal topic: "+i);}function h(i,o){var n=i.indexOf("*"),p=o.indexOf("*");if(n===-1)return p===-1?0:1;if(p===-1)return-1;var l=i.indexOf("."),g=o.indexOf(".");if(n<l){if(p>g)return-1}else if(p<g)return 1;
return 0}function b(i,o){function n(k){k||(k=i);if(k!==j&&!p.test(k)){if(k.indexOf("*")===-1||!a(k).test(i))return;k=j}var m=this.propagate?this:d(Array.prototype.slice.call(arguments,1));l&&l.call(m);if(m.aborted())return m.result();var q=m.topicChainQueue;if(q)Array.prototype.push.apply(q,g);else q=m.topicChainQueue=g.slice();for(;q.length;){q.shift().call(m,k);if(m.aborted())break}return m.result()}if(i)f(i);else i=j;var p=a(i),l,g=o?[o]:[];n.matches=function(k){return p.test(k)};n.getTopic=function(){return i};
n.add=function(k,m,q){if(i===k){l||(l=c());l.add(m)}else{var r,s,t;s=0;for(t=g.length;s<t;s++){r=g[s];if(r.matches(k)){r.add(k,m,q);return}q||(q=a(k));if(q.test(r.getTopic())){r=b(k,r);r.add(k,m,q);g[s]=r;return}}r=b(k);r.add(k,m);if(k.indexOf("*")===-1)g.unshift(r);else{s=0;for(t=g.length;s<t;s++){m=g[s].getTopic();if(h(m,k)!==-1){g.splice(s,0,r);return}}g.push(r)}}};n.remove=function(k,m){if(i===k)return l?l.remove(m):-1;var q,r,s;q=0;for(r=g.length;q<r;q++){s=g[q];if(s.matches(k))if(s.remove(k,
m))return true}f(k);q=typeof m;if(q!=="function")throw new TypeError("Callback is "+q);return false};return n}var e={};(function(){function i(l){e[l]=function(){var g=this.promise();g[l].apply(g,arguments)}}for(var o=["then","join","wait","resolve","reject"],n=0,p=o.length;n<p;n++)i(o[n])})();var j="**";hub.scope=d;hub.chain=c;hub.topicChain=b;hub.topicComparator=h;hub.validateTopic=f})();
(function(){hub.mix=function(d,c){for(var a in c)if(c.hasOwnProperty(a)&&typeof c[a]==="function"){var f=d,h=a,b=c[a],e=f[h];if(e)if(e.add)e.add(b);else f[h]=hub.chain(b,f[h]);else f[h]=b}return d};hub.create=function(d,c,a){if(typeof d!=="string"){a=c;c=d;d=null}if(typeof c!=="function")throw new TypeError;var f={};d=d?hub.topicScope(d):hub.scope();d.mix=function(){hub.emit.apply(hub,arguments).then(function(h){hub.mix(f,h)})};c=a?c.apply(d,a):c.call(d);return hub.mix(f,c)};hub.factory=function(d,
c){return function(){return hub.create(d,c)}}})();
(function(){function d(b,e){for(var j in e)e.hasOwnProperty(j)&&hub.root.add(b+j,e[j])}function c(b){return function(){return b}}function a(b,e){b+=".";return function(){var j=h.call(arguments);if(!j[0])throw new TypeError("Topic is "+j[0]);j[0]=b+j[0];return e.apply(this,j)}}hub.root=hub.topicChain();var f={},h=Array.prototype.slice;hub.on=function(b,e){if(typeof b==="function")hub.root.add("**",b);else if(Object.prototype.toString.call(b)==="[object Object]"){d("",b);return}else if(Object.prototype.toString.call(e)===
"[object Object]"){d(b+".",e);e=c(e)}hub.root.add(b,e)};hub.un=function(b,e){if(typeof b==="function")return hub.root.remove("**",b);return hub.root.remove(b,e)};hub.topicScope=function(b,e){e||(e=hub.scope());var j=f[b];if(!j){j={on:a(b,hub.on),un:a(b,hub.un),peer:a(b,hub.peer),emit:a(b,hub.emit),create:a(b,hub.create),factory:a(b,hub.factory)};f[b]=j}e.on=j.on;e.un=j.un;e.peer=j.peer;e.emit=j.emit;e.create=j.create;e.factory=j.factory;return e};hub.emit=function(b){hub.validateTopic(b);var e=h.call(arguments),
j=e.slice(1);if(b.indexOf("{")!==-1)e[0]=hub.substitute(b,j);j=this.propagate?this:hub.scope(j);j=hub.topicScope(e[0],j);var i;try{i=hub.root.apply(j,e)}catch(o){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:e[0],error:o.message});}if(!i||!i.then){e=hub.promise(0,j);e.resolve(i);i=e}return i};hub.peer=function(b,e,j){if(typeof b==="function"){if(e=hub.create(b,e))hub.on(e)}else if(typeof e==="function"){if(e=hub.create(b,e,j))hub.on(b,e)}else hub.on(b,e)};hub.reset=
function(){f={};hub.root=hub.topicChain()}})();
(function(){var d=Array.prototype.slice;hub.promise=function(c,a){function f(){n&&clearTimeout(n);for(var l=o?e:b,g=0,k=l.length;g<k;g++)l[g].apply(a,j);b.length=0;e.length=0}function h(){i--;!i&&j&&f()}var b=[],e=[],j,i=0,o=false,n,p;p={then:function(l,g){if(typeof l!=="function")throw new TypeError("Callback is "+l);b.push(l);g&&e.push(g);!i&&j&&f();return this},resolve:function(){if(j)throw Error("Promise already "+(o?"rejected":"resolved"));j=d.call(arguments);i||f();return this},reject:function(){o=
true;return this.resolve.apply(this,arguments)},wait:function(){var l=0,g=arguments.length;for(i+=g;l<g;l++)arguments[l].then(h);return this},join:function(l){if(!l||typeof l.then!=="function")throw new TypeError("Promise is "+l);var g=hub.promise();this.then(function(){var k=d.call(arguments);l.then(function(){var m=d.call(arguments);g.resolve.apply(g,k.concat(m))})});return g},emit:function(l){this.then(function(){hub.emit.apply(hub,[l].concat(j))})}};if(c)n=setTimeout(function(){p.reject(new hub.Error("timeout",
"Promise timed out after {timeout} milliseconds",{timeout:c}))},c);return p}})();
(function(){var d=hub.emit,c=hub.merge;hub.emitter=function(a,f,h){if(typeof a==="string"){if(f){if(h)return function(){return d(a,c(f.apply(null,arguments),h))};if(typeof f==="function")return function(){return d(a,f.apply(null,arguments))};return function(i){return d(a,c(i,f))}}return function(){if(arguments.length)return d.apply(hub,[a].concat(Array.prototype.slice.call(arguments)));return d(a)}}var b=hub.chain(),e;for(e in a)if(a.hasOwnProperty(e)){var j=a[e];b[e]=typeof j==="string"?hub.emitter(j):
hub.emitter.apply(hub,j);b.add(b[e])}return b}})();(function(){var d=hub.emitter,c=hub.on;hub.forward=function(a,f,h,b){if(typeof a==="object")for(var e in a){if(a.hasOwnProperty(e)){f=a[e];typeof f==="string"?c(e,d(f)):c(e,d(f[0],f[1],f[2]))}}else c(a,d(f,h,b))}})();
