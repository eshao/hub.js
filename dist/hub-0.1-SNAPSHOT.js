/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(g,h){if(g===undefined||g===null||g===h)return h;if(h===undefined||h===null)return g;var a=Object.prototype.toString,j=a.call(h);a=a.call(g);var i;if(a===j){if(j==="[object Object]"){for(i in h)if(h.hasOwnProperty(i))g[i]=hub.merge(g[i],h[i]);return g}if(j==="[object Array]")return g.concat(h)}throw new hub.Error("validation",a===j?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:g,source:h,targetType:a,sourceType:j});};
hub.resolve=function(g,h,a){for(var j=h.indexOf(".");j!==-1;){var i=h.substring(0,j);if(!g.hasOwnProperty(i))return a;g=g[i];h=h.substring(j+1);j=h.indexOf(".")}return g.hasOwnProperty(h)?g[h]:a};hub.substitute=function(g,h,a){if(a===undefined)a="";return g.replace(/\{([a-zA-Z0-9\.]+)\}/g,h?function(j,i){return hub.resolve(h,i,a)}:function(){return a})};hub.Error=function(g,h,a){this.type=g;this.context=a;this.toString=function(){return hub.substitute(h,a)}};
hub.iterator=function(g){function h(){if(a>=j)throw Error("Iterator out of bounds.");var i=g[a++];h.hasNext=a<j;return i}var a=0,j=g.length;h.hasNext=a<j;h.remove=function(i){var b=typeof i;if(b==="undefined")i=a;else if(b==="number")i<a&&a--;else{for(b=g.length-1;b>=0;b--)if(g[b]===i){i=b;break}if(b<0)return false}if(i>=j)return false;g.splice(i,1);h.hasNext=a<--j;return true};h.insert=function(i,b){if(typeof b==="undefined"){b=i;i=a}else i<a&&a++;g.splice(i,0,b);h.hasNext=a<++j};h.reset=function(){a=
0;h.hasNext=a<j};return h};
(function(){function g(){var m=b.length;if(!m)return false;m=b[m-1];if(!m.hasNext){b.pop();return g()}m=m().apply(a,j);i=hub.merge(i,m);return true}var h=false,a,j,i,b=[];hub.stopPropagation=function(){h=true;b.length=0;if(arguments.length)i=arguments[0]};hub.propagate=function(){g()};hub.chain=function(){function m(){m.aborted=false;var c=!b.length;if(c){h=false;j=arguments;i=undefined}var f=a;a=this;try{b.push(d);var l=true;do l=g();while(l)}finally{m.aborted=h;d.reset();if(c)b.length=0;a=f}if(!b.length){c=
i;a=j=i=undefined;return c}}var d=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);m.add=function(c){d.insert(0,c)};m.insert=d.insert;m.remove=d.remove;return m}})();
(function(){function g(c,f){for(var l in f)if(f.hasOwnProperty(l)){var q=f[l],o=c[l];o||(c[l]=o=hub.chain());o.add(q)}}function h(c,f,l){return function(){var q=Array.prototype.slice.call(arguments);q=hub.publish.apply(hub,[c].concat(q));hub.aborted()||(q=hub.merge(q,f.apply(l,arguments)));return q}}function a(c){var f=i[c];if(f)return f;f=b[c];if(!f)throw Error("Peer is not defined: "+c);f=d(f);var l={},q;for(q in f)if(f.hasOwnProperty(q)){var o=f[q];if(typeof o==="function")l[q]=h(c+"/"+q,o,l)}f.api=
l;return f}function j(c,f){return function(){return c.apply(f,arguments)}}var i={},b={},m=[],d;d=function(c){var f={},l=c.is,q,o;q=0;for(o=l.length;q<o;q++)g(f,a(l[q]));g(f,c.instance||c.factory());return f};hub.peer=function(c,f,l){if(b[c])throw Error("hub - peer already defined: "+c);if(!l){l=f;f=null}f={is:f?typeof f==="string"?[f]:f:m};if(typeof l==="function")f.factory=l;else{f.instance=l;l=i[c]=d(f);var q=l.api={},o;for(o in l)if(l.hasOwnProperty(o)){var e=l[o];if(typeof e==="function"){var k=
c+"/"+o;hub.subscribe(k,j(e,q));q[o]=hub.publisher(k)}}}b[c]=f};hub.get=function(c){return a(c).api};hub.resetPeers=function(){i={};for(var c in b)b.hasOwnProperty(c)&&c.indexOf("lib.")===-1&&delete b[c]}})();
(function(){function g(d){d=d.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+d+"$")}function h(d,c){var f=d.indexOf("*"),l=c.indexOf("*");if(f===-1)return l===-1?0:1;if(l===-1)return-1;var q=d.indexOf("/"),o=c.indexOf("/");if(f<q){if(l>o)return-1}else if(l<o)return 1;return 0}function a(d,c){function f(e,k,p){e||(e=d);if(e!==b&&!l.test(e)){if(e.indexOf("*")===-1||!g(e).test(d))return;e=b}var n=k&&k.length?q.apply(this,
k):q.call(this);if(q.aborted){f.aborted=true;return n}if(p){var r,s;r=0;for(s=o.length;r<s;r++)p.push(o[r])}else p=o.slice();for(;p.length;){r=p.shift();s=r.call(this,e,k,p);n=hub.merge(n,s);if(r.aborted){f.aborted=true;break}}return n}d||(d=b);var l=g(d),q=hub.chain(),o=c?[c]:[];f.matches=function(e){return l.test(e)};f.getTopic=function(){return d};f.add=function(e,k,p){if(d===k)q.add(e);else{var n,r,s;r=0;for(s=o.length;r<s;r++){n=o[r];if(n.matches(k)){n.add(e,k,p);return}p||(p=g(k));if(p.test(n.getTopic())){n=
a(k,n);n.add(e,k,p);o[r]=n;return}}n=a(k);n.add(e,k);if(k.indexOf("*")===-1)o.unshift(n);else{r=0;for(s=o.length;r<s;r++){e=o[r].getTopic();if(h(e,k)!==-1){o.splice(r,0,n);return}}o.push(n)}}};f.remove=function(e,k){if(d===k)return q.remove(e);var p,n,r;p=0;for(n=o.length;p<n;p++){r=o[p];if(r.matches(k))if(r.remove(e,k))return true}return false};return f}function j(d){var c=typeof d;if(c!=="string")throw Error("Topic is "+c);if(!d)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(d))throw Error("Illegal topic: "+
d);}function i(d){d=typeof d;if(d!=="function")throw Error("Callback is "+d);}var b="**/**",m=a();hub.topicChain=a;hub.topicComparator=h;hub.reset=function(){m=a();hub.resetPeers();hub.resetPromise()};hub.subscribe=function(d,c){i(c);j(d);m.add(c,d)};hub.unsubscribe=function(d,c){i(c);j(d);return m.remove(c,d)};hub.invoke=function(d){j(d);var c=Array.prototype.slice.call(arguments,1);if(d.indexOf("{")!==-1)d=hub.substitute(d,c);try{return m(d,c)}catch(f){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',
{topic:d,error:f.message});}};hub.aborted=function(){return Boolean(m.aborted)}})();
(function(){function g(e,k,p){var n;try{n=e.apply(null,k)}catch(r){hub.invoke("hub.error/promise.callback",new hub.Error("error","Error in promise callback: ${error}",{error:r.message}));return}if(p){if(n===undefined)return k;return[n]}}function h(){hub.invoke("hub.error/promise.resolved",new hub.Error("validation","Promise already resolved"))}function a(e){return function(){e.reject({type:"timeout"})}}function j(e,k,p){var n,r,s=!(k instanceof hub.Error),t=k===undefined?[]:[k],w;w={then:function(u,
v){if(e){var x=s?u:v;if(x)t=g(x,t,true)}else{u&&n.push(u);v&&r.push(v)}return this},publish:function(){if(e){t=[hub.invoke.apply(hub,arguments)];return this}var u=f.call(arguments);return this.then(function(){t=[hub.invoke.apply(hub,u)]})},publishResult:function(u){if(e){t=[hub.invoke.apply(hub,[u].concat(t))];return this}return this.then(function(){t=[hub.invoke.apply(hub,[u].concat(t))]})},resolve:function(){if(e)h();else{e=true;clearTimeout(p);if(arguments.length!==0)t=f.call(arguments);for(;n.length;)g(n.shift(),
t)}return this},reject:function(u){if(e)h();else{e=true;s=false;for(clearTimeout(p);r.length;){var v=r.shift();g(v,[u])}}return this},resolved:function(){return e},join:function(u){return l(w,u)}};if(!e){n=[];r=[];p=setTimeout(a(w),p||6E4)}return w}function i(e){var k=j(true);e.then=k.then;e.publish=k.publish;e.publishResult=k.publishResult;return k}var b=true,m=Array.prototype,d=m.unshift,c=m.push,f=m.slice,l;l=function(e,k){function p(){if(++r===2)(t?s.resolve:s.reject).apply(null,n)}var n=[],r=
0,s=j(false),t=true;e.then(function(){d.apply(n,arguments);p()},function(){d.apply(n,arguments);t=false;p()});k.then(function(){c.apply(n,arguments);p()},function(){c.apply(n,arguments);t=false;p()});return s};var q=Error("hub - promise already resolved"),o=function(){};o.prototype={then:function(e,k){return i(this).then(e,k)},publish:function(){return i(this).publish.apply(null,arguments)},publishResult:function(){return i(this).publishResult.apply(null,arguments)},resolve:function(){throw q;},reject:function(){throw q;
},resolved:function(){return true},join:function(e){return i(this).join(e)}};hub.publish=function(){var e=b;b=false;var k;try{k=hub.invoke.apply(this,arguments)}catch(p){if(b&&p instanceof hub.Error){b.reject(p);return b}throw p;}if(typeof k!=="undefined"){k=j(true,k);b=b?l(b,k):k}k=b;b=e;return k||new o};hub.promise=function(e){e=j(false,undefined,e);if(b===false)b=e;else if(b!==true)b=l(b,e);return e};hub.resetPromise=function(){typeof b!=="boolean"&&b.reject();b=true}})();
(function(){var g=hub.publish,h=hub.merge;hub.publisher=function(a,j,i){if(typeof a==="string"){if(j){if(i)return function(){return g(a,h(j.apply(null,arguments),i))};if(typeof j==="function")return function(){return g(a,j.apply(null,arguments))};return function(c){return g(a,h(c,j))}}return function(){if(arguments.length)return g.apply(hub,[a].concat(Array.prototype.slice.call(arguments)));return g(a)}}var b=hub.chain(),m;for(m in a)if(a.hasOwnProperty(m)){var d=a[m];b[m]=typeof d==="string"?hub.publisher(d):
hub.publisher.apply(hub,d);b.add(b[m])}return b}})();(function(){var g=hub.publisher,h=hub.subscribe;hub.forward=function(a,j,i,b){if(typeof a==="object")for(var m in a){if(a.hasOwnProperty(m)){j=a[m];typeof j==="string"?h(m,g(j)):h(m,g(j[0],j[1],j[2]))}}else h(a,g(j,i,b))}})();
