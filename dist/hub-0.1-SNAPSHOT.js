/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(c){function a(){}a.prototype=c;return new a};if(!Array.prototype.forEach)Array.prototype.forEach=function(c,a){if(!c||!c.call)throw new TypeError;for(var b=0,g=this.length;b<g;b++)c.call(a,this[b],b,this)};hub.apply=function(c,a){return this[c].apply(this,a)};
hub.resolve=function(c,a,b){for(var g=a.indexOf(".");g!==-1;){var e=a.substring(0,g);if(!c.hasOwnProperty(e))return b;c=c[e];a=a.substring(g+1);g=a.indexOf(".")}return c.hasOwnProperty(a)?c[a]:b};hub.substitute=function(c,a,b){if(b===undefined)b="";return c.replace(/\{([a-zA-Z0-9\.]+)\}/g,a?function(g,e){return hub.resolve(a,e,b)}:function(){return b})};hub.Error=function(c,a,b){this.type=c;this.context=b;this.toString=function(){return hub.substitute(a,b)}};
hub.merge=function(c,a){if(c===undefined||c===null||c===a)return a;if(a===undefined||a===null)return c;var b=Object.prototype.toString,g=b.call(a);b=b.call(c);var e;if(b===g){if(g==="[object Object]"){for(e in a)if(a.hasOwnProperty(e))c[e]=hub.merge(c[e],a[e]);return c}if(g==="[object Array]")return c.concat(a)}throw new hub.Error("validation",b===g?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:c,source:a,targetType:b,sourceType:g});};
(function(){function c(e){return function(){var h=this._,j=typeof h[e];if(j!=="function")throw new TypeError(e+" is "+j);var k=b.call(arguments);return function(){var l=b.call(arguments);return h[e].apply(h,k.concat(l))}}}function a(){function e(j){this._=j}var h={};b.call(arguments).forEach(function(j){h[j]=c(j)});e.prototype=h;return e}var b=Array.prototype.slice,g=a("emit","on","un","create","factory","peer","mix");hub.does=new g(hub);hub.does.define=a})();
hub.iterator=function(c){function a(){if(b>=g)throw Error("Iterator out of bounds.");var e=c[b++];a.hasNext=b<g;return e}var b=0,g=c.length;a.hasNext=b<g;a.remove=function(e){var h=typeof e;if(h==="undefined")e=b;else if(h==="number")e<b&&b--;else{for(h=c.length-1;h>=0;h--)if(c[h]===e){e=h;break}if(h<0)return false}if(e>=g)return false;c.splice(e,1);a.hasNext=b<--g;return true};a.insert=function(e,h){if(typeof h==="undefined"){h=e;e=b}else e<b&&b++;c.splice(e,0,h);a.hasNext=b<++g};a.reset=function(){b=
0;a.hasNext=b<g};return a};(function(){hub.chain=function(){function c(){var b=this.propagate?this:hub.scope();b.push(a);return b.propagate.apply(b,arguments)}var a=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);c.on=function(b){var g=typeof b;if(g!=="function")throw new TypeError("Callback is "+g);a.insert(0,b)};c.un=a.remove;return c}})();
(function(){function c(a){if(typeof a!=="function")throw new TypeError;}hub.mix=function(a,b){for(var g in b)if(b.hasOwnProperty(g)&&typeof b[g]==="function"){var e=a,h=g,j=b[g],k=e[h];if(k)if(k.add)k.add(j);else e[h]=hub.chain(j,e[h]);else e[h]=hub.chain(j)}return a};hub.create=function(a,b,g){if(typeof a!=="string"){g=b;b=a;a=null}c(b);var e={};a=a?hub.topicScope(a):hub.scope();a.mix=function(){hub.apply("emit",arguments).then(hub.does.mix(e))};b=g?b.apply(a,g):b.call(a);return hub.mix(e,b)};hub.factory=
function(a,b){typeof a!=="string"?c(a):c(b);return function(){return hub.create(a,b)}}})();
(function(){function c(d){var p=typeof d;if(p!=="string")throw Error("Topic is "+p);if(!d)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(d))throw Error("Illegal topic: "+d);}function a(d,p){var o=d.indexOf("*"),n=p.indexOf("*");if(o===-1)return n===-1?0:1;if(n===-1)return-1;var t=d.indexOf("."),s=p.indexOf(".");if(o<t){if(n>s)return-1}else if(n<s)return 1;return 0}function b(d){d=d.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+d+"$")}function g(d){return function(){return d}}function e(d,p,o){for(var n in o)if(o.hasOwnProperty(n))d.on(p+n,o[n])}function h(d,p){var o;if(d)if(typeof d==="string")c(d);else{o=d;d=l}else d=l;var n=b(d),t,s=p?[p]:[],r=Object.create(k);r.emit=function(f){if(arguments.length)hub.validateTopic(f);else f=d;var m=Array.prototype.slice.call(arguments,1);if(f.indexOf("{")!==-1)f=hub.substitute(f,m);if(f!==l&&!n.test(f)){if(f.indexOf("*")===-1||!b(f).test(d))return;f=l}var i=
this.propagate?this:hub.scope();i=hub.topicScope(f,i);t&&t.apply(i,m);if(i.aborted)return i.result();var q=i.topicChainQueue;if(q)Array.prototype.push.apply(q,s);else q=i.topicChainQueue=s.slice();for(;q.length;){q.shift().emit.apply(i,[f].concat(m));if(i.aborted)break}return i.result()};r.matches=function(f){return n.test(f)};r.topic=d;r.on=function(f,m,i){if(typeof f==="function")r.on(d,f);else if(Object.prototype.toString.call(f)==="[object Object]")e(r,"",f);else{if(Object.prototype.toString.call(m)===
"[object Object]"){e(r,f+".",m);m=g(m)}if(d===f){t||(t=hub.chain());t.on(m)}else{var q,u,v;u=0;for(v=s.length;u<v;u++){q=s[u];if(q.matches(f)){q.on(f,m,i);return}i||(i=b(f));if(i.test(q.topic)){q=h(f,q);q.on(f,m,i);s[u]=q;return}}q=h(f);q.on(f,m);if(f.indexOf("*")===-1)s.unshift(q);else{u=0;for(v=s.length;u<v;u++)if(a(s[u].topic,f)!==-1){s.splice(u,0,q);return}s.push(q)}}}};r.un=function(f,m){if(typeof f==="function")return r.un("**",f);if(d===f)return t?t.un(m):-1;var i,q,u;i=0;for(q=s.length;i<
q;i++){u=s[i];if(u.matches(f))if(u.un(f,m))return true}c(f);i=typeof m;if(i!=="function")throw new TypeError("Callback is "+i);return false};r.mix=function(f){if(typeof f==="string")hub.apply("emit",arguments).then(r.does.on());else r.on(f);return r};r.does=new j(r);o&&e(r,"",o);return r}var j=hub.does.define("emit","on","un","create","factory","peer","mix"),k={create:hub.create,factory:hub.factory,peer:function(d,p,o){if(typeof d==="function"){if(p=hub.create(d,p))this.on(p)}else if(typeof p==="function"){if(p=
hub.create(d,p,o))this.on(d,p)}else this.on(d,p)}},l="**";hub.node=h;hub.topicComparator=a;hub.validateTopic=c})();(function(){var c=hub.node();hub.root=c;hub.on=function(a,b){c.on(a,b)};hub.un=function(a,b){return c.un(a,b)};hub.emit=function(){return c.emit.apply(c,arguments)};hub.peer=function(){return c.peer.apply(c,arguments)};hub.reset=function(){hub.root=c=hub.node()}})();
(function(){function c(h){return function(){h.reject.apply(h,arguments)}}function a(h,j){return function(){var k=g.call(arguments);j.then(function(){var l=g.call(arguments);h.resolve.apply(h,k.concat(l))})}}var b=hub.does.define("emit","on","un","create","factory","peer","mix","resolve","reject"),g=Array.prototype.slice,e={};["on","un","emit","create","factory","peer","mix"].forEach(function(h){e[h]=function(){var j=g.call(arguments);return this.then(function(){hub[h].apply(hub,j.concat(Array.prototype.slice.call(arguments)))})}});
hub.promise=function(h,j){function k(){r&&clearTimeout(r);for(var m=s?o:p,i=0,q=m.length;i<q;i++)m[i].apply(j,n);p.length=0;o.length=0}function l(){t--;!t&&n&&k()}function d(){if(n)throw Error("Promise already "+(s?"rejected":"resolved"));}var p=[],o=[],n,t=0,s=false,r,f;f=Object.create(e);f.then=function(m,i){if(!m&&!i)throw new TypeError("Require callback or errback");if(m&&typeof m!=="function")throw new TypeError("Callback is "+m);if(i&&typeof i!=="function")throw new TypeError("Errback is "+
i);m&&p.push(m);i&&o.push(i);!t&&n&&k();return this};f.resolve=function(){d();n=g.call(arguments);t||k();return this};f.reject=function(){d();s=true;n=g.call(arguments);t||k();return this};f.wait=function(){var m=0,i=arguments.length;for(t+=i;m<i;m++)arguments[m].then(l,l);return this};f.join=function(m){if(!m||typeof m.then!=="function")throw new TypeError("Promise is "+m);var i=hub.promise(0,j);this.then(a(i,m),c(i));m.then(null,c(i));return i};f.does=new b(f);if(h)r=setTimeout(function(){f.reject(new hub.Error("timeout",
"Promise timed out after {timeout} milliseconds",{timeout:h}))},h);return f}})();
(function(){function c(j,k){if(j)j+=".";return function(){var l=g.call(arguments);if(!l[0])throw new TypeError("Topic is "+l[0]);l[0]=j+l[0];return k.apply(hub,l)}}var a={},b={},g=Array.prototype.slice;["then","join","wait","resolve","reject"].forEach(function(j){a[j]=function(){var k=this.promise();k[j].apply(k,arguments)}});hub.scope=function(j){var k=[],l,d,p,o=Object.create(a);o.aborted=false;o.stopPropagation=function(){o.aborted=true;k.length=0;if(arguments.length)d=arguments[0]};o.propagate=
function(){if(arguments.length)p=g.call(arguments);var n=k.length;if(!n)return this.result();n=k[n-1];if(n.hasNext){n=n().apply(this,p);if(l){d=l;l=undefined;d.then(function(){o.propagate.apply(o,p)});return d}else if(n&&n.then){d=n;d.then(function(){o.propagate.apply(o,p)});return}d=hub.merge(d,n)}else{n.reset();k.pop()}return this.propagate.apply(this,p)};o.result=function(){if(d&&d.then)return d;return hub.promise(0,this).resolve(d)};o.push=function(n){k.push(n)};o.promise=function(n,t){l||(l=
hub.promise(n||0,t||this));return l};o.mix=function(){return j.mix.apply(j,arguments)};return o};var e=hub.does.define("emit","on","un","create","factory","peer","mix");e.prototype.resolve=function(){var j=this._.promise().does;return j.resolve.apply(j,arguments)};e.prototype.reject=function(){var j=this._.promise().does;return j.reject.apply(j,arguments)};hub.topicScope=function(j,k){k||(k=hub.scope());var l=j.lastIndexOf(".");l=l===-1?"":j.substring(0,l);var d=b[l];if(!d){d={on:c(l,hub.on),un:c(l,
hub.un),peer:c(l,hub.peer),emit:c(l,hub.emit),create:c(l,hub.create),factory:c(l,hub.factory)};b[l]=d}k.topic=j;k.on=d.on;k.un=d.un;k.peer=d.peer;k.emit=d.emit;k.create=d.create;k.factory=d.factory;k.does=new e(k);return k};var h=hub.reset;hub.reset=function(){b={};h()}})();
