/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};(function(){function r(q,j){function k(){if(l<q.length&&!k.stop){k.result=Hub.util.merge(k.result,q[l++].apply(null,j));return true}return false}var l=0;return k}var m;Hub.stopPropagation=function(){m.stop=true};Hub.propagate=function(){m()};Hub.util.chain=function(){function q(){k||(k=Array.prototype.slice.call(j));var l=m;m=r(k,arguments);try{for(;m(););return m.result}finally{m=l}}var j=arguments.length?Array.prototype.slice.call(arguments):[],k=null;q.add=function(l){j.unshift(l);k=null};q.remove=
function(l){for(var h=j.length;h--;)if(j[h]===l){j.splice(h,1);break}k=null};return q}})();(function(){function r(a,b,c){var d=a[b];d||(a[b]=d=Hub.util.chain());d.add(c)}function m(a){var b={};if(a=n[a]){for(var c=a.is?typeof a.is==="string"?[a.is]:a.is:o,d=0,g;g=c[d++];){var v=b;g=p[g]||m(topic);var t=void 0;for(t in g)r(v,t,g[t])}a=a.factory();for(var u in a)r(b,u,a[u])}return b}function q(a){return function(){var b=m(a);j(b,a);Hub.propagate();for(var c in b)Hub.unsubscribe(a+"/"+c,b[c])}}function j(a,b){for(var c in a)Hub.subscribe(b+"/"+c,a[c])}function k(a){return function(){s(Hub.util.substitute(a,
arguments),arguments)}}function l(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function h(a,b){l(a);var c=Hub.util.chain(),d,g;b&&c.add(b);if(a.indexOf("*")!==-1){d=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");d=RegExp("^"+d+"$");for(g in e)d.test(g)&&c.add(e[g]);i[a]=d}else for(g in i){d=i[g];d.test(a)&&
c.add(e[g])}a.indexOf("{")!==-1&&c.add(k(a));return e[a]=c}function s(a,b){var c=e[a]||h(a);try{return c.apply(null,b)}catch(d){if(a==="hub.error/publish")throw d;s("hub.error/publish",[new Hub.Error("error",'Error in callback for topic "{topic}": {error}',{topic:a,error:d.message})])}}function f(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var e={},i={},p={},n={},o=[];Hub.SINGLETON="SINGLETON";Hub.PROTOTYPE="PROTOTYPE";Hub.reset=function(){e={};i={};p={};for(var a in n)a.indexOf("lib.")===
-1&&delete n[a]};Hub.subscribe=function(a,b){f(b);var c=e[a];c?c.add(b):h(a,b);for(var d in i)i[d].test(a)&&e[d].add(b)};Hub.unsubscribe=function(a,b){f(b);if(!e[a]){l(a);return false}e[a].remove(b);for(var c in i)i[c].test(a)&&e[c].remove(b);return true};Hub.peer=function(a,b,c){if(n[a])throw Error("Hub - peer already defined: "+a);if(typeof b==="function"){c=b;b={}}b.factory=c;n[a]=b;if(!b.scope||b.scope===Hub.SINGLETON){b=p[a]=m(a);j(b,a)}else Hub.subscribe(a+"/**",q(a))};Hub.invoke=function(a){var b=
arguments.length>1?Array.prototype.slice.call(arguments,1):o;return s(a,b)};Hub.forward=function(a,b,c,d){if(typeof a==="object")for(var g in a){b=a[g];typeof b==="string"?Hub.subscribe(g,Hub.publisher(b)):Hub.subscribe(g,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,c,d))};Hub.publisher=function(a,b,c){if(b){if(c)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),c))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};
return function(d){return Hub.publish(a,Hub.util.merge(d,b))}}return function(d){return Hub.publish(a,d)}};Hub.Error=function(a,b,c){return{toString:function(){return Hub.util.substitute(b,this.context)},type:a,context:c||{}}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var c=Object.prototype.toString,d=c.call(b);c=c.call(a);if(c===d){if(d==="[object Object]"){for(var g in b)a[g]=arguments.callee(a[g],b[g]);return a}if(d==="[object Array]")return a.concat(b)}s("hub.error/util.merge",
[new Hub.Error("validation",c===d?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:c,sourceType:d})]);return a};Hub.util.resolve=function(a,b,c){var d=b.indexOf(".");if(d!==-1){var g=b.substring(0,d);if(g in a)return arguments.callee(a[g],b.substring(d+1),c);return c}return b in a?a[b]:c};Hub.util.substitute=function(a,b,c){if(c===undefined)c="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(d,g){return Hub.util.resolve(b,
g,c)}:function(){return c})}})();(function(){function r(f,e){try{f(e)}catch(i){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:i.message}))}}function m(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function q(f){return function(){f.reject({type:"timeout"})}}function j(f,e,i){var p,n,o=true,a;a={then:function(b,c){if(f){var d=o?b:c;d&&r(d,e)}else{b&&p.push(b);c&&n.push(c)}return this},publish:function(b){if(f){e=Hub.invoke.apply(Hub,
arguments);return this}var c=[b];if(arguments.length>1)c=c.concat(arguments);return this.then(function(){e=Hub.invoke.apply(Hub,c)})},publishValue:function(b){if(f){e=Hub.invoke(b,e);return this}return this.then(function(){e=Hub.invoke(b,e)})},fulfill:function(b){if(f)m();else{f=true;clearTimeout(i);for(e=Hub.util.merge(e,b);p.length;)r(p.shift(),e)}return this},reject:function(b){if(f)m();else{f=true;o=false;for(clearTimeout(i);n.length;)r(n.shift(),b)}return this},fulfilled:function(){return f}};
if(!f){p=[];n=[];i=setTimeout(q(a),i||6E4)}return a}function k(f,e){function i(){if(++a===2)(c?b.fulfill:b.reject)(o)}function p(d){if(c)o=Hub.util.merge(o,d);i()}function n(d){if(c){c=false;o=d}else o=Hub.util.merge(o,d);i()}var o,a=0,b=j(false),c=true;f.then(p,n);e.then(p,n);return b}function l(f){var e=j(true);f.then=e.then;f.publish=e.publish;f.publishValue=e.publishValue;return e}var h=true,s=function(){};s.prototype={then:function(f,e){return l(this).then(f,e)},publish:function(){return l(this).publish.apply(null,
arguments)},publishValue:function(){return l(this).publishValue.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var f=h;h=false;var e=Hub.invoke.apply(this,arguments);if(typeof e!=="undefined"){e=j(true,e);h=h?k(h,e):e}e=h;h=f;return e||new s};Hub.promise=function(f){f=j(false,undefined,f);if(h===true)return f;if(h===false)return h=f;h=k(h,f);return f}})();
