/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{},noop:function(){}};Hub.iterator=function(r){function n(){if(m>=p)throw Error("Iterator out of bounds.");var l=r[m++];n.hasNext=m<p;return l}var m=0,p=r.length;n.hasNext=m<p;n.remove=function(l){if(typeof l==="undefined")l=m;else l<m&&m--;r.splice(l,1);n.hasNext=m<--p};n.insert=function(l,o){if(typeof o==="undefined"){o=l;l=m}else l<m&&m++;r.splice(l,0,o);n.hasNext=m<++p};return n};(function(){function r(){var c=i.length;if(!c)return false;c=i[c-1];if(!c.hasNext){i.pop();return r()}k=Hub.util.merge(k,c().apply(null,o));return true}function n(){function c(){n.aborted=false;if(!i.length){l=false;o=arguments}k=undefined;try{f=Hub.iterator(d);for(i.push(f);r(););}finally{n.aborted=l;f=false}if(!i.length){var h=k;o=k=undefined;return h}}var d=arguments.length?Array.prototype.slice.call(arguments):[],f=false;c.add=function(h){f?f.insert(0,h):d.unshift(h);return c};c.insert=function(h,
a){f?f.insert(h,a):d.splice(h,0,a);return c};c.remove=function(h){if(typeof h==="number"){f?f.remove(h):d.splice(h,1);return h}for(var a=d.length;a--;)if(d[a]===h){f?f.remove(a):d.splice(a,1);return a}return-1};c.get=function(h){return d[h]};return c}function m(c,d){var f=c.indexOf("*"),h=d.indexOf("*");if(f===-1)return h===-1?0:1;if(h===-1)return-1;var a=c.indexOf("/"),b=d.indexOf("/");if(f<a){if(h>b)return-1}else if(h<b)return 1;return 0}function p(c){if(!c)throw Error("comparator is "+c);var d=
n(),f=d.remove,h=[];d.add=function(a,b){if(typeof b==="undefined")throw Error("Expected 2 arguments");for(var e=0,g=h.length;e<g;e++)if(c(b,h[e])<=0){h.splice(e,0,b);d.insert(e,a);return d}d.insert(h.length,a);h.push(b);return d};d.remove=function(a){a=f(a);a!==-1&&a<h.length&&h.splice(a,1);return a};return d}var l=false,o,k,i=[];Hub.stopPropagation=function(){l=true;i.length=0};Hub.propagate=function(){r()};Hub.util.chain=n;Hub.util.topicChain=function(){return p(m)};Hub.util.sortedChain=p})();(function(){function r(i,c,d){var f=i[c];f||(i[c]=f=Hub.util.chain());f.add(d)}function n(i,c){return function(){var d=Hub.subscriberChain(i),f=d.apply(null,arguments);if(d.aborted)return f;return Hub.util.merge(f,c.apply(null,arguments))}}function m(i){var c=l[i];if(c)return c;c=o[i];if(!c)throw Error("Peer is not defined: "+i);c=p(c);var d={},f;for(f in c){var h=c[f];if(typeof h==="function")d[f]=n(i+"/"+f,h)}c.api=d;return c}function p(i){for(var c={},d=i.is,f=0,h;h=d[f++];){var a=c;h=m(h);var b=
void 0;for(b in h)r(a,b,h[b])}i=i.instance||i.factory();for(var e in i)r(c,e,i[e]);return c}var l={},o={},k=[];Hub.peer=function(i,c,d){if(o[i])throw Error("Hub - peer already defined: "+i);if(!d){d=c;c=null}c={is:c?typeof c==="string"?[c]:c:k};if(typeof d==="function")c.factory=d;else{c.instance=d;d=l[i]=p(c);var f=d.api={},h;for(h in d){var a=d[h];if(typeof a==="function"){var b=i+"/"+h;Hub.subscribe(b,a);f[h]=Hub.publisher(b)}}}o[i]=c};Hub.get=function(i){return m(i).api};Hub.resetPeers=function(){l=
{};for(var i in o)i.indexOf("lib.")===-1&&delete o[i]}})();(function(){function r(a){return function(){i(Hub.util.substitute(a,arguments),arguments)}}function n(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function m(a){var b=f[a];if(!b){b=f;var e=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");b=b[a]={re:RegExp("^"+e+"$"),chain:Hub.util.chain()};l(d,b.chain,
b.re,null)}return b}function p(a,b,e,g){for(var j in a){var q=a[j];if((e||q.re).test(g))q.chain.add(b,g)}}function l(a,b,e,g){for(var j in a){var q=a[j];if((e||q.re).test(g||j))(b||q.chain).add(q.chain,j)}}function o(a,b){d[a]={chain:b};return b}function k(a){n(a);var b=o(a,Hub.util.topicChain());l(f,b,null,a);return b}function i(a,b){var e=Hub.subscriberChain(a);try{return e.apply(null,b)}catch(g){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:g.message});
}}function c(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var d={},f={},h=[];Hub.reset=function(){d={};f={};Hub.resetPeers()};Hub.subscribe=function(a,b){c(b);var e=a.indexOf("*")!==-1,g;if(g=d[a])g=g.chain;else{if(e){g=m(a);g.chain.add(b);p(d,b,g.re,a);return}g=k(a)}e||p(f,b,null,a);g.add(b,a)};Hub.unsubscribe=function(a,b){c(b);var e=d[a];if(!e){n(a);return false}e.chain.remove(b);for(var g in f){e=f[g];e.re.test(a)&&e.chain.remove(b)}return true};Hub.subscriberChain=
function(a){var b=d[a];if(b)return b.chain;if(a.indexOf("{")!==-1)return o(a,r(a));if(a.indexOf("*")===-1)return k(a);return m(a).chain};Hub.invoke=function(a){var b=arguments.length>1?Array.prototype.slice.call(arguments,1):h;return i(a,b)};Hub.forward=function(a,b,e,g){if(typeof a==="object")for(var j in a){b=a[j];typeof b==="string"?Hub.subscribe(j,Hub.publisher(b)):Hub.subscribe(j,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,e,g))};Hub.publisher=function(a,b,e){if(typeof a===
"string"){if(b){if(e)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),e))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(s){return Hub.publish(a,Hub.util.merge(s,b))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,[a].concat(Array.prototype.slice.call(arguments)));return Hub.publish(a)}}var g=Hub.util.chain(),j;for(j in a){var q=a[j];g[j]=typeof q==="string"?Hub.publisher(q):Hub.publisher.apply(Hub,
q);g.add(g[j])}return g};Hub.Error=function(a,b,e){this.type=a;this.context=e;this.toString=function(){return Hub.util.substitute(b,e)}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var e=Object.prototype.toString,g=e.call(b);e=e.call(a);if(e===g){if(g==="[object Object]"){for(var j in b)a[j]=arguments.callee(a[j],b[j]);return a}if(g==="[object Array]")return a.concat(b)}throw new Hub.Error("validation",e===g?"Cannot merge value {target} with {source}":
"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:e,sourceType:g});};Hub.util.resolve=function(a,b,e){var g=b.indexOf(".");if(g!==-1){var j=b.substring(0,g);if(j in a)return arguments.callee(a[j],b.substring(g+1),e);return e}return b in a?a[b]:e};Hub.util.substitute=function(a,b,e){if(e===undefined)e="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(g,j){return Hub.util.resolve(b,j,e)}:function(){return e})}})();(function(){function r(c,d){try{c(d)}catch(f){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:f.message}))}}function n(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function m(c){return function(){c.reject({type:"timeout"})}}function p(c,d,f){var h,a,b=!(d instanceof Hub.Error),e;e={then:function(g,j){if(c){var q=b?g:j;q&&r(q,d)}else{g&&h.push(g);j&&a.push(j)}return this},publish:function(g){if(c){d=
Hub.invoke.apply(Hub,arguments);return this}var j=[g];if(arguments.length>1)j=j.concat(arguments);return this.then(function(){d=Hub.invoke.apply(Hub,j)})},publishResult:function(g){if(c){d=Hub.invoke(g,d);return this}return this.then(function(){d=Hub.invoke(g,d)})},fulfill:function(g){if(c)n();else{c=true;clearTimeout(f);for(d=Hub.util.merge(d,g);h.length;)r(h.shift(),d)}return this},reject:function(g){if(c)n();else{c=true;b=false;for(clearTimeout(f);a.length;)r(a.shift(),g)}return this},fulfilled:function(){return c}};
if(!c){h=[];a=[];f=setTimeout(m(e),f||6E4)}return e}function l(c,d){function f(){if(++e===2)(j?g.fulfill:g.reject)(b)}function h(q){if(j)b=Hub.util.merge(b,q);f()}function a(q){if(j){j=false;b=q}else b=Hub.util.merge(b,q);f()}var b,e=0,g=p(false),j=true;c.then(h,a);d.then(h,a);return g}function o(c){var d=p(true);c.then=d.then;c.publish=d.publish;c.publishResult=d.publishResult;return d}var k=true,i=function(){};i.prototype={then:function(c,d){return o(this).then(c,d)},publish:function(){return o(this).publish.apply(null,
arguments)},publishResult:function(){return o(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},reject:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var c=k;k=false;var d;try{d=Hub.invoke.apply(this,arguments)}catch(f){if(k&&f instanceof Hub.Error){k.reject(f);return k}throw f;}if(typeof d!=="undefined"){d=p(true,d);k=k?l(k,d):d}d=k;k=c;return d||new i};Hub.promise=
function(c){c=p(false,undefined,c);if(k===true)return c;if(k===false)return k=c;k=l(k,c);return c}})();
