/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{},noop:function(){}};Hub.iterator=function(r){function m(){if(l>=n)throw Error("Iterator out of bounds.");var k=r[l++];m.hasNext=l<n;return k}var l=0,n=r.length;m.hasNext=l<n;m.remove=function(k){if(typeof k==="undefined")k=l;else k<l&&l--;r.splice(k,1);m.hasNext=l<--n};m.insert=function(k,p){if(typeof p==="undefined"){p=k;k=l}else k<l&&l++;r.splice(k,0,p);m.hasNext=l<++n};return m};(function(){function r(){var e=p.length;if(!e)return false;e=p[e-1];if(!e.hasNext){p.pop();return r()}k=Hub.util.merge(k,e().apply(null,n));return true}function m(){function e(){m.aborted=false;if(!p.length){l=false;n=arguments}k=undefined;try{d=Hub.iterator(h);for(p.push(d);r(););}finally{m.aborted=l;d=false}if(!p.length){var c=k;n=k=undefined;return c}}var h=arguments.length?Array.prototype.slice.call(arguments):[],d=false;e.add=function(c){d?d.insert(0,c):h.unshift(c);return e};e.insert=function(c,
g){d?d.insert(c,g):h.splice(c,0,g);return e};e.remove=function(c){if(typeof c==="number"){d?d.remove(c):h.splice(c,1);return c}for(var g=h.length;g--;)if(h[g]===c){d?d.remove(g):h.splice(g,1);return g}return-1};e.get=function(c){return h[c]};return e}var l=false,n,k,p=[];Hub.stopPropagation=function(){l=true;p.length=0};Hub.propagate=function(){r()};Hub.chain=m;Hub.sortedChain=function(e){if(!e)throw Error("comparator is "+e);var h=m(),d=h.remove,c=[];h.add=function(g,q){if(typeof q==="undefined")throw Error("Expected 2 arguments");
for(var a=0,b=c.length;a<b;a++)if(e(q,c[a])<=0){c.splice(a,0,q);h.insert(a,g);return h}h.insert(c.length,g);c.push(q);return h};h.remove=function(g){g=d(g);g!==-1&&g<c.length&&c.splice(g,1);return g};return h}})();(function(){function r(e,h){return function(){var d=Hub.subscriberChain(e),c=d.apply(null,arguments);if(d.aborted)return c;return Hub.util.merge(c,h.apply(null,arguments))}}function m(e){var h=n[e];if(h)return h;h=k[e];if(!h)throw Error("Peer is not defined: "+e);h=l(h);var d={},c;for(c in h){var g=h[c];if(typeof g==="function")d[c]=r(e+"/"+c,g)}h.api=d;return h}function l(e){for(var h={},d=e.is,c=0,g;g=d[c++];){var q=h;g=m(g);var a=void 0;for(a in g){var b=g[a],i=q[a];i||(q[a]=i=Hub.chain());i.add(b)}}e=
e.instance||e.factory();for(var f in e){d=e[f];(c=h[f])||(h[f]=c=Hub.chain());c.add(d)}return h}var n={},k={},p=[];Hub.peer=function(e,h,d){if(k[e])throw Error("Hub - peer already defined: "+e);if(!d){d=h;h=null}h={is:h?typeof h==="string"?[h]:h:p};if(typeof d==="function")h.factory=d;else{h.instance=d;d=n[e]=l(h);var c=d.api={},g;for(g in d){var q=d[g];if(typeof q==="function"){var a=e+"/"+g;Hub.subscribe(a,q);c[g]=Hub.publisher(a)}}}k[e]=h};Hub.get=function(e){return m(e).api};Hub.resetPeers=function(){n=
{};for(var e in k)e.indexOf("lib.")===-1&&delete k[e]}})();(function(){function r(a){return function(){h(Hub.util.substitute(a,arguments),arguments)}}function m(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function l(a){var b=g[a];if(!b){b=g;var i=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");b=b[a]={re:RegExp("^"+i+"$"),chain:Hub.chain()};k(c,b.chain,b.re,
null)}return b}function n(a,b,i,f){for(var j in a){var o=a[j];if((i||o.re).test(f))o.chain.add(b,f)}}function k(a,b,i,f){for(var j in a){var o=a[j];if((i||o.re).test(f||j))(b||o.chain).add(o.chain,j)}}function p(a,b){c[a]={chain:b};return b}function e(a){m(a);var b=Hub.sortedChain(Hub.config.topicComparator);p(a,b);k(g,b,null,a);return b}function h(a,b){var i=Hub.subscriberChain(a);try{return i.apply(null,b)}catch(f){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,
error:f.message});}}function d(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var c={},g={},q=[];Hub.config={topicComparator:function(a,b){var i=a.indexOf("*"),f=b.indexOf("*");if(i===-1)return f===-1?0:1;if(f===-1)return-1;var j=a.indexOf("/"),o=b.indexOf("/");if(i<j){if(f>o)return-1}else if(f<o)return 1;return 0}};Hub.reset=function(){c={};g={};Hub.resetPeers()};Hub.subscribe=function(a,b){d(b);var i=a.indexOf("*")!==-1,f;if(f=c[a])f=f.chain;else{if(i){f=l(a);f.chain.add(b);
n(c,b,f.re,a);return}f=e(a)}i||n(g,b,null,a);f.add(b,a)};Hub.unsubscribe=function(a,b){d(b);var i=c[a];if(!i){m(a);return false}i.chain.remove(b);for(var f in g){i=g[f];i.re.test(a)&&i.chain.remove(b)}return true};Hub.subscriberChain=function(a){var b=c[a];if(b)return b.chain;if(a.indexOf("{")!==-1)return p(a,r(a));if(a.indexOf("*")===-1)return e(a);return l(a).chain};Hub.invoke=function(a){var b=arguments.length>1?Array.prototype.slice.call(arguments,1):q;return h(a,b)};Hub.forward=function(a,b,
i,f){if(typeof a==="object")for(var j in a){b=a[j];typeof b==="string"?Hub.subscribe(j,Hub.publisher(b)):Hub.subscribe(j,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,i,f))};Hub.publisher=function(a,b,i){if(typeof a==="string"){if(b){if(i)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),i))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(s){return Hub.publish(a,Hub.util.merge(s,b))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,
[a].concat(Array.prototype.slice.call(arguments)));return Hub.publish(a)}}var f=Hub.chain(),j;for(j in a){var o=a[j];f[j]=typeof o==="string"?Hub.publisher(o):Hub.publisher.apply(Hub,o);f.add(f[j])}return f};Hub.Error=function(a,b,i){this.type=a;this.context=i;this.toString=function(){return Hub.util.substitute(b,i)}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var i=Object.prototype.toString,f=i.call(b);i=i.call(a);if(i===f){if(f===
"[object Object]"){for(var j in b)a[j]=arguments.callee(a[j],b[j]);return a}if(f==="[object Array]")return a.concat(b)}throw new Hub.Error("validation",i===f?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:i,sourceType:f});};Hub.util.resolve=function(a,b,i){var f=b.indexOf(".");if(f!==-1){var j=b.substring(0,f);if(j in a)return arguments.callee(a[j],b.substring(f+1),i);return i}return b in a?a[b]:i};Hub.util.substitute=function(a,
b,i){if(i===undefined)i="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(f,j){return Hub.util.resolve(b,j,i)}:function(){return i})}})();(function(){function r(d,c){try{d(c)}catch(g){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:g.message}))}}function m(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function l(d){return function(){d.reject({type:"timeout"})}}function n(d,c,g){var q,a,b=!(c instanceof Hub.Error),i;i={then:function(f,j){if(d){var o=b?f:j;o&&r(o,c)}else{f&&q.push(f);j&&a.push(j)}return this},publish:function(f){if(d){c=
Hub.invoke.apply(Hub,arguments);return this}var j=[f];if(arguments.length>1)j=j.concat(arguments);return this.then(function(){c=Hub.invoke.apply(Hub,j)})},publishResult:function(f){if(d){c=Hub.invoke(f,c);return this}return this.then(function(){c=Hub.invoke(f,c)})},fulfill:function(f){if(d)m();else{d=true;clearTimeout(g);for(c=Hub.util.merge(c,f);q.length;)r(q.shift(),c)}return this},reject:function(f){if(d)m();else{d=true;b=false;for(clearTimeout(g);a.length;)r(a.shift(),f)}return this},fulfilled:function(){return d}};
if(!d){q=[];a=[];g=setTimeout(l(i),g||6E4)}return i}function k(d,c){function g(){if(++i===2)(j?f.fulfill:f.reject)(b)}function q(o){if(j)b=Hub.util.merge(b,o);g()}function a(o){if(j){j=false;b=o}else b=Hub.util.merge(b,o);g()}var b,i=0,f=n(false),j=true;d.then(q,a);c.then(q,a);return f}function p(d){var c=n(true);d.then=c.then;d.publish=c.publish;d.publishResult=c.publishResult;return c}var e=true,h=function(){};h.prototype={then:function(d,c){return p(this).then(d,c)},publish:function(){return p(this).publish.apply(null,
arguments)},publishResult:function(){return p(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},reject:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var d=e;e=false;var c;try{c=Hub.invoke.apply(this,arguments)}catch(g){if(e&&g instanceof Hub.Error){e.reject(g);return e}throw g;}if(typeof c!=="undefined"){c=n(true,c);e=e?k(e,c):c}c=e;e=d;return c||new h};Hub.promise=
function(d){d=n(false,undefined,d);if(e===true)return d;if(e===false)return e=d;e=k(e,d);return d}})();
