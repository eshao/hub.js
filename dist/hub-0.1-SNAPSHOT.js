/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};Hub.util.merge=function(f,c){if(f===undefined||f===null||f===c)return c;if(c===undefined||c===null)return f;var h=Object.prototype.toString,j=h.call(c);h=h.call(f);if(h===j){if(j==="[object Object]"){for(var g in c)f[g]=arguments.callee(f[g],c[g]);return f}if(j==="[object Array]")return f.concat(c)}throw new Hub.Error("validation",h===j?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:f,source:c,targetType:h,sourceType:j});};Hub.util.resolve=function(f,c,h){var j=c.indexOf(".");if(j!==-1){var g=c.substring(0,j);if(g in f)return arguments.callee(f[g],c.substring(j+1),h);return h}return c in f?f[c]:h};Hub.util.substitute=function(f,c,h){if(h===undefined)h="";return f.replace(/\{([a-zA-Z0-9\.]+)\}/g,c?function(j,g){return Hub.util.resolve(c,g,h)}:function(){return h})};Hub.Error=function(f,c,h){this.type=f;this.context=h;this.toString=function(){return Hub.util.substitute(c,h)}};Hub.iterator=function(f){function c(){if(h>=j)throw Error("Iterator out of bounds.");var g=f[h++];c.hasNext=h<j;return g}var h=0,j=f.length;c.hasNext=h<j;c.remove=function(g){var i=typeof g;if(i==="undefined")g=h;else if(i==="number")g<h&&h--;else{for(i=f.length-1;i>=0;i--)if(f[i]===g){g=i;break}if(i<0)return false}if(g>=j)return false;f.splice(g,1);c.hasNext=h<--j;return true};c.insert=function(g,i){if(typeof i==="undefined"){i=g;g=h}else g<h&&h++;f.splice(g,0,i);c.hasNext=h<++j};c.reset=function(){h=
0;c.hasNext=h<j};return c};(function(){function f(){var i=g.length;if(!i)return false;i=g[i-1];if(!i.hasNext){g.pop();return f()}j=Hub.util.merge(j,i().apply(null,h));return true}var c=false,h,j,g=[];Hub.stopPropagation=function(){c=true;g.length=0};Hub.propagate=function(){f()};Hub.topicComparator=function(i,a){var e=i.indexOf("*"),b=a.indexOf("*");if(e===-1)return b===-1?0:1;if(b===-1)return-1;var d=i.indexOf("/"),l=a.indexOf("/");if(e<d){if(b>l)return-1}else if(b<l)return 1;return 0};Hub.chain=function(){function i(){i.aborted=
false;var e=!g.length;if(e){c=false;h=arguments}j=undefined;try{for(g.push(a);f(););}finally{i.aborted=c;a.reset();if(e)g.length=0}if(!g.length){e=j;h=j=undefined;return e}}var a=Hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);i.add=function(e){a.insert(0,e)};i.insert=a.insert;i.remove=a.remove;return i}})();(function(){function f(a,e){return function(){var b=Array.prototype.slice.call(arguments);b=Hub.publish.apply(Hub,[a].concat(b));Hub.aborted()||(b=Hub.util.merge(b,e.apply(null,arguments)));return b}}function c(a){var e=j[a];if(e)return e;e=g[a];if(!e)throw Error("Peer is not defined: "+a);e=h(e);var b={},d;for(d in e){var l=e[d];if(typeof l==="function")b[d]=f(a+"/"+d,l)}e.api=b;return e}function h(a){for(var e={},b=a.is,d=0,l;l=b[d++];){var m=e;l=c(l);var n=void 0;for(n in l){var o=l[n],p=m[n];
p||(m[n]=p=Hub.chain());p.add(o)}}a=a.instance||a.factory();for(var k in a){b=a[k];(d=e[k])||(e[k]=d=Hub.chain());d.add(b)}return e}var j={},g={},i=[];Hub.peer=function(a,e,b){if(g[a])throw Error("Hub - peer already defined: "+a);if(!b){b=e;e=null}e={is:e?typeof e==="string"?[e]:e:i};if(typeof b==="function")e.factory=b;else{e.instance=b;b=j[a]=h(e);var d=b.api={},l;for(l in b){var m=b[l];if(typeof m==="function"){var n=a+"/"+l;Hub.subscribe(n,m);d[l]=Hub.publisher(n)}}}g[a]=e};Hub.get=function(a){return c(a).api};
Hub.resetPeers=function(){j={};for(var a in g)a.indexOf("lib.")===-1&&delete g[a]}})();(function(){function f(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+a+"$")}function c(a){a||(a=g);var e=f(a),b=Hub.chain(),d=[],l=function(m,n,o){m||(m=a);if(m!==g&&!e.test(m)){if(m.indexOf("*")===-1||!f(m).test(a))return;m=g}var p=b.apply(null,n);if(b.aborted){l.aborted=true;return p}if(o)for(var k=0,q=d.length;k<q;k++)o.push(d[k]);else o=d.slice();for(;o.length;){k=o.shift();p=Hub.util.merge(p,k(m,n,
o));if(k.aborted){l.aborted=true;break}}return p};l.matches=function(m){return e.test(m)};l.getTopic=function(){return a};l.add=function(m,n,o){if(a===n)b.add(m);else{for(var p,k=0,q=d.length;k<q;k++){var r=d[k];if(r.matches(n)){r.add(m,n,o);return}o||(o=f(n));if(o.test(r.getTopic())){p=c(n);p.addChild(r);p.add(m,n,o);d[k]=p;return}}p=c(n);p.add(m,n);if(n.indexOf("*")===-1)d.unshift(p);else{k=0;for(q=d.length;k<q;k++){m=d[k].getTopic();if(Hub.topicComparator(m,n)!==-1){d.splice(k,0,p);return}}d.push(p)}}};
l.addChild=function(m){d.unshift(m)};l.remove=function(m,n){if(a===n)return b.remove(m);for(var o=0,p=d.length;o<p;o++){var k=d[o];if(k.matches(n))if(k.remove(m,n))return true}return false};return l}function h(a){var e=typeof a;if(e!=="string")throw Error("Topic is not string: "+e);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function j(a){a=typeof a;if(a!=="function")throw Error("Callback is "+a);}var g="**/**",
i=c();Hub.reset=function(){i=c();Hub.resetPeers()};Hub.subscribe=function(a,e){j(e);h(a);i.add(e,a)};Hub.unsubscribe=function(a,e){j(e);h(a);return i.remove(e,a)};Hub.invoke=function(a){h(a);var e=Array.prototype.slice.call(arguments,1);if(a.indexOf("{")!==-1)a=Hub.util.substitute(a,e);try{return i(a,e)}catch(b){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:b.message});}};Hub.aborted=function(){return Boolean(i.aborted)};Hub.topicChain=c})();(function(){function f(b,d){try{b(d)}catch(l){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:l.message}))}}function c(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function h(b){return function(){b.reject({type:"timeout"})}}function j(b,d,l){var m,n,o=!(d instanceof Hub.Error),p;p={then:function(k,q){if(b){var r=o?k:q;r&&f(r,d)}else{k&&m.push(k);q&&n.push(q)}return this},publish:function(k){if(b){d=
Hub.invoke.apply(Hub,arguments);return this}var q=[k];if(arguments.length>1)q=q.concat(arguments);return this.then(function(){d=Hub.invoke.apply(Hub,q)})},publishResult:function(k){if(b){d=Hub.invoke(k,d);return this}return this.then(function(){d=Hub.invoke(k,d)})},fulfill:function(k){if(b)c();else{b=true;clearTimeout(l);for(d=Hub.util.merge(d,k);m.length;)f(m.shift(),d)}return this},reject:function(k){if(b)c();else{b=true;o=false;for(clearTimeout(l);n.length;)f(n.shift(),k)}return this},fulfilled:function(){return b}};
if(!b){m=[];n=[];l=setTimeout(h(p),l||6E4)}return p}function g(b,d){function l(){if(++p===2)(q?k.fulfill:k.reject)(o)}function m(r){if(q)o=Hub.util.merge(o,r);l()}function n(r){if(q){q=false;o=r}else o=Hub.util.merge(o,r);l()}var o,p=0,k=j(false),q=true;b.then(m,n);d.then(m,n);return k}function i(b){var d=j(true);b.then=d.then;b.publish=d.publish;b.publishResult=d.publishResult;return d}var a=true,e=function(){};e.prototype={then:function(b,d){return i(this).then(b,d)},publish:function(){return i(this).publish.apply(null,
arguments)},publishResult:function(){return i(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},reject:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var b=a;a=false;var d;try{d=Hub.invoke.apply(this,arguments)}catch(l){if(a&&l instanceof Hub.Error){a.reject(l);return a}throw l;}if(typeof d!=="undefined"){d=j(true,d);a=a?g(a,d):d}d=a;a=b;return d||new e};Hub.promise=
function(b){b=j(false,undefined,b);if(a===false)a=b;else if(a!==true)a=g(a,b);return b}})();Hub.publisher=function(f,c,h){if(typeof f==="string"){if(c){if(h)return function(){return Hub.publish(f,Hub.util.merge(c.apply(null,arguments),h))};if(typeof c==="function")return function(){return Hub.publish(f,c.apply(null,arguments))};return function(a){return Hub.publish(f,Hub.util.merge(a,c))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,[f].concat(Array.prototype.slice.call(arguments)));return Hub.publish(f)}}var j=Hub.chain(),g;for(g in f){var i=f[g];j[g]=typeof i==="string"?
Hub.publisher(i):Hub.publisher.apply(Hub,i);j.add(j[g])}return j};Hub.forward=function(f,c,h,j){if(typeof f==="object")for(var g in f){c=f[g];typeof c==="string"?Hub.subscribe(g,Hub.publisher(c)):Hub.subscribe(g,Hub.publisher(c[0],c[1],c[2]))}else Hub.subscribe(f,Hub.publisher(c,h,j))};
