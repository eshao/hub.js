/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(e,d){if(e===undefined||e===null||e===d)return d;if(d===undefined||d===null)return e;var c=Object.prototype.toString,g=c.call(d);c=c.call(e);var b;if(c===g){if(g==="[object Object]"){for(b in d)if(d.hasOwnProperty(b))e[b]=hub.merge(e[b],d[b]);return e}if(g==="[object Array]")return e.concat(d)}throw new hub.Error("validation",c===g?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:e,source:d,targetType:c,sourceType:g});};
hub.resolve=function(e,d,c){for(var g=d.indexOf(".");g!==-1;){var b=d.substring(0,g);if(!e.hasOwnProperty(b))return c;e=e[b];d=d.substring(g+1);g=d.indexOf(".")}return e.hasOwnProperty(d)?e[d]:c};hub.substitute=function(e,d,c){if(c===undefined)c="";return e.replace(/\{([a-zA-Z0-9\.]+)\}/g,d?function(g,b){return hub.resolve(d,b,c)}:function(){return c})};hub.Error=function(e,d,c){this.type=e;this.context=c;this.toString=function(){return hub.substitute(d,c)}};
hub.iterator=function(e){function d(){if(c>=g)throw Error("Iterator out of bounds.");var b=e[c++];d.hasNext=c<g;return b}var c=0,g=e.length;d.hasNext=c<g;d.remove=function(b){var a=typeof b;if(a==="undefined")b=c;else if(a==="number")b<c&&c--;else{for(a=e.length-1;a>=0;a--)if(e[a]===b){b=a;break}if(a<0)return false}if(b>=g)return false;e.splice(b,1);d.hasNext=c<--g;return true};d.insert=function(b,a){if(typeof a==="undefined"){a=b;b=c}else b<c&&c++;e.splice(b,0,a);d.hasNext=c<++g};d.reset=function(){c=
0;d.hasNext=c<g};return d};
(function(){function e(h){var k=[],n=false,o;return{stopPropagation:function(){n=true;k.length=0;if(arguments.length)o=arguments[0]},propagate:function(){if(arguments.length)o=arguments[0];var q=k.length;if(!q)return false;q=k[q-1];if(!q.hasNext){k.pop();return this.propagate()}q=q().apply(this,h);o=hub.merge(o,q);return true},aborted:function(){return n},result:function(){return o},push:function(q){k.push(q)}}}function d(){function h(){var n=this.propagate?this:e(arguments);n.push(k);try{for(;;)if(!n.propagate())break}finally{k.reset()}return n.result()}
var k=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);h.add=function(n){var o=typeof n;if(o!=="function")throw new TypeError("Callback is "+o);k.insert(0,n)};h.insert=k.insert;h.remove=k.remove;return h}function c(h){h=h.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+h+"$")}function g(h){var k=typeof h;if(k!=="string")throw Error("Topic is "+k);if(!h)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(h))throw Error("Illegal topic: "+
h);}function b(h,k){var n=h.indexOf("*"),o=k.indexOf("*");if(n===-1)return o===-1?0:1;if(o===-1)return-1;var q=h.indexOf("."),r=k.indexOf(".");if(n<q){if(o>r)return-1}else if(o<r)return 1;return 0}function a(h,k){function n(f){f||(f=h);if(f!==j&&!o.test(f)){if(f.indexOf("*")===-1||!c(f).test(h))return;f=j}var i=this.propagate?this:e(Array.prototype.slice.call(arguments,1));q.call(i);if(i.aborted())return i.result();var l=i.topicChainQueue;if(l)Array.prototype.push.apply(l,r);else l=i.topicChainQueue=
r.slice();for(;l.length;){l.shift().call(i,f);if(i.aborted())break}return i.result()}if(h)g(h);else h=j;var o=c(h),q=d(),r=k?[k]:[];n.matches=function(f){return o.test(f)};n.getTopic=function(){return h};n.add=function(f,i,l){if(h===f)q.add(i);else{var m,p,u;p=0;for(u=r.length;p<u;p++){m=r[p];if(m.matches(f)){m.add(f,i,l);return}l||(l=c(f));if(l.test(m.getTopic())){m=a(f,m);m.add(f,i,l);r[p]=m;return}}m=a(f);m.add(f,i);if(f.indexOf("*")===-1)r.unshift(m);else{p=0;for(u=r.length;p<u;p++){i=r[p].getTopic();
if(b(i,f)!==-1){r.splice(p,0,m);return}}r.push(m)}}};n.remove=function(f,i){if(h===f)return q.remove(i);var l,m,p;l=0;for(m=r.length;l<m;l++){p=r[l];if(p.matches(f))if(p.remove(f,i))return true}g(f);l=typeof i;if(l!=="function")throw new TypeError("Callback is "+l);return false};return n}var j="**";hub.scope=e;hub.chain=d;hub.topicChain=a;hub.topicComparator=b;hub.validateTopic=g})();
(function(){hub.mix=function(e,d){for(var c in d)if(d.hasOwnProperty(c)&&typeof d[c]==="function"){var g=e,b=c,a=d[c],j=g[b];if(j)if(j.add)j.add(a);else g[b]=hub.chain(a,g[b]);else g[b]=a}return e}})();
(function(){hub.create=function(e,d,c){if(typeof e!=="string"){c=d;d=e;e=null}if(typeof d!=="function")throw new TypeError;var g={},b={mix:function(){hub.publish.apply(hub,arguments).then(function(a){hub.mix(g,a)})},subscribe:function(a,j){if(!e)throw new TypeError("namespace is "+e);if(!a)throw new TypeError("messsage is "+a);hub.subscribe(e+"."+a,j)}};d=c?d.apply(b,c):d.call(b);return hub.mix(g,d)}})();
(function(){function e(b,a){for(var j in a)a.hasOwnProperty(j)&&hub.root.add(b+j,a[j])}function d(b){return function(){return b}}function c(b,a){var j=hub[a];b+=".";return function(){var h=Array.prototype.slice.call(arguments);h[0]=b+h[0];return j.apply(this,h)}}hub.root=hub.topicChain();var g={};hub.reset=function(){g={};hub.root=hub.topicChain();hub.resetPromise()};hub.subscribe=hub.on=function(b,a){if(Object.prototype.toString.call(b)==="[object Object]")e("",b);else{if(Object.prototype.toString.call(a)===
"[object Object]"){e(b+".",a);a=d(a)}hub.root.add(b,a)}};hub.unsubscribe=hub.un=function(b,a){return hub.root.remove(b,a)};hub.invoke=function(b){hub.validateTopic(b);var a=Array.prototype.slice.call(arguments),j=a.slice(1);if(b.indexOf("{")!==-1)a[0]=hub.substitute(b,j);j=hub.scope(j);var h=a[0],k=g[h];if(!k){k={on:c(h,"on"),un:c(h,"un"),peer:c(h,"peer"),publish:c(h,"publish")};k.subscribe=k.on;k.unsubscribe=k.un;g[h]=k}for(var n in k)if(k.hasOwnProperty(n))j[n]=k[n];try{return hub.root.apply(j,
a)}catch(o){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a[0],error:o.message});}};hub.peer=function(b,a,j){if(typeof b==="function"){if(a=hub.create(b,a))hub.on(a)}else if(typeof a==="function"){if(a=hub.create(b,a,j))hub.on(b,a)}else hub.on(b,a)}})();
(function(){function e(f,i,l){var m;try{m=f.apply(null,i)}catch(p){hub.invoke("hub.error.promise.callback",new hub.Error("error","Error in promise callback: ${error}",{error:p.message}));return}if(l){if(m===undefined)return i;return[m]}}function d(){hub.invoke("hub.error.promise.resolved",new hub.Error("validation","Promise already resolved"))}function c(f){return function(){f.reject({type:"timeout"})}}function g(f,i,l){var m,p,u=!(i instanceof hub.Error),s=i===undefined?[]:[i],w;w={then:function(t,
v){if(f){var x=u?t:v;if(x)s=e(x,s,true)}else{t&&m.push(t);v&&p.push(v)}return this},publish:function(){if(f){s=[hub.invoke.apply(hub,arguments)];return this}var t=n.call(arguments);return this.then(function(){s=[hub.invoke.apply(hub,t)]})},publishResult:function(t){if(f){s=[hub.invoke.apply(hub,[t].concat(s))];return this}return this.then(function(){s=[hub.invoke.apply(hub,[t].concat(s))]})},resolve:function(){if(f)d();else{f=true;clearTimeout(l);if(arguments.length!==0)s=n.call(arguments);for(;m.length;)e(m.shift(),
s)}return this},reject:function(t){if(f)d();else{f=true;u=false;for(clearTimeout(l);p.length;){var v=p.shift();e(v,[t])}}return this},resolved:function(){return f},join:function(t){return o(w,t)}};if(!f){m=[];p=[];l=setTimeout(c(w),l||6E4)}return w}function b(f){var i=g(true);f.then=i.then;f.publish=i.publish;f.publishResult=i.publishResult;return i}var a=true,j=Array.prototype,h=j.unshift,k=j.push,n=j.slice,o;o=function(f,i){function l(){if(++p===2)(s?u.resolve:u.reject).apply(null,m)}var m=[],p=
0,u=g(false),s=true;f.then(function(){h.apply(m,arguments);l()},function(){h.apply(m,arguments);s=false;l()});i.then(function(){k.apply(m,arguments);l()},function(){k.apply(m,arguments);s=false;l()});return u};var q=Error("hub - promise already resolved"),r=function(){};r.prototype={then:function(f,i){return b(this).then(f,i)},publish:function(){return b(this).publish.apply(null,arguments)},publishResult:function(){return b(this).publishResult.apply(null,arguments)},resolve:function(){throw q;},reject:function(){throw q;
},resolved:function(){return true},join:function(f){return b(this).join(f)}};hub.publish=function(){var f=a;a=false;var i;try{i=hub.invoke.apply(this,arguments)}catch(l){if(a&&l instanceof hub.Error){a.reject(l);return a}throw l;}if(typeof i!=="undefined"){i=g(true,i);a=a?o(a,i):i}i=a;a=f;return i||new r};hub.promise=function(f){f=g(false,undefined,f);if(a===false)a=f;else if(a!==true)a=o(a,f);return f};hub.resetPromise=function(){typeof a!=="boolean"&&a.reject();a=true}})();
(function(){var e=hub.publish,d=hub.merge;hub.publisher=function(c,g,b){if(typeof c==="string"){if(g){if(b)return function(){return e(c,d(g.apply(null,arguments),b))};if(typeof g==="function")return function(){return e(c,g.apply(null,arguments))};return function(k){return e(c,d(k,g))}}return function(){if(arguments.length)return e.apply(hub,[c].concat(Array.prototype.slice.call(arguments)));return e(c)}}var a=hub.chain(),j;for(j in c)if(c.hasOwnProperty(j)){var h=c[j];a[j]=typeof h==="string"?hub.publisher(h):
hub.publisher.apply(hub,h);a.add(a[j])}return a}})();(function(){var e=hub.publisher,d=hub.subscribe;hub.forward=function(c,g,b,a){if(typeof c==="object")for(var j in c){if(c.hasOwnProperty(j)){g=c[j];typeof g==="string"?d(j,e(g)):d(j,e(g[0],g[1],g[2]))}}else d(c,e(g,b,a))}})();
