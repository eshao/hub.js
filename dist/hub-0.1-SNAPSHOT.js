/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};(function(){function r(){function o(){function h(){if(m<n.length&&!h.stop){h.result=Hub.util.merge(h.result,n[m++].apply(null,k));return true}return false}var k=arguments,i=q;q=h;m=0;try{for(;h(););return h.result}finally{r.aborted=q.stop;q=i}}var n=arguments.length?Array.prototype.slice.call(arguments):[],m=-1;o.add=function(h){if(typeof h.all==="function"){h=h.all();n=h.concat(n);if(m!==-1)m+=h.length}else{n.unshift(h);m!==-1&&m++}};o.insert=function(h,k){n.splice(h,0,k);h<m&&m++};o.remove=function(h){if(typeof h===
"number"){n.splice(h,1);h<m&&m--;return h}for(var k=n.length;k--;)if(n[k]===h){n.splice(k,1);k<m&&m--;return k}return-1};o.all=function(){return n};return o}var q;Hub.stopPropagation=function(){q.stop=true};Hub.propagate=function(){q();return q.result};Hub.util.chain=r;Hub.util.topicChain=function(){var o=r(),n=o.remove,m=[];o.add=function(h,k){if(typeof h.all==="function")for(var i=h.all(),c=i.length-1;c>=0;c--)o.add(i[c],k);else if(k.indexOf("*")===-1)o.insert(m.length,h);else{c=0;for(i=m.length;c<
i;c++){var d;a:{var f=k,l=m[c];d=f.indexOf("*");var a=l.indexOf("*");f=f.indexOf("/");l=l.indexOf("/");if(d<f){if(a>l){d=-1;break a}}else if(a<l){d=1;break a}d=0}if(d<=0){m.splice(c,0,k);o.insert(c,h);return}}o.insert(m.length,h);m.push(k)}};o.remove=function(h){h=n(h);h!==-1&&h<m.length&&m.splice(h,1);return h};return o}})();(function(){function r(i,c,d){var f=i[c];f||(i[c]=f=Hub.util.chain());f.add(d)}function q(i,c){return function(){var d=Hub.subscriberChain(i),f=d.apply(null,arguments);if(d.aborted)return f;return Hub.util.merge(f,c.apply(null,arguments))}}function o(i){var c=m[i];if(c)return c;c=h[i];if(!c)throw Error("Peer is not defined: "+i);c=n(c);var d={},f;for(f in c){var l=c[f];if(typeof l==="function")d[f]=q(i+"/"+f,l)}c.api=d;return c}function n(i){for(var c={},d=i.is,f=0,l;l=d[f++];){var a=c;l=o(l);var b=
void 0;for(b in l)r(a,b,l[b])}i=i.instance||i.factory();for(var g in i)r(c,g,i[g]);return c}var m={},h={},k=[];Hub.peer=function(i,c,d){if(h[i])throw Error("Hub - peer already defined: "+i);if(!d){d=c;c=null}c={is:c?typeof c==="string"?[c]:c:k};if(typeof d==="function")c.factory=d;else{c.instance=d;d=m[i]=n(c);var f=d.api={},l;for(l in d){var a=d[l];if(typeof a==="function"){var b=i+"/"+l;Hub.subscribe(b,a);f[l]=Hub.publisher(b)}}}h[i]=c};Hub.get=function(i){return o(i).api};Hub.resetPeers=function(){m=
{};for(var i in h)i.indexOf("lib.")===-1&&delete h[i]}})();(function(){function r(a){return function(){i(Hub.util.substitute(a,arguments),arguments)}}function q(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function o(a){var b=f[a];if(!b){b=f;var g=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");b=b[a]={re:RegExp("^"+g+"$"),chain:Hub.util.chain()};m(d,b.chain,
b.re,null)}return b}function n(a,b,g,e){for(var j in a){var p=a[j];if((g||p.re).test(e))p.chain.add(b,e)}}function m(a,b,g,e){for(var j in a){var p=a[j];if((g||p.re).test(e||j))(b||p.chain).add(p.chain,j)}}function h(a,b){d[a]={chain:b};return b}function k(a){q(a);var b=h(a,Hub.util.topicChain());m(f,b,null,a);return b}function i(a,b){var g=Hub.subscriberChain(a);try{return g.apply(null,b)}catch(e){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:e.message});
}}function c(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var d={},f={},l=[];Hub.reset=function(){d={};f={};Hub.resetPeers()};Hub.subscribe=function(a,b){c(b);var g=a.indexOf("*")!==-1,e;if(e=d[a])e=e.chain;else{if(g){e=o(a);e.chain.add(b);n(d,b,e.re,a);return}e=k(a)}g||n(f,b,null,a);e.add(b,a)};Hub.unsubscribe=function(a,b){c(b);var g=d[a];if(!g){q(a);return false}g.chain.remove(b);for(var e in f){g=f[e];g.re.test(a)&&g.chain.remove(b)}return true};Hub.subscriberChain=
function(a){var b=d[a];if(b)return b.chain;if(a.indexOf("{")!==-1)return h(a,r(a));if(a.indexOf("*")===-1)return k(a);return o(a).chain};Hub.invoke=function(a){var b=arguments.length>1?Array.prototype.slice.call(arguments,1):l;return i(a,b)};Hub.forward=function(a,b,g,e){if(typeof a==="object")for(var j in a){b=a[j];typeof b==="string"?Hub.subscribe(j,Hub.publisher(b)):Hub.subscribe(j,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,g,e))};Hub.publisher=function(a,b,g){if(typeof a===
"string"){if(b){if(g)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),g))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(s){return Hub.publish(a,Hub.util.merge(s,b))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,[a].concat(Array.prototype.slice.call(arguments)));return Hub.publish(a)}}var e=Hub.util.chain(),j;for(j in a){var p=a[j];e[j]=typeof p==="string"?Hub.publisher(p):Hub.publisher.apply(Hub,
p);e.add(e[j])}return e};Hub.Error=function(a,b,g){this.type=a;this.context=g;this.toString=function(){return Hub.util.substitute(b,g)}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var g=Object.prototype.toString,e=g.call(b);g=g.call(a);if(g===e){if(e==="[object Object]"){for(var j in b)a[j]=arguments.callee(a[j],b[j]);return a}if(e==="[object Array]")return a.concat(b)}i("hub.error/util.merge",[new Hub.Error("validation",g===e?"Cannot merge value {target} with {source}":
"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:g,sourceType:e})]);return a};Hub.util.resolve=function(a,b,g){var e=b.indexOf(".");if(e!==-1){var j=b.substring(0,e);if(j in a)return arguments.callee(a[j],b.substring(e+1),g);return g}return b in a?a[b]:g};Hub.util.substitute=function(a,b,g){if(g===undefined)g="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(e,j){return Hub.util.resolve(b,j,g)}:function(){return g})}})();(function(){function r(c,d){try{c(d)}catch(f){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:f.message}))}}function q(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function o(c){return function(){c.reject({type:"timeout"})}}function n(c,d,f,l){var a,b,g;g={then:function(e,j){if(c){var p=d?e:j;p&&r(p,f)}else{e&&a.push(e);j&&b.push(j)}return this},publish:function(e){if(c){f=Hub.invoke.apply(Hub,
arguments);return this}var j=[e];if(arguments.length>1)j=j.concat(arguments);return this.then(function(){f=Hub.invoke.apply(Hub,j)})},publishResult:function(e){if(c){f=Hub.invoke(e,f);return this}return this.then(function(){f=Hub.invoke(e,f)})},fulfill:function(e){if(c)q();else{c=true;clearTimeout(l);for(f=Hub.util.merge(f,e);a.length;)r(a.shift(),f)}return this},reject:function(e){if(c)q();else{c=true;d=false;for(clearTimeout(l);b.length;)r(b.shift(),e)}return this},fulfilled:function(){return c}};
if(!c){a=[];b=[];l=setTimeout(o(g),l||6E4)}return g}function m(c,d){function f(){if(++g===2)(j?e.fulfill:e.reject)(b)}function l(p){if(j)b=Hub.util.merge(b,p);f()}function a(p){if(j){j=false;b=p}else b=Hub.util.merge(b,p);f()}var b,g=0,e=n(false,true),j=true;c.then(l,a);d.then(l,a);return e}function h(c){var d=n(true,true);c.then=d.then;c.publish=d.publish;c.publishResult=d.publishResult;return d}var k=true,i=function(){};i.prototype={then:function(c,d){return h(this).then(c,d)},publish:function(){return h(this).publish.apply(null,
arguments)},publishResult:function(){return h(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},reject:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var c=k;k=false;var d=true,f;try{f=Hub.invoke.apply(this,arguments)}catch(l){if(l instanceof Hub.Error){d=false;f=l}else throw l;}if(typeof f!=="undefined"){d=n(true,d,f);k=k?m(k,d):d}d=k;k=c;return d||new i};Hub.promise=
function(c){c=n(false,true,undefined,c);if(k===true)return c;if(k===false)return k=c;k=m(k,c);return c}})();
