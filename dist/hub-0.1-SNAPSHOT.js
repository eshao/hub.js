/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};(function(){function w(){function n(){function f(){if(j<l.length&&!f.stop){f.result=Hub.util.merge(f.result,l[j++].apply(null,i));return true}return false}var i=arguments,u=t;t=f;j=0;try{for(;f(););return f.result}finally{w.aborted=t.stop;t=u}}var l=arguments.length?Array.prototype.slice.call(arguments):[],j=-1;n.add=function(f){if(typeof f.all==="function"){f=f.all();l=f.concat(l);if(j!==-1)j+=f.length}else{l.unshift(f);j!==-1&&j++}};n.insert=function(f,i){l.splice(f,0,i);f<j&&j++};n.remove=function(f){if(typeof f===
"number"){l.splice(f,1);f<j&&j--;return f}for(var i=l.length;i--;)if(l[i]===f){l.splice(i,1);i<j&&j--;return i}return-1};n.all=function(){return l};return n}var t;Hub.stopPropagation=function(){t.stop=true};Hub.propagate=function(){t();return t.result};Hub.util.chain=w;Hub.util.topicChain=function(){var n=w(),l=n.remove,j=[];n.add=function(f,i){if(typeof f.all==="function")for(var u=f.all(),e=u.length-1;e>=0;e--)n.add(u[e],i);else if(i.indexOf("*")===-1)n.insert(j.length,f);else{e=0;for(u=j.length;e<
u;e++){var g;a:{var o=i,p=j[e];g=o.indexOf("*");var r=p.indexOf("*");o=o.indexOf("/");p=p.indexOf("/");if(g<o){if(r>p){g=-1;break a}}else if(r<p){g=1;break a}g=0}if(g<=0){j.splice(e,0,i);n.insert(e,f);return}}n.insert(j.length,f);j.push(i)}};n.remove=function(f){f=l(f);f!==-1&&f<j.length&&j.splice(f,1);return f};return n}})();(function(){function w(a,b,c){var d=a[b];d||(a[b]=d=Hub.util.chain());d.add(c)}function t(a){for(var b={},c=a.is,d=0,h;h=c[d++];){var q=b;h=l(h);var x=void 0;for(x in h)w(q,x,h[x])}a=a.instance||a.factory();for(var A in a)w(b,A,a[A]);return b}function n(a,b){return function(){var c=p(a),d=r(a,c,arguments);if(c.aborted)return d;return Hub.util.merge(d,r(a,b,arguments))}}function l(a){var b=v[a];if(b)return b;b=z[a];if(!b)throw Error("Peer is not defined: "+a);b=t(b);var c={},d;for(d in b){var h=b[d];
if(typeof h==="function")c[d]=n(a+"/"+d,h)}b.api=c;return b}function j(a){return function(){s(Hub.util.substitute(a,arguments),arguments)}}function f(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function i(a){var b=m[a];if(!b){b=m;var c=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");b=b[a]={re:RegExp("^"+
c+"$"),chain:Hub.util.chain()};e(k,b.chain,b.re,null)}return b}function u(a,b,c,d){for(var h in a){var q=a[h];if((c||q.re).test(d))q.chain.add(b,d)}}function e(a,b,c,d){for(var h in a){var q=a[h];if((c||q.re).test(d||h))(b||q.chain).add(q.chain,h)}}function g(a,b){k[a]={chain:b};return b}function o(a){f(a);var b=g(a,Hub.util.topicChain());e(m,b,null,a);return b}function p(a){var b=k[a];if(b)return b.chain;if(a.indexOf("{")!==-1)return g(a,j(a));if(a.indexOf("*")===-1)return o(a);return i(a).chain}
function r(a,b,c){try{return b.apply(null,c)}catch(d){if(a==="hub.error/publish")throw d;s("hub.error/publish",[new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:d.message})])}}function s(a,b){return r(a,p(a),b)}function y(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var k={},m={},v={},z={},B=[];Hub.reset=function(){k={};m={};v={};for(var a in z)a.indexOf("lib.")===-1&&delete z[a]};Hub.subscribe=function(a,b){y(b);var c=a.indexOf("*")!==
-1,d;if(d=k[a])d=d.chain;else{if(c){d=i(a);d.chain.add(b);u(k,b,d.re,a);return}d=o(a)}c||u(m,b,null,a);d.add(b,a)};Hub.unsubscribe=function(a,b){y(b);var c=k[a];if(!c){f(a);return false}c.chain.remove(b);for(var d in m){c=m[d];c.re.test(a)&&c.chain.remove(b)}return true};Hub.peer=function(a,b,c){if(z[a])throw Error("Hub - peer already defined: "+a);if(!c){c=b;b=null}b={is:b?typeof b==="string"?[b]:b:B};if(typeof c==="function")b.factory=c;else{b.instance=c;c=v[a]=t(b);var d=c.api={},h;for(h in c){var q=
c[h];if(typeof q==="function"){var x=a+"/"+h;Hub.subscribe(x,q);d[h]=Hub.publisher(x)}}}z[a]=b};Hub.get=function(a){return l(a).api};Hub.invoke=function(a){var b=arguments.length>1?Array.prototype.slice.call(arguments,1):B;return s(a,b)};Hub.forward=function(a,b,c,d){if(typeof a==="object")for(var h in a){b=a[h];typeof b==="string"?Hub.subscribe(h,Hub.publisher(b)):Hub.subscribe(h,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,c,d))};Hub.publisher=function(a,b,c){if(typeof a===
"string"){if(b){if(c)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),c))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(x){return Hub.publish(a,Hub.util.merge(x,b))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,[a].concat(Array.prototype.slice.call(arguments)));return Hub.publish(a)}}var d=Hub.util.chain(),h;for(h in a){var q=a[h];d[h]=typeof q==="string"?Hub.publisher(q):Hub.publisher.apply(Hub,
q);d.add(d[h])}return d};Hub.Error=function(a,b,c){return{toString:function(){return Hub.util.substitute(b,this.context)},type:a,context:c||{}}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var c=Object.prototype.toString,d=c.call(b);c=c.call(a);if(c===d){if(d==="[object Object]"){for(var h in b)a[h]=arguments.callee(a[h],b[h]);return a}if(d==="[object Array]")return a.concat(b)}s("hub.error/util.merge",[new Hub.Error("validation",c===
d?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:c,sourceType:d})]);return a};Hub.util.resolve=function(a,b,c){var d=b.indexOf(".");if(d!==-1){var h=b.substring(0,d);if(h in a)return arguments.callee(a[h],b.substring(d+1),c);return c}return b in a?a[b]:c};Hub.util.substitute=function(a,b,c){if(c===undefined)c="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(d,h){return Hub.util.resolve(b,h,c)}:function(){return c})}})();(function(){function w(e,g){try{e(g)}catch(o){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:o.message}))}}function t(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function n(e){return function(){e.reject({type:"timeout"})}}function l(e,g,o){var p,r,s=true,y;y={then:function(k,m){if(e){var v=s?k:m;v&&w(v,g)}else{k&&p.push(k);m&&r.push(m)}return this},publish:function(k){if(e){g=Hub.invoke.apply(Hub,
arguments);return this}var m=[k];if(arguments.length>1)m=m.concat(arguments);return this.then(function(){g=Hub.invoke.apply(Hub,m)})},publishResult:function(k){if(e){g=Hub.invoke(k,g);return this}return this.then(function(){g=Hub.invoke(k,g)})},fulfill:function(k){if(e)t();else{e=true;clearTimeout(o);for(g=Hub.util.merge(g,k);p.length;)w(p.shift(),g)}return this},reject:function(k){if(e)t();else{e=true;s=false;for(clearTimeout(o);r.length;)w(r.shift(),k)}return this},fulfilled:function(){return e}};
if(!e){p=[];r=[];o=setTimeout(n(y),o||6E4)}return y}function j(e,g){function o(){if(++y===2)(m?k.fulfill:k.reject)(s)}function p(v){if(m)s=Hub.util.merge(s,v);o()}function r(v){if(m){m=false;s=v}else s=Hub.util.merge(s,v);o()}var s,y=0,k=l(false),m=true;e.then(p,r);g.then(p,r);return k}function f(e){var g=l(true);e.then=g.then;e.publish=g.publish;e.publishResult=g.publishResult;return g}var i=true,u=function(){};u.prototype={then:function(e,g){return f(this).then(e,g)},publish:function(){return f(this).publish.apply(null,
arguments)},publishResult:function(){return f(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var e=i;i=false;var g=Hub.invoke.apply(this,arguments);if(typeof g!=="undefined"){g=l(true,g);i=i?j(i,g):g}g=i;i=e;return g||new u};Hub.promise=function(e){e=l(false,undefined,e);if(i===true)return e;if(i===false)return i=e;i=j(i,e);return e}})();
