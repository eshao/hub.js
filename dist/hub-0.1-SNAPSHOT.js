/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(e,f){if(e===undefined||e===null||e===f)return f;if(f===undefined||f===null)return e;var a=Object.prototype.toString,g=a.call(f);a=a.call(e);var h;if(a===g){if(g==="[object Object]"){for(h in f)if(f.hasOwnProperty(h))e[h]=hub.merge(e[h],f[h]);return e}if(g==="[object Array]")return e.concat(f)}throw new hub.Error("validation",a===g?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:e,source:f,targetType:a,sourceType:g});};
hub.resolve=function(e,f,a){for(var g=f.indexOf(".");g!==-1;){var h=f.substring(0,g);if(!e.hasOwnProperty(h))return a;e=e[h];f=f.substring(g+1);g=f.indexOf(".")}return e.hasOwnProperty(f)?e[f]:a};hub.substitute=function(e,f,a){if(a===undefined)a="";return e.replace(/\{([a-zA-Z0-9\.]+)\}/g,f?function(g,h){return hub.resolve(f,h,a)}:function(){return a})};hub.Error=function(e,f,a){this.type=e;this.context=a;this.toString=function(){return hub.substitute(f,a)}};
hub.iterator=function(e){function f(){if(a>=g)throw Error("Iterator out of bounds.");var h=e[a++];f.hasNext=a<g;return h}var a=0,g=e.length;f.hasNext=a<g;f.remove=function(h){var d=typeof h;if(d==="undefined")h=a;else if(d==="number")h<a&&a--;else{for(d=e.length-1;d>=0;d--)if(e[d]===h){h=d;break}if(d<0)return false}if(h>=g)return false;e.splice(h,1);f.hasNext=a<--g;return true};f.insert=function(h,d){if(typeof d==="undefined"){d=h;h=a}else h<a&&a++;e.splice(h,0,d);f.hasNext=a<++g};f.reset=function(){a=
0;f.hasNext=a<g};return f};
(function(){function e(b){var k=[],n=false,m,l,j;return j={stopPropagation:function(){n=true;k.length=0;if(arguments.length)l=arguments[0]},propagate:function(){if(arguments.length)l=arguments[0];var i=k.length;if(i){i=k[i-1];if(i.hasNext){i=i().apply(j,b);if(m){l=m;m=undefined;l.then(j.propagate);return}else if(i&&i.then){i.then(j.propagate);l=i;return}l=hub.merge(l,i)}else{i.reset();k.pop()}return j.propagate()}},aborted:function(){return n},result:function(){return l},push:function(i){k.push(i)},
promise:function(){return m=hub.promise()}}}function f(){function b(){var n=this.propagate?this:e(arguments);n.push(k);n.propagate();return n.result()}var k=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);b.add=function(n){var m=typeof n;if(m!=="function")throw new TypeError("Callback is "+m);k.insert(0,n)};b.insert=k.insert;b.remove=k.remove;return b}function a(b){b=b.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+b+"$")}function g(b){var k=typeof b;if(k!=="string")throw Error("Topic is "+k);if(!b)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(b))throw Error("Illegal topic: "+b);}function h(b,k){var n=b.indexOf("*"),m=k.indexOf("*");if(n===-1)return m===-1?0:1;if(m===-1)return-1;var l=b.indexOf("."),j=k.indexOf(".");if(n<l){if(m>j)return-1}else if(m<j)return 1;return 0}function d(b,k){function n(i){i||(i=b);if(i!==c&&!m.test(i)){if(i.indexOf("*")===-1||!a(i).test(b))return;
i=c}var o=this.propagate?this:e(Array.prototype.slice.call(arguments,1));l.call(o);if(o.aborted())return o.result();var p=o.topicChainQueue;if(p)Array.prototype.push.apply(p,j);else p=o.topicChainQueue=j.slice();for(;p.length;){p.shift().call(o,i);if(o.aborted())break}return o.result()}if(b)g(b);else b=c;var m=a(b),l=f(),j=k?[k]:[];n.matches=function(i){return m.test(i)};n.getTopic=function(){return b};n.add=function(i,o,p){if(b===i)l.add(o);else{var q,r,s;r=0;for(s=j.length;r<s;r++){q=j[r];if(q.matches(i)){q.add(i,
o,p);return}p||(p=a(i));if(p.test(q.getTopic())){q=d(i,q);q.add(i,o,p);j[r]=q;return}}q=d(i);q.add(i,o);if(i.indexOf("*")===-1)j.unshift(q);else{r=0;for(s=j.length;r<s;r++){o=j[r].getTopic();if(h(o,i)!==-1){j.splice(r,0,q);return}}j.push(q)}}};n.remove=function(i,o){if(b===i)return l.remove(o);var p,q,r;p=0;for(q=j.length;p<q;p++){r=j[p];if(r.matches(i))if(r.remove(i,o))return true}g(i);p=typeof o;if(p!=="function")throw new TypeError("Callback is "+p);return false};return n}var c="**";hub.scope=
e;hub.chain=f;hub.topicChain=d;hub.topicComparator=h;hub.validateTopic=g})();(function(){hub.mix=function(e,f){for(var a in f)if(f.hasOwnProperty(a)&&typeof f[a]==="function"){var g=e,h=a,d=f[a],c=g[h];if(c)if(c.add)c.add(d);else g[h]=hub.chain(d,g[h]);else g[h]=d}return e}})();
(function(){hub.create=function(e,f,a){if(typeof e!=="string"){a=f;f=e;e=null}if(typeof f!=="function")throw new TypeError;var g={};e=e?hub.topicScope(e):hub.scope();e.mix=function(){hub.emit.apply(hub,arguments).then(function(h){hub.mix(g,h)})};f=a?f.apply(e,a):f.call(e);return hub.mix(g,f)}})();
(function(){function e(d,c){for(var b in c)c.hasOwnProperty(b)&&hub.root.add(d+b,c[b])}function f(d){return function(){return d}}function a(d,c){d+=".";return function(){var b=h.call(arguments);if(!b[0])throw new TypeError("Topic is "+b[0]);b[0]=d+b[0];return c.apply(this,b)}}hub.root=hub.topicChain();var g={},h=Array.prototype.slice;hub.on=function(d,c){if(Object.prototype.toString.call(d)==="[object Object]")e("",d);else{if(Object.prototype.toString.call(c)==="[object Object]"){e(d+".",c);c=f(c)}hub.root.add(d,
c)}};hub.un=function(d,c){return hub.root.remove(d,c)};hub.topicScope=function(d,c){c||(c=hub.scope());var b=g[d];if(!b){b={on:a(d,hub.on),un:a(d,hub.un),peer:a(d,hub.peer),emit:a(d,hub.emit),create:a(d,hub.create)};g[d]=b}c.on=b.on;c.un=b.un;c.peer=b.peer;c.emit=b.emit;c.create=b.create;return c};hub.emit=function(d){hub.validateTopic(d);var c=h.call(arguments),b=c.slice(1);if(d.indexOf("{")!==-1)c[0]=hub.substitute(d,b);b=this.propagate?this:hub.scope(b);b=hub.topicScope(c[0],b);var k;try{k=hub.root.apply(b,
c)}catch(n){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:c[0],error:n.message});}if(k&&k.then)return k;c=hub.promise(0,b);c.resolve(k);return c};hub.peer=function(d,c,b){if(typeof d==="function"){if(c=hub.create(d,c))hub.on(c)}else if(typeof c==="function"){if(c=hub.create(d,c,b))hub.on(d,c)}else hub.on(d,c)};hub.reset=function(){g={};hub.root=hub.topicChain()}})();
(function(){hub.promise=function(e,f){function a(){n&&clearTimeout(n);for(var l=k?d:h,j=0,i=l.length;j<i;j++)l[j].apply(f,c);h.length=0;d.length=0}function g(){b--;!b&&c&&a()}var h=[],d=[],c,b=0,k=false,n,m;m={then:function(l,j){if(typeof l!=="function")throw new TypeError("Callback is "+l);h.push(l);j&&d.push(j);!b&&c&&a();return m},resolve:function(){if(c)throw Error("Promise already "+(k?"rejected":"resolved"));c=Array.prototype.slice.call(arguments);b||a();return m},reject:function(){k=true;return m.resolve.apply(m,
arguments)},wait:function(){var l=0,j=arguments.length;for(b+=j;l<j;l++)arguments[l].then(g);return m},join:function(l){if(!l||typeof l.then!=="function")throw new TypeError("Promise is "+l);var j=hub.promise();m.then(function(i){l.then(function(o){j.resolve(i,o)})});return j}};if(e)n=setTimeout(function(){m.reject(new hub.Error("timeout","Promise timed out after {timeout} milliseconds",{timeout:e}))},e);return m}})();
(function(){var e=hub.emit,f=hub.merge;hub.emitter=function(a,g,h){if(typeof a==="string"){if(g){if(h)return function(){return e(a,f(g.apply(null,arguments),h))};if(typeof g==="function")return function(){return e(a,g.apply(null,arguments))};return function(k){return e(a,f(k,g))}}return function(){if(arguments.length)return e.apply(hub,[a].concat(Array.prototype.slice.call(arguments)));return e(a)}}var d=hub.chain(),c;for(c in a)if(a.hasOwnProperty(c)){var b=a[c];d[c]=typeof b==="string"?hub.emitter(b):
hub.emitter.apply(hub,b);d.add(d[c])}return d}})();(function(){var e=hub.emitter,f=hub.on;hub.forward=function(a,g,h,d){if(typeof a==="object")for(var c in a){if(a.hasOwnProperty(c)){g=a[c];typeof g==="string"?f(c,e(g)):f(c,e(g[0],g[1],g[2]))}}else f(a,e(g,h,d))}})();
