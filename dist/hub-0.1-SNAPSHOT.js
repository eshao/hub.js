/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};Hub.iterator=function(r){function q(){if(l>=a)throw Error("Iterator out of bounds.");var b=r[l++];q.hasNext=l<a;return b}var l=0,a=r.length;q.hasNext=l<a;q.remove=function(b){var g=typeof b;if(g==="undefined")b=l;else if(g==="number")b<l&&l--;else{for(g=r.length-1;g>=0;g--)if(r[g]===b){b=g;break}if(g<0)return false}if(b>=a)return false;r.splice(b,1);q.hasNext=l<--a;return true};q.insert=function(b,g){if(typeof g==="undefined"){g=b;b=l}else b<l&&l++;r.splice(b,0,g);q.hasNext=l<++a};q.reset=function(){l=
0;q.hasNext=l<a};return q};(function(){function r(){var c=f.length;if(!c)return false;c=f[c-1];if(!c.hasNext){f.pop();return r()}d=Hub.util.merge(d,c().apply(null,g));return true}function q(){function c(){c.aborted=false;var n=!f.length;if(n){b=false;g=arguments}d=undefined;try{for(f.push(h);r(););}finally{c.aborted=b;h.reset();if(n)f.length=0}if(!f.length){n=d;g=d=undefined;return n}}var h=Hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);c.add=function(n){h.insert(0,n)};c.insert=h.insert;c.remove=h.remove;
return c}function l(c){c=c.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+c+"$")}function a(c){c||(c=e);var h=l(c),n=q(),j=[],p=function(k,i,m){k||(k=c);if(k!==e&&!h.test(k)){if(k.indexOf("*")===-1||!l(k).test(c))return;k=e}var o=n.apply(null,i);if(n.aborted){p.aborted=true;return o}if(m)for(var s=0,t=j.length;s<t;s++)m.push(j[s]);else m=j.slice();for(;m.length;){s=m.shift();o=Hub.util.merge(o,s(k,i,m));if(s.aborted){p.aborted=
true;break}}return o};p.matches=function(k){return h.test(k)};p.getTopic=function(){return c};p.add=function(k,i,m){if(c===i)n.add(k);else{for(var o,s=0,t=j.length;s<t;s++){var u=j[s];if(u.matches(i)){u.add(k,i,m);return}m||(m=l(i));if(m.test(u.getTopic())){o=a(i);o.addChild(u);o.add(k,i,m);j[s]=o;return}}o=a(i);o.add(k,i);if(i.indexOf("*")===-1)j.unshift(o);else{s=0;for(t=j.length;s<t;s++){k=j[s].getTopic();if(Hub.topicComparator(k,i)!==-1){j.splice(s,0,o);return}}j.push(o)}}};p.addChild=function(k){j.unshift(k)};
p.remove=function(k,i){if(c===i)return n.remove(k);for(var m=0,o=j.length;m<o;m++){var s=j[m];if(s.matches(i))if(s.remove(k,i))return true}return false};return p}var b=false,g,d,f=[],e="**/**";Hub.stopPropagation=function(){b=true;f.length=0};Hub.propagate=function(){r()};Hub.topicComparator=function(c,h){var n=c.indexOf("*"),j=h.indexOf("*");if(n===-1)return j===-1?0:1;if(j===-1)return-1;var p=c.indexOf("/"),k=h.indexOf("/");if(n<p){if(j>k)return-1}else if(j<k)return 1;return 0};Hub.chain=q;Hub.topicChain=
a})();(function(){function r(d,f){return function(){var e=Array.prototype.slice.call(arguments);e=Hub.publish.apply(Hub,[d].concat(e));Hub.aborted()||(e=Hub.util.merge(e,f.apply(null,arguments)));return e}}function q(d){var f=a[d];if(f)return f;f=b[d];if(!f)throw Error("Peer is not defined: "+d);f=l(f);var e={},c;for(c in f){var h=f[c];if(typeof h==="function")e[c]=r(d+"/"+c,h)}f.api=e;return f}function l(d){for(var f={},e=d.is,c=0,h;h=e[c++];){var n=f;h=q(h);var j=void 0;for(j in h){var p=h[j],k=n[j];
k||(n[j]=k=Hub.chain());k.add(p)}}d=d.instance||d.factory();for(var i in d){e=d[i];(c=f[i])||(f[i]=c=Hub.chain());c.add(e)}return f}var a={},b={},g=[];Hub.peer=function(d,f,e){if(b[d])throw Error("Hub - peer already defined: "+d);if(!e){e=f;f=null}f={is:f?typeof f==="string"?[f]:f:g};if(typeof e==="function")f.factory=e;else{f.instance=e;e=a[d]=l(f);var c=e.api={},h;for(h in e){var n=e[h];if(typeof n==="function"){var j=d+"/"+h;Hub.subscribe(j,n);c[h]=Hub.publisher(j)}}}b[d]=f};Hub.get=function(d){return q(d).api};
Hub.resetPeers=function(){a={};for(var d in b)d.indexOf("lib.")===-1&&delete b[d]}})();(function(){function r(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function q(a){a=typeof a;if(a!=="function")throw Error("Callback is "+a);}var l=Hub.topicChain();Hub.reset=function(){l=Hub.topicChain();Hub.resetPeers()};Hub.subscribe=function(a,b){q(b);r(a);l.add(b,a)};Hub.unsubscribe=function(a,b){q(b);r(a);return l.remove(b,a)};Hub.invoke=
function(a){r(a);var b=Array.prototype.slice.call(arguments,1);if(a.indexOf("{")!==-1)a=Hub.util.substitute(a,b);try{return l(a,b)}catch(g){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:g.message});}};Hub.aborted=function(){return Boolean(l.aborted)};Hub.forward=function(a,b,g,d){if(typeof a==="object")for(var f in a){b=a[f];typeof b==="string"?Hub.subscribe(f,Hub.publisher(b)):Hub.subscribe(f,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,
g,d))};Hub.publisher=function(a,b,g){if(typeof a==="string"){if(b){if(g)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),g))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(c){return Hub.publish(a,Hub.util.merge(c,b))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,[a].concat(Array.prototype.slice.call(arguments)));return Hub.publish(a)}}var d=Hub.chain(),f;for(f in a){var e=a[f];d[f]=typeof e===
"string"?Hub.publisher(e):Hub.publisher.apply(Hub,e);d.add(d[f])}return d};Hub.Error=function(a,b,g){this.type=a;this.context=g;this.toString=function(){return Hub.util.substitute(b,g)}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var g=Object.prototype.toString,d=g.call(b);g=g.call(a);if(g===d){if(d==="[object Object]"){for(var f in b)a[f]=arguments.callee(a[f],b[f]);return a}if(d==="[object Array]")return a.concat(b)}throw new Hub.Error("validation",
g===d?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:g,sourceType:d});};Hub.util.resolve=function(a,b,g){var d=b.indexOf(".");if(d!==-1){var f=b.substring(0,d);if(f in a)return arguments.callee(a[f],b.substring(d+1),g);return g}return b in a?a[b]:g};Hub.util.substitute=function(a,b,g){if(g===undefined)g="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(d,f){return Hub.util.resolve(b,f,g)}:function(){return g})}})();(function(){function r(e,c){try{e(c)}catch(h){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:h.message}))}}function q(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function l(e){return function(){e.reject({type:"timeout"})}}function a(e,c,h){var n,j,p=!(c instanceof Hub.Error),k;k={then:function(i,m){if(e){var o=p?i:m;o&&r(o,c)}else{i&&n.push(i);m&&j.push(m)}return this},publish:function(i){if(e){c=
Hub.invoke.apply(Hub,arguments);return this}var m=[i];if(arguments.length>1)m=m.concat(arguments);return this.then(function(){c=Hub.invoke.apply(Hub,m)})},publishResult:function(i){if(e){c=Hub.invoke(i,c);return this}return this.then(function(){c=Hub.invoke(i,c)})},fulfill:function(i){if(e)q();else{e=true;clearTimeout(h);for(c=Hub.util.merge(c,i);n.length;)r(n.shift(),c)}return this},reject:function(i){if(e)q();else{e=true;p=false;for(clearTimeout(h);j.length;)r(j.shift(),i)}return this},fulfilled:function(){return e}};
if(!e){n=[];j=[];h=setTimeout(l(k),h||6E4)}return k}function b(e,c){function h(){if(++k===2)(m?i.fulfill:i.reject)(p)}function n(o){if(m)p=Hub.util.merge(p,o);h()}function j(o){if(m){m=false;p=o}else p=Hub.util.merge(p,o);h()}var p,k=0,i=a(false),m=true;e.then(n,j);c.then(n,j);return i}function g(e){var c=a(true);e.then=c.then;e.publish=c.publish;e.publishResult=c.publishResult;return c}var d=true,f=function(){};f.prototype={then:function(e,c){return g(this).then(e,c)},publish:function(){return g(this).publish.apply(null,
arguments)},publishResult:function(){return g(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},reject:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var e=d;d=false;var c;try{c=Hub.invoke.apply(this,arguments)}catch(h){if(d&&h instanceof Hub.Error){d.reject(h);return d}throw h;}if(typeof c!=="undefined"){c=a(true,c);d=d?b(d,c):c}c=d;d=e;return c||new f};Hub.promise=
function(e){e=a(false,undefined,e);if(d===false)d=e;else if(d!==true)d=b(d,e);return e}})();
