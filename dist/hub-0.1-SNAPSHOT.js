/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};(function(){function z(q,n){function g(){if(j<q.length&&!g.stop){g.result=Hub.util.merge(g.result,q[j++].apply(null,n));return true}return false}var j=0;return g}var k;Hub.stopPropagation=function(){k.stop=true};Hub.propagate=function(){k()};Hub.util.chain=function(){function q(){g||(g=Array.prototype.slice.call(n));var j=k;k=z(g,arguments);try{for(;k(););return k.result}finally{k=j}}var n=arguments.length?Array.prototype.slice.call(arguments):[],g=null;q.add=function(j){n.unshift(j);g=null};q.remove=
function(j){for(var u=n.length;u--;)if(n[u]===j){n.splice(u,1);break}g=null};return q}})();(function(){function z(a,b,c){var d=a[b];d||(a[b]=d=Hub.util.chain());d.add(c)}function k(a){var b={};if(a=x[a]){for(var c=a.is?typeof a.is==="string"?[a.is]:a.is:D,d=0,e;e=c[d++];){var l=b;e=B[e]||k(topic);var p=void 0;for(p in e)z(l,p,e[p])}a=a.factory();for(var o in a)z(b,o,a[o])}return b}function q(a){return function(){var b=k(a);n(b,a);Hub.propagate();for(var c in b)Hub.unsubscribe(a+"/"+c,b[c])}}function n(a,b){for(var c in a)Hub.subscribe(b+"/"+c,a[c])}function g(a){return function(){v(Hub.util.substitute(a,
arguments),arguments)}}function j(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function u(a,b){j(a);var c=Hub.util.chain(),d,e;b&&c.add(b);if(a.indexOf("*")!==-1){d=E[a];if(!d){d=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");d=E[a]=RegExp("^"+d+"$")}for(e in m)d.test(e)&&c.add(m[e]);r[a]=d}else for(e in r){d=
r[e];d.test(a)&&c.add(m[e])}a.indexOf("{")!==-1&&c.add(g(a));return m[a]=c}function v(a,b){var c=m[a]||u(a);try{return c.apply(null,b)}catch(d){if(a==="hub.error/publish")throw d;v("hub.error/publish",[new Hub.Error("error",'Error in callback for topic "{topic}": {error}',{topic:a,error:d.message})])}}function F(){w=undefined;s=(new Date).getTime();var a=-1,b;for(b in t){var c=t[b],d=c[0];if(d<=s){c[1].reject({type:"timeout"});delete t[b]}else a=a===-1?d:Math.min(d,a)}if(a!==-1)y=setTimeout(F,a);
s=undefined}function L(a,b){s||(s=(new Date).getTime());var c=++M;t[c]=[s+b,a];if(!w){clearTimeout(y);w=setTimeout(F,15)}return c}function C(a,b){if(a)try{a(b)}catch(c){v("hub.error/promise.callback",[new Hub.Error("error","Error in promise callback: ${error}",{error:c.message})])}}function G(){v("hub.error/promise.fulfilled",[new Hub.Error("validation","Promise already fulfilled")])}function A(a,b,c){var d=[],e=[],l=true,p,o;o={then:function(f,h){if(a)C(l?f:h,b);else{f&&d.push(f);h&&e.push(h)}return this},
publish:function(f){if(a)return Hub.publish.apply(Hub,arguments);var h=[f];if(arguments.length>1)h=h.concat(arguments);return this.then(function(){return Hub.publish.apply(Hub,h)})},fulfill:function(f){if(a)G();else{a=true;delete t[p];for(b=Hub.util.merge(b,f);d.length;)C(d.shift(),b)}return this},reject:function(f){if(a)G();else{a=true;l=false;for(delete t[p];d.length;)C(e.shift(),f)}return this},fulfilled:function(){return a}};a||(p=L(o,c||6E4));return o}function H(a,b){function c(){if(++p===2)(f?
o.fulfill:o.reject)(l)}function d(h){if(f)l=Hub.util.merge(l,h);c()}function e(h){if(f){f=false;l=h}else l=Hub.util.merge(l,h);c()}var l,p=0,o=A(false,undefined),f=true;a.then(d,e);b.then(d,e);return o}function I(a){var b=A(true);a.then=b.then;a.publish=b.publish;return b}function J(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var m={},r={},B={},x={},D=[],i=true,t={},E={},y,w,M=0,s,K=function(){};K.prototype={then:function(a,b){return I(this).then(a,b)},publish:function(a,
b,c){return I(this).publish(a,b,c)},fulfill:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.SINGLETON="SINGLETON";Hub.PROTOTYPE="PROTOTYPE";Hub.reset=function(){m={};r={};B={};for(var a in x)a.indexOf("lib.")===-1&&delete x[a];if(w){clearTimeout(w);w=undefined}if(y){clearTimeout(y);y=undefined}s=undefined;t={}};Hub.subscribe=function(a,b){J(b);var c=m[a];c?c.add(b):u(a,b);for(var d in r)r[d].test(a)&&m[d].add(b)};Hub.unsubscribe=function(a,b){J(b);
if(!m[a]){j(a);return false}m[a].remove(b);for(var c in r)r[c].test(a)&&m[c].remove(b);return true};Hub.peer=function(a,b,c){if(x[a])throw Error("Hub - peer already defined: "+a);if(typeof b==="function"){c=b;b={}}b.factory=c;x[a]=b;if(!b.scope||b.scope===Hub.SINGLETON){b=B[a]=k(a);n(b,a)}else Hub.subscribe(a+"/**",q(a))};Hub.publish=function(a){var b=i;i=false;var c=arguments.length>1?Array.prototype.slice.call(arguments,1):D;c=v(a,c);if(c!==undefined){c=A(true,c);i=i?H(i,c):c}c=i;i=b;return c||
new K};Hub.promise=function(a){a=A(false,undefined,a);if(i===true)return a;if(i===false)return i=a;i=H(i,a);return a};Hub.forward=function(a,b,c,d){if(typeof a==="object")for(var e in a){b=a[e];typeof b==="string"?Hub.subscribe(e,Hub.publisher(b)):Hub.subscribe(e,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,c,d))};Hub.publisher=function(a,b,c){if(b){if(c)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),c))};if(typeof b==="function")return function(){return Hub.publish(a,
b.apply(null,arguments))};return function(d){return Hub.publish(a,Hub.util.merge(d,b))}}return function(d){return Hub.publish(a,d)}};Hub.Error=function(a,b,c){return{toString:function(){return Hub.util.substitute(b,this.context)},type:a,context:c||{}}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var c=Object.prototype.toString,d=c.call(b);c=c.call(a);if(c===d){if(d==="[object Object]"){for(var e in b)a[e]=arguments.callee(a[e],b[e]);
return a}if(d==="[object Array]")return a.concat(b)}v("hub.error/util.merge",[new Hub.Error("validation",c===d?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:c,sourceType:d})]);return a};Hub.util.resolve=function(a,b,c){var d=b.indexOf(".");if(d!==-1){var e=b.substring(0,d);if(e in a)return arguments.callee(a[e],b.substring(d+1),c);return c}return b in a?a[b]:c};Hub.util.substitute=function(a,b,c){if(c===undefined)c="";
return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(d,e){return Hub.util.resolve(b,e,c)}:function(){return c})}})();
