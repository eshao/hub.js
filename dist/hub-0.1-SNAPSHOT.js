/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{},noop:function(){}};Hub.iterator=function(r){function q(){if(l>=o)throw Error("Iterator out of bounds.");var m=r[l++];q.hasNext=l<o;return m}var l=0,o=r.length;q.hasNext=l<o;q.remove=function(m){if(typeof m==="undefined")m=l;else m<l&&l--;r.splice(m,1);q.hasNext=l<--o};q.insert=function(m,j){if(typeof j==="undefined"){j=m;m=l}else m<l&&l++;r.splice(m,0,j);q.hasNext=l<++o};return q};(function(){function r(){var d=j.length;if(!d)return false;d=j[d-1];if(!d.hasNext){j.pop();return r()}m=Hub.util.merge(m,d().apply(null,o));return true}function q(){function d(){d.aborted=false;if(!j.length){l=false;o=arguments}m=undefined;try{e=Hub.iterator(i);for(j.push(e);r(););}finally{d.aborted=l;e=false}if(!j.length){var b=m;o=m=undefined;return b}}var i=arguments.length?Array.prototype.slice.call(arguments):[],e=false;d.add=function(b){e?e.insert(0,b):i.unshift(b);return d};d.insert=function(b,
f){e?e.insert(b,f):i.splice(b,0,f);return d};d.remove=function(b){if(typeof b==="number"){e?e.remove(b):i.splice(b,1);return b}for(var f=i.length;f--;)if(i[f]===b){e?e.remove(f):i.splice(f,1);return f}return-1};d.size=function(){return i.length};d.get=function(b){if(b<0||b>i.length)throw Error("Index out of bounds");return i[b]};return d}var l=false,o,m,j=[];Hub.stopPropagation=function(){l=true;j.length=0};Hub.propagate=function(){r()};Hub.chain=q;Hub.sortedChain=function(d){if(!d)throw Error("comparator is "+
d);var i=q(),e=i.remove,b=[];i.add=function(f,n){if(typeof n==="undefined")throw Error("Expected 2 arguments");for(var a=0,c=b.length;a<c;a++)if(d(n,b[a])<=0){b.splice(a,0,n);i.insert(a,f);return i}i.insert(b.length,f);b.push(n);return i};i.remove=function(f){f=e(f);f!==-1&&f<b.length&&b.splice(f,1);return f};return i};Hub.multiChain=function(d,i){function e(){for(var b,f=0,n=i.length;f<n;f++){var a=i[f];b=Hub.util.merge(b,a.apply(null,arguments));if(a.aborted)break}return b}if(typeof d!=="function")throw Error("First argument not function");
i||(i=[]);e.add=function(b,f){i[d(f)].add(b,f);return e};e.remove=function(b,f){return i[d(f)].remove(b)};e.get=function(b,f){return i[d(f)].get(b)};e.getChain=function(b){return i[b]};e.size=function(b){return i[d(b)].size()};return e}})();(function(){function r(j){var d=l[j];if(d)return d;d=o[j];if(!d)throw Error("Peer is not defined: "+j);d=q(d);var i={},e;for(e in d){var b=d[e];if(typeof b==="function")i[e]=Hub.multiChain(Hub.noop,[Hub.subscriberChain(j+"/"+e),b])}d.api=i;return d}function q(j){for(var d={},i=j.is,e=0,b;b=i[e++];){var f=d;b=r(b);var n=void 0;for(n in b){var a=b[n],c=f[n];c||(f[n]=c=Hub.chain());c.add(a)}}j=j.instance||j.factory();for(var h in j){i=j[h];(e=d[h])||(d[h]=e=Hub.chain());e.add(i)}return d}var l={},o=
{},m=[];Hub.peer=function(j,d,i){if(o[j])throw Error("Hub - peer already defined: "+j);if(!i){i=d;d=null}d={is:d?typeof d==="string"?[d]:d:m};if(typeof i==="function")d.factory=i;else{d.instance=i;i=l[j]=q(d);var e=i.api={},b;for(b in i){var f=i[b];if(typeof f==="function"){var n=j+"/"+b;Hub.subscribe(n,f);e[b]=Hub.publisher(n)}}}o[j]=d};Hub.get=function(j){return r(j).api};Hub.resetPeers=function(){l={};for(var j in o)j.indexOf("lib.")===-1&&delete o[j]}})();(function(){function r(a){return function(){i(Hub.util.substitute(a,arguments),arguments)}}function q(a){var c=typeof a;if(c!=="string")throw Error("Topic is not string: "+c);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function l(a){var c=f[a];if(!c){c=f;var h=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");c=c[a]={re:RegExp("^"+h+"$"),chain:Hub.chain()};m(b,c.chain,c.re,
null)}return c}function o(a,c,h,g){for(var k in a){var p=a[k];if((h||p.re).test(g))p.chain.add(c,g)}}function m(a,c,h,g){for(var k in a){var p=a[k];if((h||p.re).test(g||k))c.add(p.chain,k)}}function j(a,c){b[a]={chain:c};return c}function d(a){q(a);var c=Hub.sortedChain(Hub.topicComparator);j(a,c);m(f,c,null,a);return c}function i(a,c){var h=Hub.subscriberChain(a);try{return h.apply(null,c)}catch(g){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:g.message});
}}function e(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var b={},f={},n=[];Hub.topicComparator=function(a,c){var h=a.indexOf("*"),g=c.indexOf("*");if(h===-1)return g===-1?0:1;if(g===-1)return-1;var k=a.indexOf("/"),p=c.indexOf("/");if(h<k){if(g>p)return-1}else if(g<p)return 1;return 0};Hub.reset=function(){b={};f={};Hub.resetPeers()};Hub.subscribe=function(a,c){e(c);var h=a.indexOf("*")!==-1,g;if(g=b[a])g=g.chain;else{if(h){g=l(a);g.chain.add(c);o(b,c,g.re,a);return}g=
d(a)}h||o(f,c,null,a);g.add(c,a)};Hub.unsubscribe=function(a,c){e(c);var h=b[a];if(!h){q(a);return false}h.chain.remove(c);for(var g in f){h=f[g];h.re.test(a)&&h.chain.remove(c)}return true};Hub.subscriberChain=function(a){var c=b[a];if(c)return c.chain;if(a.indexOf("{")!==-1)return j(a,r(a));if(a.indexOf("*")===-1)return d(a);return l(a).chain};Hub.invoke=function(a){var c=arguments.length>1?Array.prototype.slice.call(arguments,1):n;return i(a,c)};Hub.forward=function(a,c,h,g){if(typeof a==="object")for(var k in a){c=
a[k];typeof c==="string"?Hub.subscribe(k,Hub.publisher(c)):Hub.subscribe(k,Hub.publisher(c[0],c[1],c[2]))}else Hub.subscribe(a,Hub.publisher(c,h,g))};Hub.publisher=function(a,c,h){if(typeof a==="string"){if(c){if(h)return function(){return Hub.publish(a,Hub.util.merge(c.apply(null,arguments),h))};if(typeof c==="function")return function(){return Hub.publish(a,c.apply(null,arguments))};return function(s){return Hub.publish(a,Hub.util.merge(s,c))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,
[a].concat(Array.prototype.slice.call(arguments)));return Hub.publish(a)}}var g=Hub.chain(),k;for(k in a){var p=a[k];g[k]=typeof p==="string"?Hub.publisher(p):Hub.publisher.apply(Hub,p);g.add(g[k])}return g};Hub.Error=function(a,c,h){this.type=a;this.context=h;this.toString=function(){return Hub.util.substitute(c,h)}};Hub.util.merge=function(a,c){if(a===undefined||a===null||a===c)return c;if(c===undefined||c===null)return a;var h=Object.prototype.toString,g=h.call(c);h=h.call(a);if(h===g){if(g===
"[object Object]"){for(var k in c)a[k]=arguments.callee(a[k],c[k]);return a}if(g==="[object Array]")return a.concat(c)}throw new Hub.Error("validation",h===g?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:a,source:c,targetType:h,sourceType:g});};Hub.util.resolve=function(a,c,h){var g=c.indexOf(".");if(g!==-1){var k=c.substring(0,g);if(k in a)return arguments.callee(a[k],c.substring(g+1),h);return h}return c in a?a[c]:h};Hub.util.substitute=function(a,
c,h){if(h===undefined)h="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,c?function(g,k){return Hub.util.resolve(c,k,h)}:function(){return h})}})();(function(){function r(e,b){try{e(b)}catch(f){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:f.message}))}}function q(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function l(e){return function(){e.reject({type:"timeout"})}}function o(e,b,f){var n,a,c=!(b instanceof Hub.Error),h;h={then:function(g,k){if(e){var p=c?g:k;p&&r(p,b)}else{g&&n.push(g);k&&a.push(k)}return this},publish:function(g){if(e){b=
Hub.invoke.apply(Hub,arguments);return this}var k=[g];if(arguments.length>1)k=k.concat(arguments);return this.then(function(){b=Hub.invoke.apply(Hub,k)})},publishResult:function(g){if(e){b=Hub.invoke(g,b);return this}return this.then(function(){b=Hub.invoke(g,b)})},fulfill:function(g){if(e)q();else{e=true;clearTimeout(f);for(b=Hub.util.merge(b,g);n.length;)r(n.shift(),b)}return this},reject:function(g){if(e)q();else{e=true;c=false;for(clearTimeout(f);a.length;)r(a.shift(),g)}return this},fulfilled:function(){return e}};
if(!e){n=[];a=[];f=setTimeout(l(h),f||6E4)}return h}function m(e,b){function f(){if(++h===2)(k?g.fulfill:g.reject)(c)}function n(p){if(k)c=Hub.util.merge(c,p);f()}function a(p){if(k){k=false;c=p}else c=Hub.util.merge(c,p);f()}var c,h=0,g=o(false),k=true;e.then(n,a);b.then(n,a);return g}function j(e){var b=o(true);e.then=b.then;e.publish=b.publish;e.publishResult=b.publishResult;return b}var d=true,i=function(){};i.prototype={then:function(e,b){return j(this).then(e,b)},publish:function(){return j(this).publish.apply(null,
arguments)},publishResult:function(){return j(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},reject:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var e=d;d=false;var b;try{b=Hub.invoke.apply(this,arguments)}catch(f){if(d&&f instanceof Hub.Error){d.reject(f);return d}throw f;}if(typeof b!=="undefined"){b=o(true,b);d=d?m(d,b):b}b=d;d=e;return b||new i};Hub.promise=
function(e){e=o(false,undefined,e);if(d===true)return e;if(d===false)return d=e;d=m(d,e);return e}})();
