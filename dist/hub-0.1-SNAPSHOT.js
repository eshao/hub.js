/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(f,c){if(f===undefined||f===null||f===c)return c;if(c===undefined||c===null)return f;var b=Object.prototype.toString,d=b.call(c);b=b.call(f);var e;if(b===d){if(d==="[object Object]"){for(e in c)if(c.hasOwnProperty(e))f[e]=hub.merge(f[e],c[e]);return f}if(d==="[object Array]")return f.concat(c)}throw new hub.Error("validation",b===d?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:f,source:c,targetType:b,sourceType:d});};
hub.resolve=function(f,c,b){for(var d=c.indexOf(".");d!==-1;){var e=c.substring(0,d);if(!f.hasOwnProperty(e))return b;f=f[e];c=c.substring(d+1);d=c.indexOf(".")}return f.hasOwnProperty(c)?f[c]:b};hub.substitute=function(f,c,b){if(b===undefined)b="";return f.replace(/\{([a-zA-Z0-9\.]+)\}/g,c?function(d,e){return hub.resolve(c,e,b)}:function(){return b})};hub.Error=function(f,c,b){this.type=f;this.context=b;this.toString=function(){return hub.substitute(c,b)}};
hub.iterator=function(f){function c(){if(b>=d)throw Error("Iterator out of bounds.");var e=f[b++];c.hasNext=b<d;return e}var b=0,d=f.length;c.hasNext=b<d;c.remove=function(e){var g=typeof e;if(g==="undefined")e=b;else if(g==="number")e<b&&b--;else{for(g=f.length-1;g>=0;g--)if(f[g]===e){e=g;break}if(g<0)return false}if(e>=d)return false;f.splice(e,1);c.hasNext=b<--d;return true};c.insert=function(e,g){if(typeof g==="undefined"){g=e;e=b}else e<b&&b++;f.splice(e,0,g);c.hasNext=b<++d};c.reset=function(){b=
0;c.hasNext=b<d};return c};
(function(){function f(){var l=g.length;if(!l)return false;l=g[l-1];if(!l.hasNext){g.pop();return f()}l=l().apply(b,d);e=hub.merge(e,l);return true}var c=false,b,d,e,g=[];hub.stopPropagation=function(){c=true;g.length=0;if(arguments.length)e=arguments[0]};hub.propagate=function(){f()};hub.chain=function(){function l(){l.aborted=false;var i=!g.length;if(i){c=false;d=arguments;e=undefined}var j=b;b=this;try{g.push(a);var n=true;do n=f();while(n)}finally{l.aborted=c;a.reset();if(i)g.length=0;b=j}if(!g.length){i=
e;b=d=e=undefined;return i}}var a=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);l.add=function(i){a.insert(0,i)};l.insert=a.insert;l.remove=a.remove;return l}})();(function(){hub.mix=function(f,c){for(var b in c)if(c.hasOwnProperty(b)&&typeof c[b]==="function"){var d=f,e=b,g=c[b],l=d[e];if(l)if(l.add)l.add(g);else d[e]=hub.chain(g,d[e]);else d[e]=g}return f}})();
(function(){hub.object=function(f,c){if(typeof f!=="function")throw new TypeError;var b={},d={mix:function(){var e=hub.get.apply(hub,arguments);hub.mix(b,e)}};d=c?f.apply(d,c):f.call(d);return hub.mix(b,d)}})();
(function(){function f(a,i,j){return function(){var n=Array.prototype.slice.call(arguments);n=hub.publish.apply(hub,[a].concat(n));hub.aborted()||(n=hub.merge(n,i.apply(j,arguments)));return n}}function c(a,i){var j=d[a];if(j)return j;j=e[a];if(!j)throw Error("Peer is not defined: "+a);j=l(j,i);var n={},r;for(r in j)if(j.hasOwnProperty(r)){var q=j[r];if(typeof q==="function")n[r]=f(a+"/"+r,q,n)}j.api=n;return j}function b(a,i){return function(){return a.apply(i,arguments)}}var d={},e={},g=[],l;l=
function(a,i){var j={},n=a.is,r,q;r=0;for(q=n.length;r<q;r++)hub.mix(j,c(n[r]));(n=a.instance)||(n=hub.object(a.factory,i));hub.mix(j,n);return j};hub.peer=function(a,i,j){if(e[a])throw Error("hub - peer already defined: "+a);if(!j){j=i;i=null}i={is:i?typeof i==="string"?[i]:i:g};if(typeof j==="function")i.factory=j;else{i.instance=j;j=d[a]=l(i);var n=j.api={},r;for(r in j)if(j.hasOwnProperty(r)){var q=j[r];if(typeof q==="function"){var h=a+"/"+r;hub.subscribe(h,b(q,n));n[r]=hub.publisher(h)}}}e[a]=
i};hub.get=function(a){var i=arguments.length===1?g:Array.prototype.slice.call(arguments,1);return c(a,i).api};hub.resetPeers=function(){d={};for(var a in e)e.hasOwnProperty(a)&&a.indexOf("lib.")===-1&&delete e[a]}})();
(function(){function f(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+a+"$")}function c(a,i){var j=a.indexOf("*"),n=i.indexOf("*");if(j===-1)return n===-1?0:1;if(n===-1)return-1;var r=a.indexOf("/"),q=i.indexOf("/");if(j<r){if(n>q)return-1}else if(n<q)return 1;return 0}function b(a,i){function j(h,k,o){h||(h=a);if(h!==g&&!n.test(h)){if(h.indexOf("*")===-1||!f(h).test(a))return;h=g}var m=k&&k.length?r.apply(this,
k):r.call(this);if(r.aborted){j.aborted=true;return m}if(o){var p,s;p=0;for(s=q.length;p<s;p++)o.push(q[p])}else o=q.slice();for(;o.length;){p=o.shift();s=p.call(this,h,k,o);m=hub.merge(m,s);if(p.aborted){j.aborted=true;break}}return m}a||(a=g);var n=f(a),r=hub.chain(),q=i?[i]:[];j.matches=function(h){return n.test(h)};j.getTopic=function(){return a};j.add=function(h,k,o){if(a===k)r.add(h);else{var m,p,s;p=0;for(s=q.length;p<s;p++){m=q[p];if(m.matches(k)){m.add(h,k,o);return}o||(o=f(k));if(o.test(m.getTopic())){m=
b(k,m);m.add(h,k,o);q[p]=m;return}}m=b(k);m.add(h,k);if(k.indexOf("*")===-1)q.unshift(m);else{p=0;for(s=q.length;p<s;p++){h=q[p].getTopic();if(c(h,k)!==-1){q.splice(p,0,m);return}}q.push(m)}}};j.remove=function(h,k){if(a===k)return r.remove(h);var o,m,p;o=0;for(m=q.length;o<m;o++){p=q[o];if(p.matches(k))if(p.remove(h,k))return true}return false};return j}function d(a){var i=typeof a;if(i!=="string")throw Error("Topic is "+i);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+
a);}function e(a){a=typeof a;if(a!=="function")throw Error("Callback is "+a);}var g="**/**",l=b();hub.topicChain=b;hub.topicComparator=c;hub.reset=function(){l=b();hub.resetPeers();hub.resetPromise()};hub.subscribe=function(a,i){e(i);d(a);l.add(i,a)};hub.unsubscribe=function(a,i){e(i);d(a);return l.remove(i,a)};hub.invoke=function(a){d(a);var i=Array.prototype.slice.call(arguments,1);if(a.indexOf("{")!==-1)a=hub.substitute(a,i);try{return l(a,i)}catch(j){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',
{topic:a,error:j.message});}};hub.aborted=function(){return Boolean(l.aborted)}})();
(function(){function f(h,k,o){var m;try{m=h.apply(null,k)}catch(p){hub.invoke("hub.error/promise.callback",new hub.Error("error","Error in promise callback: ${error}",{error:p.message}));return}if(o){if(m===undefined)return k;return[m]}}function c(){hub.invoke("hub.error/promise.resolved",new hub.Error("validation","Promise already resolved"))}function b(h){return function(){h.reject({type:"timeout"})}}function d(h,k,o){var m,p,s=!(k instanceof hub.Error),t=k===undefined?[]:[k],w;w={then:function(u,
v){if(h){var x=s?u:v;if(x)t=f(x,t,true)}else{u&&m.push(u);v&&p.push(v)}return this},publish:function(){if(h){t=[hub.invoke.apply(hub,arguments)];return this}var u=j.call(arguments);return this.then(function(){t=[hub.invoke.apply(hub,u)]})},publishResult:function(u){if(h){t=[hub.invoke.apply(hub,[u].concat(t))];return this}return this.then(function(){t=[hub.invoke.apply(hub,[u].concat(t))]})},resolve:function(){if(h)c();else{h=true;clearTimeout(o);if(arguments.length!==0)t=j.call(arguments);for(;m.length;)f(m.shift(),
t)}return this},reject:function(u){if(h)c();else{h=true;s=false;for(clearTimeout(o);p.length;){var v=p.shift();f(v,[u])}}return this},resolved:function(){return h},join:function(u){return n(w,u)}};if(!h){m=[];p=[];o=setTimeout(b(w),o||6E4)}return w}function e(h){var k=d(true);h.then=k.then;h.publish=k.publish;h.publishResult=k.publishResult;return k}var g=true,l=Array.prototype,a=l.unshift,i=l.push,j=l.slice,n;n=function(h,k){function o(){if(++p===2)(t?s.resolve:s.reject).apply(null,m)}var m=[],p=
0,s=d(false),t=true;h.then(function(){a.apply(m,arguments);o()},function(){a.apply(m,arguments);t=false;o()});k.then(function(){i.apply(m,arguments);o()},function(){i.apply(m,arguments);t=false;o()});return s};var r=Error("hub - promise already resolved"),q=function(){};q.prototype={then:function(h,k){return e(this).then(h,k)},publish:function(){return e(this).publish.apply(null,arguments)},publishResult:function(){return e(this).publishResult.apply(null,arguments)},resolve:function(){throw r;},reject:function(){throw r;
},resolved:function(){return true},join:function(h){return e(this).join(h)}};hub.publish=function(){var h=g;g=false;var k;try{k=hub.invoke.apply(this,arguments)}catch(o){if(g&&o instanceof hub.Error){g.reject(o);return g}throw o;}if(typeof k!=="undefined"){k=d(true,k);g=g?n(g,k):k}k=g;g=h;return k||new q};hub.promise=function(h){h=d(false,undefined,h);if(g===false)g=h;else if(g!==true)g=n(g,h);return h};hub.resetPromise=function(){typeof g!=="boolean"&&g.reject();g=true}})();
(function(){var f=hub.publish,c=hub.merge;hub.publisher=function(b,d,e){if(typeof b==="string"){if(d){if(e)return function(){return f(b,c(d.apply(null,arguments),e))};if(typeof d==="function")return function(){return f(b,d.apply(null,arguments))};return function(i){return f(b,c(i,d))}}return function(){if(arguments.length)return f.apply(hub,[b].concat(Array.prototype.slice.call(arguments)));return f(b)}}var g=hub.chain(),l;for(l in b)if(b.hasOwnProperty(l)){var a=b[l];g[l]=typeof a==="string"?hub.publisher(a):
hub.publisher.apply(hub,a);g.add(g[l])}return g}})();(function(){var f=hub.publisher,c=hub.subscribe;hub.forward=function(b,d,e,g){if(typeof b==="object")for(var l in b){if(b.hasOwnProperty(l)){d=b[l];typeof d==="string"?c(l,f(d)):c(l,f(d[0],d[1],d[2]))}}else c(b,f(d,e,g))}})();
