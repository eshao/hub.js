/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{},noop:function(){}};Hub.iterator=function(r){function q(){if(l>=o)throw Error("Iterator out of bounds.");var m=r[l++];q.hasNext=l<o;return m}var l=0,o=r.length;q.hasNext=l<o;q.remove=function(m){if(typeof m==="undefined")m=l;else m<l&&l--;r.splice(m,1);q.hasNext=l<--o};q.insert=function(m,j){if(typeof j==="undefined"){j=m;m=l}else m<l&&l++;r.splice(m,0,j);q.hasNext=l<++o};return q};(function(){function r(){var d=j.length;if(!d)return false;d=j[d-1];if(!d.hasNext){j.pop();return r()}m=Hub.util.merge(m,d().apply(null,o));return true}function q(){function d(){d.aborted=false;if(!j.length){l=false;o=arguments}m=undefined;try{e=Hub.iterator(i);for(j.push(e);r(););}finally{d.aborted=l;e=false}if(!j.length){var c=m;o=m=undefined;return c}}var i=arguments.length?Array.prototype.slice.call(arguments):[],e=false;d.add=function(c){e?e.insert(0,c):i.unshift(c);return d};d.insert=function(c,
g){e?e.insert(c,g):i.splice(c,0,g);return d};d.remove=function(c){if(typeof c==="number"){e?e.remove(c):i.splice(c,1);return c}for(var g=i.length;g--;)if(i[g]===c){e?e.remove(g):i.splice(g,1);return g}return-1};d.size=function(){return i.length};d.get=function(c){if(c<0||c>i.length)throw Error("Index out of bounds");return i[c]};return d}var l=false,o,m,j=[];Hub.stopPropagation=function(){l=true;j.length=0};Hub.propagate=function(){r()};Hub.chain=q;Hub.sortedChain=function(d){if(!d)throw Error("comparator is "+
d);var i=q(),e=i.remove,c=[];i.add=function(g,n){if(typeof n==="undefined")throw Error("Expected 2 arguments");for(var a=0,b=c.length;a<b;a++)if(d(n,c[a])<=0){c.splice(a,0,n);i.insert(a,g);return i}i.insert(c.length,g);c.push(n);return i};i.remove=function(g){g=e(g);g!==-1&&g<c.length&&c.splice(g,1);return g};return i};Hub.multiChain=function(d,i){function e(){for(var c,g=0,n=i.length;g<n;g++){var a=i[g];c=Hub.util.merge(c,a.apply(null,arguments));if(a.aborted)break}return c}if(typeof d!=="function")throw Error("First argument not function");
i||(i=[]);e.add=function(c,g){i[d(c)].add(g);return e};e.remove=function(c,g){return i[d(c)].remove(g)};e.get=function(c,g){return i[d(c)].get(g)};e.size=function(c){return i[d(c)].size()};return e}})();(function(){function r(j){var d=l[j];if(d)return d;d=o[j];if(!d)throw Error("Peer is not defined: "+j);d=q(d);var i={},e;for(e in d){var c=d[e];if(typeof c==="function")i[e]=Hub.multiChain(Hub.noop,[Hub.subscriberChain(j+"/"+e),c])}d.api=i;return d}function q(j){for(var d={},i=j.is,e=0,c;c=i[e++];){var g=d;c=r(c);var n=void 0;for(n in c){var a=c[n],b=g[n];b||(g[n]=b=Hub.chain());b.add(a)}}j=j.instance||j.factory();for(var h in j){i=j[h];(e=d[h])||(d[h]=e=Hub.chain());e.add(i)}return d}var l={},o=
{},m=[];Hub.peer=function(j,d,i){if(o[j])throw Error("Hub - peer already defined: "+j);if(!i){i=d;d=null}d={is:d?typeof d==="string"?[d]:d:m};if(typeof i==="function")d.factory=i;else{d.instance=i;i=l[j]=q(d);var e=i.api={},c;for(c in i){var g=i[c];if(typeof g==="function"){var n=j+"/"+c;Hub.subscribe(n,g);e[c]=Hub.publisher(n)}}}o[j]=d};Hub.get=function(j){return r(j).api};Hub.resetPeers=function(){l={};for(var j in o)j.indexOf("lib.")===-1&&delete o[j]}})();(function(){function r(a){return function(){i(Hub.util.substitute(a,arguments),arguments)}}function q(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function l(a){var b=g[a];if(!b){b=g;var h=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");b=b[a]={re:RegExp("^"+h+"$"),chain:Hub.chain()};m(c,b.chain,b.re,
null)}return b}function o(a,b,h,f){for(var k in a){var p=a[k];if((h||p.re).test(f))p.chain.add(b,f)}}function m(a,b,h,f){for(var k in a){var p=a[k];if((h||p.re).test(f||k))b.add(p.chain,k)}}function j(a,b){c[a]={chain:b};return b}function d(a){q(a);var b=Hub.sortedChain(Hub.config.topicComparator);j(a,b);m(g,b,null,a);return b}function i(a,b){var h=Hub.subscriberChain(a);try{return h.apply(null,b)}catch(f){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:f.message});
}}function e(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var c={},g={},n=[];Hub.config={topicComparator:function(a,b){var h=a.indexOf("*"),f=b.indexOf("*");if(h===-1)return f===-1?0:1;if(f===-1)return-1;var k=a.indexOf("/"),p=b.indexOf("/");if(h<k){if(f>p)return-1}else if(f<p)return 1;return 0}};Hub.reset=function(){c={};g={};Hub.resetPeers()};Hub.subscribe=function(a,b){e(b);var h=a.indexOf("*")!==-1,f;if(f=c[a])f=f.chain;else{if(h){f=l(a);f.chain.add(b);o(c,b,f.re,
a);return}f=d(a)}h||o(g,b,null,a);f.add(b,a)};Hub.unsubscribe=function(a,b){e(b);var h=c[a];if(!h){q(a);return false}h.chain.remove(b);for(var f in g){h=g[f];h.re.test(a)&&h.chain.remove(b)}return true};Hub.subscriberChain=function(a){var b=c[a];if(b)return b.chain;if(a.indexOf("{")!==-1)return j(a,r(a));if(a.indexOf("*")===-1)return d(a);return l(a).chain};Hub.invoke=function(a){var b=arguments.length>1?Array.prototype.slice.call(arguments,1):n;return i(a,b)};Hub.forward=function(a,b,h,f){if(typeof a===
"object")for(var k in a){b=a[k];typeof b==="string"?Hub.subscribe(k,Hub.publisher(b)):Hub.subscribe(k,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,h,f))};Hub.publisher=function(a,b,h){if(typeof a==="string"){if(b){if(h)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),h))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(s){return Hub.publish(a,Hub.util.merge(s,b))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,
[a].concat(Array.prototype.slice.call(arguments)));return Hub.publish(a)}}var f=Hub.chain(),k;for(k in a){var p=a[k];f[k]=typeof p==="string"?Hub.publisher(p):Hub.publisher.apply(Hub,p);f.add(f[k])}return f};Hub.Error=function(a,b,h){this.type=a;this.context=h;this.toString=function(){return Hub.util.substitute(b,h)}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var h=Object.prototype.toString,f=h.call(b);h=h.call(a);if(h===f){if(f===
"[object Object]"){for(var k in b)a[k]=arguments.callee(a[k],b[k]);return a}if(f==="[object Array]")return a.concat(b)}throw new Hub.Error("validation",h===f?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:h,sourceType:f});};Hub.util.resolve=function(a,b,h){var f=b.indexOf(".");if(f!==-1){var k=b.substring(0,f);if(k in a)return arguments.callee(a[k],b.substring(f+1),h);return h}return b in a?a[b]:h};Hub.util.substitute=function(a,
b,h){if(h===undefined)h="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(f,k){return Hub.util.resolve(b,k,h)}:function(){return h})}})();(function(){function r(e,c){try{e(c)}catch(g){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:g.message}))}}function q(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function l(e){return function(){e.reject({type:"timeout"})}}function o(e,c,g){var n,a,b=!(c instanceof Hub.Error),h;h={then:function(f,k){if(e){var p=b?f:k;p&&r(p,c)}else{f&&n.push(f);k&&a.push(k)}return this},publish:function(f){if(e){c=
Hub.invoke.apply(Hub,arguments);return this}var k=[f];if(arguments.length>1)k=k.concat(arguments);return this.then(function(){c=Hub.invoke.apply(Hub,k)})},publishResult:function(f){if(e){c=Hub.invoke(f,c);return this}return this.then(function(){c=Hub.invoke(f,c)})},fulfill:function(f){if(e)q();else{e=true;clearTimeout(g);for(c=Hub.util.merge(c,f);n.length;)r(n.shift(),c)}return this},reject:function(f){if(e)q();else{e=true;b=false;for(clearTimeout(g);a.length;)r(a.shift(),f)}return this},fulfilled:function(){return e}};
if(!e){n=[];a=[];g=setTimeout(l(h),g||6E4)}return h}function m(e,c){function g(){if(++h===2)(k?f.fulfill:f.reject)(b)}function n(p){if(k)b=Hub.util.merge(b,p);g()}function a(p){if(k){k=false;b=p}else b=Hub.util.merge(b,p);g()}var b,h=0,f=o(false),k=true;e.then(n,a);c.then(n,a);return f}function j(e){var c=o(true);e.then=c.then;e.publish=c.publish;e.publishResult=c.publishResult;return c}var d=true,i=function(){};i.prototype={then:function(e,c){return j(this).then(e,c)},publish:function(){return j(this).publish.apply(null,
arguments)},publishResult:function(){return j(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},reject:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var e=d;d=false;var c;try{c=Hub.invoke.apply(this,arguments)}catch(g){if(d&&g instanceof Hub.Error){d.reject(g);return d}throw g;}if(typeof c!=="undefined"){c=o(true,c);d=d?m(d,c):c}c=d;d=e;return c||new i};Hub.promise=
function(e){e=o(false,undefined,e);if(d===true)return e;if(d===false)return d=e;d=m(d,e);return e}})();
