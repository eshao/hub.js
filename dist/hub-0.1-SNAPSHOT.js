/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};(function(){function x(){function n(){function f(){if(j<k.length&&!f.stop){f.result=Hub.util.merge(f.result,k[j++].apply(null,h));return true}return false}var h=arguments,u=r;r=f;j=0;try{for(;f(););return f.result}finally{r=u}}var k=arguments.length?Array.prototype.slice.call(arguments):[],j=-1;n.add=function(f){if(typeof f.all==="function"){f=f.all();k=f.concat(k);if(j!==-1)j+=f.length}else{k.unshift(f);j!==-1&&j++}};n.insert=function(f,h){k.splice(f,0,h);f<j&&j++};n.remove=function(f){if(typeof f===
"number"){k.splice(f,1);f<j&&j--;return f}for(var h=k.length;h--;)if(k[h]===f){k.splice(h,1);h<j&&j--;return h}return-1};n.all=function(){return k};return n}var r;Hub.stopPropagation=function(){r.stop=true};Hub.propagate=function(){r();return r.result};Hub.util.chain=x;Hub.util.topicChain=function(){var n=x(),k=n.remove,j=[];n.add=function(f,h){if(typeof f.all==="function")for(var u=f.all(),e=u.length-1;e>=0;e--)n.add(u[e],h);else if(h.indexOf("*")===-1)n.insert(j.length,f);else{e=0;for(u=j.length;e<
u;e++){var g;a:{var p=h,o=j[e];g=p.indexOf("*");var s=o.indexOf("*");p=p.indexOf("/");o=o.indexOf("/");if(g<p){if(s>o){g=-1;break a}}else if(s<o){g=1;break a}g=0}if(g<=0){j.splice(e,0,h);n.insert(e,f);return}}n.insert(j.length,f);j.push(h)}};n.remove=function(f){f=k(f);f!==-1&&f<j.length&&j.splice(f,1);return f};return n}})();(function(){function x(a,b,c){var d=a[b];d||(a[b]=d=Hub.util.chain());d.add(c)}function r(a){var b={};if(a){for(var c=a.is,d=0,i;i=c[d++];){var v=b;i=l[i]||r(m[i]);var y=void 0;for(y in i)x(v,y,i[y])}a=a.instance||a.factory();for(var z in a)x(b,z,a[z])}return b}function n(a){return function(){var b=r(m[a]);k(b,a);try{return Hub.propagate()}finally{for(var c in b){var d=b[c];typeof d==="function"&&Hub.unsubscribe(a+"/"+c,d)}}}}function k(a,b){for(var c in a){var d=a[c];typeof d==="function"&&Hub.subscribe(b+
"/"+c,d)}}function j(a){return function(){o(Hub.util.substitute(a,arguments),arguments)}}function f(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function h(a){var b=t[a];if(!b){b=t;var c=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");b=b[a]={re:RegExp("^"+c+"$"),chain:Hub.util.chain()};e(q,b.chain,b.re,
null)}return b}function u(a,b,c,d){for(var i in a){var v=a[i];if((c||v.re).test(d))v.chain.add(b,d)}}function e(a,b,c,d){for(var i in a){var v=a[i];if((c||v.re).test(d||i))(b||v.chain).add(v.chain,i)}}function g(a,b){q[a]={chain:b};return b}function p(a){f(a);var b=g(a,Hub.util.topicChain());e(t,b,null,a);return b}function o(a,b){var c;c=(c=q[a])?c.chain:a.indexOf("{")!==-1?g(a,j(a)):a.indexOf("*")===-1?p(a):h(a).chain;try{return c.apply(null,b)}catch(d){if(a==="hub.error/publish")throw d;o("hub.error/publish",
[new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:d.message})])}}function s(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var q={},t={},l={},m={},w=[];Hub.reset=function(){q={};t={};l={};for(var a in m)a.indexOf("lib.")===-1&&delete m[a]};Hub.subscribe=function(a,b){s(b);var c=a.indexOf("*")!==-1,d;if(d=q[a])d=d.chain;else{if(c){d=h(a);d.chain.add(b);u(q,b,d.re,a);return}d=p(a)}c||u(t,b,null,a);d.add(b,a)};Hub.unsubscribe=function(a,
b){s(b);var c=q[a];if(!c){f(a);return false}c.chain.remove(b);for(var d in t){c=t[d];c.re.test(a)&&c.chain.remove(b)}return true};Hub.peer=function(a,b,c){if(m[a])throw Error("Hub - peer already defined: "+a);if(!c){c=b;b=null}b={is:b?typeof b==="string"?[b]:b:w};if(typeof c==="function"){b.factory=c;Hub.subscribe(a+"/**",n(a))}else{b.instance=c;c=l[a]=r(b);k(c,a)}m[a]=b};Hub.invoke=function(a){var b=arguments.length>1?Array.prototype.slice.call(arguments,1):w;return o(a,b)};Hub.forward=function(a,
b,c,d){if(typeof a==="object")for(var i in a){b=a[i];typeof b==="string"?Hub.subscribe(i,Hub.publisher(b)):Hub.subscribe(i,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,c,d))};Hub.publisher=function(a,b,c){if(typeof a==="string"){if(b){if(c)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),c))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(y){return Hub.publish(a,Hub.util.merge(y,b))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,
[a].concat(Array.prototype.slice.call(arguments)));return Hub.publish(a)}}var d=Hub.util.chain(),i;for(i in a){var v=a[i];d[i]=typeof v==="string"?Hub.publisher(v):Hub.publisher.apply(Hub,v);d.add(d[i])}return d};Hub.Error=function(a,b,c){return{toString:function(){return Hub.util.substitute(b,this.context)},type:a,context:c||{}}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var c=Object.prototype.toString,d=c.call(b);c=c.call(a);if(c===
d){if(d==="[object Object]"){for(var i in b)a[i]=arguments.callee(a[i],b[i]);return a}if(d==="[object Array]")return a.concat(b)}o("hub.error/util.merge",[new Hub.Error("validation",c===d?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:c,sourceType:d})]);return a};Hub.util.resolve=function(a,b,c){var d=b.indexOf(".");if(d!==-1){var i=b.substring(0,d);if(i in a)return arguments.callee(a[i],b.substring(d+1),c);return c}return b in
a?a[b]:c};Hub.util.substitute=function(a,b,c){if(c===undefined)c="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(d,i){return Hub.util.resolve(b,i,c)}:function(){return c})}})();(function(){function x(e,g){try{e(g)}catch(p){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:p.message}))}}function r(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function n(e){return function(){e.reject({type:"timeout"})}}function k(e,g,p){var o,s,q=true,t;t={then:function(l,m){if(e){var w=q?l:m;w&&x(w,g)}else{l&&o.push(l);m&&s.push(m)}return this},publish:function(l){if(e){g=Hub.invoke.apply(Hub,
arguments);return this}var m=[l];if(arguments.length>1)m=m.concat(arguments);return this.then(function(){g=Hub.invoke.apply(Hub,m)})},publishResult:function(l){if(e){g=Hub.invoke(l,g);return this}return this.then(function(){g=Hub.invoke(l,g)})},fulfill:function(l){if(e)r();else{e=true;clearTimeout(p);for(g=Hub.util.merge(g,l);o.length;)x(o.shift(),g)}return this},reject:function(l){if(e)r();else{e=true;q=false;for(clearTimeout(p);s.length;)x(s.shift(),l)}return this},fulfilled:function(){return e}};
if(!e){o=[];s=[];p=setTimeout(n(t),p||6E4)}return t}function j(e,g){function p(){if(++t===2)(m?l.fulfill:l.reject)(q)}function o(w){if(m)q=Hub.util.merge(q,w);p()}function s(w){if(m){m=false;q=w}else q=Hub.util.merge(q,w);p()}var q,t=0,l=k(false),m=true;e.then(o,s);g.then(o,s);return l}function f(e){var g=k(true);e.then=g.then;e.publish=g.publish;e.publishResult=g.publishResult;return g}var h=true,u=function(){};u.prototype={then:function(e,g){return f(this).then(e,g)},publish:function(){return f(this).publish.apply(null,
arguments)},publishResult:function(){return f(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var e=h;h=false;var g=Hub.invoke.apply(this,arguments);if(typeof g!=="undefined"){g=k(true,g);h=h?j(h,g):g}g=h;h=e;return g||new u};Hub.promise=function(e){e=k(false,undefined,e);if(h===true)return e;if(h===false)return h=e;h=j(h,e);return e}})();
