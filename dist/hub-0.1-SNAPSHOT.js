/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};(function(){function r(){function o(){function g(){if(l<n.length&&!g.stop){g.result=Hub.util.merge(g.result,n[l++].apply(null,k));return true}return false}var k=arguments,i=q;q=g;l=0;try{for(;g(););return g.result}finally{r.aborted=q.stop;q=i}}var n=arguments.length?Array.prototype.slice.call(arguments):[],l=-1;o.add=function(g){if(typeof g.all==="function"){g=g.all();n=g.concat(n);if(l!==-1)l+=g.length}else{n.unshift(g);l!==-1&&l++}};o.insert=function(g,k){n.splice(g,0,k);g<l&&l++};o.remove=function(g){if(typeof g===
"number"){n.splice(g,1);g<l&&l--;return g}for(var k=n.length;k--;)if(n[k]===g){n.splice(k,1);k<l&&l--;return k}return-1};o.all=function(){return n};return o}var q;Hub.stopPropagation=function(){q.stop=true};Hub.propagate=function(){q();return q.result};Hub.util.chain=r;Hub.util.topicChain=function(){var o=r(),n=o.remove,l=[];o.add=function(g,k){if(typeof g.all==="function")for(var i=g.all(),c=i.length-1;c>=0;c--)o.add(i[c],k);else if(k.indexOf("*")===-1)o.insert(l.length,g);else{c=0;for(i=l.length;c<
i;c++){var d;a:{var h=k,m=l[c];d=h.indexOf("*");var a=m.indexOf("*");h=h.indexOf("/");m=m.indexOf("/");if(d<h){if(a>m){d=-1;break a}}else if(a<m){d=1;break a}d=0}if(d<=0){l.splice(c,0,k);o.insert(c,g);return}}o.insert(l.length,g);l.push(k)}};o.remove=function(g){g=n(g);g!==-1&&g<l.length&&l.splice(g,1);return g};return o}})();(function(){function r(i,c,d){var h=i[c];h||(i[c]=h=Hub.util.chain());h.add(d)}function q(i,c){return function(){var d=Hub.subscriberChain(i),h=d.apply(null,arguments);if(d.aborted)return h;return Hub.util.merge(h,c.apply(null,arguments))}}function o(i){var c=l[i];if(c)return c;c=g[i];if(!c)throw Error("Peer is not defined: "+i);c=n(c);var d={},h;for(h in c){var m=c[h];if(typeof m==="function")d[h]=q(i+"/"+h,m)}c.api=d;return c}function n(i){for(var c={},d=i.is,h=0,m;m=d[h++];){var a=c;m=o(m);var b=
void 0;for(b in m)r(a,b,m[b])}i=i.instance||i.factory();for(var f in i)r(c,f,i[f]);return c}var l={},g={},k=[];Hub.peer=function(i,c,d){if(g[i])throw Error("Hub - peer already defined: "+i);if(!d){d=c;c=null}c={is:c?typeof c==="string"?[c]:c:k};if(typeof d==="function")c.factory=d;else{c.instance=d;d=l[i]=n(c);var h=d.api={},m;for(m in d){var a=d[m];if(typeof a==="function"){var b=i+"/"+m;Hub.subscribe(b,a);h[m]=Hub.publisher(b)}}}g[i]=c};Hub.get=function(i){return o(i).api};Hub.resetPeers=function(){l=
{};for(var i in g)i.indexOf("lib.")===-1&&delete g[i]}})();(function(){function r(a){return function(){i(Hub.util.substitute(a,arguments),arguments)}}function q(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function o(a){var b=h[a];if(!b){b=h;var f=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");b=b[a]={re:RegExp("^"+f+"$"),chain:Hub.util.chain()};l(d,b.chain,
b.re,null)}return b}function n(a,b,f,e){for(var j in a){var p=a[j];if((f||p.re).test(e))p.chain.add(b,e)}}function l(a,b,f,e){for(var j in a){var p=a[j];if((f||p.re).test(e||j))(b||p.chain).add(p.chain,j)}}function g(a,b){d[a]={chain:b};return b}function k(a){q(a);var b=g(a,Hub.util.topicChain());l(h,b,null,a);return b}function i(a,b){var f=Hub.subscriberChain(a);try{return f.apply(null,b)}catch(e){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:e.message});
}}function c(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var d={},h={},m=[];Hub.reset=function(){d={};h={};Hub.resetPeers()};Hub.subscribe=function(a,b){c(b);var f=a.indexOf("*")!==-1,e;if(e=d[a])e=e.chain;else{if(f){e=o(a);e.chain.add(b);n(d,b,e.re,a);return}e=k(a)}f||n(h,b,null,a);e.add(b,a)};Hub.unsubscribe=function(a,b){c(b);var f=d[a];if(!f){q(a);return false}f.chain.remove(b);for(var e in h){f=h[e];f.re.test(a)&&f.chain.remove(b)}return true};Hub.subscriberChain=
function(a){var b=d[a];if(b)return b.chain;if(a.indexOf("{")!==-1)return g(a,r(a));if(a.indexOf("*")===-1)return k(a);return o(a).chain};Hub.invoke=function(a){var b=arguments.length>1?Array.prototype.slice.call(arguments,1):m;return i(a,b)};Hub.forward=function(a,b,f,e){if(typeof a==="object")for(var j in a){b=a[j];typeof b==="string"?Hub.subscribe(j,Hub.publisher(b)):Hub.subscribe(j,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,f,e))};Hub.publisher=function(a,b,f){if(typeof a===
"string"){if(b){if(f)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),f))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(s){return Hub.publish(a,Hub.util.merge(s,b))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,[a].concat(Array.prototype.slice.call(arguments)));return Hub.publish(a)}}var e=Hub.util.chain(),j;for(j in a){var p=a[j];e[j]=typeof p==="string"?Hub.publisher(p):Hub.publisher.apply(Hub,
p);e.add(e[j])}return e};Hub.Error=function(a,b,f){this.type=a;this.context=f;this.toString=function(){return Hub.util.substitute(b,f)}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var f=Object.prototype.toString,e=f.call(b);f=f.call(a);if(f===e){if(e==="[object Object]"){for(var j in b)a[j]=arguments.callee(a[j],b[j]);return a}if(e==="[object Array]")return a.concat(b)}throw new Hub.Error("validation",f===e?"Cannot merge value {target} with {source}":
"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:f,sourceType:e});};Hub.util.resolve=function(a,b,f){var e=b.indexOf(".");if(e!==-1){var j=b.substring(0,e);if(j in a)return arguments.callee(a[j],b.substring(e+1),f);return f}return b in a?a[b]:f};Hub.util.substitute=function(a,b,f){if(f===undefined)f="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(e,j){return Hub.util.resolve(b,j,f)}:function(){return f})}})();(function(){function r(c,d){try{c(d)}catch(h){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:h.message}))}}function q(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function o(c){return function(){c.reject({type:"timeout"})}}function n(c,d,h){var m,a,b=!(d instanceof Hub.Error),f;f={then:function(e,j){if(c){var p=b?e:j;p&&r(p,d)}else{e&&m.push(e);j&&a.push(j)}return this},publish:function(e){if(c){d=
Hub.invoke.apply(Hub,arguments);return this}var j=[e];if(arguments.length>1)j=j.concat(arguments);return this.then(function(){d=Hub.invoke.apply(Hub,j)})},publishResult:function(e){if(c){d=Hub.invoke(e,d);return this}return this.then(function(){d=Hub.invoke(e,d)})},fulfill:function(e){if(c)q();else{c=true;clearTimeout(h);for(d=Hub.util.merge(d,e);m.length;)r(m.shift(),d)}return this},reject:function(e){if(c)q();else{c=true;b=false;for(clearTimeout(h);a.length;)r(a.shift(),e)}return this},fulfilled:function(){return c}};
if(!c){m=[];a=[];h=setTimeout(o(f),h||6E4)}return f}function l(c,d){function h(){if(++f===2)(j?e.fulfill:e.reject)(b)}function m(p){if(j)b=Hub.util.merge(b,p);h()}function a(p){if(j){j=false;b=p}else b=Hub.util.merge(b,p);h()}var b,f=0,e=n(false),j=true;c.then(m,a);d.then(m,a);return e}function g(c){var d=n(true);c.then=d.then;c.publish=d.publish;c.publishResult=d.publishResult;return d}var k=true,i=function(){};i.prototype={then:function(c,d){return g(this).then(c,d)},publish:function(){return g(this).publish.apply(null,
arguments)},publishResult:function(){return g(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},reject:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var c=k;k=false;var d;try{d=Hub.invoke.apply(this,arguments)}catch(h){if(h instanceof Hub.Error)d=h;else throw h;}if(typeof d!=="undefined"){d=n(true,d);k=k?l(k,d):d}d=k;k=c;return d||new i};Hub.promise=function(c){c=n(false,
undefined,c);if(k===true)return c;if(k===false)return k=c;k=l(k,c);return c}})();
