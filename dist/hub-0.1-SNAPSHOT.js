/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(c,a){if(c===undefined||c===null||c===a)return a;if(a===undefined||a===null)return c;var b=Object.prototype.toString,e=b.call(a);b=b.call(c);var g;if(b===e){if(e==="[object Object]"){for(g in a)if(a.hasOwnProperty(g))c[g]=hub.merge(c[g],a[g]);return c}if(e==="[object Array]")return c.concat(a)}throw new hub.Error("validation",b===e?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:c,source:a,targetType:b,sourceType:e});};
hub.resolve=function(c,a,b){for(var e=a.indexOf(".");e!==-1;){var g=a.substring(0,e);if(!c.hasOwnProperty(g))return b;c=c[g];a=a.substring(e+1);e=a.indexOf(".")}return c.hasOwnProperty(a)?c[a]:b};hub.substitute=function(c,a,b){if(b===undefined)b="";return c.replace(/\{([a-zA-Z0-9\.]+)\}/g,a?function(e,g){return hub.resolve(a,g,b)}:function(){return b})};hub.Error=function(c,a,b){this.type=c;this.context=b;this.toString=function(){return hub.substitute(a,b)}};
hub.iterator=function(c){function a(){if(b>=e)throw Error("Iterator out of bounds.");var g=c[b++];a.hasNext=b<e;return g}var b=0,e=c.length;a.hasNext=b<e;a.remove=function(g){var d=typeof g;if(d==="undefined")g=b;else if(d==="number")g<b&&b--;else{for(d=c.length-1;d>=0;d--)if(c[d]===g){g=d;break}if(d<0)return false}if(g>=e)return false;c.splice(g,1);a.hasNext=b<--e;return true};a.insert=function(g,d){if(typeof d==="undefined"){d=g;g=b}else g<b&&b++;c.splice(g,0,d);a.hasNext=b<++e};a.reset=function(){b=
0;a.hasNext=b<e};return a};
(function(){function c(){var l=d.length;if(!l)return false;l=d[l-1];if(!l.hasNext){d.pop();return c()}l=l().apply(b,e);g=hub.merge(g,l);return true}var a=false,b,e,g,d=[];hub.stopPropagation=function(){a=true;d.length=0;if(arguments.length)g=arguments[0]};hub.propagate=function(){if(arguments.length)g=arguments[0];c()};hub.aborted=function(){return a};hub.chain=function(){function l(){var f=!d.length;if(f){a=false;e=arguments;g=undefined}var o=b;b=this;d.push(r);try{for(;;)if(!c())break}finally{r.reset();if(f)d.length=
0;b=o}if(!d.length){f=g;b=e=g=undefined;return f}}var r=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);l.add=function(f){var o=typeof f;if(o!=="function")throw new TypeError("Callback is "+o);r.insert(0,f)};l.insert=r.insert;l.remove=r.remove;return l}})();(function(){hub.mix=function(c,a){for(var b in a)if(a.hasOwnProperty(b)&&typeof a[b]==="function"){var e=c,g=b,d=a[b],l=e[g];if(l)if(l.add)l.add(d);else e[g]=hub.chain(d,e[g]);else e[g]=d}return c}})();
(function(){hub.create=function(c,a,b){if(typeof c!=="string"){b=a;a=c;c=null}if(typeof a!=="function")throw new TypeError;var e={},g={mix:function(){hub.publish.apply(hub,arguments).then(function(d){hub.mix(e,d)})},subscribe:function(d,l){if(!c)throw new TypeError("namespace is "+c);if(!d)throw new TypeError("messsage is "+d);hub.subscribe(c+"."+d,l)}};a=b?a.apply(g,b):a.call(g);return hub.mix(e,a)}})();
(function(){function c(f){f=f.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+f+"$")}function a(f){var o=typeof f;if(o!=="string")throw Error("Topic is "+o);if(!f)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(f))throw Error("Illegal topic: "+f);}function b(f,o){var q=f.indexOf("*"),t=o.indexOf("*");if(q===-1)return t===-1?0:1;if(t===-1)return-1;var u=f.indexOf("."),i=o.indexOf(".");if(q<u){if(t>
i)return-1}else if(t<i)return 1;return 0}function e(f,o){function q(h,j,k){h||(h=f);if(h!==l&&!t.test(h)){if(h.indexOf("*")===-1||!c(h).test(f))return;h=l}var m=j&&j.length?u.apply(this,j):u.call(this);if(u.aborted){q.aborted=true;return m}if(k){var n,p;n=0;for(p=i.length;n<p;n++)k.push(i[n])}else k=i.slice();for(;k.length;){n=k.shift();p=n.call(this,h,j,k);m=hub.merge(m,p);if(n.aborted){q.aborted=true;break}}return m}if(f)a(f);else f=l;var t=c(f),u=hub.chain(),i=o?[o]:[];q.matches=function(h){return t.test(h)};
q.getTopic=function(){return f};q.find=function(h){if(typeof h!=="string")throw new TypeError("topic is "+h);if(h===f)return this;var j,k;j=0;for(k=i.length;j<k;j++){var m=i[j].find(h);if(m)return m}};q.toObject=function(){var h={},j,k,m;j=0;for(k=i.length;j<k;j++){m=i[j];var n=m.getTopic(),p=n.lastIndexOf(".");if(p!==-1)n=n.substring(p+1);h[n]=m}return h};q.add=function(h,j,k){if(f===j)u.add(h);else{var m,n,p;n=0;for(p=i.length;n<p;n++){m=i[n];if(m.matches(j)){m.add(h,j,k);return}k||(k=c(j));if(k.test(m.getTopic())){m=
e(j,m);m.add(h,j,k);i[n]=m;return}}m=e(j);m.add(h,j);if(j.indexOf("*")===-1)i.unshift(m);else{n=0;for(p=i.length;n<p;n++){h=i[n].getTopic();if(b(h,j)!==-1){i.splice(n,0,m);return}}i.push(m)}}};q.remove=function(h,j){if(f===j)return u.remove(h);var k,m,n;k=0;for(m=i.length;k<m;k++){n=i[k];if(n.matches(j))if(n.remove(h,j))return true}a(j);k=typeof h;if(k!=="function")throw new TypeError("Callback is "+k);return false};return q}function g(f,o){for(var q in f)f.hasOwnProperty(q)&&r.add(f[q],o+q)}function d(f){return function(){return f}}
var l="**",r=hub.root=e();hub.topicChain=e;hub.topicComparator=b;hub.reset=function(){hub.root=r=e();hub.resetPromise()};hub.subscribe=hub.on=function(f,o){if(Object.prototype.toString.call(f)==="[object Object]")g(f,"");else{if(Object.prototype.toString.call(o)==="[object Object]"){g(o,f+".");o=d(o)}r.add(o,f)}};hub.unsubscribe=hub.un=function(f,o){return r.remove(o,f)};hub.invoke=function(f){a(f);var o=Array.prototype.slice.call(arguments,1);if(f.indexOf("{")!==-1)f=hub.substitute(f,o);try{return r(f,
o)}catch(q){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:f,error:q.message});}}})();(function(){hub.peer=function(c,a,b){if(typeof c==="function"){if(a=hub.create(c,a))hub.on(a)}else if(typeof a==="function"){if(a=hub.create(c,a,b))hub.on(c,a)}else hub.on(a)}})();
(function(){function c(i,h,j){var k;try{k=i.apply(null,h)}catch(m){hub.invoke("hub.error.promise.callback",new hub.Error("error","Error in promise callback: ${error}",{error:m.message}));return}if(j){if(k===undefined)return h;return[k]}}function a(){hub.invoke("hub.error.promise.resolved",new hub.Error("validation","Promise already resolved"))}function b(i){return function(){i.reject({type:"timeout"})}}function e(i,h,j){var k,m,n=!(h instanceof hub.Error),p=h===undefined?[]:[h],w;w={then:function(s,
v){if(i){var x=n?s:v;if(x)p=c(x,p,true)}else{s&&k.push(s);v&&m.push(v)}return this},publish:function(){if(i){p=[hub.invoke.apply(hub,arguments)];return this}var s=o.call(arguments);return this.then(function(){p=[hub.invoke.apply(hub,s)]})},publishResult:function(s){if(i){p=[hub.invoke.apply(hub,[s].concat(p))];return this}return this.then(function(){p=[hub.invoke.apply(hub,[s].concat(p))]})},resolve:function(){if(i)a();else{i=true;clearTimeout(j);if(arguments.length!==0)p=o.call(arguments);for(;k.length;)c(k.shift(),
p)}return this},reject:function(s){if(i)a();else{i=true;n=false;for(clearTimeout(j);m.length;){var v=m.shift();c(v,[s])}}return this},resolved:function(){return i},join:function(s){return q(w,s)}};if(!i){k=[];m=[];j=setTimeout(b(w),j||6E4)}return w}function g(i){var h=e(true);i.then=h.then;i.publish=h.publish;i.publishResult=h.publishResult;return h}var d=true,l=Array.prototype,r=l.unshift,f=l.push,o=l.slice,q;q=function(i,h){function j(){if(++m===2)(p?n.resolve:n.reject).apply(null,k)}var k=[],m=
0,n=e(false),p=true;i.then(function(){r.apply(k,arguments);j()},function(){r.apply(k,arguments);p=false;j()});h.then(function(){f.apply(k,arguments);j()},function(){f.apply(k,arguments);p=false;j()});return n};var t=Error("hub - promise already resolved"),u=function(){};u.prototype={then:function(i,h){return g(this).then(i,h)},publish:function(){return g(this).publish.apply(null,arguments)},publishResult:function(){return g(this).publishResult.apply(null,arguments)},resolve:function(){throw t;},reject:function(){throw t;
},resolved:function(){return true},join:function(i){return g(this).join(i)}};hub.publish=function(){var i=d;d=false;var h;try{h=hub.invoke.apply(this,arguments)}catch(j){if(d&&j instanceof hub.Error){d.reject(j);return d}throw j;}if(typeof h!=="undefined"){h=e(true,h);d=d?q(d,h):h}h=d;d=i;return h||new u};hub.promise=function(i){i=e(false,undefined,i);if(d===false)d=i;else if(d!==true)d=q(d,i);return i};hub.resetPromise=function(){typeof d!=="boolean"&&d.reject();d=true}})();
(function(){var c=hub.publish,a=hub.merge;hub.publisher=function(b,e,g){if(typeof b==="string"){if(e){if(g)return function(){return c(b,a(e.apply(null,arguments),g))};if(typeof e==="function")return function(){return c(b,e.apply(null,arguments))};return function(f){return c(b,a(f,e))}}return function(){if(arguments.length)return c.apply(hub,[b].concat(Array.prototype.slice.call(arguments)));return c(b)}}var d=hub.chain(),l;for(l in b)if(b.hasOwnProperty(l)){var r=b[l];d[l]=typeof r==="string"?hub.publisher(r):
hub.publisher.apply(hub,r);d.add(d[l])}return d}})();(function(){var c=hub.publisher,a=hub.subscribe;hub.forward=function(b,e,g,d){if(typeof b==="object")for(var l in b){if(b.hasOwnProperty(l)){e=b[l];typeof e==="string"?a(l,c(e)):a(l,c(e[0],e[1],e[2]))}}else a(b,c(e,g,d))}})();
