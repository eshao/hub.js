/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(f){function c(){}c.prototype=f;return new c};if(!Array.prototype.forEach)Array.prototype.forEach=function(f,c){if(!f||!f.call)throw new TypeError;for(var b=0,h=this.length;b<h;b++)f.call(c,this[b],b,this)};hub.apply=function(f,c){return this[f].apply(this,c)};
hub.resolve=function(f,c,b){for(var h=c.indexOf(".");h!==-1;){var g=c.substring(0,h);if(!f.hasOwnProperty(g))return b;f=f[g];c=c.substring(h+1);h=c.indexOf(".")}return f.hasOwnProperty(c)?f[c]:b};hub.substitute=function(f,c,b){if(b===undefined)b="";return f.replace(/\{([a-zA-Z0-9\.]+)\}/g,c?function(h,g){return hub.resolve(c,g,b)}:function(){return b})};hub.Error=function(f,c,b){this.type=f;this.context=b;this.toString=function(){return hub.substitute(c,b)}};
hub.merge=function(f,c){if(f===undefined||f===null||f===c)return c;if(c===undefined||c===null)return f;var b=Object.prototype.toString,h=b.call(c);b=b.call(f);var g;if(b===h){if(h==="[object Object]"){for(g in c)if(c.hasOwnProperty(g))f[g]=hub.merge(f[g],c[g]);return f}if(h==="[object Array]")return f.concat(c)}throw new hub.Error("validation",b===h?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:f,source:c,targetType:b,sourceType:h});};
(function(){function f(h){return function(){var g=this._,a=b.call(arguments);return function(){var d=b.call(arguments);return g[h].apply(g,a.concat(d))}}}function c(h){this._=h}var b=Array.prototype.slice;c.prototype={emit:f("emit"),on:f("on"),un:f("un"),create:f("create"),factory:f("factory"),peer:f("peer"),mix:f("mix")};hub.Does=c;hub.does=new c(hub)})();
hub.iterator=function(f){function c(){if(b>=h)throw Error("Iterator out of bounds.");var g=f[b++];c.hasNext=b<h;return g}var b=0,h=f.length;c.hasNext=b<h;c.remove=function(g){var a=typeof g;if(a==="undefined")g=b;else if(a==="number")g<b&&b--;else{for(a=f.length-1;a>=0;a--)if(f[a]===g){g=a;break}if(a<0)return false}if(g>=h)return false;f.splice(g,1);c.hasNext=b<--h;return true};c.insert=function(g,a){if(typeof a==="undefined"){a=g;g=b}else g<b&&b++;f.splice(g,0,a);c.hasNext=b<++h};c.reset=function(){b=
0;c.hasNext=b<h};return c};
(function(){var f={};["then","join","wait","resolve","reject"].forEach(function(c){f[c]=function(){var b=this.promise();b[c].apply(b,arguments)}});hub.scope=function(c){function b(){return d.propagate()}var h=[],g,a,d=Object.create(f);d.aborted=false;d.stopPropagation=function(){d.aborted=true;h.length=0;if(arguments.length)a=arguments[0]};d.propagate=function(){if(arguments.length)c=Array.prototype.slice.call(arguments);var e=h.length;if(!e)return this.result();e=h[e-1];if(e.hasNext){e=e().apply(this,
c);if(g){a=g;g=undefined;a.then(b);return a}else if(e&&e.then){a=e;a.then(b);return}a=hub.merge(a,e)}else{e.reset();h.pop()}return this.propagate()};d.result=function(){if(a&&a.then)return a;return hub.promise(0,this).resolve(a)};d.push=function(e){h.push(e)};d.promise=function(e,k){g||(g=hub.promise(e||0,k||this));return g};return d}})();
(function(){hub.chain=function(){function f(){var b=this.propagate?this:hub.scope(arguments);b.push(c);return b.propagate()}var c=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);f.on=function(b){var h=typeof b;if(h!=="function")throw new TypeError("Callback is "+h);c.insert(0,b)};f.un=c.remove;return f}})();
(function(){function f(a){var d=typeof a;if(d!=="string")throw Error("Topic is "+d);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(a))throw Error("Illegal topic: "+a);}function c(a,d){var e=a.indexOf("*"),k=d.indexOf("*");if(e===-1)return k===-1?0:1;if(k===-1)return-1;var q=a.indexOf("."),p=d.indexOf(".");if(e<q){if(k>p)return-1}else if(k<p)return 1;return 0}function b(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+a+"$")}function h(a,d){var e;if(a)if(typeof a==="string")f(a);else{e=a;a=g}else a=g;var k=b(a),q,p=d?[d]:[],n=Object.create({});n.emit=function(l){l||(l=a);if(l!==g&&!k.test(l)){if(l.indexOf("*")===-1||!b(l).test(a))return;l=g}var o=this.propagate?this:hub.scope(Array.prototype.slice.call(arguments,1));q&&q.call(o);if(o.aborted)return o.result();var m=o.topicChainQueue;if(m)Array.prototype.push.apply(m,p);else m=o.topicChainQueue=p.slice();for(;m.length;){m.shift().emit.call(o,
l);if(o.aborted)break}return o.result()};n.matches=function(l){return k.test(l)};n.topic=a;n.on=function(l,o,m){if(a===l){q||(q=hub.chain());q.on(o)}else{var i,j,s;j=0;for(s=p.length;j<s;j++){i=p[j];if(i.matches(l)){i.on(l,o,m);return}m||(m=b(l));if(m.test(i.topic)){i=h(l,i);i.on(l,o,m);p[j]=i;return}}i=h(l);i.on(l,o);if(l.indexOf("*")===-1)p.unshift(i);else{j=0;for(s=p.length;j<s;j++)if(c(p[j].topic,l)!==-1){p.splice(j,0,i);return}p.push(i)}}};n.un=function(l,o){if(a===l)return q?q.un(o):-1;var m,
i,j;m=0;for(i=p.length;m<i;m++){j=p[m];if(j.matches(l))if(j.un(l,o))return true}f(l);m=typeof o;if(m!=="function")throw new TypeError("Callback is "+m);return false};n.mix=function(){hub.apply("emit",arguments).then(hub.does.mix(n))};n.create=hub.create;n.factory=hub.factory;n.peer=hub.peer;n.does=new hub.Does(n);if(e)for(var r in e)if(e.hasOwnProperty(r))n.on(r,e[r]);return n}var g="**";hub.node=h;hub.topicComparator=c;hub.validateTopic=f})();
(function(){function f(c){if(typeof c!=="function")throw new TypeError;}hub.mix=function(c,b){for(var h in b)if(b.hasOwnProperty(h)&&typeof b[h]==="function"){var g=c,a=h,d=b[h],e=g[a];if(e)if(e.add)e.add(d);else g[a]=hub.chain(d,g[a]);else g[a]=hub.chain(d)}return c};hub.create=function(c,b,h){if(typeof c!=="string"){h=b;b=c;c=null}f(b);var g={};c=c?hub.topicScope(c):hub.scope();c.mix=function(){hub.apply("emit",arguments).then(hub.does.mix(g))};b=h?b.apply(c,h):b.call(c);return hub.mix(g,b)};hub.factory=
function(c,b){typeof c!=="string"?f(c):f(b);return function(){return hub.create(c,b)}}})();
(function(){function f(a,d){for(var e in d)if(d.hasOwnProperty(e))hub.root.on(a+e,d[e])}function c(a){return function(){return a}}function b(a,d){if(a)a+=".";return function(){var e=g.call(arguments);if(!e[0])throw new TypeError("Topic is "+e[0]);e[0]=a+e[0];return d.apply(this,e)}}hub.root=hub.node();var h={},g=Array.prototype.slice;hub.on=function(a,d){if(typeof a==="function")hub.root.on("**",a);else if(Object.prototype.toString.call(a)==="[object Object]"){f("",a);return}else if(Object.prototype.toString.call(d)===
"[object Object]"){f(a+".",d);d=c(d)}hub.root.on(a,d)};hub.un=function(a,d){if(typeof a==="function")return hub.root.un("**",a);return hub.root.un(a,d)};hub.topicScope=function(a,d){d||(d=hub.scope());var e=a.lastIndexOf(".");e=e===-1?"":a.substring(0,e);var k=h[e];if(!k){k={topic:a,on:b(e,hub.on),un:b(e,hub.un),peer:b(e,hub.peer),emit:b(e,hub.emit),create:b(e,hub.create),factory:b(e,hub.factory)};h[e]=k}d.topic=k.topic;d.on=k.on;d.un=k.un;d.peer=k.peer;d.emit=k.emit;d.create=k.create;d.factory=k.factory;
return d};hub.emit=function(a){hub.validateTopic(a);var d=g.call(arguments),e=d.slice(1);if(a.indexOf("{")!==-1)d[0]=hub.substitute(a,e);e=this.propagate?this:hub.scope(e);e=hub.topicScope(d[0],e);var k;try{k=hub.root.emit.apply(e,d)}catch(q){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:d[0],error:q.message});}if(!k||!k.then){d=hub.promise(0,e);d.resolve(k);k=d}return k};hub.peer=function(a,d,e){if(typeof a==="function"){if(d=hub.create(a,d))hub.on(d)}else if(typeof d===
"function"){if(d=hub.create(a,d,e))hub.on(a,d)}else hub.on(a,d)};hub.reset=function(){h={};hub.root=hub.node()}})();
(function(){function f(g){return function(){g.reject.apply(g,arguments)}}function c(g,a){return function(){var d=b.call(arguments);a.then(function(){var e=b.call(arguments);g.resolve.apply(g,d.concat(e))})}}var b=Array.prototype.slice,h={};["on","un","emit","create","factory","peer","mix"].forEach(function(g){h[g]=function(){var a=b.call(arguments);return this.then(function(){hub[g].apply(hub,a.concat(Array.prototype.slice.call(arguments)))})}});hub.promise=function(g,a){function d(){o&&clearTimeout(o);
for(var i=l?p:q,j=0,s=i.length;j<s;j++)i[j].apply(a,n);q.length=0;p.length=0}function e(){r--;!r&&n&&d()}function k(){if(n)throw Error("Promise already "+(l?"rejected":"resolved"));}var q=[],p=[],n,r=0,l=false,o,m;m=Object.create(h);m.then=function(i,j){if(!i&&!j)throw new TypeError("Require callback or errback");if(i&&typeof i!=="function")throw new TypeError("Callback is "+i);if(j&&typeof j!=="function")throw new TypeError("Errback is "+j);i&&q.push(i);j&&p.push(j);!r&&n&&d();return this};m.resolve=
function(){k();n=b.call(arguments);r||d();return this};m.reject=function(){k();l=true;n=b.call(arguments);r||d();return this};m.wait=function(){var i=0,j=arguments.length;for(r+=j;i<j;i++)arguments[i].then(e,e);return this};m.join=function(i){if(!i||typeof i.then!=="function")throw new TypeError("Promise is "+i);var j=hub.promise(0,a);this.then(c(j,i),f(j));i.then(null,f(j));return j};m.does=new hub.Does(m);if(g)o=setTimeout(function(){m.reject(new hub.Error("timeout","Promise timed out after {timeout} milliseconds",
{timeout:g}))},g);return m}})();
