/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(d){function b(){}b.prototype=d;return new b};hub.resolve=function(d,b,a){for(var f=b.indexOf(".");f!==-1;){var h=b.substring(0,f);if(!d.hasOwnProperty(h))return a;d=d[h];b=b.substring(f+1);f=b.indexOf(".")}return d.hasOwnProperty(b)?d[b]:a};hub.substitute=function(d,b,a){if(a===undefined)a="";return d.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(f,h){return hub.resolve(b,h,a)}:function(){return a})};
hub.Error=function(d,b,a){this.type=d;this.context=a;this.toString=function(){return hub.substitute(b,a)}};
hub.merge=function(d,b){if(d===undefined||d===null||d===b)return b;if(b===undefined||b===null)return d;var a=Object.prototype.toString,f=a.call(b);a=a.call(d);var h;if(a===f){if(f==="[object Object]"){for(h in b)if(b.hasOwnProperty(h))d[h]=hub.merge(d[h],b[h]);return d}if(f==="[object Array]")return d.concat(b)}throw new hub.Error("validation",a===f?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:d,source:b,targetType:a,sourceType:f});};
hub.iterator=function(d){function b(){if(a>=f)throw Error("Iterator out of bounds.");var h=d[a++];b.hasNext=a<f;return h}var a=0,f=d.length;b.hasNext=a<f;b.remove=function(h){var c=typeof h;if(c==="undefined")h=a;else if(c==="number")h<a&&a--;else{for(c=d.length-1;c>=0;c--)if(d[c]===h){h=c;break}if(c<0)return false}if(h>=f)return false;d.splice(h,1);b.hasNext=a<--f;return true};b.insert=function(h,c){if(typeof c==="undefined"){c=h;h=a}else h<a&&a++;d.splice(h,0,c);b.hasNext=a<++f};b.reset=function(){a=
0;b.hasNext=a<f};return b};
(function(){function d(i){function q(){return k.propagate()}var o=[],s=false,p,l,k=Object.create(e);k.stopPropagation=function(){s=true;o.length=0;if(arguments.length)l=arguments[0]};k.propagate=function(){if(arguments.length)l=arguments[0];var m=o.length;if(!m)return this.result();m=o[m-1];if(m.hasNext){m=m().apply(this,i);if(p){l=p;p=undefined;l.then(q);return l}else if(m&&m.then){l=m;l.then(q);return}l=hub.merge(l,m)}else{m.reset();o.pop()}return this.propagate()};k.aborted=function(){return s};
k.result=function(){if(l&&l.then)return l;return hub.promise(0,this).resolve(l)};k.push=function(m){o.push(m)};k.promise=function(){p||(p=hub.promise());return p};return k}function b(){function i(){var o=this.propagate?this:d(arguments);o.push(q);return o.propagate()}var q=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);i.add=function(o){var s=typeof o;if(s!=="function")throw new TypeError("Callback is "+s);q.insert(0,o)};i.insert=q.insert;i.remove=q.remove;return i}function a(i){i=
i.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+i+"$")}function f(i){var q=typeof i;if(q!=="string")throw Error("Topic is "+q);if(!i)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(i))throw Error("Illegal topic: "+i);}function h(i,q){var o=i.indexOf("*"),s=q.indexOf("*");if(o===-1)return s===-1?0:1;if(s===-1)return-1;var p=i.indexOf("."),l=q.indexOf(".");if(o<p){if(s>l)return-1}else if(s<l)return 1;
return 0}function c(i,q){function o(k){k||(k=i);if(k!==j&&!s.test(k)){if(k.indexOf("*")===-1||!a(k).test(i))return;k=j}var m=this.propagate?this:d(Array.prototype.slice.call(arguments,1));p&&p.call(m);if(m.aborted())return m.result();var r=m.topicChainQueue;if(r)Array.prototype.push.apply(r,l);else r=m.topicChainQueue=l.slice();for(;r.length;){r.shift().call(m,k);if(m.aborted())break}return m.result()}if(i)f(i);else i=j;var s=a(i),p,l=q?[q]:[];o.matches=function(k){return s.test(k)};o.getTopic=function(){return i};
o.add=function(k,m,r){if(i===k){p||(p=b());p.add(m)}else{var g,n,t;n=0;for(t=l.length;n<t;n++){g=l[n];if(g.matches(k)){g.add(k,m,r);return}r||(r=a(k));if(r.test(g.getTopic())){g=c(k,g);g.add(k,m,r);l[n]=g;return}}g=c(k);g.add(k,m);if(k.indexOf("*")===-1)l.unshift(g);else{n=0;for(t=l.length;n<t;n++){m=l[n].getTopic();if(h(m,k)!==-1){l.splice(n,0,g);return}}l.push(g)}}};o.remove=function(k,m){if(i===k)return p?p.remove(m):-1;var r,g,n;r=0;for(g=l.length;r<g;r++){n=l[r];if(n.matches(k))if(n.remove(k,
m))return true}f(k);r=typeof m;if(r!=="function")throw new TypeError("Callback is "+r);return false};return o}var e={};(function(){function i(p){e[p]=function(){var l=this.promise();l[p].apply(l,arguments)}}for(var q=["then","join","wait","resolve","reject"],o=0,s=q.length;o<s;o++)i(q[o])})();var j="**";hub.scope=d;hub.chain=b;hub.topicChain=c;hub.topicComparator=h;hub.validateTopic=f})();
(function(){hub.mix=function(d,b){for(var a in b)if(b.hasOwnProperty(a)&&typeof b[a]==="function"){var f=d,h=a,c=b[a],e=f[h];if(e)if(e.add)e.add(c);else f[h]=hub.chain(c,f[h]);else f[h]=c}return d};hub.create=function(d,b,a){if(typeof d!=="string"){a=b;b=d;d=null}if(typeof b!=="function")throw new TypeError;var f={};d=d?hub.topicScope(d):hub.scope();d.mix=function(){hub.emit.apply(hub,arguments).then(function(h){hub.mix(f,h)})};b=a?b.apply(d,a):b.call(d);return hub.mix(f,b)};hub.factory=function(d,
b){return function(){return hub.create(d,b)}}})();
(function(){function d(c,e){for(var j in e)e.hasOwnProperty(j)&&hub.root.add(c+j,e[j])}function b(c){return function(){return c}}function a(c,e){c+=".";return function(){var j=h.call(arguments);if(!j[0])throw new TypeError("Topic is "+j[0]);j[0]=c+j[0];return e.apply(this,j)}}hub.root=hub.topicChain();var f={},h=Array.prototype.slice;hub.on=function(c,e){if(typeof c==="function")hub.root.add("**",c);else if(Object.prototype.toString.call(c)==="[object Object]"){d("",c);return}else if(Object.prototype.toString.call(e)===
"[object Object]"){d(c+".",e);e=b(e)}hub.root.add(c,e)};hub.un=function(c,e){if(typeof c==="function")return hub.root.remove("**",c);return hub.root.remove(c,e)};hub.topicScope=function(c,e){e||(e=hub.scope());var j=f[c];if(!j){j={on:a(c,hub.on),un:a(c,hub.un),peer:a(c,hub.peer),emit:a(c,hub.emit),create:a(c,hub.create),factory:a(c,hub.factory)};f[c]=j}e.on=j.on;e.un=j.un;e.peer=j.peer;e.emit=j.emit;e.create=j.create;e.factory=j.factory;return e};hub.emit=function(c){hub.validateTopic(c);var e=h.call(arguments),
j=e.slice(1);if(c.indexOf("{")!==-1)e[0]=hub.substitute(c,j);j=this.propagate?this:hub.scope(j);j=hub.topicScope(e[0],j);var i;try{i=hub.root.apply(j,e)}catch(q){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:e[0],error:q.message});}if(!i||!i.then){e=hub.promise(0,j);e.resolve(i);i=e}return i};hub.peer=function(c,e,j){if(typeof c==="function"){if(e=hub.create(c,e))hub.on(e)}else if(typeof e==="function"){if(e=hub.create(c,e,j))hub.on(c,e)}else hub.on(c,e)};hub.reset=
function(){f={};hub.root=hub.topicChain()}})();
(function(){var d=Array.prototype.slice;hub.promise=function(b,a){function f(){m&&clearTimeout(m);for(var g=k?s:o,n=0,t=g.length;n<t;n++)g[n].apply(a,p);o.length=0;s.length=0}function h(){l--;!l&&p&&f()}function c(g){return function(){g.reject.apply(g,arguments)}}function e(g,n){return function(){var t=d.call(arguments);n.then(function(){var u=d.call(arguments);g.resolve.apply(g,t.concat(u))})}}function j(){if(p)throw Error("Promise already "+(k?"rejected":"resolved"));}function i(g){return function(){hub.emit.apply(hub,
[g].concat(p))}}function q(g){return function(){hub.emit.apply(hub,g)}}var o=[],s=[],p,l=0,k=false,m,r;r={then:function(g,n){if(!g&&!n)throw new TypeError("Require callback or errback");if(g&&typeof g!=="function")throw new TypeError("Callback is "+g);if(n&&typeof n!=="function")throw new TypeError("Errback is "+n);g&&o.push(g);n&&s.push(n);!l&&p&&f();return this},resolve:function(){j();p=d.call(arguments);l||f();return this},reject:function(){j();k=true;p=d.call(arguments);l||f();return this},wait:function(){var g=
0,n=arguments.length;for(l+=n;g<n;g++)arguments[g].then(h,h);return this},join:function(g){if(!g||typeof g.then!=="function")throw new TypeError("Promise is "+g);var n=hub.promise();this.then(e(n,g),c(n));g.then(null,c(n));return n},emit:function(g){hub.validateTopic(g);return this.then(arguments.length===1?i(g):q(arguments))}};if(b)m=setTimeout(function(){r.reject(new hub.Error("timeout","Promise timed out after {timeout} milliseconds",{timeout:b}))},b);return r}})();
(function(){var d=hub.emit,b=hub.merge;hub.emitter=function(a,f,h){if(typeof a==="string"){if(f){if(h)return function(){return d(a,b(f.apply(null,arguments),h))};if(typeof f==="function")return function(){return d(a,f.apply(null,arguments))};return function(i){return d(a,b(i,f))}}return function(){if(arguments.length)return d.apply(hub,[a].concat(Array.prototype.slice.call(arguments)));return d(a)}}var c=hub.chain(),e;for(e in a)if(a.hasOwnProperty(e)){var j=a[e];c[e]=typeof j==="string"?hub.emitter(j):
hub.emitter.apply(hub,j);c.add(c[e])}return c}})();(function(){var d=hub.emitter,b=hub.on;hub.forward=function(a,f,h,c){if(typeof a==="object")for(var e in a){if(a.hasOwnProperty(e)){f=a[e];typeof f==="string"?b(e,d(f)):b(e,d(f[0],f[1],f[2]))}}else b(a,d(f,h,c))}})();
