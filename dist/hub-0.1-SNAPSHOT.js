/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(g,h){if(g===undefined||g===null||g===h)return h;if(h===undefined||h===null)return g;var a=Object.prototype.toString,i=a.call(h);a=a.call(g);var j;if(a===i){if(i==="[object Object]"){for(j in h)if(h.hasOwnProperty(j))g[j]=hub.merge(g[j],h[j]);return g}if(i==="[object Array]")return g.concat(h)}throw new hub.Error("validation",a===i?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:g,source:h,targetType:a,sourceType:i});};
hub.resolve=function(g,h,a){for(var i=h.indexOf(".");i!==-1;){var j=h.substring(0,i);if(!g.hasOwnProperty(j))return a;g=g[j];h=h.substring(i+1);i=h.indexOf(".")}return g.hasOwnProperty(h)?g[h]:a};hub.substitute=function(g,h,a){if(a===undefined)a="";return g.replace(/\{([a-zA-Z0-9\.]+)\}/g,h?function(i,j){return hub.resolve(h,j,a)}:function(){return a})};hub.Error=function(g,h,a){this.type=g;this.context=a;this.toString=function(){return hub.substitute(h,a)}};
hub.iterator=function(g){function h(){if(a>=i)throw Error("Iterator out of bounds.");var j=g[a++];h.hasNext=a<i;return j}var a=0,i=g.length;h.hasNext=a<i;h.remove=function(j){var b=typeof j;if(b==="undefined")j=a;else if(b==="number")j<a&&a--;else{for(b=g.length-1;b>=0;b--)if(g[b]===j){j=b;break}if(b<0)return false}if(j>=i)return false;g.splice(j,1);h.hasNext=a<--i;return true};h.insert=function(j,b){if(typeof b==="undefined"){b=j;j=a}else j<a&&a++;g.splice(j,0,b);h.hasNext=a<++i};h.reset=function(){a=
0;h.hasNext=a<i};return h};
(function(){function g(){var n=b.length;if(!n)return false;n=b[n-1];if(!n.hasNext){b.pop();return g()}j=hub.merge(j,n().apply(a,i));return true}var h=false,a,i,j,b=[];hub.stopPropagation=function(){h=true;b.length=0};hub.propagate=function(){g()};hub.chain=function(){function n(){n.aborted=false;var c=!b.length;if(c){h=false;i=arguments}var f=a;a=this;j=undefined;try{b.push(d);var l=true;do l=g();while(l)}finally{n.aborted=h;d.reset();if(c)b.length=0;a=f}if(!b.length){c=j;a=i=j=undefined;return c}}
var d=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);n.add=function(c){d.insert(0,c)};n.insert=d.insert;n.remove=d.remove;return n}})();
(function(){function g(c,f){for(var l in f)if(f.hasOwnProperty(l)){var q=f[l],o=c[l];o||(c[l]=o=hub.chain());o.add(q)}}function h(c,f,l){return function(){var q=Array.prototype.slice.call(arguments);q=hub.publish.apply(hub,[c].concat(q));hub.aborted()||(q=hub.merge(q,f.apply(l,arguments)));return q}}function a(c){var f=j[c];if(f)return f;f=b[c];if(!f)throw Error("Peer is not defined: "+c);f=d(f);var l={},q;for(q in f)if(f.hasOwnProperty(q)){var o=f[q];if(typeof o==="function")l[q]=h(c+"/"+q,o,l)}f.api=
l;return f}function i(c,f){return function(){return c.apply(f,arguments)}}var j={},b={},n=[],d;d=function(c){var f={},l=c.is,q,o;q=0;for(o=l.length;q<o;q++)g(f,a(l[q]));g(f,c.instance||c.factory());return f};hub.peer=function(c,f,l){if(b[c])throw Error("hub - peer already defined: "+c);if(!l){l=f;f=null}f={is:f?typeof f==="string"?[f]:f:n};if(typeof l==="function")f.factory=l;else{f.instance=l;l=j[c]=d(f);var q=l.api={},o;for(o in l)if(l.hasOwnProperty(o)){var e=l[o];if(typeof e==="function"){var k=
c+"/"+o;hub.subscribe(k,i(e,q));q[o]=hub.publisher(k)}}}b[c]=f};hub.get=function(c){return a(c).api};hub.resetPeers=function(){j={};for(var c in b)b.hasOwnProperty(c)&&c.indexOf("lib.")===-1&&delete b[c]}})();
(function(){function g(d){d=d.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+d+"$")}function h(d,c){var f=d.indexOf("*"),l=c.indexOf("*");if(f===-1)return l===-1?0:1;if(l===-1)return-1;var q=d.indexOf("/"),o=c.indexOf("/");if(f<q){if(l>o)return-1}else if(l<o)return 1;return 0}function a(d,c){function f(e,k,p){e||(e=d);if(e!==b&&!l.test(e)){if(e.indexOf("*")===-1||!g(e).test(d))return;e=b}var m=k&&k.length?q.apply(this,
k):q.call(this);if(q.aborted){f.aborted=true;return m}if(p){var r,s;r=0;for(s=o.length;r<s;r++)p.push(o[r])}else p=o.slice();for(;p.length;){r=p.shift();s=r.call(this,e,k,p);m=hub.merge(m,s);if(r.aborted){f.aborted=true;break}}return m}d||(d=b);var l=g(d),q=hub.chain(),o=c?[c]:[];f.matches=function(e){return l.test(e)};f.getTopic=function(){return d};f.add=function(e,k,p){if(d===k)q.add(e);else{var m,r,s;r=0;for(s=o.length;r<s;r++){m=o[r];if(m.matches(k)){m.add(e,k,p);return}p||(p=g(k));if(p.test(m.getTopic())){m=
a(k,m);m.add(e,k,p);o[r]=m;return}}m=a(k);m.add(e,k);if(k.indexOf("*")===-1)o.unshift(m);else{r=0;for(s=o.length;r<s;r++){e=o[r].getTopic();if(h(e,k)!==-1){o.splice(r,0,m);return}}o.push(m)}}};f.remove=function(e,k){if(d===k)return q.remove(e);var p,m,r;p=0;for(m=o.length;p<m;p++){r=o[p];if(r.matches(k))if(r.remove(e,k))return true}return false};return f}function i(d){var c=typeof d;if(c!=="string")throw Error("Topic is "+c);if(!d)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(d))throw Error("Illegal topic: "+
d);}function j(d){d=typeof d;if(d!=="function")throw Error("Callback is "+d);}var b="**/**",n=a();hub.topicChain=a;hub.topicComparator=h;hub.reset=function(){n=a();hub.resetPeers();hub.resetPromise()};hub.subscribe=function(d,c){j(c);i(d);n.add(c,d)};hub.unsubscribe=function(d,c){j(c);i(d);return n.remove(c,d)};hub.invoke=function(d){i(d);var c=Array.prototype.slice.call(arguments,1);if(d.indexOf("{")!==-1)d=hub.substitute(d,c);try{return n(d,c)}catch(f){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',
{topic:d,error:f.message});}};hub.aborted=function(){return Boolean(n.aborted)}})();
(function(){function g(e,k,p){var m;try{m=e.apply(null,k)}catch(r){hub.invoke("hub.error/promise.callback",new hub.Error("error","Error in promise callback: ${error}",{error:r.message}));return}if(p){if(m===undefined)return k;return[m]}}function h(){hub.invoke("hub.error/promise.resolved",new hub.Error("validation","Promise already resolved"))}function a(e){return function(){e.reject({type:"timeout"})}}function i(e,k,p){var m,r,s=!(k instanceof hub.Error),t=k===undefined?[]:[k],w;w={then:function(u,
v){if(e){var x=s?u:v;if(x)t=g(x,t,true)}else{u&&m.push(u);v&&r.push(v)}return this},publish:function(){if(e){t=[hub.invoke.apply(hub,arguments)];return this}var u=f.call(arguments);return this.then(function(){t=[hub.invoke.apply(hub,u)]})},publishResult:function(u){if(e){t=[hub.invoke.apply(hub,[u].concat(t))];return this}return this.then(function(){t=[hub.invoke.apply(hub,[u].concat(t))]})},resolve:function(){if(e)h();else{e=true;clearTimeout(p);if(arguments.length!==0)t=f.call(arguments);for(;m.length;)g(m.shift(),
t)}return this},reject:function(u){if(e)h();else{e=true;s=false;for(clearTimeout(p);r.length;){var v=r.shift();g(v,[u])}}return this},resolved:function(){return e},join:function(u){return l(w,u)}};if(!e){m=[];r=[];p=setTimeout(a(w),p||6E4)}return w}function j(e){var k=i(true);e.then=k.then;e.publish=k.publish;e.publishResult=k.publishResult;return k}var b=true,n=Array.prototype,d=n.unshift,c=n.push,f=n.slice,l;l=function(e,k){function p(){if(++r===2)(t?s.resolve:s.reject).apply(null,m)}var m=[],r=
0,s=i(false),t=true;e.then(function(){d.apply(m,arguments);p()},function(){d.apply(m,arguments);t=false;p()});k.then(function(){c.apply(m,arguments);p()},function(){c.apply(m,arguments);t=false;p()});return s};var q=Error("hub - promise already resolved"),o=function(){};o.prototype={then:function(e,k){return j(this).then(e,k)},publish:function(){return j(this).publish.apply(null,arguments)},publishResult:function(){return j(this).publishResult.apply(null,arguments)},resolve:function(){throw q;},reject:function(){throw q;
},resolved:function(){return true},join:function(e){return j(this).join(e)}};hub.publish=function(){var e=b;b=false;var k;try{k=hub.invoke.apply(this,arguments)}catch(p){if(b&&p instanceof hub.Error){b.reject(p);return b}throw p;}if(typeof k!=="undefined"){k=i(true,k);b=b?l(b,k):k}k=b;b=e;return k||new o};hub.promise=function(e){e=i(false,undefined,e);if(b===false)b=e;else if(b!==true)b=l(b,e);return e};hub.resetPromise=function(){typeof b!=="boolean"&&b.reject();b=true}})();
(function(){var g=hub.publish,h=hub.merge;hub.publisher=function(a,i,j){if(typeof a==="string"){if(i){if(j)return function(){return g(a,h(i.apply(null,arguments),j))};if(typeof i==="function")return function(){return g(a,i.apply(null,arguments))};return function(c){return g(a,h(c,i))}}return function(){if(arguments.length)return g.apply(hub,[a].concat(Array.prototype.slice.call(arguments)));return g(a)}}var b=hub.chain(),n;for(n in a)if(a.hasOwnProperty(n)){var d=a[n];b[n]=typeof d==="string"?hub.publisher(d):
hub.publisher.apply(hub,d);b.add(b[n])}return b}})();(function(){var g=hub.publisher,h=hub.subscribe;hub.forward=function(a,i,j,b){if(typeof a==="object")for(var n in a){if(a.hasOwnProperty(n)){i=a[n];typeof i==="string"?h(n,g(i)):h(n,g(i[0],i[1],i[2]))}}else h(a,g(i,j,b))}})();
