/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(e,f){if(e===undefined||e===null||e===f)return f;if(f===undefined||f===null)return e;var a=Object.prototype.toString,g=a.call(f);a=a.call(e);var h;if(a===g){if(g==="[object Object]"){for(h in f)if(f.hasOwnProperty(h))e[h]=hub.merge(e[h],f[h]);return e}if(g==="[object Array]")return e.concat(f)}throw new hub.Error("validation",a===g?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:e,source:f,targetType:a,sourceType:g});};
hub.resolve=function(e,f,a){for(var g=f.indexOf(".");g!==-1;){var h=f.substring(0,g);if(!e.hasOwnProperty(h))return a;e=e[h];f=f.substring(g+1);g=f.indexOf(".")}return e.hasOwnProperty(f)?e[f]:a};hub.substitute=function(e,f,a){if(a===undefined)a="";return e.replace(/\{([a-zA-Z0-9\.]+)\}/g,f?function(g,h){return hub.resolve(f,h,a)}:function(){return a})};hub.Error=function(e,f,a){this.type=e;this.context=a;this.toString=function(){return hub.substitute(f,a)}};
hub.iterator=function(e){function f(){if(a>=g)throw Error("Iterator out of bounds.");var h=e[a++];f.hasNext=a<g;return h}var a=0,g=e.length;f.hasNext=a<g;f.remove=function(h){var b=typeof h;if(b==="undefined")h=a;else if(b==="number")h<a&&a--;else{for(b=e.length-1;b>=0;b--)if(e[b]===h){h=b;break}if(b<0)return false}if(h>=g)return false;e.splice(h,1);f.hasNext=a<--g;return true};f.insert=function(h,b){if(typeof b==="undefined"){b=h;h=a}else h<a&&a++;e.splice(h,0,b);f.hasNext=a<++g};f.reset=function(){a=
0;f.hasNext=a<g};return f};
(function(){function e(c){var k=[],m=false,n,l,j;return j={stopPropagation:function(){m=true;k.length=0;if(arguments.length)l=arguments[0]},propagate:function(){if(arguments.length)l=arguments[0];var i=k.length;if(i){i=k[i-1];if(i.hasNext){i=i().apply(j,c);if(n){l=n;n=undefined;l.then(j.propagate);return}else if(i&&i.then){i.then(j.propagate);l=i;return}l=hub.merge(l,i)}else{i.reset();k.pop()}return j.propagate()}},aborted:function(){return m},result:function(){return l},push:function(i){k.push(i)},
promise:function(){return n=hub.promise()}}}function f(){function c(){var m=this.propagate?this:e(arguments);m.push(k);m.propagate();return m.result()}var k=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);c.add=function(m){var n=typeof m;if(n!=="function")throw new TypeError("Callback is "+n);k.insert(0,m)};c.insert=k.insert;c.remove=k.remove;return c}function a(c){c=c.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+c+"$")}function g(c){var k=typeof c;if(k!=="string")throw Error("Topic is "+k);if(!c)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(c))throw Error("Illegal topic: "+c);}function h(c,k){var m=c.indexOf("*"),n=k.indexOf("*");if(m===-1)return n===-1?0:1;if(n===-1)return-1;var l=c.indexOf("."),j=k.indexOf(".");if(m<l){if(n>j)return-1}else if(n<j)return 1;return 0}function b(c,k){function m(i){i||(i=c);if(i!==d&&!n.test(i)){if(i.indexOf("*")===-1||!a(i).test(c))return;
i=d}var o=this.propagate?this:e(Array.prototype.slice.call(arguments,1));l.call(o);if(o.aborted())return o.result();var p=o.topicChainQueue;if(p)Array.prototype.push.apply(p,j);else p=o.topicChainQueue=j.slice();for(;p.length;){p.shift().call(o,i);if(o.aborted())break}return o.result()}if(c)g(c);else c=d;var n=a(c),l=f(),j=k?[k]:[];m.matches=function(i){return n.test(i)};m.getTopic=function(){return c};m.add=function(i,o,p){if(c===i)l.add(o);else{var q,r,s;r=0;for(s=j.length;r<s;r++){q=j[r];if(q.matches(i)){q.add(i,
o,p);return}p||(p=a(i));if(p.test(q.getTopic())){q=b(i,q);q.add(i,o,p);j[r]=q;return}}q=b(i);q.add(i,o);if(i.indexOf("*")===-1)j.unshift(q);else{r=0;for(s=j.length;r<s;r++){o=j[r].getTopic();if(h(o,i)!==-1){j.splice(r,0,q);return}}j.push(q)}}};m.remove=function(i,o){if(c===i)return l.remove(o);var p,q,r;p=0;for(q=j.length;p<q;p++){r=j[p];if(r.matches(i))if(r.remove(i,o))return true}g(i);p=typeof o;if(p!=="function")throw new TypeError("Callback is "+p);return false};return m}var d="**";hub.scope=
e;hub.chain=f;hub.topicChain=b;hub.topicComparator=h;hub.validateTopic=g})();(function(){hub.mix=function(e,f){for(var a in f)if(f.hasOwnProperty(a)&&typeof f[a]==="function"){var g=e,h=a,b=f[a],d=g[h];if(d)if(d.add)d.add(b);else g[h]=hub.chain(b,g[h]);else g[h]=b}return e}})();
(function(){hub.create=function(e,f,a){if(typeof e!=="string"){a=f;f=e;e=null}if(typeof f!=="function")throw new TypeError;var g={};e=e?hub.topicScope(e):hub.scope();e.mix=function(){hub.emit.apply(hub,arguments).then(function(h){hub.mix(g,h)})};f=a?f.apply(e,a):f.call(e);return hub.mix(g,f)}})();
(function(){function e(b,d){for(var c in d)d.hasOwnProperty(c)&&hub.root.add(b+c,d[c])}function f(b){return function(){return b}}function a(b,d){b+=".";return function(){var c=h.call(arguments);if(!c[0])throw new TypeError("Topic is "+c[0]);c[0]=b+c[0];return d.apply(this,c)}}hub.root=hub.topicChain();var g={},h=Array.prototype.slice;hub.on=function(b,d){if(Object.prototype.toString.call(b)==="[object Object]")e("",b);else{if(Object.prototype.toString.call(d)==="[object Object]"){e(b+".",d);d=f(d)}hub.root.add(b,
d)}};hub.un=function(b,d){return hub.root.remove(b,d)};hub.topicScope=function(b,d){d||(d=hub.scope());var c=g[b];if(!c){c={on:a(b,hub.on),un:a(b,hub.un),peer:a(b,hub.peer),emit:a(b,hub.emit),create:a(b,hub.create)};g[b]=c}d.on=c.on;d.un=c.un;d.peer=c.peer;d.emit=c.emit;d.create=c.create;return d};hub.emitPromise=function(b,d){if(!b||!b.then){var c=hub.promise(0,d);c.resolve(b);b=c}b.emit=function(k){b.then(function(m){hub.emit(k,m)})};return b};hub.emit=function(b){hub.validateTopic(b);var d=h.call(arguments),
c=d.slice(1);if(b.indexOf("{")!==-1)d[0]=hub.substitute(b,c);c=this.propagate?this:hub.scope(c);c=hub.topicScope(d[0],c);var k;try{k=hub.root.apply(c,d)}catch(m){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:d[0],error:m.message});}return hub.emitPromise(k,c)};hub.peer=function(b,d,c){if(typeof b==="function"){if(d=hub.create(b,d))hub.on(d)}else if(typeof d==="function"){if(d=hub.create(b,d,c))hub.on(b,d)}else hub.on(b,d)};hub.reset=function(){g={};hub.root=
hub.topicChain()}})();
(function(){hub.promise=function(e,f){function a(){m&&clearTimeout(m);for(var l=k?b:h,j=0,i=l.length;j<i;j++)l[j].apply(f,d);h.length=0;b.length=0}function g(){c--;!c&&d&&a()}var h=[],b=[],d,c=0,k=false,m,n;n={then:function(l,j){if(typeof l!=="function")throw new TypeError("Callback is "+l);h.push(l);j&&b.push(j);!c&&d&&a();return n},resolve:function(){if(d)throw Error("Promise already "+(k?"rejected":"resolved"));d=Array.prototype.slice.call(arguments);c||a();return n},reject:function(){k=true;return n.resolve.apply(n,
arguments)},wait:function(){var l=0,j=arguments.length;for(c+=j;l<j;l++)arguments[l].then(g);return n},join:function(l){if(!l||typeof l.then!=="function")throw new TypeError("Promise is "+l);var j=hub.promise();n.then(function(i){l.then(function(o){j.resolve(i,o)})});return j}};if(e)m=setTimeout(function(){n.reject(new hub.Error("timeout","Promise timed out after {timeout} milliseconds",{timeout:e}))},e);return n}})();
(function(){var e=hub.emit,f=hub.merge;hub.emitter=function(a,g,h){if(typeof a==="string"){if(g){if(h)return function(){return e(a,f(g.apply(null,arguments),h))};if(typeof g==="function")return function(){return e(a,g.apply(null,arguments))};return function(k){return e(a,f(k,g))}}return function(){if(arguments.length)return e.apply(hub,[a].concat(Array.prototype.slice.call(arguments)));return e(a)}}var b=hub.chain(),d;for(d in a)if(a.hasOwnProperty(d)){var c=a[d];b[d]=typeof c==="string"?hub.emitter(c):
hub.emitter.apply(hub,c);b.add(b[d])}return b}})();(function(){var e=hub.emitter,f=hub.on;hub.forward=function(a,g,h,b){if(typeof a==="object")for(var d in a){if(a.hasOwnProperty(d)){g=a[d];typeof g==="string"?f(d,e(g)):f(d,e(g[0],g[1],g[2]))}}else f(a,e(g,h,b))}})();
