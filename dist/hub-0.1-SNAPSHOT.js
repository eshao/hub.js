/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(e,d){if(e===undefined||e===null||e===d)return d;if(d===undefined||d===null)return e;var b=Object.prototype.toString,f=b.call(d);b=b.call(e);var g;if(b===f){if(f==="[object Object]"){for(g in d)if(d.hasOwnProperty(g))e[g]=hub.merge(e[g],d[g]);return e}if(f==="[object Array]")return e.concat(d)}throw new hub.Error("validation",b===f?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:e,source:d,targetType:b,sourceType:f});};
hub.resolve=function(e,d,b){for(var f=d.indexOf(".");f!==-1;){var g=d.substring(0,f);if(!e.hasOwnProperty(g))return b;e=e[g];d=d.substring(f+1);f=d.indexOf(".")}return e.hasOwnProperty(d)?e[d]:b};hub.substitute=function(e,d,b){if(b===undefined)b="";return e.replace(/\{([a-zA-Z0-9\.]+)\}/g,d?function(f,g){return hub.resolve(d,g,b)}:function(){return b})};hub.Error=function(e,d,b){this.type=e;this.context=b;this.toString=function(){return hub.substitute(d,b)}};
hub.iterator=function(e){function d(){if(b>=f)throw Error("Iterator out of bounds.");var g=e[b++];d.hasNext=b<f;return g}var b=0,f=e.length;d.hasNext=b<f;d.remove=function(g){var a=typeof g;if(a==="undefined")g=b;else if(a==="number")g<b&&b--;else{for(a=e.length-1;a>=0;a--)if(e[a]===g){g=a;break}if(a<0)return false}if(g>=f)return false;e.splice(g,1);d.hasNext=b<--f;return true};d.insert=function(g,a){if(typeof a==="undefined"){a=g;g=b}else g<b&&b++;e.splice(g,0,a);d.hasNext=b<++f};d.reset=function(){b=
0;d.hasNext=b<f};return d};
(function(){function e(){var h=a.length;if(!h)return false;h=a[h-1];if(!h.hasNext){a.pop();return e()}h=h().apply(b,f);g=hub.merge(g,h);return true}var d=false,b,f,g,a=[];hub.stopPropagation=function(){d=true;a.length=0;if(arguments.length)g=arguments[0]};hub.propagate=function(){if(arguments.length)g=arguments[0];e()};hub.aborted=function(){return d};hub.chain=function(){function h(){var l=!a.length;if(l){d=false;f=arguments;g=undefined}var o=b;b=this;a.push(c);try{for(;;)if(!e())break}finally{c.reset();if(l)a.length=
0;b=o}if(!a.length){l=g;b=f=g=undefined;return l}}var c=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);h.add=function(l){c.insert(0,l)};h.insert=c.insert;h.remove=c.remove;return h}})();(function(){hub.mix=function(e,d){for(var b in d)if(d.hasOwnProperty(b)&&typeof d[b]==="function"){var f=e,g=b,a=d[b],h=f[g];if(h)if(h.add)h.add(a);else f[g]=hub.chain(a,f[g]);else f[g]=a}return e}})();
(function(){hub.object=function(e,d,b){if(typeof e!=="string"){b=d;d=e;e=null}if(typeof d!=="function")throw new TypeError;var f={},g={mix:function(){var a=hub.get.apply(hub,arguments);hub.mix(f,a)},subscribe:function(a,h){if(!e)throw new TypeError("namespace is "+e);if(!a)throw new TypeError("messsage is "+a);hub.subscribe(e+"."+a,h)}};d=b?d.apply(g,b):d.call(g);return hub.mix(f,d)}})();
(function(){function e(a,h){return function(){return a.apply(h,arguments)}}function d(a,h,c){var l=a.api={},o;for(o in a)if(a.hasOwnProperty(o)){var q=a[o];if(typeof q==="function"){var t=h+"."+o,p=hub.publisher(t);if(c)l[o]=hub.chain(p,q);else{l[o]=p;q=e(q,l);hub.subscribe(t,q)}}}hub.publish("hub.peer.new."+h,l)}var b={},f={},g=[];hub.peer=function(a,h){if(f[a])throw Error('Peer "'+a+'" already defined');var c={};if(typeof h==="function")c.factory=h;else{b[a]=h;d(h,a,false)}f[a]=c};hub.singleton=
function(a,h,c){hub.peer(a,typeof h==="function"?hub.object(a,h,c):h)};hub.get=function(a){var h=arguments.length===1?g:Array.prototype.slice.call(arguments,1),c=b[a];if(c)return c.api;c=f[a];if(!c)throw Error("Peer is not defined: "+a);c=hub.object(a,c.factory,h);d(c,a,true);return c.api};hub.resetPeers=function(){b={};for(var a in f)f.hasOwnProperty(a)&&a.indexOf("lib.")===-1&&delete f[a]}})();
(function(){function e(c){c=c.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+c+"$")}function d(c,l){var o=c.indexOf("*"),q=l.indexOf("*");if(o===-1)return q===-1?0:1;if(q===-1)return-1;var t=c.indexOf("."),p=l.indexOf(".");if(o<t){if(q>p)return-1}else if(q<p)return 1;return 0}function b(c,l){function o(i,j,m){i||(i=c);if(i!==a&&!q.test(i)){if(i.indexOf("*")===-1||!e(i).test(c))return;i=a}var k=j&&j.length?t.apply(this,
j):t.call(this);if(t.aborted){o.aborted=true;return k}if(m){var n,r;n=0;for(r=p.length;n<r;n++)m.push(p[n])}else m=p.slice();for(;m.length;){n=m.shift();r=n.call(this,i,j,m);k=hub.merge(k,r);if(n.aborted){o.aborted=true;break}}return k}c||(c=a);var q=e(c),t=hub.chain(),p=l?[l]:[];o.matches=function(i){return q.test(i)};o.getTopic=function(){return c};o.add=function(i,j,m){if(c===j)t.add(i);else{var k,n,r;n=0;for(r=p.length;n<r;n++){k=p[n];if(k.matches(j)){k.add(i,j,m);return}m||(m=e(j));if(m.test(k.getTopic())){k=
b(j,k);k.add(i,j,m);p[n]=k;return}}k=b(j);k.add(i,j);if(j.indexOf("*")===-1)p.unshift(k);else{n=0;for(r=p.length;n<r;n++){i=p[n].getTopic();if(d(i,j)!==-1){p.splice(n,0,k);return}}p.push(k)}}};o.remove=function(i,j){if(c===j)return t.remove(i);var m,k,n;m=0;for(k=p.length;m<k;m++){n=p[m];if(n.matches(j))if(n.remove(i,j))return true}return false};return o}function f(c){var l=typeof c;if(l!=="string")throw Error("Topic is "+l);if(!c)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(c))throw Error("Illegal topic: "+
c);}function g(c){c=typeof c;if(c!=="function")throw new TypeError("Callback is "+c);}var a="**",h=b();hub.topicChain=b;hub.topicComparator=d;hub.reset=function(){h=b();hub.resetPeers();hub.resetPromise()};hub.subscribe=function(c,l){g(l);f(c);h.add(l,c)};hub.unsubscribe=function(c,l){g(l);f(c);return h.remove(l,c)};hub.invoke=function(c){f(c);var l=Array.prototype.slice.call(arguments,1);if(c.indexOf("{")!==-1)c=hub.substitute(c,l);try{return h(c,l)}catch(o){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',
{topic:c,error:o.message});}}})();
(function(){function e(i,j,m){var k;try{k=i.apply(null,j)}catch(n){hub.invoke("hub.error.promise.callback",new hub.Error("error","Error in promise callback: ${error}",{error:n.message}));return}if(m){if(k===undefined)return j;return[k]}}function d(){hub.invoke("hub.error.promise.resolved",new hub.Error("validation","Promise already resolved"))}function b(i){return function(){i.reject({type:"timeout"})}}function f(i,j,m){var k,n,r=!(j instanceof hub.Error),s=j===undefined?[]:[j],w;w={then:function(u,
v){if(i){var x=r?u:v;if(x)s=e(x,s,true)}else{u&&k.push(u);v&&n.push(v)}return this},publish:function(){if(i){s=[hub.invoke.apply(hub,arguments)];return this}var u=o.call(arguments);return this.then(function(){s=[hub.invoke.apply(hub,u)]})},publishResult:function(u){if(i){s=[hub.invoke.apply(hub,[u].concat(s))];return this}return this.then(function(){s=[hub.invoke.apply(hub,[u].concat(s))]})},resolve:function(){if(i)d();else{i=true;clearTimeout(m);if(arguments.length!==0)s=o.call(arguments);for(;k.length;)e(k.shift(),
s)}return this},reject:function(u){if(i)d();else{i=true;r=false;for(clearTimeout(m);n.length;){var v=n.shift();e(v,[u])}}return this},resolved:function(){return i},join:function(u){return q(w,u)}};if(!i){k=[];n=[];m=setTimeout(b(w),m||6E4)}return w}function g(i){var j=f(true);i.then=j.then;i.publish=j.publish;i.publishResult=j.publishResult;return j}var a=true,h=Array.prototype,c=h.unshift,l=h.push,o=h.slice,q;q=function(i,j){function m(){if(++n===2)(s?r.resolve:r.reject).apply(null,k)}var k=[],n=
0,r=f(false),s=true;i.then(function(){c.apply(k,arguments);m()},function(){c.apply(k,arguments);s=false;m()});j.then(function(){l.apply(k,arguments);m()},function(){l.apply(k,arguments);s=false;m()});return r};var t=Error("hub - promise already resolved"),p=function(){};p.prototype={then:function(i,j){return g(this).then(i,j)},publish:function(){return g(this).publish.apply(null,arguments)},publishResult:function(){return g(this).publishResult.apply(null,arguments)},resolve:function(){throw t;},reject:function(){throw t;
},resolved:function(){return true},join:function(i){return g(this).join(i)}};hub.publish=function(){var i=a;a=false;var j;try{j=hub.invoke.apply(this,arguments)}catch(m){if(a&&m instanceof hub.Error){a.reject(m);return a}throw m;}if(typeof j!=="undefined"){j=f(true,j);a=a?q(a,j):j}j=a;a=i;return j||new p};hub.promise=function(i){i=f(false,undefined,i);if(a===false)a=i;else if(a!==true)a=q(a,i);return i};hub.resetPromise=function(){typeof a!=="boolean"&&a.reject();a=true}})();
(function(){var e=hub.publish,d=hub.merge;hub.publisher=function(b,f,g){if(typeof b==="string"){if(f){if(g)return function(){return e(b,d(f.apply(null,arguments),g))};if(typeof f==="function")return function(){return e(b,f.apply(null,arguments))};return function(l){return e(b,d(l,f))}}return function(){if(arguments.length)return e.apply(hub,[b].concat(Array.prototype.slice.call(arguments)));return e(b)}}var a=hub.chain(),h;for(h in b)if(b.hasOwnProperty(h)){var c=b[h];a[h]=typeof c==="string"?hub.publisher(c):
hub.publisher.apply(hub,c);a.add(a[h])}return a}})();(function(){var e=hub.publisher,d=hub.subscribe;hub.forward=function(b,f,g,a){if(typeof b==="object")for(var h in b){if(b.hasOwnProperty(h)){f=b[h];typeof f==="string"?d(h,e(f)):d(h,e(f[0],f[1],f[2]))}}else d(b,e(f,g,a))}})();
