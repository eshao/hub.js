/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};Hub.iterator=function(s){function r(){if(o>=b)throw Error("Iterator out of bounds.");var c=s[o++];r.hasNext=o<b;return c}var o=0,b=s.length;r.hasNext=o<b;r.remove=function(c){if(typeof c==="undefined")c=o;else c<o&&o--;s.splice(c,1);r.hasNext=o<--b};r.insert=function(c,j){if(typeof j==="undefined"){j=c;c=o}else c<o&&o++;s.splice(c,0,j);r.hasNext=o<++b};return r};(function(){function s(){var a=f.length;if(!a)return false;a=f[a-1];if(!a.hasNext){f.pop();return s()}d=Hub.util.merge(d,a().apply(null,j));return true}function r(){function a(){a.aborted=false;if(!f.length){c=false;j=arguments}d=undefined;try{l=Hub.iterator(h);for(f.push(l);s(););}finally{a.aborted=c;l=false}if(!f.length){var g=d;j=d=undefined;return g}}var h=arguments.length?Array.prototype.slice.call(arguments):[],l=false;a.add=function(g){l?l.insert(0,g):h.unshift(g);return a};a.insert=function(g,
n){l?l.insert(g,n):h.splice(g,0,n);return a};a.remove=function(g){if(typeof g==="number"){l?l.remove(g):h.splice(g,1);return g}for(var n=h.length;n--;)if(h[n]===g){l?l.remove(n):h.splice(n,1);return n}return-1};a.size=function(){return h.length};a.get=function(g){if(g<0||g>h.length)throw Error("Index out of bounds");return h[g]};return a}function o(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+a+"$")}function b(a){a||
(a=e);var h=o(a),l=r(),g=[],n=function(k,i,m){k||(k=a);if(k!==e&&!h.test(k)){if(k.indexOf("*")===-1||!o(k).test(a))return;k=e}var p=l.apply(null,i);if(l.aborted){n.aborted=true;return p}if(m)for(var q=0,t=g.length;q<t;q++)m.push(g[q]);else m=g.slice();for(;m.length;){q=m.shift();p=Hub.util.merge(p,q(k,i,m));if(q.aborted){n.aborted=true;break}}return p};n.matches=function(k){return h.test(k)};n.getTopic=function(){return a};n.add=function(k,i,m){if(a===i)l.add(k);else{for(var p,q=0,t=g.length;q<t;q++){var u=
g[q];if(u.matches(i)){u.add(k,i,m);return}m||(m=o(i));if(m.test(u.getTopic())){p=b(i);p.addChild(u);p.add(k,i,m);g[q]=p;return}}p=b(i);p.add(k,i);if(i.indexOf("*")===-1)g.unshift(p);else{q=0;for(t=g.length;q<t;q++){k=g[q].getTopic();if(Hub.topicComparator(k,i)!==-1){g.splice(q,0,p);return}}g.push(p)}}};n.addChild=function(k){g.unshift(k)};n.getChild=function(k,i){if(a===k)return this;i||(i=o(k));if(i.test(a))return this;for(var m=0,p=g.length;m<p;m++){var q=g[m].getChild(k,i);if(q)return q}};n.remove=
function(k,i){if(a===i)return l.remove(k)!==-1;for(var m=0,p=g.length;m<p;m++){var q=g[m];if(q.matches(i))if(q.remove(k,i))return true}return false};return n}var c=false,j,d,f=[],e="**/**";Hub.stopPropagation=function(){c=true;f.length=0};Hub.propagate=function(){s()};Hub.topicComparator=function(a,h){var l=a.indexOf("*"),g=h.indexOf("*");if(l===-1)return g===-1?0:1;if(g===-1)return-1;var n=a.indexOf("/"),k=h.indexOf("/");if(l<n){if(g>k)return-1}else if(g<k)return 1;return 0};Hub.chain=r;Hub.topicChain=
b})();(function(){function s(d,f){return function(){var e=Array.prototype.slice.call(arguments);e=Hub.publish.apply(Hub,[d].concat(e));Hub.aborted()||(e=Hub.util.merge(e,f.apply(null,arguments)));return e}}function r(d){var f=b[d];if(f)return f;f=c[d];if(!f)throw Error("Peer is not defined: "+d);f=o(f);var e={},a;for(a in f){var h=f[a];if(typeof h==="function")e[a]=s(d+"/"+a,h)}f.api=e;return f}function o(d){for(var f={},e=d.is,a=0,h;h=e[a++];){var l=f;h=r(h);var g=void 0;for(g in h){var n=h[g],k=l[g];
k||(l[g]=k=Hub.chain());k.add(n)}}d=d.instance||d.factory();for(var i in d){e=d[i];(a=f[i])||(f[i]=a=Hub.chain());a.add(e)}return f}var b={},c={},j=[];Hub.peer=function(d,f,e){if(c[d])throw Error("Hub - peer already defined: "+d);if(!e){e=f;f=null}f={is:f?typeof f==="string"?[f]:f:j};if(typeof e==="function")f.factory=e;else{f.instance=e;e=b[d]=o(f);var a=e.api={},h;for(h in e){var l=e[h];if(typeof l==="function"){var g=d+"/"+h;Hub.subscribe(g,l);a[h]=Hub.publisher(g)}}}c[d]=f};Hub.get=function(d){return r(d).api};
Hub.resetPeers=function(){b={};for(var d in c)d.indexOf("lib.")===-1&&delete c[d]}})();(function(){function s(b){var c=typeof b;if(c!=="string")throw Error("Topic is not string: "+c);if(!b)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(b))throw Error("Illegal topic: "+b);}function r(b){b=typeof b;if(b!=="function")throw Error("Callback is not function: "+b);}var o=Hub.topicChain();Hub.reset=function(){o=Hub.topicChain();Hub.resetPeers()};Hub.subscribe=function(b,c){r(c);s(b);o.add(c,b)};Hub.unsubscribe=function(b,c){r(c);s(b);return o.remove(c,
b)};Hub.invoke=function(b){s(b);var c=Array.prototype.slice.call(arguments,1);if(b.indexOf("{")!==-1)b=Hub.util.substitute(b,c);try{return o(b,c)}catch(j){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:b,error:j.message});}};Hub.aborted=function(){return Boolean(o.aborted)};Hub.forward=function(b,c,j,d){if(typeof b==="object")for(var f in b){c=b[f];typeof c==="string"?Hub.subscribe(f,Hub.publisher(c)):Hub.subscribe(f,Hub.publisher(c[0],c[1],c[2]))}else Hub.subscribe(b,
Hub.publisher(c,j,d))};Hub.publisher=function(b,c,j){if(typeof b==="string"){if(c){if(j)return function(){return Hub.publish(b,Hub.util.merge(c.apply(null,arguments),j))};if(typeof c==="function")return function(){return Hub.publish(b,c.apply(null,arguments))};return function(a){return Hub.publish(b,Hub.util.merge(a,c))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,[b].concat(Array.prototype.slice.call(arguments)));return Hub.publish(b)}}var d=Hub.chain(),f;for(f in b){var e=
b[f];d[f]=typeof e==="string"?Hub.publisher(e):Hub.publisher.apply(Hub,e);d.add(d[f])}return d};Hub.Error=function(b,c,j){this.type=b;this.context=j;this.toString=function(){return Hub.util.substitute(c,j)}};Hub.util.merge=function(b,c){if(b===undefined||b===null||b===c)return c;if(c===undefined||c===null)return b;var j=Object.prototype.toString,d=j.call(c);j=j.call(b);if(j===d){if(d==="[object Object]"){for(var f in c)b[f]=arguments.callee(b[f],c[f]);return b}if(d==="[object Array]")return b.concat(c)}throw new Hub.Error("validation",
j===d?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:b,source:c,targetType:j,sourceType:d});};Hub.util.resolve=function(b,c,j){var d=c.indexOf(".");if(d!==-1){var f=c.substring(0,d);if(f in b)return arguments.callee(b[f],c.substring(d+1),j);return j}return c in b?b[c]:j};Hub.util.substitute=function(b,c,j){if(j===undefined)j="";return b.replace(/\{([a-zA-Z0-9\.]+)\}/g,c?function(d,f){return Hub.util.resolve(c,f,j)}:function(){return j})}})();(function(){function s(e,a){try{e(a)}catch(h){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:h.message}))}}function r(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function o(e){return function(){e.reject({type:"timeout"})}}function b(e,a,h){var l,g,n=!(a instanceof Hub.Error),k;k={then:function(i,m){if(e){var p=n?i:m;p&&s(p,a)}else{i&&l.push(i);m&&g.push(m)}return this},publish:function(i){if(e){a=
Hub.invoke.apply(Hub,arguments);return this}var m=[i];if(arguments.length>1)m=m.concat(arguments);return this.then(function(){a=Hub.invoke.apply(Hub,m)})},publishResult:function(i){if(e){a=Hub.invoke(i,a);return this}return this.then(function(){a=Hub.invoke(i,a)})},fulfill:function(i){if(e)r();else{e=true;clearTimeout(h);for(a=Hub.util.merge(a,i);l.length;)s(l.shift(),a)}return this},reject:function(i){if(e)r();else{e=true;n=false;for(clearTimeout(h);g.length;)s(g.shift(),i)}return this},fulfilled:function(){return e}};
if(!e){l=[];g=[];h=setTimeout(o(k),h||6E4)}return k}function c(e,a){function h(){if(++k===2)(m?i.fulfill:i.reject)(n)}function l(p){if(m)n=Hub.util.merge(n,p);h()}function g(p){if(m){m=false;n=p}else n=Hub.util.merge(n,p);h()}var n,k=0,i=b(false),m=true;e.then(l,g);a.then(l,g);return i}function j(e){var a=b(true);e.then=a.then;e.publish=a.publish;e.publishResult=a.publishResult;return a}var d=true,f=function(){};f.prototype={then:function(e,a){return j(this).then(e,a)},publish:function(){return j(this).publish.apply(null,
arguments)},publishResult:function(){return j(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},reject:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var e=d;d=false;var a;try{a=Hub.invoke.apply(this,arguments)}catch(h){if(d&&h instanceof Hub.Error){d.reject(h);return d}throw h;}if(typeof a!=="undefined"){a=b(true,a);d=d?c(d,a):a}a=d;d=e;return a||new f};Hub.promise=
function(e){e=b(false,undefined,e);if(d===true)return e;if(d===false)return d=e;d=c(d,e);return e}})();
