/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(e,f){if(e===undefined||e===null||e===f)return f;if(f===undefined||f===null)return e;var a=Object.prototype.toString,g=a.call(f);a=a.call(e);var h;if(a===g){if(g==="[object Object]"){for(h in f)if(f.hasOwnProperty(h))e[h]=hub.merge(e[h],f[h]);return e}if(g==="[object Array]")return e.concat(f)}throw new hub.Error("validation",a===g?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:e,source:f,targetType:a,sourceType:g});};
hub.resolve=function(e,f,a){for(var g=f.indexOf(".");g!==-1;){var h=f.substring(0,g);if(!e.hasOwnProperty(h))return a;e=e[h];f=f.substring(g+1);g=f.indexOf(".")}return e.hasOwnProperty(f)?e[f]:a};hub.substitute=function(e,f,a){if(a===undefined)a="";return e.replace(/\{([a-zA-Z0-9\.]+)\}/g,f?function(g,h){return hub.resolve(f,h,a)}:function(){return a})};hub.Error=function(e,f,a){this.type=e;this.context=a;this.toString=function(){return hub.substitute(f,a)}};
hub.iterator=function(e){function f(){if(a>=g)throw Error("Iterator out of bounds.");var h=e[a++];f.hasNext=a<g;return h}var a=0,g=e.length;f.hasNext=a<g;f.remove=function(h){var d=typeof h;if(d==="undefined")h=a;else if(d==="number")h<a&&a--;else{for(d=e.length-1;d>=0;d--)if(e[d]===h){h=d;break}if(d<0)return false}if(h>=g)return false;e.splice(h,1);f.hasNext=a<--g;return true};f.insert=function(h,d){if(typeof d==="undefined"){d=h;h=a}else h<a&&a++;e.splice(h,0,d);f.hasNext=a<++g};f.reset=function(){a=
0;f.hasNext=a<g};return f};
(function(){function e(b){var l=[],n=false,m,j,k;return k={stopPropagation:function(){n=true;l.length=0;if(arguments.length)j=arguments[0]},propagate:function(){if(arguments.length)j=arguments[0];var i=l.length;if(!i)return k.result();i=l[i-1];if(i.hasNext){i=i().apply(k,b);if(m){j=m;m=undefined;j.then(k.propagate);return j}else if(i&&i.then){j=i;j.then(k.propagate);return}j=hub.merge(j,i)}else{i.reset();l.pop()}return k.propagate()},aborted:function(){return n},result:function(){if(j&&j.then)return j;
return hub.promise(0,k).resolve(j)},push:function(i){l.push(i)},promise:function(){return m=hub.promise()}}}function f(){function b(){var n=this.propagate?this:e(arguments);n.push(l);return n.propagate()}var l=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);b.add=function(n){var m=typeof n;if(m!=="function")throw new TypeError("Callback is "+m);l.insert(0,n)};b.insert=l.insert;b.remove=l.remove;return b}function a(b){b=b.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,
"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+b+"$")}function g(b){var l=typeof b;if(l!=="string")throw Error("Topic is "+l);if(!b)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(b))throw Error("Illegal topic: "+b);}function h(b,l){var n=b.indexOf("*"),m=l.indexOf("*");if(n===-1)return m===-1?0:1;if(m===-1)return-1;var j=b.indexOf("."),k=l.indexOf(".");if(n<j){if(m>k)return-1}else if(m<k)return 1;return 0}function d(b,l){function n(i){i||(i=b);if(i!==c&&!m.test(i)){if(i.indexOf("*")===
-1||!a(i).test(b))return;i=c}var o=this.propagate?this:e(Array.prototype.slice.call(arguments,1));j&&j.call(o);if(o.aborted())return o.result();var p=o.topicChainQueue;if(p)Array.prototype.push.apply(p,k);else p=o.topicChainQueue=k.slice();for(;p.length;){p.shift().call(o,i);if(o.aborted())break}return o.result()}if(b)g(b);else b=c;var m=a(b),j,k=l?[l]:[];n.matches=function(i){return m.test(i)};n.getTopic=function(){return b};n.add=function(i,o,p){if(b===i){j||(j=f());j.add(o)}else{var q,r,s;r=0;
for(s=k.length;r<s;r++){q=k[r];if(q.matches(i)){q.add(i,o,p);return}p||(p=a(i));if(p.test(q.getTopic())){q=d(i,q);q.add(i,o,p);k[r]=q;return}}q=d(i);q.add(i,o);if(i.indexOf("*")===-1)k.unshift(q);else{r=0;for(s=k.length;r<s;r++){o=k[r].getTopic();if(h(o,i)!==-1){k.splice(r,0,q);return}}k.push(q)}}};n.remove=function(i,o){if(b===i)return j?j.remove(o):-1;var p,q,r;p=0;for(q=k.length;p<q;p++){r=k[p];if(r.matches(i))if(r.remove(i,o))return true}g(i);p=typeof o;if(p!=="function")throw new TypeError("Callback is "+
p);return false};return n}var c="**";hub.scope=e;hub.chain=f;hub.topicChain=d;hub.topicComparator=h;hub.validateTopic=g})();(function(){hub.mix=function(e,f){for(var a in f)if(f.hasOwnProperty(a)&&typeof f[a]==="function"){var g=e,h=a,d=f[a],c=g[h];if(c)if(c.add)c.add(d);else g[h]=hub.chain(d,g[h]);else g[h]=d}return e}})();
(function(){hub.create=function(e,f,a){if(typeof e!=="string"){a=f;f=e;e=null}if(typeof f!=="function")throw new TypeError;var g={};e=e?hub.topicScope(e):hub.scope();e.mix=function(){hub.emit.apply(hub,arguments).then(function(h){hub.mix(g,h)})};f=a?f.apply(e,a):f.call(e);return hub.mix(g,f)}})();
(function(){function e(d,c){for(var b in c)c.hasOwnProperty(b)&&hub.root.add(d+b,c[b])}function f(d){return function(){return d}}function a(d,c){d+=".";return function(){var b=h.call(arguments);if(!b[0])throw new TypeError("Topic is "+b[0]);b[0]=d+b[0];return c.apply(this,b)}}hub.root=hub.topicChain();var g={},h=Array.prototype.slice;hub.on=function(d,c){if(Object.prototype.toString.call(d)==="[object Object]")e("",d);else{if(Object.prototype.toString.call(c)==="[object Object]"){e(d+".",c);c=f(c)}hub.root.add(d,
c)}};hub.un=function(d,c){return hub.root.remove(d,c)};hub.topicScope=function(d,c){c||(c=hub.scope());var b=g[d];if(!b){b={on:a(d,hub.on),un:a(d,hub.un),peer:a(d,hub.peer),emit:a(d,hub.emit),create:a(d,hub.create)};g[d]=b}c.on=b.on;c.un=b.un;c.peer=b.peer;c.emit=b.emit;c.create=b.create;return c};hub.emit=function(d){hub.validateTopic(d);var c=h.call(arguments),b=c.slice(1);if(d.indexOf("{")!==-1)c[0]=hub.substitute(d,b);b=this.propagate?this:hub.scope(b);b=hub.topicScope(c[0],b);var l;try{l=hub.root.apply(b,
c)}catch(n){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:c[0],error:n.message});}if(!l||!l.then){c=hub.promise(0,b);c.resolve(l);l=c}return l};hub.peer=function(d,c,b){if(typeof d==="function"){if(c=hub.create(d,c))hub.on(c)}else if(typeof c==="function"){if(c=hub.create(d,c,b))hub.on(d,c)}else hub.on(d,c)};hub.reset=function(){g={};hub.root=hub.topicChain()}})();
(function(){hub.promise=function(e,f){function a(){n&&clearTimeout(n);for(var j=l?d:h,k=0,i=j.length;k<i;k++)j[k].apply(f,c);h.length=0;d.length=0}function g(){b--;!b&&c&&a()}var h=[],d=[],c,b=0,l=false,n,m;m={then:function(j,k){if(typeof j!=="function")throw new TypeError("Callback is "+j);h.push(j);k&&d.push(k);!b&&c&&a();return m},resolve:function(){if(c)throw Error("Promise already "+(l?"rejected":"resolved"));c=Array.prototype.slice.call(arguments);b||a();return m},reject:function(){l=true;return m.resolve.apply(m,
arguments)},wait:function(){var j=0,k=arguments.length;for(b+=k;j<k;j++)arguments[j].then(g);return m},join:function(j){if(!j||typeof j.then!=="function")throw new TypeError("Promise is "+j);var k=hub.promise();m.then(function(i){j.then(function(o){k.resolve(i,o)})});return k},emit:function(j){m.then(function(){hub.emit.apply(hub,[j].concat(c))})}};if(e)n=setTimeout(function(){m.reject(new hub.Error("timeout","Promise timed out after {timeout} milliseconds",{timeout:e}))},e);return m}})();
(function(){var e=hub.emit,f=hub.merge;hub.emitter=function(a,g,h){if(typeof a==="string"){if(g){if(h)return function(){return e(a,f(g.apply(null,arguments),h))};if(typeof g==="function")return function(){return e(a,g.apply(null,arguments))};return function(l){return e(a,f(l,g))}}return function(){if(arguments.length)return e.apply(hub,[a].concat(Array.prototype.slice.call(arguments)));return e(a)}}var d=hub.chain(),c;for(c in a)if(a.hasOwnProperty(c)){var b=a[c];d[c]=typeof b==="string"?hub.emitter(b):
hub.emitter.apply(hub,b);d.add(d[c])}return d}})();(function(){var e=hub.emitter,f=hub.on;hub.forward=function(a,g,h,d){if(typeof a==="object")for(var c in a){if(a.hasOwnProperty(c)){g=a[c];typeof g==="string"?f(c,e(g)):f(c,e(g[0],g[1],g[2]))}}else f(a,e(g,h,d))}})();
