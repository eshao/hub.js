/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(d){function e(){}e.prototype=d;return new e};hub.apply=function(d,e){this[d].apply(this,e)};hub.resolve=function(d,e,c){for(var f=e.indexOf(".");f!==-1;){var g=e.substring(0,f);if(!d.hasOwnProperty(g))return c;d=d[g];e=e.substring(f+1);f=e.indexOf(".")}return d.hasOwnProperty(e)?d[e]:c};hub.substitute=function(d,e,c){if(c===undefined)c="";return d.replace(/\{([a-zA-Z0-9\.]+)\}/g,e?function(f,g){return hub.resolve(e,g,c)}:function(){return c})};
hub.Error=function(d,e,c){this.type=d;this.context=c;this.toString=function(){return hub.substitute(e,c)}};
hub.merge=function(d,e){if(d===undefined||d===null||d===e)return e;if(e===undefined||e===null)return d;var c=Object.prototype.toString,f=c.call(e);c=c.call(d);var g;if(c===f){if(f==="[object Object]"){for(g in e)if(e.hasOwnProperty(g))d[g]=hub.merge(d[g],e[g]);return d}if(f==="[object Array]")return d.concat(e)}throw new hub.Error("validation",c===f?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:d,source:e,targetType:c,sourceType:f});};
hub.iterator=function(d){function e(){if(c>=f)throw Error("Iterator out of bounds.");var g=d[c++];e.hasNext=c<f;return g}var c=0,f=d.length;e.hasNext=c<f;e.remove=function(g){var a=typeof g;if(a==="undefined")g=c;else if(a==="number")g<c&&c--;else{for(a=d.length-1;a>=0;a--)if(d[a]===g){g=a;break}if(a<0)return false}if(g>=f)return false;d.splice(g,1);e.hasNext=c<--f;return true};e.insert=function(g,a){if(typeof a==="undefined"){a=g;g=c}else g<c&&c++;d.splice(g,0,a);e.hasNext=c<++f};e.reset=function(){c=
0;e.hasNext=c<f};return e};
(function(){var d={};(function(){function e(a){d[a]=function(){var b=this.promise();b[a].apply(b,arguments)}}for(var c=["then","join","wait","resolve","reject"],f=0,g=c.length;f<g;f++)e(c[f])})();hub.scope=function(e){function c(){return h.propagate()}var f=[],g=false,a,b,h=Object.create(d);h.stopPropagation=function(){g=true;f.length=0;if(arguments.length)b=arguments[0]};h.propagate=function(){if(arguments.length)b=arguments[0];var i=f.length;if(!i)return this.result();i=f[i-1];if(i.hasNext){i=i().apply(this,
e);if(a){b=a;a=undefined;b.then(c);return b}else if(i&&i.then){b=i;b.then(c);return}b=hub.merge(b,i)}else{i.reset();f.pop()}return this.propagate()};h.aborted=function(){return g};h.result=function(){if(b&&b.then)return b;return hub.promise(0,this).resolve(b)};h.push=function(i){f.push(i)};h.promise=function(){a||(a=hub.promise());return a};return h}})();
(function(){hub.chain=function(){function d(){var c=this.propagate?this:hub.scope(arguments);c.push(e);return c.propagate()}var e=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);d.on=function(c){var f=typeof c;if(f!=="function")throw new TypeError("Callback is "+f);e.insert(0,c)};d.un=e.remove;return d}})();
(function(){function d(a){var b=typeof a;if(b!=="string")throw Error("Topic is "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(a))throw Error("Illegal topic: "+a);}function e(a,b){var h=a.indexOf("*"),i=b.indexOf("*");if(h===-1)return i===-1?0:1;if(i===-1)return-1;var p=a.indexOf("."),k=b.indexOf(".");if(h<p){if(i>k)return-1}else if(i<k)return 1;return 0}function c(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+a+"$")}function f(a,b){if(a)d(a);else a=g;var h=c(a),i,p=b?[b]:[];return{emit:function(k){k||(k=a);if(k!==g&&!h.test(k)){if(k.indexOf("*")===-1||!c(k).test(a))return;k=g}var n=this.propagate?this:hub.scope(Array.prototype.slice.call(arguments,1));i&&i.call(n);if(n.aborted())return n.result();var l=n.topicChainQueue;if(l)Array.prototype.push.apply(l,p);else l=n.topicChainQueue=p.slice();for(;l.length;){l.shift().emit.call(n,k);if(n.aborted())break}return n.result()},matches:function(k){return h.test(k)},
getTopic:function(){return a},on:function(k,n,l){if(a===k){i||(i=hub.chain());i.on(n)}else{var o,q,r;q=0;for(r=p.length;q<r;q++){o=p[q];if(o.matches(k)){o.on(k,n,l);return}l||(l=c(k));if(l.test(o.getTopic())){o=f(k,o);o.on(k,n,l);p[q]=o;return}}o=f(k);o.on(k,n);if(k.indexOf("*")===-1)p.unshift(o);else{q=0;for(r=p.length;q<r;q++){n=p[q].getTopic();if(e(n,k)!==-1){p.splice(q,0,o);return}}p.push(o)}}},un:function(k,n){if(a===k)return i?i.un(n):-1;var l,o,q;l=0;for(o=p.length;l<o;l++){q=p[l];if(q.matches(k))if(q.un(k,
n))return true}d(k);l=typeof n;if(l!=="function")throw new TypeError("Callback is "+l);return false}}}var g="**";hub.node=f;hub.topicComparator=e;hub.validateTopic=d})();
(function(){hub.mix=function(d,e){for(var c in e)if(e.hasOwnProperty(c)&&typeof e[c]==="function"){var f=d,g=c,a=e[c],b=f[g];if(b)if(b.add)b.add(a);else f[g]=hub.chain(a,f[g]);else f[g]=hub.chain(a)}return d};hub.create=function(d,e,c){if(typeof d!=="string"){c=e;e=d;d=null}if(typeof e!=="function")throw new TypeError;var f={};d=d?hub.topicScope(d):hub.scope();d.mix=function(){hub.emit.apply(hub,arguments).then(function(g){hub.mix(f,g)})};e=c?e.apply(d,c):e.call(d);return hub.mix(f,e)};hub.factory=
function(d,e){return function(){return hub.create(d,e)}}})();
(function(){function d(a,b){for(var h in b)if(b.hasOwnProperty(h))hub.root.on(a+h,b[h])}function e(a){return function(){return a}}function c(a,b){if(a)a+=".";return function(){var h=g.call(arguments);if(!h[0])throw new TypeError("Topic is "+h[0]);h[0]=a+h[0];return b.apply(this,h)}}hub.root=hub.node();var f={},g=Array.prototype.slice;hub.on=function(a,b){if(typeof a==="function")hub.root.on("**",a);else if(Object.prototype.toString.call(a)==="[object Object]"){d("",a);return}else if(Object.prototype.toString.call(b)===
"[object Object]"){d(a+".",b);b=e(b)}hub.root.on(a,b)};hub.un=function(a,b){if(typeof a==="function")return hub.root.un("**",a);return hub.root.un(a,b)};hub.topicScope=function(a,b){b||(b=hub.scope());var h=a.lastIndexOf(".");h=h===-1?"":a.substring(0,h);var i=f[h];if(!i){i={topic:e(a),on:c(h,hub.on),un:c(h,hub.un),peer:c(h,hub.peer),emit:c(h,hub.emit),create:c(h,hub.create),factory:c(h,hub.factory)};f[h]=i}b.topic=i.topic;b.on=i.on;b.un=i.un;b.peer=i.peer;b.emit=i.emit;b.create=i.create;b.factory=
i.factory;return b};hub.emit=function(a){hub.validateTopic(a);var b=g.call(arguments),h=b.slice(1);if(a.indexOf("{")!==-1)b[0]=hub.substitute(a,h);h=this.propagate?this:hub.scope(h);h=hub.topicScope(b[0],h);var i;try{i=hub.root.emit.apply(h,b)}catch(p){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:b[0],error:p.message});}if(!i||!i.then){b=hub.promise(0,h);b.resolve(i);i=b}return i};hub.peer=function(a,b,h){if(typeof a==="function"){if(b=hub.create(a,b))hub.on(b)}else if(typeof b===
"function"){if(b=hub.create(a,b,h))hub.on(a,b)}else hub.on(a,b)};hub.reset=function(){f={};hub.root=hub.node()}})();
(function(){var d=Array.prototype.slice;hub.promise=function(e,c){function f(){r&&clearTimeout(r);for(var j=q?n:k,m=0,s=j.length;m<s;m++)j[m].apply(c,l);k.length=0;n.length=0}function g(){o--;!o&&l&&f()}function a(j){return function(){j.reject.apply(j,arguments)}}function b(j,m){return function(){var s=d.call(arguments);m.then(function(){var u=d.call(arguments);j.resolve.apply(j,s.concat(u))})}}function h(){if(l)throw Error("Promise already "+(q?"rejected":"resolved"));}function i(j,m){return function(){j.apply(hub,
[m].concat(l))}}function p(j,m){return function(){j.apply(hub,m)}}var k=[],n=[],l,o=0,q=false,r,t;t={then:function(j,m){if(!j&&!m)throw new TypeError("Require callback or errback");if(j&&typeof j!=="function")throw new TypeError("Callback is "+j);if(m&&typeof m!=="function")throw new TypeError("Errback is "+m);j&&k.push(j);m&&n.push(m);!o&&l&&f();return this},resolve:function(){h();l=d.call(arguments);o||f();return this},reject:function(){h();q=true;l=d.call(arguments);o||f();return this},wait:function(){var j=
0,m=arguments.length;for(o+=m;j<m;j++)arguments[j].then(g,g);return this},join:function(j){if(!j||typeof j.then!=="function")throw new TypeError("Promise is "+j);var m=hub.promise();this.then(b(m,j),a(m));j.then(null,a(m));return m},emit:function(j){hub.validateTopic(j);return this.then(arguments.length===1?i(hub.emit,j):p(hub.emit,arguments))},create:function(j){hub.validateTopic(j);return this.then(i(hub.create,j))}};if(e)r=setTimeout(function(){t.reject(new hub.Error("timeout","Promise timed out after {timeout} milliseconds",
{timeout:e}))},e);return t}})();
(function(){var d=hub.emit,e=hub.merge;hub.emitter=function(c,f,g){if(typeof c==="string"){if(f){if(g)return function(){return d(c,e(f.apply(null,arguments),g))};if(typeof f==="function")return function(){return d(c,f.apply(null,arguments))};return function(i){return d(c,e(i,f))}}return function(){if(arguments.length)return d.apply(hub,[c].concat(Array.prototype.slice.call(arguments)));return d(c)}}var a=hub.chain(),b;for(b in c)if(c.hasOwnProperty(b)){var h=c[b];a[b]=typeof h==="string"?hub.emitter(h):
hub.emitter.apply(hub,h);a.on(a[b])}return a}})();(function(){var d=hub.emitter,e=hub.on;hub.forward=function(c,f,g,a){if(typeof c==="object")for(var b in c){if(c.hasOwnProperty(b)){f=c[b];typeof f==="string"?e(b,d(f)):e(b,d(f[0],f[1],f[2]))}}else e(c,d(f,g,a))}})();
(function(){function d(c){return function(){var f=e.call(arguments);return function(){var g=e.call(arguments);return hub[c].apply(hub,f.concat(g))}}}var e=Array.prototype.slice;hub.does={emit:d("emit"),on:d("on"),un:d("un"),create:d("create"),factory:d("factory"),peer:d("peer")}})();
