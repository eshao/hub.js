/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(d,e){if(d===undefined||d===null||d===e)return e;if(e===undefined||e===null)return d;var b=Object.prototype.toString,h=b.call(e);b=b.call(d);var i;if(b===h){if(h==="[object Object]"){for(i in e)if(e.hasOwnProperty(i))d[i]=hub.merge(d[i],e[i]);return d}if(h==="[object Array]")return d.concat(e)}throw new hub.Error("validation",b===h?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:d,source:e,targetType:b,sourceType:h});};
hub.resolve=function(d,e,b){for(var h=e.indexOf(".");h!==-1;){var i=e.substring(0,h);if(!d.hasOwnProperty(i))return b;d=d[i];e=e.substring(h+1);h=e.indexOf(".")}return d.hasOwnProperty(e)?d[e]:b};hub.substitute=function(d,e,b){if(b===undefined)b="";return d.replace(/\{([a-zA-Z0-9\.]+)\}/g,e?function(h,i){return hub.resolve(e,i,b)}:function(){return b})};hub.Error=function(d,e,b){this.type=d;this.context=b;this.toString=function(){return hub.substitute(e,b)}};
hub.iterator=function(d){function e(){if(b>=h)throw Error("Iterator out of bounds.");var i=d[b++];e.hasNext=b<h;return i}var b=0,h=d.length;e.hasNext=b<h;e.remove=function(i){var a=typeof i;if(a==="undefined")i=b;else if(a==="number")i<b&&b--;else{for(a=d.length-1;a>=0;a--)if(d[a]===i){i=a;break}if(a<0)return false}if(i>=h)return false;d.splice(i,1);e.hasNext=b<--h;return true};e.insert=function(i,a){if(typeof a==="undefined"){a=i;i=b}else i<b&&b++;d.splice(i,0,a);e.hasNext=b<++h};e.reset=function(){b=
0;e.hasNext=b<h};return e};
(function(){function d(c){var m=[],o=false,p;return{stopPropagation:function(){o=true;m.length=0;if(arguments.length)p=arguments[0]},propagate:function(){if(arguments.length)p=arguments[0];var q=m.length;if(!q)return false;q=m[q-1];if(!q.hasNext){m.pop();return this.propagate()}q=q().apply(this,c);p=hub.merge(p,q);return true},aborted:function(){return o},result:function(){return p},push:function(q){m.push(q)}}}function e(){function c(){var o=this.propagate?this:d(arguments);o.push(m);try{for(;;)if(!o.propagate())break}finally{m.reset()}return o.result()}
var m=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);c.add=function(o){var p=typeof o;if(p!=="function")throw new TypeError("Callback is "+p);m.insert(0,o)};c.insert=m.insert;c.remove=m.remove;return c}function b(c){c=c.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+c+"$")}function h(c){var m=typeof c;if(m!=="string")throw Error("Topic is "+m);if(!c)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(c))throw Error("Illegal topic: "+
c);}function i(c,m){var o=c.indexOf("*"),p=m.indexOf("*");if(o===-1)return p===-1?0:1;if(p===-1)return-1;var q=c.indexOf("."),r=m.indexOf(".");if(o<q){if(p>r)return-1}else if(p<r)return 1;return 0}function a(c,m){function o(g){g||(g=c);if(g!==f&&!p.test(g)){if(g.indexOf("*")===-1||!b(g).test(c))return;g=f}var j=this.propagate?this:d(Array.prototype.slice.call(arguments,1));q.call(j);if(j.aborted())return j.result();var k=j.topicChainQueue;if(k)Array.prototype.push.apply(k,r);else k=j.topicChainQueue=
r.slice();for(;k.length;){k.shift().call(j,g);if(j.aborted())break}return j.result()}if(c)h(c);else c=f;var p=b(c),q=e(),r=m?[m]:[];o.matches=function(g){return p.test(g)};o.getTopic=function(){return c};o.add=function(g,j,k){if(c===g)q.add(j);else{var l,n,u;n=0;for(u=r.length;n<u;n++){l=r[n];if(l.matches(g)){l.add(g,j,k);return}k||(k=b(g));if(k.test(l.getTopic())){l=a(g,l);l.add(g,j,k);r[n]=l;return}}l=a(g);l.add(g,j);if(g.indexOf("*")===-1)r.unshift(l);else{n=0;for(u=r.length;n<u;n++){j=r[n].getTopic();
if(i(j,g)!==-1){r.splice(n,0,l);return}}r.push(l)}}};o.remove=function(g,j){if(c===g)return q.remove(j);var k,l,n;k=0;for(l=r.length;k<l;k++){n=r[k];if(n.matches(g))if(n.remove(g,j))return true}h(g);k=typeof j;if(k!=="function")throw new TypeError("Callback is "+k);return false};return o}var f="**";hub.scope=d;hub.chain=e;hub.topicChain=a;hub.topicComparator=i;hub.validateTopic=h})();
(function(){hub.mix=function(d,e){for(var b in e)if(e.hasOwnProperty(b)&&typeof e[b]==="function"){var h=d,i=b,a=e[b],f=h[i];if(f)if(f.add)f.add(a);else h[i]=hub.chain(a,h[i]);else h[i]=a}return d}})();(function(){hub.create=function(d,e,b){if(typeof d!=="string"){b=e;e=d;d=null}if(typeof e!=="function")throw new TypeError;var h={};d=d?hub.topicScope(d):hub.scope();d.mix=function(){hub.emit.apply(hub,arguments).then(function(i){hub.mix(h,i)})};e=b?e.apply(d,b):e.call(d);return hub.mix(h,e)}})();
(function(){function d(a,f){for(var c in f)f.hasOwnProperty(c)&&hub.root.add(a+c,f[c])}function e(a){return function(){return a}}function b(a,f){a+=".";return function(){var c=i.call(arguments);if(!c[0])throw new TypeError("Topic is "+c[0]);c[0]=a+c[0];return f.apply(this,c)}}hub.root=hub.topicChain();var h={},i=Array.prototype.slice;hub.on=function(a,f){if(Object.prototype.toString.call(a)==="[object Object]")d("",a);else{if(Object.prototype.toString.call(f)==="[object Object]"){d(a+".",f);f=e(f)}hub.root.add(a,
f)}};hub.un=function(a,f){return hub.root.remove(a,f)};hub.topicScope=function(a,f){f||(f=hub.scope());var c=h[a];if(!c){c={on:b(a,hub.on),un:b(a,hub.un),peer:b(a,hub.peer),emit:b(a,hub.emit),create:b(a,hub.create)};h[a]=c}f.on=c.on;f.un=c.un;f.peer=c.peer;f.emit=c.emit;f.create=c.create;return f};hub.invoke=function(a){hub.validateTopic(a);var f=i.call(arguments),c=f.slice(1);if(a.indexOf("{")!==-1)f[0]=hub.substitute(a,c);c=this.propagate?this:hub.scope(c);c=hub.topicScope(f[0],c);try{return hub.root.apply(c,
f)}catch(m){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:f[0],error:m.message});}};hub.peer=function(a,f,c){if(typeof a==="function"){if(f=hub.create(a,f))hub.on(f)}else if(typeof f==="function"){if(f=hub.create(a,f,c))hub.on(a,f)}else hub.on(a,f)};hub.reset=function(){h={};hub.root=hub.topicChain();hub.resetPromise()}})();
(function(){function d(g,j,k){var l;try{l=g.apply(null,j)}catch(n){hub.invoke("hub.error.promise.callback",new hub.Error("error","Error in promise callback: ${error}",{error:n.message}));return}if(k){if(l===undefined)return j;return[l]}}function e(){hub.invoke("hub.error.promise.resolved",new hub.Error("validation","Promise already resolved"))}function b(g){return function(){g.reject({type:"timeout"})}}function h(g,j,k){var l,n,u=!(j instanceof hub.Error),s=j===undefined?[]:[j],w;w={then:function(t,
v){if(g){var x=u?t:v;if(x)s=d(x,s,true)}else{t&&l.push(t);v&&n.push(v)}return this},emit:function(){if(g){s=[hub.invoke.apply(hub,arguments)];return this}var t=o.call(arguments);return this.then(function(){s=[hub.invoke.apply(hub,t)]})},emitResult:function(t){if(g){s=[hub.invoke.apply(hub,[t].concat(s))];return this}return this.then(function(){s=[hub.invoke.apply(hub,[t].concat(s))]})},resolve:function(){if(g)e();else{g=true;clearTimeout(k);if(arguments.length!==0)s=o.call(arguments);for(;l.length;)d(l.shift(),
s)}return this},reject:function(t){if(g)e();else{g=true;u=false;for(clearTimeout(k);n.length;){var v=n.shift();d(v,[t])}}return this},resolved:function(){return g},join:function(t){return p(w,t)}};if(!g){l=[];n=[];k=setTimeout(b(w),k||6E4)}return w}function i(g){var j=h(true);g.then=j.then;g.emit=j.emit;g.emitResult=j.emitResult;return j}var a=true,f=Array.prototype,c=f.unshift,m=f.push,o=f.slice,p;p=function(g,j){function k(){if(++n===2)(s?u.resolve:u.reject).apply(null,l)}var l=[],n=0,u=h(false),
s=true;g.then(function(){c.apply(l,arguments);k()},function(){c.apply(l,arguments);s=false;k()});j.then(function(){m.apply(l,arguments);k()},function(){m.apply(l,arguments);s=false;k()});return u};var q=Error("hub - promise already resolved"),r=function(){};r.prototype={then:function(g,j){return i(this).then(g,j)},emit:function(){return i(this).emit.apply(null,arguments)},emitResult:function(){return i(this).emitResult.apply(null,arguments)},resolve:function(){throw q;},reject:function(){throw q;
},resolved:function(){return true},join:function(g){return i(this).join(g)}};hub.emit=function(){var g=a;a=false;var j;try{j=hub.invoke.apply(this,arguments)}catch(k){if(a&&k instanceof hub.Error){a.reject(k);return a}throw k;}if(typeof j!=="undefined"){j=h(true,j);a=a?p(a,j):j}j=a;a=g;return j||new r};hub.promise=function(g){g=h(false,undefined,g);if(a===false)a=g;else if(a!==true)a=p(a,g);return g};hub.resetPromise=function(){typeof a!=="boolean"&&a.reject();a=true}})();
(function(){var d=hub.emit,e=hub.merge;hub.emitter=function(b,h,i){if(typeof b==="string"){if(h){if(i)return function(){return d(b,e(h.apply(null,arguments),i))};if(typeof h==="function")return function(){return d(b,h.apply(null,arguments))};return function(m){return d(b,e(m,h))}}return function(){if(arguments.length)return d.apply(hub,[b].concat(Array.prototype.slice.call(arguments)));return d(b)}}var a=hub.chain(),f;for(f in b)if(b.hasOwnProperty(f)){var c=b[f];a[f]=typeof c==="string"?hub.emitter(c):
hub.emitter.apply(hub,c);a.add(a[f])}return a}})();(function(){var d=hub.emitter,e=hub.on;hub.forward=function(b,h,i,a){if(typeof b==="object")for(var f in b){if(b.hasOwnProperty(f)){h=b[f];typeof h==="string"?e(f,d(h)):e(f,d(h[0],h[1],h[2]))}}else e(b,d(h,i,a))}})();
