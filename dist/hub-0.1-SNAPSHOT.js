/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={};
Hub.merge=function(f,d){if(f===undefined||f===null||f===d)return d;if(d===undefined||d===null)return f;var b=Object.prototype.toString,j=b.call(d);b=b.call(f);var h;if(b===j){if(j==="[object Object]"){for(h in d)if(d.hasOwnProperty(h))f[h]=Hub.merge(f[h],d[h]);return f}if(j==="[object Array]")return f.concat(d)}throw new Hub.Error("validation",b===j?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:f,source:d,targetType:b,sourceType:j});};
Hub.resolve=function(f,d,b){for(var j=d.indexOf(".");j!==-1;){var h=d.substring(0,j);if(!f.hasOwnProperty(h))return b;f=f[h];d=d.substring(j+1);j=d.indexOf(".")}return f.hasOwnProperty(d)?f[d]:b};Hub.substitute=function(f,d,b){if(b===undefined)b="";return f.replace(/\{([a-zA-Z0-9\.]+)\}/g,d?function(j,h){return Hub.resolve(d,h,b)}:function(){return b})};Hub.Error=function(f,d,b){this.type=f;this.context=b;this.toString=function(){return Hub.substitute(d,b)}};
Hub.iterator=function(f){function d(){if(b>=j)throw Error("Iterator out of bounds.");var h=f[b++];d.hasNext=b<j;return h}var b=0,j=f.length;d.hasNext=b<j;d.remove=function(h){var c=typeof h;if(c==="undefined")h=b;else if(c==="number")h<b&&b--;else{for(c=f.length-1;c>=0;c--)if(f[c]===h){h=c;break}if(c<0)return false}if(h>=j)return false;f.splice(h,1);d.hasNext=b<--j;return true};d.insert=function(h,c){if(typeof c==="undefined"){c=h;h=b}else h<b&&b++;f.splice(h,0,c);d.hasNext=b<++j};d.reset=function(){b=
0;d.hasNext=b<j};return d};
(function(){function f(){var a=c.length;if(!a)return false;a=c[a-1];if(!a.hasNext){c.pop();return f()}h=Hub.merge(h,a().apply(b,j));return true}var d=false,b,j,h,c=[];Hub.stopPropagation=function(){d=true;c.length=0};Hub.propagate=function(){f()};Hub.topicComparator=function(a,q){var g=a.indexOf("*"),i=q.indexOf("*");if(g===-1)return i===-1?0:1;if(i===-1)return-1;var m=a.indexOf("/"),l=q.indexOf("/");if(g<m){if(i>l)return-1}else if(i<l)return 1;return 0};Hub.chain=function(){function a(){a.aborted=false;
var g=!c.length;if(g){d=false;j=arguments}var i=b;b=this;h=undefined;try{c.push(q);var m=true;do m=f();while(m)}finally{a.aborted=d;q.reset();if(g)c.length=0;b=i}if(!c.length){g=h;b=j=h=undefined;return g}}var q=Hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);a.add=function(g){q.insert(0,g)};a.insert=q.insert;a.remove=q.remove;return a}})();
(function(){function f(g,i){for(var m in i)if(i.hasOwnProperty(m)){var l=i[m],n=g[m];n||(g[m]=n=Hub.chain());n.add(l)}}function d(g,i,m){return function(){var l=Array.prototype.slice.call(arguments);l=Hub.publish.apply(Hub,[g].concat(l));Hub.aborted()||(l=Hub.merge(l,i.apply(m,arguments)));return l}}function b(g){var i=h[g];if(i)return i;i=c[g];if(!i)throw Error("Peer is not defined: "+g);i=q(i);var m={},l;for(l in i)if(i.hasOwnProperty(l)){var n=i[l];if(typeof n==="function")m[l]=d(g+"/"+l,n,m)}i.api=
m;return i}function j(g,i){return function(){return g.apply(i,arguments)}}var h={},c={},a=[],q;q=function(g){var i={},m=g.is,l,n;l=0;for(n=m.length;l<n;l++)f(i,b(m[l]));f(i,g.instance||g.factory());return i};Hub.peer=function(g,i,m){if(c[g])throw Error("Hub - peer already defined: "+g);if(!m){m=i;i=null}i={is:i?typeof i==="string"?[i]:i:a};if(typeof m==="function")i.factory=m;else{i.instance=m;m=h[g]=q(i);var l=m.api={},n;for(n in m)if(m.hasOwnProperty(n)){var e=m[n];if(typeof e==="function"){var k=
g+"/"+n;Hub.subscribe(k,j(e,l));l[n]=Hub.publisher(k)}}}c[g]=i};Hub.get=function(g){return b(g).api};Hub.resetPeers=function(){h={};for(var g in c)c.hasOwnProperty(g)&&g.indexOf("lib.")===-1&&delete c[g]}})();
(function(){function f(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+a+"$")}function d(a,q){function g(n,e,k){n||(n=a);if(n!==h&&!i.test(n)){if(n.indexOf("*")===-1||!f(n).test(a))return;n=h}var o=e&&e.length?m.apply(this,e):m.call(this);if(m.aborted){g.aborted=true;return o}if(k){var p,r;p=0;for(r=l.length;p<r;p++)k.push(l[p])}else k=l.slice();for(;k.length;){p=k.shift();r=p.call(this,n,e,k);o=Hub.merge(o,
r);if(p.aborted){g.aborted=true;break}}return o}a||(a=h);var i=f(a),m=Hub.chain(),l=q?[q]:[];g.matches=function(n){return i.test(n)};g.getTopic=function(){return a};g.add=function(n,e,k){if(a===e)m.add(n);else{var o,p,r;p=0;for(r=l.length;p<r;p++){o=l[p];if(o.matches(e)){o.add(n,e,k);return}k||(k=f(e));if(k.test(o.getTopic())){o=d(e,o);o.add(n,e,k);l[p]=o;return}}o=d(e);o.add(n,e);if(e.indexOf("*")===-1)l.unshift(o);else{p=0;for(r=l.length;p<r;p++){n=l[p].getTopic();if(Hub.topicComparator(n,e)!==
-1){l.splice(p,0,o);return}}l.push(o)}}};g.remove=function(n,e){if(a===e)return m.remove(n);var k,o,p;k=0;for(o=l.length;k<o;k++){p=l[k];if(p.matches(e))if(p.remove(n,e))return true}return false};return g}function b(a){var q=typeof a;if(q!=="string")throw Error("Topic is "+q);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function j(a){a=typeof a;if(a!=="function")throw Error("Callback is "+a);}var h="**/**",c=d();
Hub.topicChain=d;Hub.reset=function(){c=d();Hub.resetPeers();Hub.resetPromise()};Hub.subscribe=function(a,q){j(q);b(a);c.add(q,a)};Hub.unsubscribe=function(a,q){j(q);b(a);return c.remove(q,a)};Hub.invoke=function(a){b(a);var q=Array.prototype.slice.call(arguments,1);if(a.indexOf("{")!==-1)a=Hub.substitute(a,q);try{return c(a,q)}catch(g){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:g.message});}};Hub.aborted=function(){return Boolean(c.aborted)}})();
(function(){function f(e,k,o){var p;try{p=e.apply(null,k)}catch(r){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:r.message}));return}if(o){if(p===undefined)return k;return[p]}}function d(){Hub.invoke("hub.error/promise.resolved",new Hub.Error("validation","Promise already resolved"))}function b(e){return function(){e.reject({type:"timeout"})}}function j(e,k,o){var p,r,u=!(k instanceof Hub.Error),s=k===undefined?[]:[k],w;w={then:function(t,
v){if(e){var x=u?t:v;if(x)s=f(x,s,true)}else{t&&p.push(t);v&&r.push(v)}return this},publish:function(){if(e){s=[Hub.invoke.apply(Hub,arguments)];return this}var t=i.call(arguments);return this.then(function(){s=[Hub.invoke.apply(Hub,t)]})},publishResult:function(t){if(e){s=[Hub.invoke.apply(Hub,[t].concat(s))];return this}return this.then(function(){s=[Hub.invoke.apply(Hub,[t].concat(s))]})},resolve:function(){if(e)d();else{e=true;clearTimeout(o);if(arguments.length!==0)s=i.call(arguments);for(;p.length;)f(p.shift(),
s)}return this},reject:function(t){if(e)d();else{e=true;u=false;for(clearTimeout(o);r.length;){var v=r.shift();f(v,[t])}}return this},resolved:function(){return e},join:function(t){return m(w,t)}};if(!e){p=[];r=[];o=setTimeout(b(w),o||6E4)}return w}function h(e){var k=j(true);e.then=k.then;e.publish=k.publish;e.publishResult=k.publishResult;return k}var c=true,a=Array.prototype,q=a.unshift,g=a.push,i=a.slice,m;m=function(e,k){function o(){if(++r===2)(s?u.resolve:u.reject).apply(null,p)}var p=[],r=
0,u=j(false),s=true;e.then(function(){q.apply(p,arguments);o()},function(){q.apply(p,arguments);s=false;o()});k.then(function(){g.apply(p,arguments);o()},function(){g.apply(p,arguments);s=false;o()});return u};var l=Error("Hub - promise already resolved"),n=function(){};n.prototype={then:function(e,k){return h(this).then(e,k)},publish:function(){return h(this).publish.apply(null,arguments)},publishResult:function(){return h(this).publishResult.apply(null,arguments)},resolve:function(){throw l;},reject:function(){throw l;
},resolved:function(){return true},join:function(e){return h(this).join(e)}};Hub.publish=function(){var e=c;c=false;var k;try{k=Hub.invoke.apply(this,arguments)}catch(o){if(c&&o instanceof Hub.Error){c.reject(o);return c}throw o;}if(typeof k!=="undefined"){k=j(true,k);c=c?m(c,k):k}k=c;c=e;return k||new n};Hub.promise=function(e){e=j(false,undefined,e);if(c===false)c=e;else if(c!==true)c=m(c,e);return e};Hub.resetPromise=function(){typeof c!=="boolean"&&c.reject();c=true}})();
(function(){var f=Hub.publish,d=Hub.merge;Hub.publisher=function(b,j,h){if(typeof b==="string"){if(j){if(h)return function(){return f(b,d(j.apply(null,arguments),h))};if(typeof j==="function")return function(){return f(b,j.apply(null,arguments))};return function(g){return f(b,d(g,j))}}return function(){if(arguments.length)return f.apply(Hub,[b].concat(Array.prototype.slice.call(arguments)));return f(b)}}var c=Hub.chain(),a;for(a in b)if(b.hasOwnProperty(a)){var q=b[a];c[a]=typeof q==="string"?Hub.publisher(q):
Hub.publisher.apply(Hub,q);c.add(c[a])}return c}})();(function(){var f=Hub.publisher,d=Hub.subscribe;Hub.forward=function(b,j,h,c){if(typeof b==="object")for(var a in b){if(b.hasOwnProperty(a)){j=b[a];typeof j==="string"?d(a,f(j)):d(a,f(j[0],j[1],j[2]))}}else d(b,f(j,h,c))}})();
