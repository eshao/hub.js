/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};Hub.iterator=function(r){function o(){if(m>=p)throw Error("Iterator out of bounds.");var l=r[m++];o.hasNext=m<p;return l}var m=0,p=r.length;o.hasNext=m<p;o.remove=function(l){if(typeof l==="undefined")l=m;else l<m&&m--;r.splice(l,1);o.hasNext=m<--p};o.insert=function(l,n){if(typeof n==="undefined"){n=l;l=m}else l<m&&m++;r.splice(l,0,n);o.hasNext=m<++p};return o};(function(){function r(){var i=n.length;if(!i)return false;i=n[i-1];if(!i.hasNext){n.pop();return r()}l=Hub.util.merge(l,i().apply(null,p));return true}function o(){function i(){o.aborted=false;if(!n.length){m=false;p=arguments}l=undefined;try{c=Hub.iterator(h);for(n.push(c);r(););}finally{o.aborted=m;c=false}if(!n.length){var d=l;p=l=undefined;return d}}var h=arguments.length?Array.prototype.slice.call(arguments):[],c=false;i.add=function(d){c?c.insert(0,d):h.unshift(d)};i.insert=function(d,g){c?
c.insert(d,g):h.splice(d,0,g)};i.remove=function(d){if(typeof d==="number"){c?c.remove(d):h.splice(d,1);return d}for(var g=h.length;g--;)if(h[g]===d){c?c.remove(g):h.splice(g,1);return g}return-1};return i}var m=false,p,l,n=[];Hub.stopPropagation=function(){m=true;n.length=0};Hub.propagate=function(){r()};Hub.util.chain=o;Hub.util.topicChain=function(){var i=o(),h=i.remove,c=[];i.add=function(d,g){if(g.indexOf("*")===-1)i.insert(c.length,d);else{for(var k=0,a=c.length;k<a;k++){var b;a:{var f=g,e=
c[k];b=f.indexOf("*");var j=e.indexOf("*");f=f.indexOf("/");e=e.indexOf("/");if(b<f){if(j>e){b=-1;break a}}else if(j<e){b=1;break a}b=0}if(b<=0){c.splice(k,0,g);i.insert(k,d);return}}i.insert(c.length,d);c.push(g)}};i.remove=function(d){d=h(d);d!==-1&&d<c.length&&c.splice(d,1);return d};return i}})();(function(){function r(h,c,d){var g=h[c];g||(h[c]=g=Hub.util.chain());g.add(d)}function o(h,c){return function(){var d=Hub.subscriberChain(h),g=d.apply(null,arguments);if(d.aborted)return g;return Hub.util.merge(g,c.apply(null,arguments))}}function m(h){var c=l[h];if(c)return c;c=n[h];if(!c)throw Error("Peer is not defined: "+h);c=p(c);var d={},g;for(g in c){var k=c[g];if(typeof k==="function")d[g]=o(h+"/"+g,k)}c.api=d;return c}function p(h){for(var c={},d=h.is,g=0,k;k=d[g++];){var a=c;k=m(k);var b=
void 0;for(b in k)r(a,b,k[b])}h=h.instance||h.factory();for(var f in h)r(c,f,h[f]);return c}var l={},n={},i=[];Hub.peer=function(h,c,d){if(n[h])throw Error("Hub - peer already defined: "+h);if(!d){d=c;c=null}c={is:c?typeof c==="string"?[c]:c:i};if(typeof d==="function")c.factory=d;else{c.instance=d;d=l[h]=p(c);var g=d.api={},k;for(k in d){var a=d[k];if(typeof a==="function"){var b=h+"/"+k;Hub.subscribe(b,a);g[k]=Hub.publisher(b)}}}n[h]=c};Hub.get=function(h){return m(h).api};Hub.resetPeers=function(){l=
{};for(var h in n)h.indexOf("lib.")===-1&&delete n[h]}})();(function(){function r(a){return function(){h(Hub.util.substitute(a,arguments),arguments)}}function o(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function m(a){var b=g[a];if(!b){b=g;var f=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");b=b[a]={re:RegExp("^"+f+"$"),chain:Hub.util.chain()};l(d,b.chain,
b.re,null)}return b}function p(a,b,f,e){for(var j in a){var q=a[j];if((f||q.re).test(e))q.chain.add(b,e)}}function l(a,b,f,e){for(var j in a){var q=a[j];if((f||q.re).test(e||j))(b||q.chain).add(q.chain,j)}}function n(a,b){d[a]={chain:b};return b}function i(a){o(a);var b=n(a,Hub.util.topicChain());l(g,b,null,a);return b}function h(a,b){var f=Hub.subscriberChain(a);try{return f.apply(null,b)}catch(e){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:e.message});
}}function c(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var d={},g={},k=[];Hub.reset=function(){d={};g={};Hub.resetPeers()};Hub.subscribe=function(a,b){c(b);var f=a.indexOf("*")!==-1,e;if(e=d[a])e=e.chain;else{if(f){e=m(a);e.chain.add(b);p(d,b,e.re,a);return}e=i(a)}f||p(g,b,null,a);e.add(b,a)};Hub.unsubscribe=function(a,b){c(b);var f=d[a];if(!f){o(a);return false}f.chain.remove(b);for(var e in g){f=g[e];f.re.test(a)&&f.chain.remove(b)}return true};Hub.subscriberChain=
function(a){var b=d[a];if(b)return b.chain;if(a.indexOf("{")!==-1)return n(a,r(a));if(a.indexOf("*")===-1)return i(a);return m(a).chain};Hub.invoke=function(a){var b=arguments.length>1?Array.prototype.slice.call(arguments,1):k;return h(a,b)};Hub.forward=function(a,b,f,e){if(typeof a==="object")for(var j in a){b=a[j];typeof b==="string"?Hub.subscribe(j,Hub.publisher(b)):Hub.subscribe(j,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,f,e))};Hub.publisher=function(a,b,f){if(typeof a===
"string"){if(b){if(f)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),f))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(s){return Hub.publish(a,Hub.util.merge(s,b))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,[a].concat(Array.prototype.slice.call(arguments)));return Hub.publish(a)}}var e=Hub.util.chain(),j;for(j in a){var q=a[j];e[j]=typeof q==="string"?Hub.publisher(q):Hub.publisher.apply(Hub,
q);e.add(e[j])}return e};Hub.Error=function(a,b,f){this.type=a;this.context=f;this.toString=function(){return Hub.util.substitute(b,f)}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var f=Object.prototype.toString,e=f.call(b);f=f.call(a);if(f===e){if(e==="[object Object]"){for(var j in b)a[j]=arguments.callee(a[j],b[j]);return a}if(e==="[object Array]")return a.concat(b)}throw new Hub.Error("validation",f===e?"Cannot merge value {target} with {source}":
"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:f,sourceType:e});};Hub.util.resolve=function(a,b,f){var e=b.indexOf(".");if(e!==-1){var j=b.substring(0,e);if(j in a)return arguments.callee(a[j],b.substring(e+1),f);return f}return b in a?a[b]:f};Hub.util.substitute=function(a,b,f){if(f===undefined)f="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(e,j){return Hub.util.resolve(b,j,f)}:function(){return f})}})();(function(){function r(c,d){try{c(d)}catch(g){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:g.message}))}}function o(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function m(c){return function(){c.reject({type:"timeout"})}}function p(c,d,g){var k,a,b=!(d instanceof Hub.Error),f;f={then:function(e,j){if(c){var q=b?e:j;q&&r(q,d)}else{e&&k.push(e);j&&a.push(j)}return this},publish:function(e){if(c){d=
Hub.invoke.apply(Hub,arguments);return this}var j=[e];if(arguments.length>1)j=j.concat(arguments);return this.then(function(){d=Hub.invoke.apply(Hub,j)})},publishResult:function(e){if(c){d=Hub.invoke(e,d);return this}return this.then(function(){d=Hub.invoke(e,d)})},fulfill:function(e){if(c)o();else{c=true;clearTimeout(g);for(d=Hub.util.merge(d,e);k.length;)r(k.shift(),d)}return this},reject:function(e){if(c)o();else{c=true;b=false;for(clearTimeout(g);a.length;)r(a.shift(),e)}return this},fulfilled:function(){return c}};
if(!c){k=[];a=[];g=setTimeout(m(f),g||6E4)}return f}function l(c,d){function g(){if(++f===2)(j?e.fulfill:e.reject)(b)}function k(q){if(j)b=Hub.util.merge(b,q);g()}function a(q){if(j){j=false;b=q}else b=Hub.util.merge(b,q);g()}var b,f=0,e=p(false),j=true;c.then(k,a);d.then(k,a);return e}function n(c){var d=p(true);c.then=d.then;c.publish=d.publish;c.publishResult=d.publishResult;return d}var i=true,h=function(){};h.prototype={then:function(c,d){return n(this).then(c,d)},publish:function(){return n(this).publish.apply(null,
arguments)},publishResult:function(){return n(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},reject:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var c=i;i=false;var d;try{d=Hub.invoke.apply(this,arguments)}catch(g){if(i&&g instanceof Hub.Error){i.reject(g);return i}throw g;}if(typeof d!=="undefined"){d=p(true,d);i=i?l(i,d):d}d=i;i=c;return d||new h};Hub.promise=
function(c){c=p(false,undefined,c);if(i===true)return c;if(i===false)return i=c;i=l(i,c);return c}})();
