/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(e){function c(){}c.prototype=e;return new c};if(!Array.prototype.forEach)Array.prototype.forEach=function(e,c){if(!e||!e.call)throw new TypeError;for(var b=0,h=this.length;b<h;b++)e.call(c,this[b],b,this)};hub.apply=function(e,c){return this[e].apply(this,c)};
hub.resolve=function(e,c,b){for(var h=c.indexOf(".");h!==-1;){var f=c.substring(0,h);if(!e.hasOwnProperty(f))return b;e=e[f];c=c.substring(h+1);h=c.indexOf(".")}return e.hasOwnProperty(c)?e[c]:b};hub.substitute=function(e,c,b){if(b===undefined)b="";return e.replace(/\{([a-zA-Z0-9\.]+)\}/g,c?function(h,f){return hub.resolve(c,f,b)}:function(){return b})};hub.Error=function(e,c,b){this.type=e;this.context=b;this.toString=function(){return hub.substitute(c,b)}};
hub.merge=function(e,c){if(e===undefined||e===null||e===c)return c;if(c===undefined||c===null)return e;var b=Object.prototype.toString,h=b.call(c);b=b.call(e);var f;if(b===h){if(h==="[object Object]"){for(f in c)if(c.hasOwnProperty(f))e[f]=hub.merge(e[f],c[f]);return e}if(h==="[object Array]")return e.concat(c)}throw new hub.Error("validation",b===h?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:e,source:c,targetType:b,sourceType:h});};
(function(){function e(h){return function(){var f=this._,a=b.call(arguments);return function(){var d=b.call(arguments);return f[h].apply(f,a.concat(d))}}}function c(h){this._=h}var b=Array.prototype.slice;c.prototype={emit:e("emit"),on:e("on"),un:e("un"),create:e("create"),factory:e("factory"),peer:e("peer"),mix:e("mix")};hub.Does=c;hub.does=new c(hub)})();
hub.iterator=function(e){function c(){if(b>=h)throw Error("Iterator out of bounds.");var f=e[b++];c.hasNext=b<h;return f}var b=0,h=e.length;c.hasNext=b<h;c.remove=function(f){var a=typeof f;if(a==="undefined")f=b;else if(a==="number")f<b&&b--;else{for(a=e.length-1;a>=0;a--)if(e[a]===f){f=a;break}if(a<0)return false}if(f>=h)return false;e.splice(f,1);c.hasNext=b<--h;return true};c.insert=function(f,a){if(typeof a==="undefined"){a=f;f=b}else f<b&&b++;e.splice(f,0,a);c.hasNext=b<++h};c.reset=function(){b=
0;c.hasNext=b<h};return c};
(function(){var e={};["then","join","wait","resolve","reject"].forEach(function(c){e[c]=function(){var b=this.promise();b[c].apply(b,arguments)}});hub.scope=function(c){function b(){return g.propagate()}var h=[],f=false,a,d,g=Object.create(e);g.stopPropagation=function(){f=true;h.length=0;if(arguments.length)d=arguments[0]};g.propagate=function(){if(arguments.length)d=arguments[0];var i=h.length;if(!i)return this.result();i=h[i-1];if(i.hasNext){i=i().apply(this,c);if(a){d=a;a=undefined;d.then(b);
return d}else if(i&&i.then){d=i;d.then(b);return}d=hub.merge(d,i)}else{i.reset();h.pop()}return this.propagate()};g.aborted=function(){return f};g.result=function(){if(d&&d.then)return d;return hub.promise(0,this).resolve(d)};g.push=function(i){h.push(i)};g.promise=function(i,o){a||(a=hub.promise(i||0,o||this));return a};return g}})();
(function(){hub.chain=function(){function e(){var b=this.propagate?this:hub.scope(arguments);b.push(c);return b.propagate()}var c=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);e.on=function(b){var h=typeof b;if(h!=="function")throw new TypeError("Callback is "+h);c.insert(0,b)};e.un=c.remove;return e}})();
(function(){function e(a){var d=typeof a;if(d!=="string")throw Error("Topic is "+d);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(a))throw Error("Illegal topic: "+a);}function c(a,d){var g=a.indexOf("*"),i=d.indexOf("*");if(g===-1)return i===-1?0:1;if(i===-1)return-1;var o=a.indexOf("."),p=d.indexOf(".");if(g<o){if(i>p)return-1}else if(i<p)return 1;return 0}function b(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+a+"$")}function h(a,d){if(a)e(a);else a=f;var g=b(a),i,o=d?[d]:[],p=Object.create({});p.emit=function(j){j||(j=a);if(j!==f&&!g.test(j)){if(j.indexOf("*")===-1||!b(j).test(a))return;j=f}var l=this.propagate?this:hub.scope(Array.prototype.slice.call(arguments,1));i&&i.call(l);if(l.aborted())return l.result();var n=l.topicChainQueue;if(n)Array.prototype.push.apply(n,o);else n=l.topicChainQueue=o.slice();for(;n.length;){n.shift().emit.call(l,j);if(l.aborted())break}return l.result()};
p.matches=function(j){return g.test(j)};p.topic=a;p.on=function(j,l,n){if(a===j){i||(i=hub.chain());i.on(l)}else{var q,k,m;k=0;for(m=o.length;k<m;k++){q=o[k];if(q.matches(j)){q.on(j,l,n);return}n||(n=b(j));if(n.test(q.topic)){q=h(j,q);q.on(j,l,n);o[k]=q;return}}q=h(j);q.on(j,l);if(j.indexOf("*")===-1)o.unshift(q);else{k=0;for(m=o.length;k<m;k++)if(c(o[k].topic,j)!==-1){o.splice(k,0,q);return}o.push(q)}}};p.un=function(j,l){if(a===j)return i?i.un(l):-1;var n,q,k;n=0;for(q=o.length;n<q;n++){k=o[n];
if(k.matches(j))if(k.un(j,l))return true}e(j);n=typeof l;if(n!=="function")throw new TypeError("Callback is "+n);return false};p.mix=function(){hub.apply("emit",arguments).then(hub.does.mix(p))};p.create=hub.create;p.factory=hub.factory;p.peer=hub.peer;p.does=new hub.Does(p);return p}var f="**";hub.node=h;hub.topicComparator=c;hub.validateTopic=e})();
(function(){function e(c){if(typeof c!=="function")throw new TypeError;}hub.mix=function(c,b){for(var h in b)if(b.hasOwnProperty(h)&&typeof b[h]==="function"){var f=c,a=h,d=b[h],g=f[a];if(g)if(g.add)g.add(d);else f[a]=hub.chain(d,f[a]);else f[a]=hub.chain(d)}return c};hub.create=function(c,b,h){if(typeof c!=="string"){h=b;b=c;c=null}e(b);var f={};c=c?hub.topicScope(c):hub.scope();c.mix=function(){hub.apply("emit",arguments).then(hub.does.mix(f))};b=h?b.apply(c,h):b.call(c);return hub.mix(f,b)};hub.factory=
function(c,b){typeof c!=="string"?e(c):e(b);return function(){return hub.create(c,b)}}})();
(function(){function e(a,d){for(var g in d)if(d.hasOwnProperty(g))hub.root.on(a+g,d[g])}function c(a){return function(){return a}}function b(a,d){if(a)a+=".";return function(){var g=f.call(arguments);if(!g[0])throw new TypeError("Topic is "+g[0]);g[0]=a+g[0];return d.apply(this,g)}}hub.root=hub.node();var h={},f=Array.prototype.slice;hub.on=function(a,d){if(typeof a==="function")hub.root.on("**",a);else if(Object.prototype.toString.call(a)==="[object Object]"){e("",a);return}else if(Object.prototype.toString.call(d)===
"[object Object]"){e(a+".",d);d=c(d)}hub.root.on(a,d)};hub.un=function(a,d){if(typeof a==="function")return hub.root.un("**",a);return hub.root.un(a,d)};hub.topicScope=function(a,d){d||(d=hub.scope());var g=a.lastIndexOf(".");g=g===-1?"":a.substring(0,g);var i=h[g];if(!i){i={topic:c(a),on:b(g,hub.on),un:b(g,hub.un),peer:b(g,hub.peer),emit:b(g,hub.emit),create:b(g,hub.create),factory:b(g,hub.factory)};h[g]=i}d.topic=i.topic;d.on=i.on;d.un=i.un;d.peer=i.peer;d.emit=i.emit;d.create=i.create;d.factory=
i.factory;return d};hub.emit=function(a){hub.validateTopic(a);var d=f.call(arguments),g=d.slice(1);if(a.indexOf("{")!==-1)d[0]=hub.substitute(a,g);g=this.propagate?this:hub.scope(g);g=hub.topicScope(d[0],g);var i;try{i=hub.root.emit.apply(g,d)}catch(o){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:d[0],error:o.message});}if(!i||!i.then){d=hub.promise(0,g);d.resolve(i);i=d}return i};hub.peer=function(a,d,g){if(typeof a==="function"){if(d=hub.create(a,d))hub.on(d)}else if(typeof d===
"function"){if(d=hub.create(a,d,g))hub.on(a,d)}else hub.on(a,d)};hub.reset=function(){h={};hub.root=hub.node()}})();
(function(){function e(f){return function(){f.reject.apply(f,arguments)}}function c(f,a){return function(){var d=b.call(arguments);a.then(function(){var g=b.call(arguments);f.resolve.apply(f,d.concat(g))})}}var b=Array.prototype.slice,h={};["on","un","emit","create","factory","peer","mix"].forEach(function(f){h[f]=function(){var a=b.call(arguments);return this.then(function(){hub[f].apply(hub,a.concat(Array.prototype.slice.call(arguments)))})}});hub.promise=function(f,a){function d(){q&&clearTimeout(q);
for(var m=n?p:o,r=0,s=m.length;r<s;r++)m[r].apply(a,j);o.length=0;p.length=0}function g(){l--;!l&&j&&d()}function i(){if(j)throw Error("Promise already "+(n?"rejected":"resolved"));}var o=[],p=[],j,l=0,n=false,q,k;k=Object.create(h);k.then=function(m,r){if(!m&&!r)throw new TypeError("Require callback or errback");if(m&&typeof m!=="function")throw new TypeError("Callback is "+m);if(r&&typeof r!=="function")throw new TypeError("Errback is "+r);m&&o.push(m);r&&p.push(r);!l&&j&&d();return this};k.resolve=
function(){i();j=b.call(arguments);l||d();return this};k.reject=function(){i();n=true;j=b.call(arguments);l||d();return this};k.wait=function(){var m=0,r=arguments.length;for(l+=r;m<r;m++)arguments[m].then(g,g);return this};k.join=function(m){if(!m||typeof m.then!=="function")throw new TypeError("Promise is "+m);var r=hub.promise(0,a);this.then(c(r,m),e(r));m.then(null,e(r));return r};k.does=new hub.Does(k);if(f)q=setTimeout(function(){k.reject(new hub.Error("timeout","Promise timed out after {timeout} milliseconds",
{timeout:f}))},f);return k}})();
