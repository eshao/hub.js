/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(c){function a(){}a.prototype=c;return new a};if(!Array.prototype.forEach)Array.prototype.forEach=function(c,a){if(!c||!c.call)throw new TypeError;for(var b=0,g=this.length;b<g;b++)c.call(a,this[b],b,this)};hub.apply=function(c,a){return this[c].apply(this,a)};
hub.resolve=function(c,a,b){for(var g=a.indexOf(".");g!==-1;){var d=a.substring(0,g);if(!c.hasOwnProperty(d))return b;c=c[d];a=a.substring(g+1);g=a.indexOf(".")}return c.hasOwnProperty(a)?c[a]:b};hub.substitute=function(c,a,b){if(b===undefined)b="";return c.replace(/\{([a-zA-Z0-9\.]+)\}/g,a?function(g,d){return hub.resolve(a,d,b)}:function(){return b})};hub.Error=function(c,a,b){this.type=c;this.context=b;this.toString=function(){return hub.substitute(a,b)}};
hub.merge=function(c,a){if(c===undefined||c===null||c===a)return a;if(a===undefined||a===null)return c;var b=Object.prototype.toString,g=b.call(a);b=b.call(c);var d;if(b===g){if(g==="[object Object]"){for(d in a)if(a.hasOwnProperty(d))c[d]=hub.merge(c[d],a[d]);return c}if(g==="[object Array]")return c.concat(a)}throw new hub.Error("validation",b===g?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:c,source:a,targetType:b,sourceType:g});};
(function(){function c(g){return function(){var d=this._,i=typeof d[g];if(i!=="function")throw new TypeError(g+" is "+i);var n=b.call(arguments);return function(){var j=b.call(arguments);return d[g].apply(d,n.concat(j))}}}function a(g){this._=g}var b=Array.prototype.slice;a.prototype={emit:c("emit"),on:c("on"),un:c("un"),create:c("create"),factory:c("factory"),peer:c("peer"),mix:c("mix")};hub.Does=a;hub.does=new a(hub)})();
hub.iterator=function(c){function a(){if(b>=g)throw Error("Iterator out of bounds.");var d=c[b++];a.hasNext=b<g;return d}var b=0,g=c.length;a.hasNext=b<g;a.remove=function(d){var i=typeof d;if(i==="undefined")d=b;else if(i==="number")d<b&&b--;else{for(i=c.length-1;i>=0;i--)if(c[i]===d){d=i;break}if(i<0)return false}if(d>=g)return false;c.splice(d,1);a.hasNext=b<--g;return true};a.insert=function(d,i){if(typeof i==="undefined"){i=d;d=b}else d<b&&b++;c.splice(d,0,i);a.hasNext=b<++g};a.reset=function(){b=
0;a.hasNext=b<g};return a};(function(){hub.chain=function(){function c(){var b=this.propagate?this:hub.scope(arguments);b.push(a);return b.propagate()}var a=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);c.on=function(b){var g=typeof b;if(g!=="function")throw new TypeError("Callback is "+g);a.insert(0,b)};c.un=a.remove;return c}})();
(function(){function c(a){if(typeof a!=="function")throw new TypeError;}hub.mix=function(a,b){for(var g in b)if(b.hasOwnProperty(g)&&typeof b[g]==="function"){var d=a,i=g,n=b[g],j=d[i];if(j)if(j.add)j.add(n);else d[i]=hub.chain(n,d[i]);else d[i]=hub.chain(n)}return a};hub.create=function(a,b,g){if(typeof a!=="string"){g=b;b=a;a=null}c(b);var d={};a=a?hub.topicScope(a):hub.scope();a.mix=function(){hub.apply("emit",arguments).then(hub.does.mix(d))};b=g?b.apply(a,g):b.call(a);return hub.mix(d,b)};hub.factory=
function(a,b){typeof a!=="string"?c(a):c(b);return function(){return hub.create(a,b)}}})();
(function(){function c(e){var l=typeof e;if(l!=="string")throw Error("Topic is "+l);if(!e)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(e))throw Error("Illegal topic: "+e);}function a(e,l){var o=e.indexOf("*"),m=l.indexOf("*");if(o===-1)return m===-1?0:1;if(m===-1)return-1;var r=e.indexOf("."),q=l.indexOf(".");if(o<r){if(m>q)return-1}else if(m<q)return 1;return 0}function b(e){e=e.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+e+"$")}function g(e){return function(){return e}}function d(e,l,o){for(var m in o)if(o.hasOwnProperty(m))e.on(l+m,o[m])}function i(e,l){var o;if(e)if(typeof e==="string")c(e);else{o=e;e=j}else e=j;var m=b(e),r,q=l?[l]:[],p=Object.create(n);p.emit=function(f){if(arguments.length)hub.validateTopic(f);else f=e;var h=Array.prototype.slice.call(arguments,1);if(f.indexOf("{")!==-1)f=hub.substitute(f,h);if(f!==j&&!m.test(f)){if(f.indexOf("*")===-1||!b(f).test(e))return;f=j}h=this.propagate?
this:hub.scope(h);h=hub.topicScope(f,h);r&&r.call(h);if(h.aborted)return h.result();var k=h.topicChainQueue;if(k)Array.prototype.push.apply(k,q);else k=h.topicChainQueue=q.slice();for(;k.length;){k.shift().emit.call(h,f);if(h.aborted)break}return h.result()};p.matches=function(f){return m.test(f)};p.topic=e;p.on=function(f,h,k){if(typeof f==="function")p.on(e,f);else if(Object.prototype.toString.call(f)==="[object Object]")d(p,"",f);else{if(Object.prototype.toString.call(h)==="[object Object]"){d(p,
f+".",h);h=g(h)}if(e===f){r||(r=hub.chain());r.on(h)}else{var s,t,u;t=0;for(u=q.length;t<u;t++){s=q[t];if(s.matches(f)){s.on(f,h,k);return}k||(k=b(f));if(k.test(s.topic)){s=i(f,s);s.on(f,h,k);q[t]=s;return}}s=i(f);s.on(f,h);if(f.indexOf("*")===-1)q.unshift(s);else{t=0;for(u=q.length;t<u;t++)if(a(q[t].topic,f)!==-1){q.splice(t,0,s);return}q.push(s)}}}};p.un=function(f,h){if(typeof f==="function")return p.un("**",f);if(e===f)return r?r.un(h):-1;var k,s,t;k=0;for(s=q.length;k<s;k++){t=q[k];if(t.matches(f))if(t.un(f,
h))return true}c(f);k=typeof h;if(k!=="function")throw new TypeError("Callback is "+k);return false};p.mix=function(f){if(typeof f==="string")hub.apply("emit",arguments).then(p.does.on());else p.on(f);return p};p.does=new hub.Does(p);o&&d(p,"",o);return p}var n={create:hub.create,factory:hub.factory,peer:function(e,l,o){if(typeof e==="function"){if(l=hub.create(e,l))this.on(l)}else if(typeof l==="function"){if(l=hub.create(e,l,o))this.on(e,l)}else this.on(e,l)}},j="**";hub.node=i;hub.topicComparator=
a;hub.validateTopic=c})();(function(){hub.root=hub.node();hub.on=function(c,a){hub.root.on(c,a)};hub.un=function(c,a){return hub.root.un(c,a)};hub.emit=function(){return hub.root.emit.apply(hub.root,arguments)};hub.peer=function(){return hub.root.peer.apply(hub.root,arguments)};hub.reset=function(){hub.root=hub.node()}})();
(function(){function c(d){return function(){d.reject.apply(d,arguments)}}function a(d,i){return function(){var n=b.call(arguments);i.then(function(){var j=b.call(arguments);d.resolve.apply(d,n.concat(j))})}}var b=Array.prototype.slice,g={};["on","un","emit","create","factory","peer","mix"].forEach(function(d){g[d]=function(){var i=b.call(arguments);return this.then(function(){hub[d].apply(hub,i.concat(Array.prototype.slice.call(arguments)))})}});hub.promise=function(d,i){function n(){p&&clearTimeout(p);
for(var h=q?o:l,k=0,s=h.length;k<s;k++)h[k].apply(i,m);l.length=0;o.length=0}function j(){r--;!r&&m&&n()}function e(){if(m)throw Error("Promise already "+(q?"rejected":"resolved"));}var l=[],o=[],m,r=0,q=false,p,f;f=Object.create(g);f.then=function(h,k){if(!h&&!k)throw new TypeError("Require callback or errback");if(h&&typeof h!=="function")throw new TypeError("Callback is "+h);if(k&&typeof k!=="function")throw new TypeError("Errback is "+k);h&&l.push(h);k&&o.push(k);!r&&m&&n();return this};f.resolve=
function(){e();m=b.call(arguments);r||n();return this};f.reject=function(){e();q=true;m=b.call(arguments);r||n();return this};f.wait=function(){var h=0,k=arguments.length;for(r+=k;h<k;h++)arguments[h].then(j,j);return this};f.join=function(h){if(!h||typeof h.then!=="function")throw new TypeError("Promise is "+h);var k=hub.promise(0,i);this.then(a(k,h),c(k));h.then(null,c(k));return k};f.does=new hub.Does(f);if(d)p=setTimeout(function(){f.reject(new hub.Error("timeout","Promise timed out after {timeout} milliseconds",
{timeout:d}))},d);return f}})();
(function(){function c(i,n){if(i)i+=".";return function(){var j=g.call(arguments);if(!j[0])throw new TypeError("Topic is "+j[0]);j[0]=i+j[0];return n.apply(hub,j)}}var a={},b={},g=Array.prototype.slice;["then","join","wait","resolve","reject"].forEach(function(i){a[i]=function(){var n=this.promise();n[i].apply(n,arguments)}});hub.scope=function(i){function n(){return o.propagate()}var j=[],e,l,o=Object.create(a);o.aborted=false;o.stopPropagation=function(){o.aborted=true;j.length=0;if(arguments.length)l=
arguments[0]};o.propagate=function(){if(arguments.length)i=g.call(arguments);var m=j.length;if(!m)return this.result();m=j[m-1];if(m.hasNext){m=m().apply(this,i);if(e){l=e;e=undefined;l.then(n);return l}else if(m&&m.then){l=m;l.then(n);return}l=hub.merge(l,m)}else{m.reset();j.pop()}return this.propagate()};o.result=function(){if(l&&l.then)return l;return hub.promise(0,this).resolve(l)};o.push=function(m){j.push(m)};o.promise=function(m,r){e||(e=hub.promise(m||0,r||this));return e};return o};hub.topicScope=
function(i,n){n||(n=hub.scope());var j=i.lastIndexOf(".");j=j===-1?"":i.substring(0,j);var e=b[j];if(!e){e={on:c(j,hub.on),un:c(j,hub.un),peer:c(j,hub.peer),emit:c(j,hub.emit),create:c(j,hub.create),factory:c(j,hub.factory)};b[j]=e}n.topic=i;n.on=e.on;n.un=e.un;n.peer=e.peer;n.emit=e.emit;n.create=e.create;n.factory=e.factory;return n};var d=hub.reset;hub.reset=function(){b={};d()}})();
