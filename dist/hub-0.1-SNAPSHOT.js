/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(c,a){if(c===undefined||c===null||c===a)return a;if(a===undefined||a===null)return c;var b=Object.prototype.toString,e=b.call(a);b=b.call(c);var f;if(b===e){if(e==="[object Object]"){for(f in a)if(a.hasOwnProperty(f))c[f]=hub.merge(c[f],a[f]);return c}if(e==="[object Array]")return c.concat(a)}throw new hub.Error("validation",b===e?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:c,source:a,targetType:b,sourceType:e});};
hub.resolve=function(c,a,b){for(var e=a.indexOf(".");e!==-1;){var f=a.substring(0,e);if(!c.hasOwnProperty(f))return b;c=c[f];a=a.substring(e+1);e=a.indexOf(".")}return c.hasOwnProperty(a)?c[a]:b};hub.substitute=function(c,a,b){if(b===undefined)b="";return c.replace(/\{([a-zA-Z0-9\.]+)\}/g,a?function(e,f){return hub.resolve(a,f,b)}:function(){return b})};hub.Error=function(c,a,b){this.type=c;this.context=b;this.toString=function(){return hub.substitute(a,b)}};
hub.iterator=function(c){function a(){if(b>=e)throw Error("Iterator out of bounds.");var f=c[b++];a.hasNext=b<e;return f}var b=0,e=c.length;a.hasNext=b<e;a.remove=function(f){var d=typeof f;if(d==="undefined")f=b;else if(d==="number")f<b&&b--;else{for(d=c.length-1;d>=0;d--)if(c[d]===f){f=d;break}if(d<0)return false}if(f>=e)return false;c.splice(f,1);a.hasNext=b<--e;return true};a.insert=function(f,d){if(typeof d==="undefined"){d=f;f=b}else f<b&&b++;c.splice(f,0,d);a.hasNext=b<++e};a.reset=function(){b=
0;a.hasNext=b<e};return a};
(function(){function c(){var j=d.length;if(!j)return false;j=d[j-1];if(!j.hasNext){d.pop();return c()}j=j().apply(b,e);f=hub.merge(f,j);return true}var a=false,b,e,f,d=[];hub.stopPropagation=function(){a=true;d.length=0;if(arguments.length)f=arguments[0]};hub.propagate=function(){if(arguments.length)f=arguments[0];c()};hub.aborted=function(){return a};hub.chain=function(){function j(){var g=!d.length;if(g){a=false;e=arguments;f=undefined}var n=b;b=this;d.push(r);try{for(;;)if(!c())break}finally{r.reset();if(g)d.length=
0;b=n}if(!d.length){g=f;b=e=f=undefined;return g}}var r=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);j.add=function(g){var n=typeof g;if(n!=="function")throw new TypeError("Callback is "+n);r.insert(0,g)};j.insert=r.insert;j.remove=r.remove;return j}})();(function(){hub.mix=function(c,a){for(var b in a)if(a.hasOwnProperty(b)&&typeof a[b]==="function"){var e=c,f=b,d=a[b],j=e[f];if(j)if(j.add)j.add(d);else e[f]=hub.chain(d,e[f]);else e[f]=d}return c}})();
(function(){hub.create=function(c,a,b){if(typeof c!=="string"){b=a;a=c;c=null}if(typeof a!=="function")throw new TypeError;var e={},f={mix:function(){hub.publish.apply(hub,arguments).then(function(d){hub.mix(e,d)})},subscribe:function(d,j){if(!c)throw new TypeError("namespace is "+c);if(!d)throw new TypeError("messsage is "+d);hub.subscribe(c+"."+d,j)}};a=b?a.apply(f,b):a.call(f);return hub.mix(e,a)}})();
(function(){function c(g){g=g.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+g+"$")}function a(g){var n=typeof g;if(n!=="string")throw Error("Topic is "+n);if(!g)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(g))throw Error("Illegal topic: "+g);}function b(g,n){var q=g.indexOf("*"),t=n.indexOf("*");if(q===-1)return t===-1?0:1;if(t===-1)return-1;var u=g.indexOf("."),h=n.indexOf(".");if(q<u){if(t>
h)return-1}else if(t<h)return 1;return 0}function e(g,n){function q(i,k,l){i||(i=g);if(i!==j&&!t.test(i)){if(i.indexOf("*")===-1||!c(i).test(g))return;i=j}var m=k&&k.length?u.apply(this,k):u.call(this);if(u.aborted){q.aborted=true;return m}if(l){var o,p;o=0;for(p=h.length;o<p;o++)l.push(h[o])}else l=h.slice();for(;l.length;){o=l.shift();p=o.call(this,i,k,l);m=hub.merge(m,p);if(o.aborted){q.aborted=true;break}}return m}if(g)a(g);else g=j;var t=c(g),u=hub.chain(),h=n?[n]:[];q.matches=function(i){return t.test(i)};
q.getTopic=function(){return g};q.add=function(i,k,l){if(g===k)u.add(i);else{var m,o,p;o=0;for(p=h.length;o<p;o++){m=h[o];if(m.matches(k)){m.add(i,k,l);return}l||(l=c(k));if(l.test(m.getTopic())){m=e(k,m);m.add(i,k,l);h[o]=m;return}}m=e(k);m.add(i,k);if(k.indexOf("*")===-1)h.unshift(m);else{o=0;for(p=h.length;o<p;o++){i=h[o].getTopic();if(b(i,k)!==-1){h.splice(o,0,m);return}}h.push(m)}}};q.remove=function(i,k){if(g===k)return u.remove(i);var l,m,o;l=0;for(m=h.length;l<m;l++){o=h[l];if(o.matches(k))if(o.remove(i,
k))return true}a(k);l=typeof i;if(l!=="function")throw new TypeError("Callback is "+l);return false};return q}function f(g,n){for(var q in g)g.hasOwnProperty(q)&&r.add(g[q],n+q)}function d(g){return function(){return g}}var j="**",r=hub.root=e();hub.topicChain=e;hub.topicComparator=b;hub.reset=function(){hub.root=r=e();hub.resetPromise()};hub.subscribe=hub.on=function(g,n){if(Object.prototype.toString.call(g)==="[object Object]")f(g,"");else{if(Object.prototype.toString.call(n)==="[object Object]"){f(n,
g+".");n=d(n)}r.add(n,g)}};hub.unsubscribe=hub.un=function(g,n){return r.remove(n,g)};hub.invoke=function(g){a(g);var n=Array.prototype.slice.call(arguments,1);if(g.indexOf("{")!==-1)g=hub.substitute(g,n);try{return r(g,n)}catch(q){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:g,error:q.message});}}})();
(function(){hub.peer=function(c,a,b){if(typeof c==="function"){if(a=hub.create(c,a))hub.on(a)}else if(typeof a==="function"){if(a=hub.create(c,a,b))hub.on(c,a)}else hub.on(c,a)}})();
(function(){function c(h,i,k){var l;try{l=h.apply(null,i)}catch(m){hub.invoke("hub.error.promise.callback",new hub.Error("error","Error in promise callback: ${error}",{error:m.message}));return}if(k){if(l===undefined)return i;return[l]}}function a(){hub.invoke("hub.error.promise.resolved",new hub.Error("validation","Promise already resolved"))}function b(h){return function(){h.reject({type:"timeout"})}}function e(h,i,k){var l,m,o=!(i instanceof hub.Error),p=i===undefined?[]:[i],w;w={then:function(s,
v){if(h){var x=o?s:v;if(x)p=c(x,p,true)}else{s&&l.push(s);v&&m.push(v)}return this},publish:function(){if(h){p=[hub.invoke.apply(hub,arguments)];return this}var s=n.call(arguments);return this.then(function(){p=[hub.invoke.apply(hub,s)]})},publishResult:function(s){if(h){p=[hub.invoke.apply(hub,[s].concat(p))];return this}return this.then(function(){p=[hub.invoke.apply(hub,[s].concat(p))]})},resolve:function(){if(h)a();else{h=true;clearTimeout(k);if(arguments.length!==0)p=n.call(arguments);for(;l.length;)c(l.shift(),
p)}return this},reject:function(s){if(h)a();else{h=true;o=false;for(clearTimeout(k);m.length;){var v=m.shift();c(v,[s])}}return this},resolved:function(){return h},join:function(s){return q(w,s)}};if(!h){l=[];m=[];k=setTimeout(b(w),k||6E4)}return w}function f(h){var i=e(true);h.then=i.then;h.publish=i.publish;h.publishResult=i.publishResult;return i}var d=true,j=Array.prototype,r=j.unshift,g=j.push,n=j.slice,q;q=function(h,i){function k(){if(++m===2)(p?o.resolve:o.reject).apply(null,l)}var l=[],m=
0,o=e(false),p=true;h.then(function(){r.apply(l,arguments);k()},function(){r.apply(l,arguments);p=false;k()});i.then(function(){g.apply(l,arguments);k()},function(){g.apply(l,arguments);p=false;k()});return o};var t=Error("hub - promise already resolved"),u=function(){};u.prototype={then:function(h,i){return f(this).then(h,i)},publish:function(){return f(this).publish.apply(null,arguments)},publishResult:function(){return f(this).publishResult.apply(null,arguments)},resolve:function(){throw t;},reject:function(){throw t;
},resolved:function(){return true},join:function(h){return f(this).join(h)}};hub.publish=function(){var h=d;d=false;var i;try{i=hub.invoke.apply(this,arguments)}catch(k){if(d&&k instanceof hub.Error){d.reject(k);return d}throw k;}if(typeof i!=="undefined"){i=e(true,i);d=d?q(d,i):i}i=d;d=h;return i||new u};hub.promise=function(h){h=e(false,undefined,h);if(d===false)d=h;else if(d!==true)d=q(d,h);return h};hub.resetPromise=function(){typeof d!=="boolean"&&d.reject();d=true}})();
(function(){var c=hub.publish,a=hub.merge;hub.publisher=function(b,e,f){if(typeof b==="string"){if(e){if(f)return function(){return c(b,a(e.apply(null,arguments),f))};if(typeof e==="function")return function(){return c(b,e.apply(null,arguments))};return function(g){return c(b,a(g,e))}}return function(){if(arguments.length)return c.apply(hub,[b].concat(Array.prototype.slice.call(arguments)));return c(b)}}var d=hub.chain(),j;for(j in b)if(b.hasOwnProperty(j)){var r=b[j];d[j]=typeof r==="string"?hub.publisher(r):
hub.publisher.apply(hub,r);d.add(d[j])}return d}})();(function(){var c=hub.publisher,a=hub.subscribe;hub.forward=function(b,e,f,d){if(typeof b==="object")for(var j in b){if(b.hasOwnProperty(j)){e=b[j];typeof e==="string"?a(j,c(e)):a(j,c(e[0],e[1],e[2]))}}else a(b,c(e,f,d))}})();
