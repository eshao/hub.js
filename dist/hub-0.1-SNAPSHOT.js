/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(d){function a(){}a.prototype=d;return new a};if(!Array.prototype.forEach)Array.prototype.forEach=function(d,a){if(!d||!d.call)throw new TypeError;for(var b=0,e=this.length;b<e;b++)d.call(a,this[b],b,this)};hub.apply=function(d,a){return this[d].apply(this,a)};
hub.resolve=function(d,a,b){for(var e=a.indexOf(".");e!==-1;){var c=a.substring(0,e);if(!d.hasOwnProperty(c))return b;d=d[c];a=a.substring(e+1);e=a.indexOf(".")}return d.hasOwnProperty(a)?d[a]:b};hub.substitute=function(d,a,b){if(b===undefined)b="";return d.replace(/\{([a-zA-Z0-9\.]+)\}/g,a?function(e,c){return hub.resolve(a,c,b)}:function(){return b})};hub.Error=function(d,a,b){this.type=d;this.context=b;this.toString=function(){return hub.substitute(a,b)}};
hub.merge=function(d,a){if(d===undefined||d===null||d===a)return a;if(a===undefined||a===null)return d;var b=Object.prototype.toString,e=b.call(a);b=b.call(d);var c;if(b===e){if(e==="[object Object]"){for(c in a)if(a.hasOwnProperty(c))d[c]=hub.merge(d[c],a[c]);return d}if(e==="[object Array]")return d.concat(a)}throw new hub.Error("validation",b===e?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:d,source:a,targetType:b,sourceType:e});};
(function(){function d(e){return function(){var c=this._,f=typeof c[e];if(f!=="function")throw new TypeError(e+" is "+f);var k=b.call(arguments);return function(){var l=b.call(arguments);return c[e].apply(c,k.concat(l))}}}function a(e){this._=e}var b=Array.prototype.slice;a.prototype={emit:d("emit"),on:d("on"),un:d("un"),create:d("create"),factory:d("factory"),peer:d("peer"),mix:d("mix")};hub.Does=a;hub.does=new a(hub)})();
hub.iterator=function(d){function a(){if(b>=e)throw Error("Iterator out of bounds.");var c=d[b++];a.hasNext=b<e;return c}var b=0,e=d.length;a.hasNext=b<e;a.remove=function(c){var f=typeof c;if(f==="undefined")c=b;else if(f==="number")c<b&&b--;else{for(f=d.length-1;f>=0;f--)if(d[f]===c){c=f;break}if(f<0)return false}if(c>=e)return false;d.splice(c,1);a.hasNext=b<--e;return true};a.insert=function(c,f){if(typeof f==="undefined"){f=c;c=b}else c<b&&b++;d.splice(c,0,f);a.hasNext=b<++e};a.reset=function(){b=
0;a.hasNext=b<e};return a};
(function(){var d={};["then","join","wait","resolve","reject"].forEach(function(a){d[a]=function(){var b=this.promise();b[a].apply(b,arguments)}});hub.scope=function(a){function b(){return k.propagate()}var e=[],c,f,k=Object.create(d);k.aborted=false;k.stopPropagation=function(){k.aborted=true;e.length=0;if(arguments.length)f=arguments[0]};k.propagate=function(){if(arguments.length)a=Array.prototype.slice.call(arguments);var l=e.length;if(!l)return this.result();l=e[l-1];if(l.hasNext){l=l().apply(this,
a);if(c){f=c;c=undefined;f.then(b);return f}else if(l&&l.then){f=l;f.then(b);return}f=hub.merge(f,l)}else{l.reset();e.pop()}return this.propagate()};k.result=function(){if(f&&f.then)return f;return hub.promise(0,this).resolve(f)};k.push=function(l){e.push(l)};k.promise=function(l,i){c||(c=hub.promise(l||0,i||this));return c};return k}})();
(function(){hub.chain=function(){function d(){var b=this.propagate?this:hub.scope(arguments);b.push(a);return b.propagate()}var a=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);d.on=function(b){var e=typeof b;if(e!=="function")throw new TypeError("Callback is "+e);a.insert(0,b)};d.un=a.remove;return d}})();
(function(){function d(a){if(typeof a!=="function")throw new TypeError;}hub.mix=function(a,b){for(var e in b)if(b.hasOwnProperty(e)&&typeof b[e]==="function"){var c=a,f=e,k=b[e],l=c[f];if(l)if(l.add)l.add(k);else c[f]=hub.chain(k,c[f]);else c[f]=hub.chain(k)}return a};hub.create=function(a,b,e){if(typeof a!=="string"){e=b;b=a;a=null}d(b);var c={};a=a?hub.topicScope(a):hub.scope();a.mix=function(){hub.apply("emit",arguments).then(hub.does.mix(c))};b=e?b.apply(a,e):b.call(a);return hub.mix(c,b)};hub.factory=
function(a,b){typeof a!=="string"?d(a):d(b);return function(){return hub.create(a,b)}}})();
(function(){function d(i){var m=typeof i;if(m!=="string")throw Error("Topic is "+m);if(!i)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(i))throw Error("Illegal topic: "+i);}function a(i,m){var r=i.indexOf("*"),p=m.indexOf("*");if(r===-1)return p===-1?0:1;if(p===-1)return-1;var s=i.indexOf("."),o=m.indexOf(".");if(r<s){if(p>o)return-1}else if(p<o)return 1;return 0}function b(i){i=i.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+i+"$")}function e(i){return function(){return i}}function c(i,m,r){for(var p in r)if(r.hasOwnProperty(p))i.on(m+p,r[p])}function f(i,m){var r;if(i)if(typeof i==="string")d(i);else{r=i;i=l}else i=l;var p=b(i),s,o=m?[m]:[],n=Object.create(k);n.emit=function(g){if(arguments.length)hub.validateTopic(g);else g=i;var h=Array.prototype.slice.call(arguments,1);if(g.indexOf("{")!==-1)g=hub.substitute(g,h);if(g!==l&&!p.test(g)){if(g.indexOf("*")===-1||!b(g).test(i))return;g=l}h=this.propagate?
this:hub.scope(h);h=hub.topicScope(g,h);s&&s.call(h);if(h.aborted)return h.result();var j=h.topicChainQueue;if(j)Array.prototype.push.apply(j,o);else j=h.topicChainQueue=o.slice();for(;j.length;){j.shift().emit.call(h,g);if(h.aborted)break}return h.result()};n.matches=function(g){return p.test(g)};n.topic=i;n.on=function(g,h,j){if(typeof g==="function")n.on(i,g);else if(Object.prototype.toString.call(g)==="[object Object]")c(n,"",g);else{if(Object.prototype.toString.call(h)==="[object Object]"){c(n,
g+".",h);h=e(h)}if(i===g){s||(s=hub.chain());s.on(h)}else{var q,t,u;t=0;for(u=o.length;t<u;t++){q=o[t];if(q.matches(g)){q.on(g,h,j);return}j||(j=b(g));if(j.test(q.topic)){q=f(g,q);q.on(g,h,j);o[t]=q;return}}q=f(g);q.on(g,h);if(g.indexOf("*")===-1)o.unshift(q);else{t=0;for(u=o.length;t<u;t++)if(a(o[t].topic,g)!==-1){o.splice(t,0,q);return}o.push(q)}}}};n.un=function(g,h){if(typeof g==="function")return n.un("**",g);if(i===g)return s?s.un(h):-1;var j,q,t;j=0;for(q=o.length;j<q;j++){t=o[j];if(t.matches(g))if(t.un(g,
h))return true}d(g);j=typeof h;if(j!=="function")throw new TypeError("Callback is "+j);return false};n.mix=function(g){if(typeof g==="string")hub.apply("emit",arguments).then(n.does.on());else n.on(g);return n};n.does=new hub.Does(n);r&&c(n,"",r);return n}var k={create:hub.create,factory:hub.factory,peer:function(i,m,r){if(typeof i==="function"){if(m=hub.create(i,m))this.on(m)}else if(typeof m==="function"){if(m=hub.create(i,m,r))this.on(i,m)}else this.on(i,m)}},l="**";hub.node=f;hub.topicComparator=
a;hub.validateTopic=d})();
(function(){function d(e,c){if(e)e+=".";return function(){var f=b.call(arguments);if(!f[0])throw new TypeError("Topic is "+f[0]);f[0]=e+f[0];return c.apply(this,f)}}hub.root=hub.node();var a={},b=Array.prototype.slice;hub.on=function(e,c){hub.root.on(e,c)};hub.un=function(e,c){return hub.root.un(e,c)};hub.topicScope=function(e,c){c||(c=hub.scope());var f=e.lastIndexOf(".");f=f===-1?"":e.substring(0,f);var k=a[f];if(!k){k={topic:e,on:d(f,hub.on),un:d(f,hub.un),peer:d(f,hub.peer),emit:d(f,hub.emit),
create:d(f,hub.create),factory:d(f,hub.factory)};a[f]=k}c.topic=k.topic;c.on=k.on;c.un=k.un;c.peer=k.peer;c.emit=k.emit;c.create=k.create;c.factory=k.factory;return c};hub.emit=function(){return hub.root.emit.apply(hub.root,arguments)};hub.peer=function(){return hub.root.peer.apply(hub.root,arguments)};hub.reset=function(){a={};hub.root=hub.node()}})();
(function(){function d(c){return function(){c.reject.apply(c,arguments)}}function a(c,f){return function(){var k=b.call(arguments);f.then(function(){var l=b.call(arguments);c.resolve.apply(c,k.concat(l))})}}var b=Array.prototype.slice,e={};["on","un","emit","create","factory","peer","mix"].forEach(function(c){e[c]=function(){var f=b.call(arguments);return this.then(function(){hub[c].apply(hub,f.concat(Array.prototype.slice.call(arguments)))})}});hub.promise=function(c,f){function k(){n&&clearTimeout(n);
for(var h=o?r:m,j=0,q=h.length;j<q;j++)h[j].apply(f,p);m.length=0;r.length=0}function l(){s--;!s&&p&&k()}function i(){if(p)throw Error("Promise already "+(o?"rejected":"resolved"));}var m=[],r=[],p,s=0,o=false,n,g;g=Object.create(e);g.then=function(h,j){if(!h&&!j)throw new TypeError("Require callback or errback");if(h&&typeof h!=="function")throw new TypeError("Callback is "+h);if(j&&typeof j!=="function")throw new TypeError("Errback is "+j);h&&m.push(h);j&&r.push(j);!s&&p&&k();return this};g.resolve=
function(){i();p=b.call(arguments);s||k();return this};g.reject=function(){i();o=true;p=b.call(arguments);s||k();return this};g.wait=function(){var h=0,j=arguments.length;for(s+=j;h<j;h++)arguments[h].then(l,l);return this};g.join=function(h){if(!h||typeof h.then!=="function")throw new TypeError("Promise is "+h);var j=hub.promise(0,f);this.then(a(j,h),d(j));h.then(null,d(j));return j};g.does=new hub.Does(g);if(c)n=setTimeout(function(){g.reject(new hub.Error("timeout","Promise timed out after {timeout} milliseconds",
{timeout:c}))},c);return g}})();
