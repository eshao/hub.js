/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};(function(){function w(){function l(){function g(){if(i<k.length&&!g.stop){n=Hub.util.merge(n,k[i++].apply(null,h));return true}return false}var h=arguments,n,e=s;s=g;i=0;try{for(;s(););return n}finally{s=e}}var k=arguments.length?Array.prototype.slice.call(arguments):[],i=-1;l.add=function(g){k.unshift(g);i!==-1&&i++};l.addAll=function(g){k=g.concat(k);if(i!==-1)i+=g.length};l.insert=function(g,h){k.splice(g,0,h);g<i&&i++};l.remove=function(g){if(typeof g==="number"){k.splice(g,1);g<i&&i--;return g}for(var h=
k.length;h--;)if(k[h]===g){k.splice(h,1);h<i&&i--;return h}return-1};l.all=function(){return k};return l}var s;Hub.stopPropagation=function(){s.stop=true};Hub.propagate=function(){s()};Hub.util.chain=w;Hub.util.topicChain=function(){var l=w(),k=l.remove,i=[];l.add=function(g,h){if(h.indexOf("*")===-1)l.insert(i.length,g);else{for(var n=0,e=i.length;n<e;n++){var f;a:{var q=h,p=i[n];f=q.indexOf("*");var t=p.indexOf("*");q=q.indexOf("/");p=p.indexOf("/");if(f<q){if(t>p){f=-1;break a}}else if(t<p){f=
1;break a}f=0}if(f<=0){i.splice(n,0,h);l.insert(n,g);return}}l.insert(i.length,g);i.push(h)}};l.addAll=function(g,h){for(var n=0,e=g.length;n<e;n++)l.add(g[n],h)};l.remove=function(g){g=k(g);g!==-1&&g<i.length&&i.splice(g,1);return g};return l}})();(function(){function w(a,b,c){var d=a[b];d||(a[b]=d=Hub.util.chain());d.add(c)}function s(a){var b={};if(a){for(var c=a.is,d=0,j;j=c[d++];){var x=b;j=m[j]||s(o[j]);var y=void 0;for(y in j)w(x,y,j[y])}a=a.instance||a.factory();for(var z in a)w(b,z,a[z])}return b}function l(a){return function(){var b=s(o[a]);k(b,a);Hub.propagate();for(var c in b)Hub.unsubscribe(a+"/"+c,b[c])}}function k(a,b){for(var c in a)Hub.subscribe(b+"/"+c,a[c])}function i(a){return function(){p(Hub.util.substitute(a,arguments),
arguments)}}function g(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function h(a){var b=u[a];if(!b){b=u;var c=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");b=b[a]={re:RegExp("^"+c+"$"),chain:Hub.util.chain()};e(r,b.chain,b.re,null)}return b}function n(a,b,c,d){for(var j in a){var x=a[j];if((c||x.re).test(d))x.chain.add(b,
d)}}function e(a,b,c,d){for(var j in a){var x=a[j];if((c||x.re).test(d||j))(b||x.chain).addAll(x.chain.all(),j)}}function f(a,b){r[a]={chain:b};return b}function q(a){g(a);var b=f(a,Hub.util.topicChain());e(u,b,null,a);return b}function p(a,b){var c;c=(c=r[a])?c.chain:a.indexOf("{")!==-1?f(a,i(a)):a.indexOf("*")===-1?q(a):h(a).chain;try{return c.apply(null,b)}catch(d){if(a==="hub.error/publish")throw d;p("hub.error/publish",[new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',
{topic:a,error:d.message})])}}function t(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var r={},u={},m={},o={},v=[];Hub.reset=function(){r={};u={};m={};for(var a in o)a.indexOf("lib.")===-1&&delete o[a]};Hub.subscribe=function(a,b){t(b);var c=a.indexOf("*")!==-1,d;if(d=r[a])d=d.chain;else{if(c){d=h(a);d.chain.add(b);n(r,b,d.re,a);return}d=q(a)}c||n(u,b,null,a);d.add(b,a)};Hub.unsubscribe=function(a,b){t(b);var c=r[a];if(!c){g(a);return false}c.chain.remove(b);for(var d in u){c=
u[d];c.re.test(a)&&c.chain.remove(b)}return true};Hub.peer=function(a,b,c){if(o[a])throw Error("Hub - peer already defined: "+a);if(!c){c=b;b=null}b={is:b?typeof b==="string"?[b]:b:v};if(typeof c==="function"){b.factory=c;Hub.subscribe(a+"/**",l(a))}else{b.instance=c;c=m[a]=s(b);k(c,a)}o[a]=b};Hub.invoke=function(a){var b=arguments.length>1?Array.prototype.slice.call(arguments,1):v;return p(a,b)};Hub.forward=function(a,b,c,d){if(typeof a==="object")for(var j in a){b=a[j];typeof b==="string"?Hub.subscribe(j,
Hub.publisher(b)):Hub.subscribe(j,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,c,d))};Hub.publisher=function(a,b,c){if(b){if(c)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),c))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(d){return Hub.publish(a,Hub.util.merge(d,b))}}return function(d){return Hub.publish(a,d)}};Hub.Error=function(a,b,c){return{toString:function(){return Hub.util.substitute(b,
this.context)},type:a,context:c||{}}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var c=Object.prototype.toString,d=c.call(b);c=c.call(a);if(c===d){if(d==="[object Object]"){for(var j in b)a[j]=arguments.callee(a[j],b[j]);return a}if(d==="[object Array]")return a.concat(b)}p("hub.error/util.merge",[new Hub.Error("validation",c===d?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:a,
source:b,targetType:c,sourceType:d})]);return a};Hub.util.resolve=function(a,b,c){var d=b.indexOf(".");if(d!==-1){var j=b.substring(0,d);if(j in a)return arguments.callee(a[j],b.substring(d+1),c);return c}return b in a?a[b]:c};Hub.util.substitute=function(a,b,c){if(c===undefined)c="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(d,j){return Hub.util.resolve(b,j,c)}:function(){return c})}})();(function(){function w(e,f){try{e(f)}catch(q){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:q.message}))}}function s(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function l(e){return function(){e.reject({type:"timeout"})}}function k(e,f,q){var p,t,r=true,u;u={then:function(m,o){if(e){var v=r?m:o;v&&w(v,f)}else{m&&p.push(m);o&&t.push(o)}return this},publish:function(m){if(e){f=Hub.invoke.apply(Hub,
arguments);return this}var o=[m];if(arguments.length>1)o=o.concat(arguments);return this.then(function(){f=Hub.invoke.apply(Hub,o)})},publishValue:function(m){if(e){f=Hub.invoke(m,f);return this}return this.then(function(){f=Hub.invoke(m,f)})},fulfill:function(m){if(e)s();else{e=true;clearTimeout(q);for(f=Hub.util.merge(f,m);p.length;)w(p.shift(),f)}return this},reject:function(m){if(e)s();else{e=true;r=false;for(clearTimeout(q);t.length;)w(t.shift(),m)}return this},fulfilled:function(){return e}};
if(!e){p=[];t=[];q=setTimeout(l(u),q||6E4)}return u}function i(e,f){function q(){if(++u===2)(o?m.fulfill:m.reject)(r)}function p(v){if(o)r=Hub.util.merge(r,v);q()}function t(v){if(o){o=false;r=v}else r=Hub.util.merge(r,v);q()}var r,u=0,m=k(false),o=true;e.then(p,t);f.then(p,t);return m}function g(e){var f=k(true);e.then=f.then;e.publish=f.publish;e.publishValue=f.publishValue;return f}var h=true,n=function(){};n.prototype={then:function(e,f){return g(this).then(e,f)},publish:function(){return g(this).publish.apply(null,
arguments)},publishValue:function(){return g(this).publishValue.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var e=h;h=false;var f=Hub.invoke.apply(this,arguments);if(typeof f!=="undefined"){f=k(true,f);h=h?i(h,f):f}f=h;h=e;return f||new n};Hub.promise=function(e){e=k(false,undefined,e);if(h===true)return e;if(h===false)return h=e;h=i(h,e);return e}})();
