/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub=function(){function s(a,b){var c=function(){if(!b){if(!a)return;return a.apply(null,arguments)}if(!a)return b.apply(null,arguments);var d=n;n=b;A=arguments;try{var e=a.apply(null,arguments);if(n)e=Hub.util.merge(e,b.apply(null,arguments));return e}finally{n=d;nextarguments=undefined}};c.add=function(d){if(b===undefined)b=d;else a=a===undefined?d:s(d,a)};c.remove=function(d){if(d===b){b=undefined;return a}if(d===a){a=undefined;return b}if(a&&typeof a.remove==="function"&&!(a=a.remove(d)))return b;
return this};return c}function w(a){var b={};if(a=t[a]){for(var c=a.is?typeof a.is==="string"?[a.is]:a.is:B,d=0,e;e=c[d++];){var h=b;e=x[e]||w(topic);var k=void 0;for(k in e){var l=e[k],f=h[k];f||(h[k]=f=s());f.add(l)}}a=a.factory();for(var g in a){c=a[g];(d=b[g])||(b[g]=d=s());d.add(c)}}return b}function L(a){return function(){var b=w(a);C(b,a);Hub.propagate();for(var c in b)Hub.unsubscribe(a+"/"+c,b[c])}}function C(a,b){for(var c in a)Hub.subscribe(b+"/"+c,a[c])}function M(a){return function(){q(Hub.util.substitute(a,
arguments),arguments)}}function y(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function D(a,b){y(a);var c=s(),d,e;a.indexOf("{")!==-1&&c.add(M(a));if(a.indexOf("*")!==-1){d=E[a];if(!d){d=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");d=E[a]=RegExp("^"+d+"$")}for(e in j)d.test(e)&&c.add(j[e]);m[a]=d}else for(e in m){d=
m[e];d.test(a)&&c.add(j[e])}b&&c.add(b);return j[a]=c}function q(a,b){var c=j[a]||D(a);try{return c.apply(null,b)}catch(d){if(a==="hub.error/publish")throw d;q("hub.error/publish",[new Hub.Error("error",'Error in callback for topic "{topic}": {error}',{topic:a,error:d.message})])}}function F(){r=undefined;o=(new Date).getTime();var a=-1,b;for(b in p){var c=p[b],d=c[0];if(d<=o){c[1].reject({type:"timeout"});delete p[b]}else a=a===-1?d:Math.min(d,a)}if(a!==-1)u=setTimeout(F,a);o=undefined}function N(a,
b){o||(o=(new Date).getTime());var c=++O;p[c]=[o+b,a];if(!r){clearTimeout(u);r=setTimeout(F,15)}return c}function z(a,b){if(a)try{a(b)}catch(c){q("hub.error/promise.callback",[new Hub.Error("error","Error in promise callback: ${error}",{error:c.message})])}}function G(){q("hub.error/promise.fulfilled",[new Hub.Error("validation","Promise already fulfilled")])}function v(a,b,c){var d=[],e=[],h=true,k,l;l={then:function(f,g){if(a)z(h?f:g,b);else{f&&d.push(f);g&&e.push(g)}return this},publish:function(f){if(a)return Hub.publish.apply(Hub,
arguments);var g=[f];if(arguments.length>1)g=g.concat(arguments);return this.then(function(){return Hub.publish.apply(Hub,g)})},fulfill:function(f){if(a)G();else{a=true;delete p[k];for(b=Hub.util.merge(b,f);d.length;)z(d.shift(),b)}return this},reject:function(f){if(a)G();else{a=true;h=false;for(delete p[k];d.length;)z(e.shift(),f)}return this},fulfilled:function(){return a}};a||(k=N(l,c||6E4));return l}function H(a,b){function c(){if(++k===2)(f?l.fulfill:l.reject)(h)}function d(g){if(f)h=Hub.util.merge(h,
g);c()}function e(g){if(f){f=false;h=g}else h=Hub.util.merge(h,g);c()}var h,k=0,l=v(false,undefined),f=true;a.then(d,e);b.then(d,e);return l}function I(a){var b=v(true);a.then=b.then;a.publish=b.publish;return b}function J(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var j={},m={},x={},t={},n=false,A,B=[],i=true,p={},E={},u,r,O=0,o,K=function(){};K.prototype={then:function(a,b){return I(this).then(a,b)},publish:function(a,b,c){return I(this).publish(a,b,c)},fulfill:function(){throw Error("Hub - promise already fulfilled");
},fulfilled:function(){return true}};return{SINGLETON:"SINGLETON",PROTOTYPE:"PROTOTYPE",reset:function(){j={};m={};x={};for(var a in t)a.indexOf("lib.")===-1&&delete t[a];if(r){clearTimeout(r);r=undefined}if(u){clearTimeout(u);u=undefined}o=undefined;p={}},subscribe:function(a,b){J(b);var c=j[a];if(c){y(a);c.add(b)}else D(a,b);for(var d in m)m[d].test(a)&&j[d].add(b)},unsubscribe:function(a,b){J(b);if(!j[a]){y(a);return false}j[a].remove(b);for(var c in m)m[c].test(a)&&j[c].remove(b);return true},
peer:function(a,b,c){if(t[a])throw Error("Hub - peer already defined: "+a);if(typeof b==="function"){c=b;b={}}b.factory=c;t[a]=b;if(!b.scope||b.scope===Hub.SINGLETON){b=x[a]=w(a);C(b,a)}else Hub.subscribe(a+"/**",L(a))},publish:function(a){var b=i;i=false;var c=arguments.length>1?Array.prototype.slice.call(arguments,1):B;c=q(a,c);if(c!==undefined){c=v(true,c);i=i?H(i,c):c}c=i;i=b;return c||new K},stopPropagation:function(){n=false},propagate:function(){n.apply(null,A);n=false},promise:function(a){a=
v(false,undefined,a);if(i===true)return a;if(i===false)return i=a;i=H(i,a);return a},forward:function(a,b,c,d){if(typeof a==="object")for(var e in a){b=a[e];typeof b==="string"?Hub.subscribe(e,Hub.publisher(b)):Hub.subscribe(e,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,c,d))},publisher:function(a,b,c){if(b){if(c)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),c))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};
return function(d){return Hub.publish(a,Hub.util.merge(d,b))}}return function(d){return Hub.publish(a,d)}},Error:function(a,b,c){return{toString:function(){return Hub.util.substitute(b,this.context)},type:a,context:c||{}}},util:{merge:function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var c=Object.prototype.toString,d=c.call(b);c=c.call(a);if(c===d){if(d==="[object Object]"){for(var e in b)a[e]=arguments.callee(a[e],b[e]);return a}if(d==="[object Array]")return a.concat(b)}q("hub.error/util.merge",
[new Hub.Error("validation",c===d?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:c,sourceType:d})]);return a},chain:function(){for(var a=s(),b=arguments.length;b--;)a.add(arguments[b]);return a},resolve:function(a,b,c){var d=b.indexOf(".");if(d!==-1){var e=b.substring(0,d);if(e in a)return arguments.callee(a[e],b.substring(d+1),c);return c}return b in a?a[b]:c},substitute:function(a,b,c){if(c===undefined)c="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,
b?function(d,e){return Hub.util.resolve(b,e,c)}:function(){return c})}}}}();
