/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(e){function d(){}d.prototype=e;return new d};hub.apply=function(e,d){this[e].apply(this,d)};hub.resolve=function(e,d,c){for(var f=d.indexOf(".");f!==-1;){var h=d.substring(0,f);if(!e.hasOwnProperty(h))return c;e=e[h];d=d.substring(f+1);f=d.indexOf(".")}return e.hasOwnProperty(d)?e[d]:c};hub.substitute=function(e,d,c){if(c===undefined)c="";return e.replace(/\{([a-zA-Z0-9\.]+)\}/g,d?function(f,h){return hub.resolve(d,h,c)}:function(){return c})};
hub.Error=function(e,d,c){this.type=e;this.context=c;this.toString=function(){return hub.substitute(d,c)}};
hub.merge=function(e,d){if(e===undefined||e===null||e===d)return d;if(d===undefined||d===null)return e;var c=Object.prototype.toString,f=c.call(d);c=c.call(e);var h;if(c===f){if(f==="[object Object]"){for(h in d)if(d.hasOwnProperty(h))e[h]=hub.merge(e[h],d[h]);return e}if(f==="[object Array]")return e.concat(d)}throw new hub.Error("validation",c===f?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:e,source:d,targetType:c,sourceType:f});};
hub.iterator=function(e){function d(){if(c>=f)throw Error("Iterator out of bounds.");var h=e[c++];d.hasNext=c<f;return h}var c=0,f=e.length;d.hasNext=c<f;d.remove=function(h){var a=typeof h;if(a==="undefined")h=c;else if(a==="number")h<c&&c--;else{for(a=e.length-1;a>=0;a--)if(e[a]===h){h=a;break}if(a<0)return false}if(h>=f)return false;e.splice(h,1);d.hasNext=c<--f;return true};d.insert=function(h,a){if(typeof a==="undefined"){a=h;h=c}else h<c&&c++;e.splice(h,0,a);d.hasNext=c<++f};d.reset=function(){c=
0;d.hasNext=c<f};return d};
(function(){var e={};(function(){function d(a){e[a]=function(){var b=this.promise();b[a].apply(b,arguments)}}for(var c=["then","join","wait","resolve","reject"],f=0,h=c.length;f<h;f++)d(c[f])})();hub.scope=function(d){function c(){return g.propagate()}var f=[],h=false,a,b,g=Object.create(e);g.stopPropagation=function(){h=true;f.length=0;if(arguments.length)b=arguments[0]};g.propagate=function(){if(arguments.length)b=arguments[0];var i=f.length;if(!i)return this.result();i=f[i-1];if(i.hasNext){i=i().apply(this,
d);if(a){b=a;a=undefined;b.then(c);return b}else if(i&&i.then){b=i;b.then(c);return}b=hub.merge(b,i)}else{i.reset();f.pop()}return this.propagate()};g.aborted=function(){return h};g.result=function(){if(b&&b.then)return b;return hub.promise(0,this).resolve(b)};g.push=function(i){f.push(i)};g.promise=function(){a||(a=hub.promise());return a};return g}})();
(function(){hub.chain=function(){function e(){var c=this.propagate?this:hub.scope(arguments);c.push(d);return c.propagate()}var d=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);e.add=function(c){var f=typeof c;if(f!=="function")throw new TypeError("Callback is "+f);d.insert(0,c)};e.insert=d.insert;e.remove=d.remove;return e}})();
(function(){function e(a){var b=typeof a;if(b!=="string")throw Error("Topic is "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(a))throw Error("Illegal topic: "+a);}function d(a,b){var g=a.indexOf("*"),i=b.indexOf("*");if(g===-1)return i===-1?0:1;if(i===-1)return-1;var p=a.indexOf("."),k=b.indexOf(".");if(g<p){if(i>k)return-1}else if(i<k)return 1;return 0}function c(a){a=a.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+a+"$")}function f(a,b){if(a)e(a);else a=h;var g=c(a),i,p=b?[b]:[];return{emit:function(k){k||(k=a);if(k!==h&&!g.test(k)){if(k.indexOf("*")===-1||!c(k).test(a))return;k=h}var n=this.propagate?this:hub.scope(Array.prototype.slice.call(arguments,1));i&&i.call(n);if(n.aborted())return n.result();var l=n.topicChainQueue;if(l)Array.prototype.push.apply(l,p);else l=n.topicChainQueue=p.slice();for(;l.length;){l.shift().emit.call(n,k);if(n.aborted())break}return n.result()},matches:function(k){return g.test(k)},
getTopic:function(){return a},on:function(k,n,l){if(a===k){i||(i=hub.chain());i.add(n)}else{var o,q,r;q=0;for(r=p.length;q<r;q++){o=p[q];if(o.matches(k)){o.on(k,n,l);return}l||(l=c(k));if(l.test(o.getTopic())){o=f(k,o);o.on(k,n,l);p[q]=o;return}}o=f(k);o.on(k,n);if(k.indexOf("*")===-1)p.unshift(o);else{q=0;for(r=p.length;q<r;q++){n=p[q].getTopic();if(d(n,k)!==-1){p.splice(q,0,o);return}}p.push(o)}}},un:function(k,n){if(a===k)return i?i.remove(n):-1;var l,o,q;l=0;for(o=p.length;l<o;l++){q=p[l];if(q.matches(k))if(q.un(k,
n))return true}e(k);l=typeof n;if(l!=="function")throw new TypeError("Callback is "+l);return false}}}var h="**";hub.node=f;hub.topicComparator=d;hub.validateTopic=e})();
(function(){hub.mix=function(e,d){for(var c in d)if(d.hasOwnProperty(c)&&typeof d[c]==="function"){var f=e,h=c,a=d[c],b=f[h];if(b)if(b.add)b.add(a);else f[h]=hub.chain(a,f[h]);else f[h]=hub.chain(a)}return e};hub.create=function(e,d,c){if(typeof e!=="string"){c=d;d=e;e=null}if(typeof d!=="function")throw new TypeError;var f={};e=e?hub.topicScope(e):hub.scope();e.mix=function(){hub.emit.apply(hub,arguments).then(function(h){hub.mix(f,h)})};d=c?d.apply(e,c):d.call(e);return hub.mix(f,d)};hub.factory=
function(e,d){return function(){return hub.create(e,d)}}})();
(function(){function e(a,b){for(var g in b)if(b.hasOwnProperty(g))hub.root.on(a+g,b[g])}function d(a){return function(){return a}}function c(a,b){if(a)a+=".";return function(){var g=h.call(arguments);if(!g[0])throw new TypeError("Topic is "+g[0]);g[0]=a+g[0];return b.apply(this,g)}}hub.root=hub.node();var f={},h=Array.prototype.slice;hub.on=function(a,b){if(typeof a==="function")hub.root.on("**",a);else if(Object.prototype.toString.call(a)==="[object Object]"){e("",a);return}else if(Object.prototype.toString.call(b)===
"[object Object]"){e(a+".",b);b=d(b)}hub.root.on(a,b)};hub.un=function(a,b){if(typeof a==="function")return hub.root.un("**",a);return hub.root.un(a,b)};hub.topicScope=function(a,b){b||(b=hub.scope());var g=a.lastIndexOf(".");g=g===-1?"":a.substring(0,g);var i=f[g];if(!i){i={topic:d(a),on:c(g,hub.on),un:c(g,hub.un),peer:c(g,hub.peer),emit:c(g,hub.emit),create:c(g,hub.create),factory:c(g,hub.factory)};f[g]=i}b.topic=i.topic;b.on=i.on;b.un=i.un;b.peer=i.peer;b.emit=i.emit;b.create=i.create;b.factory=
i.factory;return b};hub.emit=function(a){hub.validateTopic(a);var b=h.call(arguments),g=b.slice(1);if(a.indexOf("{")!==-1)b[0]=hub.substitute(a,g);g=this.propagate?this:hub.scope(g);g=hub.topicScope(b[0],g);var i;try{i=hub.root.emit.apply(g,b)}catch(p){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:b[0],error:p.message});}if(!i||!i.then){b=hub.promise(0,g);b.resolve(i);i=b}return i};hub.peer=function(a,b,g){if(typeof a==="function"){if(b=hub.create(a,b))hub.on(b)}else if(typeof b===
"function"){if(b=hub.create(a,b,g))hub.on(a,b)}else hub.on(a,b)};hub.reset=function(){f={};hub.root=hub.node()}})();
(function(){var e=Array.prototype.slice;hub.promise=function(d,c){function f(){r&&clearTimeout(r);for(var j=q?n:k,m=0,s=j.length;m<s;m++)j[m].apply(c,l);k.length=0;n.length=0}function h(){o--;!o&&l&&f()}function a(j){return function(){j.reject.apply(j,arguments)}}function b(j,m){return function(){var s=e.call(arguments);m.then(function(){var u=e.call(arguments);j.resolve.apply(j,s.concat(u))})}}function g(){if(l)throw Error("Promise already "+(q?"rejected":"resolved"));}function i(j,m){return function(){j.apply(hub,
[m].concat(l))}}function p(j,m){return function(){j.apply(hub,m)}}var k=[],n=[],l,o=0,q=false,r,t;t={then:function(j,m){if(!j&&!m)throw new TypeError("Require callback or errback");if(j&&typeof j!=="function")throw new TypeError("Callback is "+j);if(m&&typeof m!=="function")throw new TypeError("Errback is "+m);j&&k.push(j);m&&n.push(m);!o&&l&&f();return this},resolve:function(){g();l=e.call(arguments);o||f();return this},reject:function(){g();q=true;l=e.call(arguments);o||f();return this},wait:function(){var j=
0,m=arguments.length;for(o+=m;j<m;j++)arguments[j].then(h,h);return this},join:function(j){if(!j||typeof j.then!=="function")throw new TypeError("Promise is "+j);var m=hub.promise();this.then(b(m,j),a(m));j.then(null,a(m));return m},emit:function(j){hub.validateTopic(j);return this.then(arguments.length===1?i(hub.emit,j):p(hub.emit,arguments))},create:function(j){hub.validateTopic(j);return this.then(i(hub.create,j))}};if(d)r=setTimeout(function(){t.reject(new hub.Error("timeout","Promise timed out after {timeout} milliseconds",
{timeout:d}))},d);return t}})();
(function(){var e=hub.emit,d=hub.merge;hub.emitter=function(c,f,h){if(typeof c==="string"){if(f){if(h)return function(){return e(c,d(f.apply(null,arguments),h))};if(typeof f==="function")return function(){return e(c,f.apply(null,arguments))};return function(i){return e(c,d(i,f))}}return function(){if(arguments.length)return e.apply(hub,[c].concat(Array.prototype.slice.call(arguments)));return e(c)}}var a=hub.chain(),b;for(b in c)if(c.hasOwnProperty(b)){var g=c[b];a[b]=typeof g==="string"?hub.emitter(g):
hub.emitter.apply(hub,g);a.add(a[b])}return a}})();(function(){var e=hub.emitter,d=hub.on;hub.forward=function(c,f,h,a){if(typeof c==="object")for(var b in c){if(c.hasOwnProperty(b)){f=c[b];typeof f==="string"?d(b,e(f)):d(b,e(f[0],f[1],f[2]))}}else d(c,e(f,h,a))}})();
