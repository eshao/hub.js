/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};hub.resolve=function(e,f,a){for(var g=f.indexOf(".");g!==-1;){var h=f.substring(0,g);if(!e.hasOwnProperty(h))return a;e=e[h];f=f.substring(g+1);g=f.indexOf(".")}return e.hasOwnProperty(f)?e[f]:a};hub.substitute=function(e,f,a){if(a===undefined)a="";return e.replace(/\{([a-zA-Z0-9\.]+)\}/g,f?function(g,h){return hub.resolve(f,h,a)}:function(){return a})};hub.Error=function(e,f,a){this.type=e;this.context=a;this.toString=function(){return hub.substitute(f,a)}};
hub.merge=function(e,f){if(e===undefined||e===null||e===f)return f;if(f===undefined||f===null)return e;var a=Object.prototype.toString,g=a.call(f);a=a.call(e);var h;if(a===g){if(g==="[object Object]"){for(h in f)if(f.hasOwnProperty(h))e[h]=hub.merge(e[h],f[h]);return e}if(g==="[object Array]")return e.concat(f)}throw new hub.Error("validation",a===g?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:e,source:f,targetType:a,sourceType:g});};
hub.iterator=function(e){function f(){if(a>=g)throw Error("Iterator out of bounds.");var h=e[a++];f.hasNext=a<g;return h}var a=0,g=e.length;f.hasNext=a<g;f.remove=function(h){var b=typeof h;if(b==="undefined")h=a;else if(b==="number")h<a&&a--;else{for(b=e.length-1;b>=0;b--)if(e[b]===h){h=b;break}if(b<0)return false}if(h>=g)return false;e.splice(h,1);f.hasNext=a<--g;return true};f.insert=function(h,b){if(typeof b==="undefined"){b=h;h=a}else h<a&&a++;e.splice(h,0,b);f.hasNext=a<++g};f.reset=function(){a=
0;f.hasNext=a<g};return f};
(function(){function e(c){var l=[],n=false,m,j,k;return k={stopPropagation:function(){n=true;l.length=0;if(arguments.length)j=arguments[0]},propagate:function(){if(arguments.length)j=arguments[0];var i=l.length;if(!i)return k.result();i=l[i-1];if(i.hasNext){i=i().apply(k,c);if(m){j=m;m=undefined;j.then(k.propagate);return j}else if(i&&i.then){j=i;j.then(k.propagate);return}j=hub.merge(j,i)}else{i.reset();l.pop()}return k.propagate()},aborted:function(){return n},result:function(){if(j&&j.then)return j;
return hub.promise(0,k).resolve(j)},push:function(i){l.push(i)},promise:function(){return m=hub.promise()}}}function f(){function c(){var n=this.propagate?this:e(arguments);n.push(l);return n.propagate()}var l=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);c.add=function(n){var m=typeof n;if(m!=="function")throw new TypeError("Callback is "+m);l.insert(0,n)};c.insert=l.insert;c.remove=l.remove;return c}function a(c){c=c.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,
"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+c+"$")}function g(c){var l=typeof c;if(l!=="string")throw Error("Topic is "+l);if(!c)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(c))throw Error("Illegal topic: "+c);}function h(c,l){var n=c.indexOf("*"),m=l.indexOf("*");if(n===-1)return m===-1?0:1;if(m===-1)return-1;var j=c.indexOf("."),k=l.indexOf(".");if(n<j){if(m>k)return-1}else if(m<k)return 1;return 0}function b(c,l){function n(i){i||(i=c);if(i!==d&&!m.test(i)){if(i.indexOf("*")===
-1||!a(i).test(c))return;i=d}var o=this.propagate?this:e(Array.prototype.slice.call(arguments,1));j&&j.call(o);if(o.aborted())return o.result();var p=o.topicChainQueue;if(p)Array.prototype.push.apply(p,k);else p=o.topicChainQueue=k.slice();for(;p.length;){p.shift().call(o,i);if(o.aborted())break}return o.result()}if(c)g(c);else c=d;var m=a(c),j,k=l?[l]:[];n.matches=function(i){return m.test(i)};n.getTopic=function(){return c};n.add=function(i,o,p){if(c===i){j||(j=f());j.add(o)}else{var q,r,s;r=0;
for(s=k.length;r<s;r++){q=k[r];if(q.matches(i)){q.add(i,o,p);return}p||(p=a(i));if(p.test(q.getTopic())){q=b(i,q);q.add(i,o,p);k[r]=q;return}}q=b(i);q.add(i,o);if(i.indexOf("*")===-1)k.unshift(q);else{r=0;for(s=k.length;r<s;r++){o=k[r].getTopic();if(h(o,i)!==-1){k.splice(r,0,q);return}}k.push(q)}}};n.remove=function(i,o){if(c===i)return j?j.remove(o):-1;var p,q,r;p=0;for(q=k.length;p<q;p++){r=k[p];if(r.matches(i))if(r.remove(i,o))return true}g(i);p=typeof o;if(p!=="function")throw new TypeError("Callback is "+
p);return false};return n}var d="**";hub.scope=e;hub.chain=f;hub.topicChain=b;hub.topicComparator=h;hub.validateTopic=g})();
(function(){hub.create=function(e,f,a){if(typeof e!=="string"){a=f;f=e;e=null}if(typeof f!=="function")throw new TypeError;var g={};e=e?hub.topicScope(e):hub.scope();e.mix=function(){hub.emit.apply(hub,arguments).then(function(h){hub.mix(g,h)})};f=a?f.apply(e,a):f.call(e);return hub.mix(g,f)};hub.mix=function(e,f){for(var a in f)if(f.hasOwnProperty(a)&&typeof f[a]==="function"){var g=e,h=a,b=f[a],d=g[h];if(d)if(d.add)d.add(b);else g[h]=hub.chain(b,g[h]);else g[h]=b}return e}})();
(function(){function e(b,d){for(var c in d)d.hasOwnProperty(c)&&hub.root.add(b+c,d[c])}function f(b){return function(){return b}}function a(b,d){b+=".";return function(){var c=h.call(arguments);if(!c[0])throw new TypeError("Topic is "+c[0]);c[0]=b+c[0];return d.apply(this,c)}}hub.root=hub.topicChain();var g={},h=Array.prototype.slice;hub.on=function(b,d){if(typeof b==="function")hub.root.add("**",b);else if(Object.prototype.toString.call(b)==="[object Object]"){e("",b);return}else if(Object.prototype.toString.call(d)===
"[object Object]"){e(b+".",d);d=f(d)}hub.root.add(b,d)};hub.un=function(b,d){if(typeof b==="function")return hub.root.remove("**",b);return hub.root.remove(b,d)};hub.topicScope=function(b,d){d||(d=hub.scope());var c=g[b];if(!c){c={on:a(b,hub.on),un:a(b,hub.un),peer:a(b,hub.peer),emit:a(b,hub.emit),create:a(b,hub.create)};g[b]=c}d.on=c.on;d.un=c.un;d.peer=c.peer;d.emit=c.emit;d.create=c.create;return d};hub.emit=function(b){hub.validateTopic(b);var d=h.call(arguments),c=d.slice(1);if(b.indexOf("{")!==
-1)d[0]=hub.substitute(b,c);c=this.propagate?this:hub.scope(c);c=hub.topicScope(d[0],c);var l;try{l=hub.root.apply(c,d)}catch(n){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:d[0],error:n.message});}if(!l||!l.then){d=hub.promise(0,c);d.resolve(l);l=d}return l};hub.peer=function(b,d,c){if(typeof b==="function"){if(d=hub.create(b,d))hub.on(d)}else if(typeof d==="function"){if(d=hub.create(b,d,c))hub.on(b,d)}else hub.on(b,d)};hub.reset=function(){g={};hub.root=
hub.topicChain()}})();
(function(){hub.promise=function(e,f){function a(){n&&clearTimeout(n);for(var j=l?b:h,k=0,i=j.length;k<i;k++)j[k].apply(f,d);h.length=0;b.length=0}function g(){c--;!c&&d&&a()}var h=[],b=[],d,c=0,l=false,n,m;m={then:function(j,k){if(typeof j!=="function")throw new TypeError("Callback is "+j);h.push(j);k&&b.push(k);!c&&d&&a();return m},resolve:function(){if(d)throw Error("Promise already "+(l?"rejected":"resolved"));d=Array.prototype.slice.call(arguments);c||a();return m},reject:function(){l=true;return m.resolve.apply(m,
arguments)},wait:function(){var j=0,k=arguments.length;for(c+=k;j<k;j++)arguments[j].then(g);return m},join:function(j){if(!j||typeof j.then!=="function")throw new TypeError("Promise is "+j);var k=hub.promise();m.then(function(i){j.then(function(o){k.resolve(i,o)})});return k},emit:function(j){m.then(function(){hub.emit.apply(hub,[j].concat(d))})}};if(e)n=setTimeout(function(){m.reject(new hub.Error("timeout","Promise timed out after {timeout} milliseconds",{timeout:e}))},e);return m}})();
(function(){var e=hub.emit,f=hub.merge;hub.emitter=function(a,g,h){if(typeof a==="string"){if(g){if(h)return function(){return e(a,f(g.apply(null,arguments),h))};if(typeof g==="function")return function(){return e(a,g.apply(null,arguments))};return function(l){return e(a,f(l,g))}}return function(){if(arguments.length)return e.apply(hub,[a].concat(Array.prototype.slice.call(arguments)));return e(a)}}var b=hub.chain(),d;for(d in a)if(a.hasOwnProperty(d)){var c=a[d];b[d]=typeof c==="string"?hub.emitter(c):
hub.emitter.apply(hub,c);b.add(b[d])}return b}})();(function(){var e=hub.emitter,f=hub.on;hub.forward=function(a,g,h,b){if(typeof a==="object")for(var d in a){if(a.hasOwnProperty(d)){g=a[d];typeof g==="string"?f(d,e(g)):f(d,e(g[0],g[1],g[2]))}}else f(a,e(g,h,b))}})();
