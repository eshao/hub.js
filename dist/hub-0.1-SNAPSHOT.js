/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};
hub.merge=function(f,e){if(f===undefined||f===null||f===e)return e;if(e===undefined||e===null)return f;var b=Object.prototype.toString,d=b.call(e);b=b.call(f);var g;if(b===d){if(d==="[object Object]"){for(g in e)if(e.hasOwnProperty(g))f[g]=hub.merge(f[g],e[g]);return f}if(d==="[object Array]")return f.concat(e)}throw new hub.Error("validation",b===d?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:f,source:e,targetType:b,sourceType:d});};
hub.resolve=function(f,e,b){for(var d=e.indexOf(".");d!==-1;){var g=e.substring(0,d);if(!f.hasOwnProperty(g))return b;f=f[g];e=e.substring(d+1);d=e.indexOf(".")}return f.hasOwnProperty(e)?f[e]:b};hub.substitute=function(f,e,b){if(b===undefined)b="";return f.replace(/\{([a-zA-Z0-9\.]+)\}/g,e?function(d,g){return hub.resolve(e,g,b)}:function(){return b})};hub.Error=function(f,e,b){this.type=f;this.context=b;this.toString=function(){return hub.substitute(e,b)}};
hub.iterator=function(f){function e(){if(b>=d)throw Error("Iterator out of bounds.");var g=f[b++];e.hasNext=b<d;return g}var b=0,d=f.length;e.hasNext=b<d;e.remove=function(g){var a=typeof g;if(a==="undefined")g=b;else if(a==="number")g<b&&b--;else{for(a=f.length-1;a>=0;a--)if(f[a]===g){g=a;break}if(a<0)return false}if(g>=d)return false;f.splice(g,1);e.hasNext=b<--d;return true};e.insert=function(g,a){if(typeof a==="undefined"){a=g;g=b}else g<b&&b++;f.splice(g,0,a);e.hasNext=b<++d};e.reset=function(){b=
0;e.hasNext=b<d};return e};
(function(){function f(){var h=a.length;if(!h)return false;h=a[h-1];if(!h.hasNext){a.pop();return f()}h=h().apply(b,d);g=hub.merge(g,h);return true}var e=false,b,d,g,a=[];hub.stopPropagation=function(){e=true;a.length=0;if(arguments.length)g=arguments[0]};hub.propagate=function(){f()};hub.chain=function(){function h(){h.aborted=false;var l=!a.length;if(l){e=false;d=arguments;g=undefined}var o=b;b=this;try{a.push(c);var p=true;do p=f();while(p)}finally{h.aborted=e;c.reset();if(l)a.length=0;b=o}if(!a.length){l=
g;b=d=g=undefined;return l}}var c=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);h.add=function(l){c.insert(0,l)};h.insert=c.insert;h.remove=c.remove;return h}})();(function(){hub.mix=function(f,e){for(var b in e)if(e.hasOwnProperty(b)&&typeof e[b]==="function"){var d=f,g=b,a=e[b],h=d[g];if(h)if(h.add)h.add(a);else d[g]=hub.chain(a,d[g]);else d[g]=a}return f}})();
(function(){hub.object=function(f,e){if(typeof f!=="function")throw new TypeError;var b={},d={mix:function(){var g=hub.get.apply(hub,arguments);hub.mix(b,g)}};d=e?f.apply(d,e):f.call(d);return hub.mix(b,d)}})();
(function(){function f(a,h){return function(){return a.apply(h,arguments)}}function e(a,h,c){var l=a.api={},o;for(o in a)if(a.hasOwnProperty(o)){var p=a[o];if(typeof p==="function"){var s=h+"/"+o;if(c)l[o]=hub.chain(hub.publisher(s),p);else{l[o]=hub.publisher(s);p=f(p,l);hub.subscribe(s,p)}}}}var b={},d={},g=[];hub.peer=function(a,h){if(d[a])throw Error("hub - peer already defined: "+a);var c={};if(typeof h==="function")c.factory=h;else{b[a]=h;e(h,a,false)}d[a]=c};hub.singleton=function(a,h,c){hub.peer(a,
typeof h==="function"?hub.object(h,c):h)};hub.get=function(a){var h=arguments.length===1?g:Array.prototype.slice.call(arguments,1),c=b[a];if(c)return c.api;c=d[a];if(!c)throw Error("Peer is not defined: "+a);c=hub.object(c.factory,h);e(c,a,true);return c.api};hub.resetPeers=function(){b={};for(var a in d)d.hasOwnProperty(a)&&a.indexOf("lib.")===-1&&delete d[a]}})();
(function(){function f(c){c=c.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,"\\*");return RegExp("^"+c+"$")}function e(c,l){var o=c.indexOf("*"),p=l.indexOf("*");if(o===-1)return p===-1?0:1;if(p===-1)return-1;var s=c.indexOf("/"),q=l.indexOf("/");if(o<s){if(p>q)return-1}else if(p<q)return 1;return 0}function b(c,l){function o(i,j,m){i||(i=c);if(i!==a&&!p.test(i)){if(i.indexOf("*")===-1||!f(i).test(c))return;i=a}var k=j&&j.length?s.apply(this,
j):s.call(this);if(s.aborted){o.aborted=true;return k}if(m){var n,r;n=0;for(r=q.length;n<r;n++)m.push(q[n])}else m=q.slice();for(;m.length;){n=m.shift();r=n.call(this,i,j,m);k=hub.merge(k,r);if(n.aborted){o.aborted=true;break}}return k}c||(c=a);var p=f(c),s=hub.chain(),q=l?[l]:[];o.matches=function(i){return p.test(i)};o.getTopic=function(){return c};o.add=function(i,j,m){if(c===j)s.add(i);else{var k,n,r;n=0;for(r=q.length;n<r;n++){k=q[n];if(k.matches(j)){k.add(i,j,m);return}m||(m=f(j));if(m.test(k.getTopic())){k=
b(j,k);k.add(i,j,m);q[n]=k;return}}k=b(j);k.add(i,j);if(j.indexOf("*")===-1)q.unshift(k);else{n=0;for(r=q.length;n<r;n++){i=q[n].getTopic();if(e(i,j)!==-1){q.splice(n,0,k);return}}q.push(k)}}};o.remove=function(i,j){if(c===j)return s.remove(i);var m,k,n;m=0;for(k=q.length;m<k;m++){n=q[m];if(n.matches(j))if(n.remove(i,j))return true}return false};return o}function d(c){var l=typeof c;if(l!=="string")throw Error("Topic is "+l);if(!c)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(c))throw Error("Illegal topic: "+
c);}function g(c){c=typeof c;if(c!=="function")throw Error("Callback is "+c);}var a="**/**",h=b();hub.topicChain=b;hub.topicComparator=e;hub.reset=function(){h=b();hub.resetPeers();hub.resetPromise()};hub.subscribe=function(c,l){g(l);d(c);h.add(l,c)};hub.unsubscribe=function(c,l){g(l);d(c);return h.remove(l,c)};hub.invoke=function(c){d(c);var l=Array.prototype.slice.call(arguments,1);if(c.indexOf("{")!==-1)c=hub.substitute(c,l);try{return h(c,l)}catch(o){throw new hub.Error("error",'Error in call chain for topic "{topic}": {error}',
{topic:c,error:o.message});}};hub.aborted=function(){return Boolean(h.aborted)}})();
(function(){function f(i,j,m){var k;try{k=i.apply(null,j)}catch(n){hub.invoke("hub.error/promise.callback",new hub.Error("error","Error in promise callback: ${error}",{error:n.message}));return}if(m){if(k===undefined)return j;return[k]}}function e(){hub.invoke("hub.error/promise.resolved",new hub.Error("validation","Promise already resolved"))}function b(i){return function(){i.reject({type:"timeout"})}}function d(i,j,m){var k,n,r=!(j instanceof hub.Error),t=j===undefined?[]:[j],w;w={then:function(u,
v){if(i){var x=r?u:v;if(x)t=f(x,t,true)}else{u&&k.push(u);v&&n.push(v)}return this},publish:function(){if(i){t=[hub.invoke.apply(hub,arguments)];return this}var u=o.call(arguments);return this.then(function(){t=[hub.invoke.apply(hub,u)]})},publishResult:function(u){if(i){t=[hub.invoke.apply(hub,[u].concat(t))];return this}return this.then(function(){t=[hub.invoke.apply(hub,[u].concat(t))]})},resolve:function(){if(i)e();else{i=true;clearTimeout(m);if(arguments.length!==0)t=o.call(arguments);for(;k.length;)f(k.shift(),
t)}return this},reject:function(u){if(i)e();else{i=true;r=false;for(clearTimeout(m);n.length;){var v=n.shift();f(v,[u])}}return this},resolved:function(){return i},join:function(u){return p(w,u)}};if(!i){k=[];n=[];m=setTimeout(b(w),m||6E4)}return w}function g(i){var j=d(true);i.then=j.then;i.publish=j.publish;i.publishResult=j.publishResult;return j}var a=true,h=Array.prototype,c=h.unshift,l=h.push,o=h.slice,p;p=function(i,j){function m(){if(++n===2)(t?r.resolve:r.reject).apply(null,k)}var k=[],n=
0,r=d(false),t=true;i.then(function(){c.apply(k,arguments);m()},function(){c.apply(k,arguments);t=false;m()});j.then(function(){l.apply(k,arguments);m()},function(){l.apply(k,arguments);t=false;m()});return r};var s=Error("hub - promise already resolved"),q=function(){};q.prototype={then:function(i,j){return g(this).then(i,j)},publish:function(){return g(this).publish.apply(null,arguments)},publishResult:function(){return g(this).publishResult.apply(null,arguments)},resolve:function(){throw s;},reject:function(){throw s;
},resolved:function(){return true},join:function(i){return g(this).join(i)}};hub.publish=function(){var i=a;a=false;var j;try{j=hub.invoke.apply(this,arguments)}catch(m){if(a&&m instanceof hub.Error){a.reject(m);return a}throw m;}if(typeof j!=="undefined"){j=d(true,j);a=a?p(a,j):j}j=a;a=i;return j||new q};hub.promise=function(i){i=d(false,undefined,i);if(a===false)a=i;else if(a!==true)a=p(a,i);return i};hub.resetPromise=function(){typeof a!=="boolean"&&a.reject();a=true}})();
(function(){var f=hub.publish,e=hub.merge;hub.publisher=function(b,d,g){if(typeof b==="string"){if(d){if(g)return function(){return f(b,e(d.apply(null,arguments),g))};if(typeof d==="function")return function(){return f(b,d.apply(null,arguments))};return function(l){return f(b,e(l,d))}}return function(){if(arguments.length)return f.apply(hub,[b].concat(Array.prototype.slice.call(arguments)));return f(b)}}var a=hub.chain(),h;for(h in b)if(b.hasOwnProperty(h)){var c=b[h];a[h]=typeof c==="string"?hub.publisher(c):
hub.publisher.apply(hub,c);a.add(a[h])}return a}})();(function(){var f=hub.publisher,e=hub.subscribe;hub.forward=function(b,d,g,a){if(typeof b==="object")for(var h in b){if(b.hasOwnProperty(h)){d=b[h];typeof d==="string"?e(h,f(d)):e(h,f(d[0],d[1],d[2]))}}else e(b,f(d,g,a))}})();
