/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};(function(){function s(){function n(){function f(){if(i<l.length&&!f.stop){o=Hub.util.merge(o,l[i++].apply(null,h));return true}return false}var h=arguments,o,d=r;r=f;i=0;try{for(;r(););return o}finally{r=d}}var l=arguments.length?Array.prototype.slice.call(arguments):[],i=-1;n.add=function(f){l.unshift(f);i!==-1&&i++};n.addAll=function(f){l=f.concat(l);if(i!==-1)i+=f.length};n.insert=function(f,h){l.splice(f,0,h);f<i&&i++};n.remove=function(f){if(typeof f==="number"){l.splice(f,1);f<i&&i--;return f}for(var h=
l.length;h--;)if(l[h]===f){l.splice(h,1);h<i&&i--;return h}return-1};n.all=function(){return l};return n}var r;Hub.stopPropagation=function(){r.stop=true};Hub.propagate=function(){r()};Hub.util.chain=s;Hub.util.topicChain=function(){var n=s(),l=n.remove,i=[];n.add=function(f,h){if(h.indexOf("*")===-1)n.insert(i.length,f);else{for(var o=0,d=i.length;o<d;o++){var e;a:{var j=h,m=i[o];e=j.indexOf("*");var q=m.indexOf("*");j=j.indexOf("/");m=m.indexOf("/");if(e<j){if(q>m){e=-1;break a}}else if(q<m){e=
1;break a}e=0}if(e<=0){i.splice(o,0,h);n.insert(o,f);return}}n.insert(i.length,f);i.push(h)}};n.addAll=function(f,h){for(var o=0,d=f.length;o<d;o++)n.add(f[o],h)};n.remove=function(f){f=l(f);f!==-1&&f<i.length&&i.splice(f,1);return f};return n}})();(function(){function s(a,b,c){var g=a[b];g||(a[b]=g=Hub.util.chain());g.add(c)}function r(a){var b={};if(a=p[a]){for(var c=a.is?typeof a.is==="string"?[a.is]:a.is:t,g=0,k;k=c[g++];){var u=b;k=q[k]||r(k);var v=void 0;for(v in k)s(u,v,k[v])}a=a.factory();for(var w in a)s(b,w,a[w])}return b}function n(a){return function(){var b=r(a);l(b,a);Hub.propagate();for(var c in b)Hub.unsubscribe(a+"/"+c,b[c])}}function l(a,b){for(var c in a)Hub.subscribe(b+"/"+c,a[c])}function i(a){return function(){d(Hub.util.substitute(a,
arguments),arguments)}}function f(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function h(a){var b;if(!(b=m[a])){b=m;var c=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");b=b[a]={re:RegExp("^"+c+"$"),chain:Hub.util.chain()}}return b}function o(a){f(a);var b=j[a]=Hub.util.topicChain(),c;for(c in m){var g=
m[c];g.re.test(a)&&b.addAll(g.chain.all(),c)}return b}function d(a,b){var c=j[a];if(!c)if(a.indexOf("{")!==-1)c=j[a]=i(a);else if(a.indexOf("*")===-1)c=o(a);else{c=h(a);var g=c.re;c=c.chain;for(var k in j)g.test(k)&&c.addAll(j[k].all(),k)}try{return c.apply(null,b)}catch(u){if(a==="hub.error/publish")throw u;d("hub.error/publish",[new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:u.message})])}}function e(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+
a);}var j={},m={},q={},p={},t=[];Hub.SINGLETON="SINGLETON";Hub.PROTOTYPE="PROTOTYPE";Hub.reset=function(){j={};m={};q={};for(var a in p)a.indexOf("lib.")===-1&&delete p[a]};Hub.subscribe=function(a,b){e(b);var c=j[a];if(!c){if(a.indexOf("*")!==-1){c=h(a);c.chain.add(b);c=c.re;for(var g in j)c.test(g)&&j[g].add(b,a);return}c=o(a)}c.add(b,a)};Hub.unsubscribe=function(a,b){e(b);if(!j[a]){f(a);return false}j[a].remove(b);for(var c in m){var g=m[c];g.re.test(a)&&g.chain.remove(b)}return true};Hub.peer=
function(a,b,c){if(p[a])throw Error("Hub - peer already defined: "+a);if(typeof b==="function"){c=b;b={}}b.factory=c;p[a]=b;if(!b.scope||b.scope===Hub.SINGLETON){b=q[a]||r(a);l(b,a)}else Hub.subscribe(a+"/**",n(a))};Hub.invoke=function(a){var b=arguments.length>1?Array.prototype.slice.call(arguments,1):t;return d(a,b)};Hub.forward=function(a,b,c,g){if(typeof a==="object")for(var k in a){b=a[k];typeof b==="string"?Hub.subscribe(k,Hub.publisher(b)):Hub.subscribe(k,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,
Hub.publisher(b,c,g))};Hub.publisher=function(a,b,c){if(b){if(c)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),c))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(g){return Hub.publish(a,Hub.util.merge(g,b))}}return function(g){return Hub.publish(a,g)}};Hub.Error=function(a,b,c){return{toString:function(){return Hub.util.substitute(b,this.context)},type:a,context:c||{}}};Hub.util.merge=function(a,b){if(a===undefined||
a===null||a===b)return b;if(b===undefined||b===null)return a;var c=Object.prototype.toString,g=c.call(b);c=c.call(a);if(c===g){if(g==="[object Object]"){for(var k in b)a[k]=arguments.callee(a[k],b[k]);return a}if(g==="[object Array]")return a.concat(b)}d("hub.error/util.merge",[new Hub.Error("validation",c===g?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:c,sourceType:g})]);return a};Hub.util.resolve=function(a,b,c){var g=
b.indexOf(".");if(g!==-1){var k=b.substring(0,g);if(k in a)return arguments.callee(a[k],b.substring(g+1),c);return c}return b in a?a[b]:c};Hub.util.substitute=function(a,b,c){if(c===undefined)c="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(g,k){return Hub.util.resolve(b,k,c)}:function(){return c})}})();(function(){function s(d,e){try{d(e)}catch(j){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:j.message}))}}function r(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function n(d){return function(){d.reject({type:"timeout"})}}function l(d,e,j){var m,q,p=true,t;t={then:function(a,b){if(d){var c=p?a:b;c&&s(c,e)}else{a&&m.push(a);b&&q.push(b)}return this},publish:function(a){if(d){e=Hub.invoke.apply(Hub,
arguments);return this}var b=[a];if(arguments.length>1)b=b.concat(arguments);return this.then(function(){e=Hub.invoke.apply(Hub,b)})},publishValue:function(a){if(d){e=Hub.invoke(a,e);return this}return this.then(function(){e=Hub.invoke(a,e)})},fulfill:function(a){if(d)r();else{d=true;clearTimeout(j);for(e=Hub.util.merge(e,a);m.length;)s(m.shift(),e)}return this},reject:function(a){if(d)r();else{d=true;p=false;for(clearTimeout(j);q.length;)s(q.shift(),a)}return this},fulfilled:function(){return d}};
if(!d){m=[];q=[];j=setTimeout(n(t),j||6E4)}return t}function i(d,e){function j(){if(++t===2)(b?a.fulfill:a.reject)(p)}function m(c){if(b)p=Hub.util.merge(p,c);j()}function q(c){if(b){b=false;p=c}else p=Hub.util.merge(p,c);j()}var p,t=0,a=l(false),b=true;d.then(m,q);e.then(m,q);return a}function f(d){var e=l(true);d.then=e.then;d.publish=e.publish;d.publishValue=e.publishValue;return e}var h=true,o=function(){};o.prototype={then:function(d,e){return f(this).then(d,e)},publish:function(){return f(this).publish.apply(null,
arguments)},publishValue:function(){return f(this).publishValue.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var d=h;h=false;var e=Hub.invoke.apply(this,arguments);if(typeof e!=="undefined"){e=l(true,e);h=h?i(h,e):e}e=h;h=d;return e||new o};Hub.promise=function(d){d=l(false,undefined,d);if(h===true)return d;if(h===false)return h=d;h=i(h,d);return d}})();
