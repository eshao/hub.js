/*
 hub.js JavaScript library
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
Hub={util:{}};Hub.iterator=function(r){function p(){if(l>=n)throw Error("Iterator out of bounds.");var m=r[l++];p.hasNext=l<n;return m}var l=0,n=r.length;p.hasNext=l<n;p.remove=function(m){if(typeof m==="undefined")m=l;else m<l&&l--;r.splice(m,1);p.hasNext=l<--n};p.insert=function(m,o){if(typeof o==="undefined"){o=m;m=l}else m<l&&l++;r.splice(m,0,o);p.hasNext=l<++n};return p};(function(){function r(){if(n||!l.hasNext)return false;m=Hub.util.merge(m,l().apply(null,o));return true}function p(){function j(){var c=l,e=n,k=m,a=o;m=undefined;try{l=Hub.iterator(h);for(o=arguments;r(););return m}finally{l=c;p.aborted=n;n=e;m=k;o=a;d=false}}var h=arguments.length?Array.prototype.slice.call(arguments):[],d=false;j.add=function(c){if(typeof c.all==="function"){c=c.all();if(d)for(var e=0,k=c.length;e<k;e++)l.insert(e,c[e]);else h=c.concat(h)}else d?iteartor.insert(0,c):h.unshift(c)};
j.insert=function(c,e){d?l.insert(c,e):h.splice(c,0,e)};j.remove=function(c){if(typeof c==="number"){d?l.remove(c):h.splice(c,1);return c}for(var e=h.length;e--;)if(h[e]===c){d?l.remove(e):h.splice(e,1);return e}return-1};j.all=function(){return h};return j}var l,n=false,m,o;Hub.stopPropagation=function(){n=true};Hub.propagate=function(){r()};Hub.util.chain=p;Hub.util.topicChain=function(){var j=p(),h=j.remove,d=[];j.add=function(c,e){if(typeof c.all==="function")for(var k=c.all(),a=k.length-1;a>=
0;a--)j.add(k[a],e);else if(e.indexOf("*")===-1)j.insert(d.length,c);else{a=0;for(k=d.length;a<k;a++){var b;a:{var g=e,f=d[a];b=g.indexOf("*");var i=f.indexOf("*");g=g.indexOf("/");f=f.indexOf("/");if(b<g){if(i>f){b=-1;break a}}else if(i<f){b=1;break a}b=0}if(b<=0){d.splice(a,0,e);j.insert(a,c);return}}j.insert(d.length,c);d.push(e)}};j.remove=function(c){c=h(c);c!==-1&&c<d.length&&d.splice(c,1);return c};return j}})();(function(){function r(h,d,c){var e=h[d];e||(h[d]=e=Hub.util.chain());e.add(c)}function p(h,d){return function(){var c=Hub.subscriberChain(h),e=c.apply(null,arguments);if(c.aborted)return e;return Hub.util.merge(e,d.apply(null,arguments))}}function l(h){var d=m[h];if(d)return d;d=o[h];if(!d)throw Error("Peer is not defined: "+h);d=n(d);var c={},e;for(e in d){var k=d[e];if(typeof k==="function")c[e]=p(h+"/"+e,k)}d.api=c;return d}function n(h){for(var d={},c=h.is,e=0,k;k=c[e++];){var a=d;k=l(k);var b=
void 0;for(b in k)r(a,b,k[b])}h=h.instance||h.factory();for(var g in h)r(d,g,h[g]);return d}var m={},o={},j=[];Hub.peer=function(h,d,c){if(o[h])throw Error("Hub - peer already defined: "+h);if(!c){c=d;d=null}d={is:d?typeof d==="string"?[d]:d:j};if(typeof c==="function")d.factory=c;else{d.instance=c;c=m[h]=n(d);var e=c.api={},k;for(k in c){var a=c[k];if(typeof a==="function"){var b=h+"/"+k;Hub.subscribe(b,a);e[k]=Hub.publisher(b)}}}o[h]=d};Hub.get=function(h){return l(h).api};Hub.resetPeers=function(){m=
{};for(var h in o)h.indexOf("lib.")===-1&&delete o[h]}})();(function(){function r(a){return function(){h(Hub.util.substitute(a,arguments),arguments)}}function p(a){var b=typeof a;if(b!=="string")throw Error("Topic is not string: "+b);if(!a)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+(\/[a-zA-Z0-9\.\{\}\*]+)?$/.test(a))throw Error("Illegal topic: "+a);}function l(a){var b=e[a];if(!b){b=e;var g=a.replace(/\./g,"\\.").replace(/\*\*/g,"[a-zA-Z0-9\\.]+").replace(/\*/g,"[a-zA-Z0-9]+");b=b[a]={re:RegExp("^"+g+"$"),chain:Hub.util.chain()};m(c,b.chain,
b.re,null)}return b}function n(a,b,g,f){for(var i in a){var q=a[i];if((g||q.re).test(f))q.chain.add(b,f)}}function m(a,b,g,f){for(var i in a){var q=a[i];if((g||q.re).test(f||i))(b||q.chain).add(q.chain,i)}}function o(a,b){c[a]={chain:b};return b}function j(a){p(a);var b=o(a,Hub.util.topicChain());m(e,b,null,a);return b}function h(a,b){var g=Hub.subscriberChain(a);try{return g.apply(null,b)}catch(f){throw new Hub.Error("error",'Error in call chain for topic "{topic}": {error}',{topic:a,error:f.message});
}}function d(a){a=typeof a;if(a!=="function")throw Error("Callback is not function: "+a);}var c={},e={},k=[];Hub.reset=function(){c={};e={};Hub.resetPeers()};Hub.subscribe=function(a,b){d(b);var g=a.indexOf("*")!==-1,f;if(f=c[a])f=f.chain;else{if(g){f=l(a);f.chain.add(b);n(c,b,f.re,a);return}f=j(a)}g||n(e,b,null,a);f.add(b,a)};Hub.unsubscribe=function(a,b){d(b);var g=c[a];if(!g){p(a);return false}g.chain.remove(b);for(var f in e){g=e[f];g.re.test(a)&&g.chain.remove(b)}return true};Hub.subscriberChain=
function(a){var b=c[a];if(b)return b.chain;if(a.indexOf("{")!==-1)return o(a,r(a));if(a.indexOf("*")===-1)return j(a);return l(a).chain};Hub.invoke=function(a){var b=arguments.length>1?Array.prototype.slice.call(arguments,1):k;return h(a,b)};Hub.forward=function(a,b,g,f){if(typeof a==="object")for(var i in a){b=a[i];typeof b==="string"?Hub.subscribe(i,Hub.publisher(b)):Hub.subscribe(i,Hub.publisher(b[0],b[1],b[2]))}else Hub.subscribe(a,Hub.publisher(b,g,f))};Hub.publisher=function(a,b,g){if(typeof a===
"string"){if(b){if(g)return function(){return Hub.publish(a,Hub.util.merge(b.apply(null,arguments),g))};if(typeof b==="function")return function(){return Hub.publish(a,b.apply(null,arguments))};return function(s){return Hub.publish(a,Hub.util.merge(s,b))}}return function(){if(arguments.length)return Hub.publish.apply(Hub,[a].concat(Array.prototype.slice.call(arguments)));return Hub.publish(a)}}var f=Hub.util.chain(),i;for(i in a){var q=a[i];f[i]=typeof q==="string"?Hub.publisher(q):Hub.publisher.apply(Hub,
q);f.add(f[i])}return f};Hub.Error=function(a,b,g){this.type=a;this.context=g;this.toString=function(){return Hub.util.substitute(b,g)}};Hub.util.merge=function(a,b){if(a===undefined||a===null||a===b)return b;if(b===undefined||b===null)return a;var g=Object.prototype.toString,f=g.call(b);g=g.call(a);if(g===f){if(f==="[object Object]"){for(var i in b)a[i]=arguments.callee(a[i],b[i]);return a}if(f==="[object Array]")return a.concat(b)}throw new Hub.Error("validation",g===f?"Cannot merge value {target} with {source}":
"Cannot merge type {targetType} with {sourceType}",{target:a,source:b,targetType:g,sourceType:f});};Hub.util.resolve=function(a,b,g){var f=b.indexOf(".");if(f!==-1){var i=b.substring(0,f);if(i in a)return arguments.callee(a[i],b.substring(f+1),g);return g}return b in a?a[b]:g};Hub.util.substitute=function(a,b,g){if(g===undefined)g="";return a.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(f,i){return Hub.util.resolve(b,i,g)}:function(){return g})}})();(function(){function r(d,c){try{d(c)}catch(e){Hub.invoke("hub.error/promise.callback",new Hub.Error("error","Error in promise callback: ${error}",{error:e.message}))}}function p(){Hub.invoke("hub.error/promise.fulfilled",new Hub.Error("validation","Promise already fulfilled"))}function l(d){return function(){d.reject({type:"timeout"})}}function n(d,c,e){var k,a,b=!(c instanceof Hub.Error),g;g={then:function(f,i){if(d){var q=b?f:i;q&&r(q,c)}else{f&&k.push(f);i&&a.push(i)}return this},publish:function(f){if(d){c=
Hub.invoke.apply(Hub,arguments);return this}var i=[f];if(arguments.length>1)i=i.concat(arguments);return this.then(function(){c=Hub.invoke.apply(Hub,i)})},publishResult:function(f){if(d){c=Hub.invoke(f,c);return this}return this.then(function(){c=Hub.invoke(f,c)})},fulfill:function(f){if(d)p();else{d=true;clearTimeout(e);for(c=Hub.util.merge(c,f);k.length;)r(k.shift(),c)}return this},reject:function(f){if(d)p();else{d=true;b=false;for(clearTimeout(e);a.length;)r(a.shift(),f)}return this},fulfilled:function(){return d}};
if(!d){k=[];a=[];e=setTimeout(l(g),e||6E4)}return g}function m(d,c){function e(){if(++g===2)(i?f.fulfill:f.reject)(b)}function k(q){if(i)b=Hub.util.merge(b,q);e()}function a(q){if(i){i=false;b=q}else b=Hub.util.merge(b,q);e()}var b,g=0,f=n(false),i=true;d.then(k,a);c.then(k,a);return f}function o(d){var c=n(true);d.then=c.then;d.publish=c.publish;d.publishResult=c.publishResult;return c}var j=true,h=function(){};h.prototype={then:function(d,c){return o(this).then(d,c)},publish:function(){return o(this).publish.apply(null,
arguments)},publishResult:function(){return o(this).publishResult.apply(null,arguments)},fulfill:function(){throw Error("Hub - promise already fulfilled");},reject:function(){throw Error("Hub - promise already fulfilled");},fulfilled:function(){return true}};Hub.publish=function(){var d=j;j=false;var c;try{c=Hub.invoke.apply(this,arguments)}catch(e){if(e instanceof Hub.Error)c=e;else throw e;}if(typeof c!=="undefined"){c=n(true,c);j=j?m(j,c):c}c=j;j=d;return c||new h};Hub.promise=function(d){d=n(false,
undefined,d);if(j===true)return d;if(j===false)return j=d;j=m(j,d);return d}})();
