<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Hub.js by mantoni</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Hub.js</h1>
          <h2>Pub/Sub oriented JavaScript</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/mantoni/hub.js/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/mantoni/hub.js/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/mantoni/hub.js" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>hub.js</h1>

<p>Pub/Sub oriented JavaScript - <a href="http://mantoni.github.com/hub.js">http://mantoni.github.com/hub.js</a></p>

<p><a href="http://travis-ci.org/mantoni/hub.js"><img src="https://secure.travis-ci.org/mantoni/hub.js.png?branch=rewrite" alt="Build Status"></a></p>

<h2>Install</h2>

<pre><code>npm install hubjs
</code></pre>

<p>You can also download a browser package from <a href="https://github.com/mantoni/hub.js/downloads">https://github.com/mantoni/hub.js/downloads</a> or <code>make compile</code> it yourself.</p>

<h2>Usage</h2>

<h3>Instantiation</h3>

<div class="highlight"><pre><span class="kd">var</span> <span class="nx">hubjs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'hubjs'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">hub</span> <span class="o">=</span> <span class="nx">hubjs</span><span class="p">();</span>
</pre></div>

<h3>Publish / Subscribe</h3>

<div class="highlight"><pre><span class="nx">hub</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'some.event'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">});</span>
<span class="nx">hub</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'some.event'</span><span class="p">,</span> <span class="s1">'any'</span><span class="p">,</span> <span class="s1">'args'</span><span class="p">);</span>
</pre></div>

<h3>Return Values</h3>

<div class="highlight"><pre><span class="nx">hub</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'answer'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">42</span><span class="p">;</span>
<span class="p">});</span>
<span class="nx">hub</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'answer'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<h3>Callbacks</h3>

<p>Simply define an (additional) callback argument:</p>

<div class="highlight"><pre><span class="nx">hub</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'answer'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="mi">42</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">hub</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'answer'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>Alternatively, call <code>this.callback()</code> to obtain a callback, or even multiple callbacks that will be waited for.</p>

<h3>Exception Handling</h3>

<div class="highlight"><pre><span class="nx">hub</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'answer'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'ouch!'</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">hub</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'answer'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>Exceptions from multiple listeners will be merged into an <code>ErrorList</code> with an <code>errors</code> array containing all the original exceptions.</p>

<h3>Wildcard Subscriptions</h3>

<p><code>*</code> matches <code>test</code>, but not <code>test.two</code>, while <code>**</code> matches both. <code>test.*</code> matches <code>test.one</code> but not <code>one.test</code>.
Unless normal listeners, matchers do not get invoked in registration order. The more generic matchers get invoked before the more specific ones, e.g. <code>a.**</code> is invoked before <code>a.b.*</code> if <code>a.b.c</code> is emitted.</p>

<div class="highlight"><pre><span class="nx">hub</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'**'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hub event '</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">event</span> <span class="o">+</span> <span class="s1">'('</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">args</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span> <span class="o">+</span> <span class="s1">')'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">hub</span><span class="p">.</span><span class="nx">before</span><span class="p">(</span><span class="s1">'server.*'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">'No data passed to '</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">event</span> <span class="o">+</span> <span class="s1">'. Aborting.'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<h3>Wildcard Emit</h3>

<div class="highlight"><pre><span class="nx">hub</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'module.**.start'</span><span class="p">);</span>

<span class="nx">hub</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'**.destroy'</span><span class="p">);</span>
</pre></div>

<h3>Event Phases</h3>

<p>Each event is emitted in 6 phases:</p>

<ol>
<li><code>before(*)</code></li>
<li><code>before(event)</code></li>
<li><code>on(*)</code></li>
<li><code>on(event)</code></li>
<li><code>after(event)</code></li>
<li><code>after(*)</code></li>
</ol><p>Each phase is completed if all callbacks on all listeners where invoked. The next phase in only executed if the previous one is complete.
Calling <code>this.stop()</code> will prevent the following phases from being executed. Note that other listeners on the same phase will still be invoked.</p>

<p>The first 4 phases will receive the arguments passed to emit. Phase 5 and 6 will receive <code>(err, value)</code>, which is the same as what gets passed to an  <code>emit</code> callback.</p>

<h3>Strategies</h3>

<p>Strategies are functions that take an array of non-undefined values and return a result of any type.</p>

<div class="highlight"><pre><span class="nx">hub</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'answer.a'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">2</span><span class="p">;</span> <span class="p">});</span>
<span class="nx">hub</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'answer.b'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">3</span><span class="p">;</span> <span class="p">});</span>
<span class="nx">hub</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'answer.c'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">7</span><span class="p">;</span> <span class="p">});</span>

<span class="nx">hub</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'answer.*'</span><span class="p">,</span> <span class="nx">hubjs</span><span class="p">.</span><span class="nx">CONCAT</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">' * '</span><span class="p">));</span> <span class="c1">// = 2 * 3 * 7</span>
<span class="p">});</span>
</pre></div>

<p>These strategies are pre-defined:</p>

<ul>
<li>
<code>LAST</code> - returns the last non-undefined value</li>
<li>
<code>CONCAT</code> - returns an array of all non-undefined listener return values</li>
</ul><h2>API</h2>

<h5><code>hub([listeners])</code></h5>

<p>The hub module exports a factory function which takes optional listeners and returns a hub instance. All functions in the given listeners object will be installed on the hub instance using <code>on</code>.</p>

<h5><code>hub.on(event, function)</code></h5>

<p>Registers a listener for an event. The event may contain <code>*</code> or <code>**</code> to register a "matcher" (see below). If the listener function expects more arguments than are passed to <code>emit</code>, the last argument will be a callback function. The listener is expected to invoke the callback once completed with an error object or <code>null</code> and a single return value.</p>

<h5><code>hub.before(event, function)</code></h5>

<p>Like on, but invoked before listeners registered with <code>on</code>.</p>

<h5><code>hub.after(event, function)</code></h5>

<p>Like on, but invoked after listeners registered with <code>on</code> and gets invoked with the arguments <code>(err, value)</code>.</p>

<h5><code>hub.un(event)</code></h5>

<p>Unregisters all listeners for the given event.</p>

<h5><code>hub.un(event, function)</code></h5>

<p>Unregisters a single listener for an event.</p>

<h5><code>hub.once(event, function)</code></h5>

<p>Registers a listerner for an event that will be automatically unregistered on the first invocation.</p>

<h5><code>hub.emit(event[, arg1, arg2, ...][[, strategy], callback])</code></h5>

<p>Invokes all listeners for an event. The optional arguments are passed to each listener. The event may contain <code>*</code> or <code>**</code> to invoke all listeners registered for matching events (broadcasting). The optional callback will be invoked once all listeners returned. The first argument is an error if at least one of the listeners threw, the second argument is the return value. If a callback is given, the optional strategy filters the return values of the listeners. By default the strategy <code>hub.LAST</code> is used.</p>

<h3>this in listeners</h3>

<p>The API of the <code>this</code> object in all listeners and callbacks:</p>

<h5><code>hub</code></h5>

<p>The hub instance.</p>

<h5><code>event</code></h5>

<p>The current event.</p>

<h5><code>args()</code></h5>

<p>Returns a copy of the arguments passed to emit following the event.</p>

<h5><code>stop()</code></h5>

<p>Prevent listener invocation on the following event phases.</p>

<h5><code>stopped()</code></h5>

<p>Returns true if <code>stop()</code> was called.</p>

<h5><code>callback()</code></h5>

<p>Returns a callback that has to be invoked for the operation to complete. Listeners may obtain mutliple callbacks.</p>

<h3>events</h3>

<p>Calling <code>on</code>, <code>before</code>, <code>after</code> or <code>once</code> triggers a <code>newListener</code> event passing the event name and the listener function as arguments. If the event gets stopped (<code>this.stop()</code>) the listener will not be registered.</p>

<h2>Run tests</h2>

<pre><code>make
</code></pre>

<h2>Run tests in your browser</h2>

<p>This requires <a href="https://github.com/mantoni/nomo.js">nomo.js</a>.</p>

<pre><code>nomo server
</code></pre>

<p>Open http://localhost:4444/test in your browser.</p>

<h2>Compile for browsers and minify</h2>

<pre><code>make compile
</code></pre>
        </section>

        <footer>
          Hub.js is maintained by <a href="https://github.com/mantoni">mantoni</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.
        </footer>

                  <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-126897-7");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

      </div>
    </div>
  </body>
</html>