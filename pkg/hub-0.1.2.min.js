/*
 hub.js JavaScript library, v0.1.2
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(c){function b(){}b.prototype=c;return new b};if(!Array.prototype.forEach)Array.prototype.forEach=function(c,b){if(!c||!c.call)throw new TypeError;for(var a=0,f=this.length;a<f;a++)c.call(b,this[a],a,this)};hub.apply=function(c,b){return this[c].apply(this,b)};
hub.resolve=function(c,b,a){for(var f=b.indexOf(".");f!==-1;){var d=b.substring(0,f);if(!c.hasOwnProperty(d))return a;c=c[d];b=b.substring(f+1);f=b.indexOf(".")}return c.hasOwnProperty(b)?c[b]:a};hub.substitute=function(c,b,a){if(a===undefined)a="";return c.replace(/\{([a-zA-Z0-9\.]+)\}/g,b?function(f,d){return hub.resolve(b,d,a)}:function(){return a})};hub.Error=function(c,b,a){this.type=c;this.context=a;this.toString=function(){return hub.substitute(b,a)}};
hub.merge=function(c,b){if(c===undefined||c===null||c===b)return b;if(b===undefined||b===null)return c;var a=Object.prototype.toString,f=a.call(b);a=a.call(c);var d;if(a===f){if(f==="[object Object]"){for(d in b)if(b.hasOwnProperty(d))c[d]=hub.merge(c[d],b[d]);return c}if(f==="[object Array]")return c.concat(b)}throw new hub.Error("validation",a===f?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:c,source:b,targetType:a,sourceType:f});};
(function(){function c(d){return function(){var e=this._,k=typeof e[d];if(k!=="function")throw new TypeError(d+" is "+k);var p=a.call(arguments);return function(){var n=a.call(arguments);return e[d].apply(e,p.concat(n))}}}function b(){function d(k){this._=k}var e={};a.call(arguments).forEach(function(k){e[k]=c(k)});d.prototype=e;return d}var a=Array.prototype.slice,f=b("emit","on","un","create","factory","peer","mix");hub.does=new f(hub);hub.does.define=b})();
hub.iterator=function(c){function b(){if(a>=f)throw Error("Iterator out of bounds.");var d=c[a++];b.hasNext=a<f;return d}var a=0,f=c.length;b.hasNext=a<f;b.remove=function(d){var e=typeof d;if(e==="undefined")d=a;else if(e==="number")d<a&&a--;else{for(e=c.length-1;e>=0;e--)if(c[e]===d){d=e;break}if(e<0)return false}if(d>=f)return false;c.splice(d,1);b.hasNext=a<--f;return true};b.insert=function(d,e){if(typeof e==="undefined"){e=d;d=a}else d<a&&a++;c.splice(d,0,e);b.hasNext=a<++f};b.reset=function(){a=
0;b.hasNext=a<f};return b};hub.chain=function(){function c(){var a=this.propagate?this:hub.scope();a.push(b);return a.propagate.apply(a,arguments)}var b=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);c.on=function(a){var f=typeof a;if(f!=="function")throw new TypeError("Callback is "+f);b.insert(0,a)};c.un=b.remove;return c};
(function(){function c(b){if(typeof b!=="function")throw new TypeError;}hub.mix=function(b,a){for(var f in a)if(a.hasOwnProperty(f)&&typeof a[f]==="function"){var d=b,e=f,k=a[f],p=d[e];if(p)if(p.add)p.add(k);else d[e]=hub.chain(k,d[e]);else d[e]=hub.chain(k)}return b};hub.create=function(b,a){var f=Array.prototype.slice.call(arguments,2);if(typeof b!=="string"){f.unshift(a);a=b;b=null}c(a);var d={},e=this.propagate?this:hub.scope();if(b)e=hub.topicScope(b,e);e.mix=function(){return hub.apply("emit",
arguments).then(hub.does.mix(d))};f=f?a.apply(e,f):a.call(e);return hub.mix(d,f)};hub.factory=function(b,a){typeof b!=="string"?c(b):c(a);return function(){return hub.create(b,a)}}})();
(function(){function c(g){var h=typeof g;if(h!=="string")throw Error("Topic is "+h);if(!g)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(g))throw Error("Illegal topic: "+g);}function b(g,h){var j=g.indexOf("*"),l=h.indexOf("*");if(j===-1)return l===-1?0:1;if(l===-1)return-1;var u=g.indexOf("."),q=h.indexOf(".");if(j<u){if(l>q)return-1}else if(l<q)return 1;return 0}function a(g){g=g.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+g+"$")}function f(g){return function(){return g}}function d(g,h,j){for(var l in j)if(j.hasOwnProperty(l))g.on(h+l,j[l])}function e(g,h){var j=RegExp("^"+h.replace(x,"([a-zA-Z0-9\\.]+)")+"$");return function(){for(var l=n.call(arguments),u=this.topic.match(j),q=1,r=u.length;q<r;q++)l[q-1]=u[q];return g.apply(this,l)}}function k(g,h){var j;if(g)if(typeof g==="string")c(g);else{j=g;g=A}else g=A;var l=a(g),u,q=h?[h]:[],r=Object.create(y);r.emit=function(){var i;if(arguments.length){i=
arguments[0];hub.validateTopic(i)}else i=g;var s=n.call(arguments,1);if(i.indexOf("{")!==-1)i=hub.substitute(i,s);var t=i.indexOf("*")===-1;if(!(t&&!l.test(i))){var m=this.propagate?this:hub.scope();m.topic||(m=r.topicScope(i,m,true));if(t||a(i).test(g)){u&&u.apply(m,s);if(m.aborted)return m.result()}if(t=m.topicChainQueue)Array.prototype.push.apply(t,q);else t=m.topicChainQueue=q.slice();for(i=[i].concat(s);t.length;){t.shift().emit.apply(m,i);if(m.aborted)break}return m.result()}};r.matches=function(i){return l.test(i)};
r.topic=g;r.on=function(i,s,t){if(typeof i===o)r.on(g,i);else if(Object.prototype.toString.call(i)==="[object Object]")d(r,"",i);else{if(i.indexOf("{")!==-1){s=e(s,i);i=i.replace(x,"*")}if(s&&Object.prototype.toString.call(s)==="[object Object]"){d(r,i+".",s);s=f(s)}if(g===i){u||(u=hub.chain());u.on(s)}else{var m,v,z;v=0;for(z=q.length;v<z;v++){m=q[v];if(m.matches(i)){m.on(i,s,t);return}t||(t=a(i));if(t.test(m.topic)){q[v]=m=k(i,m);m.on(i,s,t);return}}m=k(i);m.on(i,s);if(i.indexOf("*")===-1)q.unshift(m);
else{v=0;for(z=q.length;v<z;v++)if(b(q[v].topic,i)!==-1){q.splice(v,0,m);return}q.push(m)}}}};r.un=function(i,s,t){if(typeof i===o)return r.un("**",i);t||(t=a(i));var m=typeof s;if(m==="undefined"){if(u&&t.test(g))u=hub.chain()}else if(g===i){if(u){u.un(s);return true}return false}var v,z,C;v=0;for(z=q.length;v<z;v++){C=q[v];if((C.matches(i)||t.test(C.topic))&&C.un(i,s,t))return true}c(i);if(m!=="undefined"&&m!==o)throw new TypeError("Callback is "+m);return false};r.mix=function(i){if(typeof i===
"string")hub.apply("emit",arguments).then(r.does.on());else r.on(i);return r};r.does=new p(r);j&&d(r,"",j);return r}var p=hub.does.define("emit","on","un","create","factory","peer","mix"),n=Array.prototype.slice,o="function",x=/\{([a-zA-Z0-9\.]+)\}/g,B=hub.does.define("emit","on","un","create","factory","peer","mix");["resolve","reject"].forEach(function(g){B.prototype[g]=function(){var h=this._.promise().does;return h[g].apply(h,arguments)}});var w={};["on","un","emit","peer","create","factory"].forEach(function(g){w[g]=
function(){var h=n.call(arguments);if(!h[0])throw new TypeError("Topic is "+h[0]);h[0]=this.namespace?this.namespace+"."+h[0]:h[0];return this.node[g].apply(hub,h)}});var y={create:hub.create,factory:hub.factory,peer:function(g,h){var j;if(typeof g===o){if(j=hub.create.apply(hub,arguments))this.on(j)}else if(typeof h===o){if(j=hub.create.apply(hub,arguments))this.on(g,j)}else this.on(g,h)},topicScope:function(g,h,j){if(!g)throw new TypeError("Topic is "+g);h||(h=hub.scope());h.topic=g;if(j){j=g.lastIndexOf(".");
h.namespace=j===-1?"":g.substring(0,j)}else h.namespace=g;h.node=this;h.on=w.on;h.un=w.un;h.peer=w.peer;h.emit=w.emit;h.create=w.create;h.factory=w.factory;h.does=new B(h);return h}},A="**";hub.node=k;hub.topicComparator=b;hub.validateTopic=c})();(function(){var c=hub.node();hub.root=c;hub.on=function(b,a){c.on(b,a)};hub.un=function(b,a){return c.un(b,a)};hub.emit=function(){return c.emit.apply(c,arguments)};hub.peer=function(){return c.peer.apply(c,arguments)};hub.reset=function(){hub.root=c=hub.node()}})();
(function(){function c(e){return function(){e.reject.apply(e,arguments)}}function b(e,k){return function(){var p=f.call(arguments);k.then(function(){var n=f.call(arguments);e.resolve.apply(e,p.concat(n))})}}var a=hub.does.define("emit","on","un","create","factory","peer","mix","resolve","reject"),f=Array.prototype.slice,d={};["on","un","emit","create","factory","peer","mix"].forEach(function(e){d[e]=function(){var k=f.call(arguments);return this.then(function(){hub[e].apply(hub,k.concat(Array.prototype.slice.call(arguments)))})}});
hub.promise=function(e,k){function p(){g&&clearTimeout(g);for(var j=A?B:x,l=0,u=j.length;l<u;l++)j[l].apply(k,w);x.length=0;B.length=0}function n(){y--;!y&&w&&p()}function o(){if(w)throw Error("Promise already "+(A?"rejected":"resolved"));}var x=[],B=[],w,y=0,A=false,g,h;h=Object.create(d);h.then=function(j,l){if(!j&&!l)throw new TypeError("Require callback or errback");if(j&&typeof j!=="function")throw new TypeError("Callback is "+j);if(l&&typeof l!=="function")throw new TypeError("Errback is "+
l);j&&x.push(j);l&&B.push(l);!y&&w&&p();return this};h.resolve=function(){o();w=f.call(arguments);y||p();return this};h.reject=function(){o();A=true;w=f.call(arguments);y||p();return this};h.wait=function(){var j=0,l=arguments.length;for(y+=l;j<l;j++)arguments[j].then(n,n);return this};h.join=function(j){if(!j||typeof j.then!=="function")throw new TypeError("Promise is "+j);var l=hub.promise(0,k);this.then(b(l,j),c(l));j.then(null,c(l));return l};h.does=new a(h);if(e)g=setTimeout(function(){h.reject(new hub.Error("timeout",
"Promise timed out after {timeout} milliseconds",{timeout:e}))},e);return h}})();
(function(){var c={},b=Array.prototype.slice,a=[];["then","join","wait","resolve","reject"].forEach(function(f){c[f]=function(){var d=this.promise();d[f].apply(d,arguments)}});hub.scope=function(f){var d=[],e,k,p=a,n=Object.create(c);n.aborted=false;n.stopPropagation=function(){n.aborted=true;d.length=0;if(arguments.length)k=arguments[0]};n.propagate=function(){if(arguments.length)p=b.call(arguments);var o=d.length;if(!o)return this.result();o=d[o-1];if(o.hasNext){o=o().apply(this,p);if(e){k=e;e=
undefined;k.then(function(){n.propagate.apply(n,p)});return k}else if(o&&o.then){k=o;k.then(function(){n.propagate.apply(n,p)});return}k=hub.merge(k,o)}else{o.reset();d.pop()}return this.propagate.apply(this,p)};n.result=function(){if(k&&k.then)return k;return hub.promise(0,this).resolve(k)};n.push=function(o){d.push(o)};n.promise=function(o,x){e||(e=hub.promise(o||0,x||this));return e};n.mix=function(){return f.mix.apply(f,arguments)};return n};hub.topicScope=function(f,d,e){return hub.root.topicScope(f,
d,e)}})();
