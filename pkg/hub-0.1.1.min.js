/*
 hub.js JavaScript library, v0.1.1
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(c){function a(){}a.prototype=c;return new a};if(!Array.prototype.forEach)Array.prototype.forEach=function(c,a){if(!c||!c.call)throw new TypeError;for(var b=0,g=this.length;b<g;b++)c.call(a,this[b],b,this)};hub.apply=function(c,a){return this[c].apply(this,a)};
hub.resolve=function(c,a,b){for(var g=a.indexOf(".");g!==-1;){var d=a.substring(0,g);if(!c.hasOwnProperty(d))return b;c=c[d];a=a.substring(g+1);g=a.indexOf(".")}return c.hasOwnProperty(a)?c[a]:b};hub.substitute=function(c,a,b){if(b===undefined)b="";return c.replace(/\{([a-zA-Z0-9\.]+)\}/g,a?function(g,d){return hub.resolve(a,d,b)}:function(){return b})};hub.Error=function(c,a,b){this.type=c;this.context=b;this.toString=function(){return hub.substitute(a,b)}};
hub.merge=function(c,a){if(c===undefined||c===null||c===a)return a;if(a===undefined||a===null)return c;var b=Object.prototype.toString,g=b.call(a);b=b.call(c);var d;if(b===g){if(g==="[object Object]"){for(d in a)if(a.hasOwnProperty(d))c[d]=hub.merge(c[d],a[d]);return c}if(g==="[object Array]")return c.concat(a)}throw new hub.Error("validation",b===g?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:c,source:a,targetType:b,sourceType:g});};
(function(){function c(d){return function(){var h=this._,k=typeof h[d];if(k!=="function")throw new TypeError(d+" is "+k);var q=b.call(arguments);return function(){var m=b.call(arguments);return h[d].apply(h,q.concat(m))}}}function a(){function d(k){this._=k}var h={};b.call(arguments).forEach(function(k){h[k]=c(k)});d.prototype=h;return d}var b=Array.prototype.slice,g=a("emit","on","un","create","factory","peer","mix");hub.does=new g(hub);hub.does.define=a})();
hub.iterator=function(c){function a(){if(b>=g)throw Error("Iterator out of bounds.");var d=c[b++];a.hasNext=b<g;return d}var b=0,g=c.length;a.hasNext=b<g;a.remove=function(d){var h=typeof d;if(h==="undefined")d=b;else if(h==="number")d<b&&b--;else{for(h=c.length-1;h>=0;h--)if(c[h]===d){d=h;break}if(h<0)return false}if(d>=g)return false;c.splice(d,1);a.hasNext=b<--g;return true};a.insert=function(d,h){if(typeof h==="undefined"){h=d;d=b}else d<b&&b++;c.splice(d,0,h);a.hasNext=b<++g};a.reset=function(){b=
0;a.hasNext=b<g};return a};hub.chain=function(){function c(){var b=this.propagate?this:hub.scope();b.push(a);return b.propagate.apply(b,arguments)}var a=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);c.on=function(b){var g=typeof b;if(g!=="function")throw new TypeError("Callback is "+g);a.insert(0,b)};c.un=a.remove;return c};
(function(){function c(a){if(typeof a!=="function")throw new TypeError;}hub.mix=function(a,b){for(var g in b)if(b.hasOwnProperty(g)&&typeof b[g]==="function"){var d=a,h=g,k=b[g],q=d[h];if(q)if(q.add)q.add(k);else d[h]=hub.chain(k,d[h]);else d[h]=hub.chain(k)}return a};hub.create=function(a,b,g){if(typeof a!=="string"){g=b;b=a;a=null}c(b);var d={};a=a?hub.topicScope(a):hub.scope();a.mix=function(){hub.apply("emit",arguments).then(hub.does.mix(d))};b=g?b.apply(a,g):b.call(a);return hub.mix(d,b)};hub.factory=
function(a,b){typeof a!=="string"?c(a):c(b);return function(){return hub.create(a,b)}}})();
(function(){function c(f){var e=typeof f;if(e!=="string")throw Error("Topic is "+e);if(!f)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(f))throw Error("Illegal topic: "+f);}function a(f,e){var j=f.indexOf("*"),l=e.indexOf("*");if(j===-1)return l===-1?0:1;if(l===-1)return-1;var u=f.indexOf("."),r=e.indexOf(".");if(j<u){if(l>r)return-1}else if(l<r)return 1;return 0}function b(f){f=f.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+f+"$")}function g(f){return function(){return f}}function d(f,e,j){for(var l in j)if(j.hasOwnProperty(l))f.on(e+l,j[l])}function h(f,e){var j=RegExp("^"+e.replace(x,"([a-zA-Z0-9\\.]+)")+"$");return function(){for(var l=m.call(arguments),u=this.topic.match(j),r=1,s=u.length;r<s;r++)l[r-1]=u[r];return f.apply(this,l)}}function k(f,e){var j;if(f)if(typeof f==="string")c(f);else{j=f;f=y}else f=y;var l=b(f),u,r=e?[e]:[],s=Object.create(z);s.emit=function(){var i;if(arguments.length){i=
arguments[0];hub.validateTopic(i)}else i=f;var t=m.call(arguments,1);if(i.indexOf("{")!==-1)i=hub.substitute(i,t);if(i!==y&&!l.test(i)){if(i.indexOf("*")===-1||!b(i).test(f))return;i=y}var o=this.propagate?this:hub.scope();o.topic||(o=s.topicScope(i,o,true));u&&u.apply(o,t);if(o.aborted)return o.result();var p=o.topicChainQueue;if(p)Array.prototype.push.apply(p,r);else p=o.topicChainQueue=r.slice();for(i=[i].concat(t);p.length;){p.shift().emit.apply(o,i);if(o.aborted)break}return o.result()};s.matches=
function(i){return l.test(i)};s.topic=f;s.on=function(i,t,o){if(typeof i===n)s.on(f,i);else if(Object.prototype.toString.call(i)==="[object Object]")d(s,"",i);else{if(i.indexOf("{")!==-1){t=h(t,i);i=i.replace(x,"*")}if(t&&Object.prototype.toString.call(t)==="[object Object]"){d(s,i+".",t);t=g(t)}if(f===i){u||(u=hub.chain());u.on(t)}else{var p,v,A;v=0;for(A=r.length;v<A;v++){p=r[v];if(p.matches(i)){p.on(i,t,o);return}o||(o=b(i));if(o.test(p.topic)){r[v]=p=k(i,p);p.on(i,t,o);return}}p=k(i);p.on(i,t);
if(i.indexOf("*")===-1)r.unshift(p);else{v=0;for(A=r.length;v<A;v++)if(a(r[v].topic,i)!==-1){r.splice(v,0,p);return}r.push(p)}}}};s.un=function(i,t,o){if(typeof i===n)return s.un("**",i);o||(o=b(i));var p=typeof t;if(p==="undefined"){if(u&&o.test(f))u=hub.chain()}else if(f===i){if(u){u.un(t);return true}return false}var v,A,C;v=0;for(A=r.length;v<A;v++){C=r[v];if((C.matches(i)||o.test(C.topic))&&C.un(i,t,o))return true}c(i);if(p!=="undefined"&&p!==n)throw new TypeError("Callback is "+p);return false};
s.mix=function(i){if(typeof i==="string")hub.apply("emit",arguments).then(s.does.on());else s.on(i);return s};s.does=new q(s);j&&d(s,"",j);return s}var q=hub.does.define("emit","on","un","create","factory","peer","mix"),m=Array.prototype.slice,n="function",x=/\{([a-zA-Z0-9\.]+)\}/g,B=hub.does.define("emit","on","un","create","factory","peer","mix");["resolve","reject"].forEach(function(f){B.prototype[f]=function(){var e=this._.promise().does;return e[f].apply(e,arguments)}});var w={};["on","un","emit",
"peer","create","factory"].forEach(function(f){w[f]=function(){var e=m.call(arguments);if(!e[0])throw new TypeError("Topic is "+e[0]);e[0]=this.namespace?this.namespace+"."+e[0]:e[0];return this.node[f].apply(hub,e)}});var z={create:hub.create,factory:hub.factory,peer:function(f,e,j){if(typeof f===n){if(e=hub.create(f,e))this.on(e)}else if(typeof e===n){if(e=hub.create(f,e,j))this.on(f,e)}else this.on(f,e)},topicScope:function(f,e,j){if(!f)throw new TypeError("Topic is "+f);e||(e=hub.scope());e.topic=
f;if(j){j=f.lastIndexOf(".");e.namespace=j===-1?"":f.substring(0,j)}else e.namespace=f;e.node=this;e.on=w.on;e.un=w.un;e.peer=w.peer;e.emit=w.emit;e.create=w.create;e.factory=w.factory;e.does=new B(e);return e}},y="**";hub.node=k;hub.topicComparator=a;hub.validateTopic=c})();
(function(){var c=hub.node();hub.root=c;hub.on=function(a,b){c.on(a,b)};hub.un=function(a,b){return c.un(a,b)};hub.emit=function(){return c.emit.apply(c,arguments)};hub.peer=function(){return c.peer.apply(c,arguments)};hub.reset=function(){hub.root=c=hub.node()}})();
(function(){function c(h){return function(){h.reject.apply(h,arguments)}}function a(h,k){return function(){var q=g.call(arguments);k.then(function(){var m=g.call(arguments);h.resolve.apply(h,q.concat(m))})}}var b=hub.does.define("emit","on","un","create","factory","peer","mix","resolve","reject"),g=Array.prototype.slice,d={};["on","un","emit","create","factory","peer","mix"].forEach(function(h){d[h]=function(){var k=g.call(arguments);return this.then(function(){hub[h].apply(hub,k.concat(Array.prototype.slice.call(arguments)))})}});
hub.promise=function(h,k){function q(){f&&clearTimeout(f);for(var j=y?B:x,l=0,u=j.length;l<u;l++)j[l].apply(k,w);x.length=0;B.length=0}function m(){z--;!z&&w&&q()}function n(){if(w)throw Error("Promise already "+(y?"rejected":"resolved"));}var x=[],B=[],w,z=0,y=false,f,e;e=Object.create(d);e.then=function(j,l){if(!j&&!l)throw new TypeError("Require callback or errback");if(j&&typeof j!=="function")throw new TypeError("Callback is "+j);if(l&&typeof l!=="function")throw new TypeError("Errback is "+
l);j&&x.push(j);l&&B.push(l);!z&&w&&q();return this};e.resolve=function(){n();w=g.call(arguments);z||q();return this};e.reject=function(){n();y=true;w=g.call(arguments);z||q();return this};e.wait=function(){var j=0,l=arguments.length;for(z+=l;j<l;j++)arguments[j].then(m,m);return this};e.join=function(j){if(!j||typeof j.then!=="function")throw new TypeError("Promise is "+j);var l=hub.promise(0,k);this.then(a(l,j),c(l));j.then(null,c(l));return l};e.does=new b(e);if(h)f=setTimeout(function(){e.reject(new hub.Error("timeout",
"Promise timed out after {timeout} milliseconds",{timeout:h}))},h);return e}})();
(function(){var c={},a=Array.prototype.slice,b=[];["then","join","wait","resolve","reject"].forEach(function(g){c[g]=function(){var d=this.promise();d[g].apply(d,arguments)}});hub.scope=function(g){var d=[],h,k,q=b,m=Object.create(c);m.aborted=false;m.stopPropagation=function(){m.aborted=true;d.length=0;if(arguments.length)k=arguments[0]};m.propagate=function(){if(arguments.length)q=a.call(arguments);var n=d.length;if(!n)return this.result();n=d[n-1];if(n.hasNext){n=n().apply(this,q);if(h){k=h;h=
undefined;k.then(function(){m.propagate.apply(m,q)});return k}else if(n&&n.then){k=n;k.then(function(){m.propagate.apply(m,q)});return}k=hub.merge(k,n)}else{n.reset();d.pop()}return this.propagate.apply(this,q)};m.result=function(){if(k&&k.then)return k;return hub.promise(0,this).resolve(k)};m.push=function(n){d.push(n)};m.promise=function(n,x){h||(h=hub.promise(n||0,x||this));return h};m.mix=function(){return g.mix.apply(g,arguments)};return m};hub.topicScope=function(g,d,h){return hub.root.topicScope(g,
d,h)}})();
