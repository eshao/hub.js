/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(c){function a(){}a.prototype=c;return new a};if(!Array.prototype.forEach)Array.prototype.forEach=function(c,a){if(!c||!c.call)throw new TypeError;for(var b=0,g=this.length;b<g;b++)c.call(a,this[b],b,this)};hub.apply=function(c,a){return this[c].apply(this,a)};
hub.resolve=function(c,a,b){for(var g=a.indexOf(".");g!==-1;){var e=a.substring(0,g);if(!c.hasOwnProperty(e))return b;c=c[e];a=a.substring(g+1);g=a.indexOf(".")}return c.hasOwnProperty(a)?c[a]:b};hub.substitute=function(c,a,b){if(b===undefined)b="";return c.replace(/\{([a-zA-Z0-9\.]+)\}/g,a?function(g,e){return hub.resolve(a,e,b)}:function(){return b})};hub.Error=function(c,a,b){this.type=c;this.context=b;this.toString=function(){return hub.substitute(a,b)}};
hub.merge=function(c,a){if(c===undefined||c===null||c===a)return a;if(a===undefined||a===null)return c;var b=Object.prototype.toString,g=b.call(a);b=b.call(c);var e;if(b===g){if(g==="[object Object]"){for(e in a)if(a.hasOwnProperty(e))c[e]=hub.merge(c[e],a[e]);return c}if(g==="[object Array]")return c.concat(a)}throw new hub.Error("validation",b===g?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:c,source:a,targetType:b,sourceType:g});};
(function(){function c(e){return function(){var h=this._,s=typeof h[e];if(s!=="function")throw new TypeError(e+" is "+s);var m=b.call(arguments);return function(){var j=b.call(arguments);return h[e].apply(h,m.concat(j))}}}function a(){function e(s){this._=s}var h={};b.call(arguments).forEach(function(s){h[s]=c(s)});e.prototype=h;return e}var b=Array.prototype.slice,g=a("emit","on","un","create","factory","peer","mix");hub.does=new g(hub);hub.does.define=a})();
hub.iterator=function(c){function a(){if(b>=g)throw Error("Iterator out of bounds.");var e=c[b++];a.hasNext=b<g;return e}var b=0,g=c.length;a.hasNext=b<g;a.remove=function(e){var h=typeof e;if(h==="undefined")e=b;else if(h==="number")e<b&&b--;else{for(h=c.length-1;h>=0;h--)if(c[h]===e){e=h;break}if(h<0)return false}if(e>=g)return false;c.splice(e,1);a.hasNext=b<--g;return true};a.insert=function(e,h){if(typeof h==="undefined"){h=e;e=b}else e<b&&b++;c.splice(e,0,h);a.hasNext=b<++g};a.reset=function(){b=
0;a.hasNext=b<g};return a};hub.chain=function(){function c(){var b=this.propagate?this:hub.scope();b.push(a);return b.propagate.apply(b,arguments)}var a=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);c.on=function(b){var g=typeof b;if(g!=="function")throw new TypeError("Callback is "+g);a.insert(0,b)};c.un=a.remove;return c};
(function(){function c(a){if(typeof a!=="function")throw new TypeError;}hub.mix=function(a,b){for(var g in b)if(b.hasOwnProperty(g)&&typeof b[g]==="function"){var e=a,h=g,s=b[g],m=e[h];if(m)if(m.add)m.add(s);else e[h]=hub.chain(s,e[h]);else e[h]=hub.chain(s)}return a};hub.create=function(a,b,g){if(typeof a!=="string"){g=b;b=a;a=null}c(b);var e={};a=a?hub.topicScope(a):hub.scope();a.mix=function(){hub.apply("emit",arguments).then(hub.does.mix(e))};b=g?b.apply(a,g):b.call(a);return hub.mix(e,b)};hub.factory=
function(a,b){typeof a!=="string"?c(a):c(b);return function(){return hub.create(a,b)}}})();
(function(){function c(d){var o=typeof d;if(o!=="string")throw Error("Topic is "+o);if(!d)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(d))throw Error("Illegal topic: "+d);}function a(d,o){var w=d.indexOf("*"),p=o.indexOf("*");if(w===-1)return p===-1?0:1;if(p===-1)return-1;var l=d.indexOf("."),i=o.indexOf(".");if(w<l){if(p>i)return-1}else if(p<i)return 1;return 0}function b(d){d=d.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+d+"$")}function g(d){return function(){return d}}function e(d,o,w){for(var p in w)if(w.hasOwnProperty(p))d.on(o+p,w[p])}function h(d,o){var w=RegExp("^"+o.replace(n,"([a-zA-Z0-9\\.]+)")+"$");return function(){for(var p=j.call(arguments),l=this.topic.match(w),i=1,t=l.length;i<t;i++)p[i-1]=l[i];return d.apply(this,p)}}function s(d,o){var w;if(d)if(typeof d==="string")c(d);else{w=d;d=q}else d=q;var p=b(d),l,i=o?[o]:[],t=Object.create(y);t.emit=function(){var f;if(arguments.length){f=
arguments[0];hub.validateTopic(f)}else f=d;var v=j.call(arguments,1);if(f.indexOf("{")!==-1)f=hub.substitute(f,v);if(f!==q&&!p.test(f)){if(f.indexOf("*")===-1||!b(f).test(d))return;f=q}var r=this.propagate?this:hub.scope();r.topic||(r=hub.topicScope(f,r));l&&l.apply(r,v);if(r.aborted)return r.result();var u=r.topicChainQueue;if(u)Array.prototype.push.apply(u,i);else u=r.topicChainQueue=i.slice();for(f=[f].concat(v);u.length;){u.shift().emit.apply(r,f);if(r.aborted)break}return r.result()};t.matches=
function(f){return p.test(f)};t.topic=d;t.on=function(f,v,r){if(typeof f===k)t.on(d,f);else if(Object.prototype.toString.call(f)==="[object Object]")e(t,"",f);else{if(f.indexOf("{")!==-1){v=h(v,f);f=f.replace(n,"*")}if(v&&Object.prototype.toString.call(v)==="[object Object]"){e(t,f+".",v);v=g(v)}if(d===f){l||(l=hub.chain());l.on(v)}else{var u,x,z;x=0;for(z=i.length;x<z;x++){u=i[x];if(u.matches(f)){u.on(f,v,r);return}r||(r=b(f));if(r.test(u.topic)){i[x]=u=s(f,u);u.on(f,v,r);return}}u=s(f);u.on(f,v);
if(f.indexOf("*")===-1)i.unshift(u);else{x=0;for(z=i.length;x<z;x++)if(a(i[x].topic,f)!==-1){i.splice(x,0,u);return}i.push(u)}}}};t.un=function(f,v){if(typeof f===k)return t.un("**",f);if(d===f)return l?l.un(v):-1;var r,u,x;r=0;for(u=i.length;r<u;r++){x=i[r];if(x.matches(f))if(x.un(f,v))return true}c(f);r=typeof v;if(r!==k)throw new TypeError("Callback is "+r);return false};t.mix=function(f){if(typeof f==="string")hub.apply("emit",arguments).then(t.does.on());else t.on(f);return t};t.does=new m(t);
w&&e(t,"",w);return t}var m=hub.does.define("emit","on","un","create","factory","peer","mix"),j=Array.prototype.slice,k="function",n=/\{([a-zA-Z0-9\.]+)\}/g,y={create:hub.create,factory:hub.factory,peer:function(d,o,w){if(typeof d===k){if(o=hub.create(d,o))this.on(o)}else if(typeof o===k){if(o=hub.create(d,o,w))this.on(d,o)}else this.on(d,o)}},q="**";hub.node=s;hub.topicComparator=a;hub.validateTopic=c})();
(function(){var c=hub.node();hub.root=c;hub.on=function(a,b){c.on(a,b)};hub.un=function(a,b){return c.un(a,b)};hub.emit=function(){return c.emit.apply(c,arguments)};hub.peer=function(){return c.peer.apply(c,arguments)};hub.reset=function(){hub.root=c=hub.node()}})();
(function(){function c(h){return function(){h.reject.apply(h,arguments)}}function a(h,s){return function(){var m=g.call(arguments);s.then(function(){var j=g.call(arguments);h.resolve.apply(h,m.concat(j))})}}var b=hub.does.define("emit","on","un","create","factory","peer","mix","resolve","reject"),g=Array.prototype.slice,e={};["on","un","emit","create","factory","peer","mix"].forEach(function(h){e[h]=function(){var s=g.call(arguments);return this.then(function(){hub[h].apply(hub,s.concat(Array.prototype.slice.call(arguments)))})}});
hub.promise=function(h,s){function m(){w&&clearTimeout(w);for(var l=o?y:n,i=0,t=l.length;i<t;i++)l[i].apply(s,q);n.length=0;y.length=0}function j(){d--;!d&&q&&m()}function k(){if(q)throw Error("Promise already "+(o?"rejected":"resolved"));}var n=[],y=[],q,d=0,o=false,w,p;p=Object.create(e);p.then=function(l,i){if(!l&&!i)throw new TypeError("Require callback or errback");if(l&&typeof l!=="function")throw new TypeError("Callback is "+l);if(i&&typeof i!=="function")throw new TypeError("Errback is "+
i);l&&n.push(l);i&&y.push(i);!d&&q&&m();return this};p.resolve=function(){k();q=g.call(arguments);d||m();return this};p.reject=function(){k();o=true;q=g.call(arguments);d||m();return this};p.wait=function(){var l=0,i=arguments.length;for(d+=i;l<i;l++)arguments[l].then(j,j);return this};p.join=function(l){if(!l||typeof l.then!=="function")throw new TypeError("Promise is "+l);var i=hub.promise(0,s);this.then(a(i,l),c(i));l.then(null,c(i));return i};p.does=new b(p);if(h)w=setTimeout(function(){p.reject(new hub.Error("timeout",
"Promise timed out after {timeout} milliseconds",{timeout:h}))},h);return p}})();
(function(){function c(m,j){return function(){var k=g.call(arguments);if(!k[0])throw new TypeError("Topic is "+k[0]);k[0]=m+k[0];return j.apply(hub,k)}}var a={},b={},g=Array.prototype.slice,e=[];["then","join","wait","resolve","reject"].forEach(function(m){a[m]=function(){var j=this.promise();j[m].apply(j,arguments)}});hub.scope=function(m){var j=[],k,n,y=e,q=Object.create(a);q.aborted=false;q.stopPropagation=function(){q.aborted=true;j.length=0;if(arguments.length)n=arguments[0]};q.propagate=function(){if(arguments.length)y=
g.call(arguments);var d=j.length;if(!d)return this.result();d=j[d-1];if(d.hasNext){d=d().apply(this,y);if(k){n=k;k=undefined;n.then(function(){q.propagate.apply(q,y)});return n}else if(d&&d.then){n=d;n.then(function(){q.propagate.apply(q,y)});return}n=hub.merge(n,d)}else{d.reset();j.pop()}return this.propagate.apply(this,y)};q.result=function(){if(n&&n.then)return n;return hub.promise(0,this).resolve(n)};q.push=function(d){j.push(d)};q.promise=function(d,o){k||(k=hub.promise(d||0,o||this));return k};
q.mix=function(){return m.mix.apply(m,arguments)};return q};var h=hub.does.define("emit","on","un","create","factory","peer","mix");["resolve","reject"].forEach(function(m){h.prototype[m]=function(){var j=this._.promise().does;return j[m].apply(j,arguments)}});hub.topicScope=function(m,j){j||(j=hub.scope());var k=m.lastIndexOf(".");k=k===-1?"":m.substring(0,k)+".";var n=b[k];if(!n){n={on:c(k,hub.on),un:c(k,hub.un),peer:c(k,hub.peer),emit:c(k,hub.emit),create:c(k,hub.create),factory:c(k,hub.factory)};
b[k]=n}j.topic=m;j.on=n.on;j.un=n.un;j.peer=n.peer;j.emit=n.emit;j.create=n.create;j.factory=n.factory;j.does=new h(j);return j};var s=hub.reset;hub.reset=function(){b={};s()}})();
