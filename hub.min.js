/*
 hub.js JavaScript library, v0.1-SNAPSHOT
 https://github.com/mantoni/hub.js

 Copyright 2011, Maximilian Antoni
 Released under the MIT license:
 https://github.com/mantoni/hub.js/raw/master/LICENSE
*/
hub={};if(!Object.create)Object.create=function(c){function a(){}a.prototype=c;return new a};if(!Array.prototype.forEach)Array.prototype.forEach=function(c,a){if(!c||!c.call)throw new TypeError;for(var b=0,e=this.length;b<e;b++)c.call(a,this[b],b,this)};hub.apply=function(c,a){return this[c].apply(this,a)};
hub.resolve=function(c,a,b){for(var e=a.indexOf(".");e!==-1;){var d=a.substring(0,e);if(!c.hasOwnProperty(d))return b;c=c[d];a=a.substring(e+1);e=a.indexOf(".")}return c.hasOwnProperty(a)?c[a]:b};hub.substitute=function(c,a,b){if(b===undefined)b="";return c.replace(/\{([a-zA-Z0-9\.]+)\}/g,a?function(e,d){return hub.resolve(a,d,b)}:function(){return b})};hub.Error=function(c,a,b){this.type=c;this.context=b;this.toString=function(){return hub.substitute(a,b)}};
hub.merge=function(c,a){if(c===undefined||c===null||c===a)return a;if(a===undefined||a===null)return c;var b=Object.prototype.toString,e=b.call(a);b=b.call(c);var d;if(b===e){if(e==="[object Object]"){for(d in a)if(a.hasOwnProperty(d))c[d]=hub.merge(c[d],a[d]);return c}if(e==="[object Array]")return c.concat(a)}throw new hub.Error("validation",b===e?"Cannot merge value {target} with {source}":"Cannot merge type {targetType} with {sourceType}",{target:c,source:a,targetType:b,sourceType:e});};
(function(){function c(d){return function(){var h=this._,j=typeof h[d];if(j!=="function")throw new TypeError(d+" is "+j);var i=b.call(arguments);return function(){var l=b.call(arguments);return h[d].apply(h,i.concat(l))}}}function a(){function d(j){this._=j}var h={};b.call(arguments).forEach(function(j){h[j]=c(j)});d.prototype=h;return d}var b=Array.prototype.slice,e=a("emit","on","un","create","factory","peer","mix");hub.does=new e(hub);hub.does.define=a})();
hub.iterator=function(c){function a(){if(b>=e)throw Error("Iterator out of bounds.");var d=c[b++];a.hasNext=b<e;return d}var b=0,e=c.length;a.hasNext=b<e;a.remove=function(d){var h=typeof d;if(h==="undefined")d=b;else if(h==="number")d<b&&b--;else{for(h=c.length-1;h>=0;h--)if(c[h]===d){d=h;break}if(h<0)return false}if(d>=e)return false;c.splice(d,1);a.hasNext=b<--e;return true};a.insert=function(d,h){if(typeof h==="undefined"){h=d;d=b}else d<b&&b++;c.splice(d,0,h);a.hasNext=b<++e};a.reset=function(){b=
0;a.hasNext=b<e};return a};hub.chain=function(){function c(){var b=this.propagate?this:hub.scope();b.push(a);return b.propagate.apply(b,arguments)}var a=hub.iterator(arguments.length?Array.prototype.slice.call(arguments):[]);c.on=function(b){var e=typeof b;if(e!=="function")throw new TypeError("Callback is "+e);a.insert(0,b)};c.un=a.remove;return c};
(function(){function c(a){if(typeof a!=="function")throw new TypeError;}hub.mix=function(a,b){for(var e in b)if(b.hasOwnProperty(e)&&typeof b[e]==="function"){var d=a,h=e,j=b[e],i=d[h];if(i)if(i.add)i.add(j);else d[h]=hub.chain(j,d[h]);else d[h]=hub.chain(j)}return a};hub.create=function(a,b,e){if(typeof a!=="string"){e=b;b=a;a=null}c(b);var d={};a=a?hub.topicScope(a):hub.scope();a.mix=function(){hub.apply("emit",arguments).then(hub.does.mix(d))};b=e?b.apply(a,e):b.call(a);return hub.mix(d,b)};hub.factory=
function(a,b){typeof a!=="string"?c(a):c(b);return function(){return hub.create(a,b)}}})();
(function(){function c(f){var p=typeof f;if(p!=="string")throw Error("Topic is "+p);if(!f)throw Error("Topic is empty");if(!/^[a-zA-Z0-9\.\{\}\*]+$/.test(f))throw Error("Illegal topic: "+f);}function a(f,p){var v=f.indexOf("*"),q=p.indexOf("*");if(v===-1)return q===-1?0:1;if(q===-1)return-1;var m=f.indexOf("."),k=p.indexOf(".");if(v<m){if(q>k)return-1}else if(q<k)return 1;return 0}function b(f){f=f.replace(/\./g,"\\.").replace(/\*\*/g,"([a-zA-Z0-9\\.#]+|##)").replace(/\*/g,"([a-zA-Z0-9\\*]+)").replace(/#/g,
"\\*");return RegExp("^"+f+"$")}function e(f){return function(){return f}}function d(f,p,v){for(var q in v)if(v.hasOwnProperty(q))f.on(p+q,v[q])}function h(f,p){var v=RegExp("^"+p.replace(y,"([a-zA-Z0-9\\.]+)")+"$");return function(){for(var q=l.call(arguments),m=this.topic.match(v),k=1,t=m.length;k<t;k++)q[k-1]=m[k];return f.apply(this,q)}}function j(f,p){var v;if(f)if(typeof f==="string")c(f);else{v=f;f=o}else f=o;var q=b(f),m,k=p?[p]:[],t=Object.create(u);t.emit=function(){var g;if(arguments.length){g=
arguments[0];hub.validateTopic(g)}else g=f;var w=l.call(arguments,1);if(g.indexOf("{")!==-1)g=hub.substitute(g,w);if(g!==o&&!q.test(g)){if(g.indexOf("*")===-1||!b(g).test(f))return;g=o}var r=this.propagate?this:hub.scope();r.topic||(r=hub.topicScope(g,r));m&&m.apply(r,w);if(r.aborted)return r.result();var s=r.topicChainQueue;if(s)Array.prototype.push.apply(s,k);else s=r.topicChainQueue=k.slice();for(;s.length;){s.shift().emit.apply(r,[g].concat(w));if(r.aborted)break}return r.result()};t.matches=
function(g){return q.test(g)};t.topic=f;t.on=function(g,w,r){if(typeof g===n)t.on(f,g);else if(Object.prototype.toString.call(g)==="[object Object]")d(t,"",g);else{if(g.indexOf("{")!==-1){w=h(w,g);g=g.replace(y,"*")}if(Object.prototype.toString.call(w)==="[object Object]"){d(t,g+".",w);w=e(w)}if(f===g){m||(m=hub.chain());m.on(w)}else{var s,x,z;x=0;for(z=k.length;x<z;x++){s=k[x];if(s.matches(g)){s.on(g,w,r);return}r||(r=b(g));if(r.test(s.topic)){s=j(g,s);s.on(g,w,r);k[x]=s;return}}s=j(g);s.on(g,w);
if(g.indexOf("*")===-1)k.unshift(s);else{x=0;for(z=k.length;x<z;x++)if(a(k[x].topic,g)!==-1){k.splice(x,0,s);return}k.push(s)}}}};t.un=function(g,w){if(typeof g===n)return t.un("**",g);if(f===g)return m?m.un(w):-1;var r,s,x;r=0;for(s=k.length;r<s;r++){x=k[r];if(x.matches(g))if(x.un(g,w))return true}c(g);r=typeof w;if(r!==n)throw new TypeError("Callback is "+r);return false};t.mix=function(g){if(typeof g==="string")hub.apply("emit",arguments).then(t.does.on());else t.on(g);return t};t.does=new i(t);
v&&d(t,"",v);return t}var i=hub.does.define("emit","on","un","create","factory","peer","mix"),l=Array.prototype.slice,n="function",y=/\{([a-zA-Z0-9\.]+)\}/g,u={create:hub.create,factory:hub.factory,peer:function(f,p,v){if(typeof f===n){if(p=hub.create(f,p))this.on(p)}else if(typeof p===n){if(p=hub.create(f,p,v))this.on(f,p)}else this.on(f,p)}},o="**";hub.node=j;hub.topicComparator=a;hub.validateTopic=c})();
(function(){var c=hub.node();hub.root=c;hub.on=function(a,b){c.on(a,b)};hub.un=function(a,b){return c.un(a,b)};hub.emit=function(){return c.emit.apply(c,arguments)};hub.peer=function(){return c.peer.apply(c,arguments)};hub.reset=function(){hub.root=c=hub.node()}})();
(function(){function c(h){return function(){h.reject.apply(h,arguments)}}function a(h,j){return function(){var i=e.call(arguments);j.then(function(){var l=e.call(arguments);h.resolve.apply(h,i.concat(l))})}}var b=hub.does.define("emit","on","un","create","factory","peer","mix","resolve","reject"),e=Array.prototype.slice,d={};["on","un","emit","create","factory","peer","mix"].forEach(function(h){d[h]=function(){var j=e.call(arguments);return this.then(function(){hub[h].apply(hub,j.concat(Array.prototype.slice.call(arguments)))})}});
hub.promise=function(h,j){function i(){v&&clearTimeout(v);for(var m=p?u:y,k=0,t=m.length;k<t;k++)m[k].apply(j,o);y.length=0;u.length=0}function l(){f--;!f&&o&&i()}function n(){if(o)throw Error("Promise already "+(p?"rejected":"resolved"));}var y=[],u=[],o,f=0,p=false,v,q;q=Object.create(d);q.then=function(m,k){if(!m&&!k)throw new TypeError("Require callback or errback");if(m&&typeof m!=="function")throw new TypeError("Callback is "+m);if(k&&typeof k!=="function")throw new TypeError("Errback is "+
k);m&&y.push(m);k&&u.push(k);!f&&o&&i();return this};q.resolve=function(){n();o=e.call(arguments);f||i();return this};q.reject=function(){n();p=true;o=e.call(arguments);f||i();return this};q.wait=function(){var m=0,k=arguments.length;for(f+=k;m<k;m++)arguments[m].then(l,l);return this};q.join=function(m){if(!m||typeof m.then!=="function")throw new TypeError("Promise is "+m);var k=hub.promise(0,j);this.then(a(k,m),c(k));m.then(null,c(k));return k};q.does=new b(q);if(h)v=setTimeout(function(){q.reject(new hub.Error("timeout",
"Promise timed out after {timeout} milliseconds",{timeout:h}))},h);return q}})();
(function(){function c(j,i){if(j)j+=".";return function(){var l=e.call(arguments);if(!l[0])throw new TypeError("Topic is "+l[0]);l[0]=j+l[0];return i.apply(hub,l)}}var a={},b={},e=Array.prototype.slice;["then","join","wait","resolve","reject"].forEach(function(j){a[j]=function(){var i=this.promise();i[j].apply(i,arguments)}});hub.scope=function(j){var i=[],l,n,y,u=Object.create(a);u.aborted=false;u.stopPropagation=function(){u.aborted=true;i.length=0;if(arguments.length)n=arguments[0]};u.propagate=
function(){if(arguments.length)y=e.call(arguments);var o=i.length;if(!o)return this.result();o=i[o-1];if(o.hasNext){o=o().apply(this,y);if(l){n=l;l=undefined;n.then(function(){u.propagate.apply(u,y)});return n}else if(o&&o.then){n=o;n.then(function(){u.propagate.apply(u,y)});return}n=hub.merge(n,o)}else{o.reset();i.pop()}return this.propagate.apply(this,y)};u.result=function(){if(n&&n.then)return n;return hub.promise(0,this).resolve(n)};u.push=function(o){i.push(o)};u.promise=function(o,f){l||(l=
hub.promise(o||0,f||this));return l};u.mix=function(){return j.mix.apply(j,arguments)};return u};var d=hub.does.define("emit","on","un","create","factory","peer","mix");["resolve","reject"].forEach(function(j){d.prototype[j]=function(){var i=this._.promise().does;return i[j].apply(i,arguments)}});hub.topicScope=function(j,i){i||(i=hub.scope());var l=j.lastIndexOf(".");l=l===-1?"":j.substring(0,l);var n=b[l];if(!n){n={on:c(l,hub.on),un:c(l,hub.un),peer:c(l,hub.peer),emit:c(l,hub.emit),create:c(l,hub.create),
factory:c(l,hub.factory)};b[l]=n}i.topic=j;i.on=n.on;i.un=n.un;i.peer=n.peer;i.emit=n.emit;i.create=n.create;i.factory=n.factory;i.does=new d(i);return i};var h=hub.reset;hub.reset=function(){b={};h()}})();
